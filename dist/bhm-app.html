<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>brainHEALTH Manchester — Assessment App</title>
  <!-- Bootstrap 5 CSS from CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
/* ═══════════════════════════════════════════════════════
   BHM Assessment App — Custom Styles
   ═══════════════════════════════════════════════════════ */

/* ── Brand / Logo placeholder ── */
.brand-logo-placeholder {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 38px;
  height: 38px;
  border-radius: 8px;
  background: rgba(255,255,255,0.2);
  font-weight: 700;
  font-size: 0.75rem;
  letter-spacing: 1px;
}

/* ── Main tab bar ── */
.main-tabs .nav-link {
  font-weight: 500;
  font-size: 0.9rem;
  color: #495057;
  border-bottom: 3px solid transparent;
  padding: 0.6rem 1rem;
}
.main-tabs .nav-link.active {
  color: #0d6efd;
  border-bottom-color: #0d6efd;
  background: transparent;
}
.main-tabs .nav-link:hover:not(.active) {
  color: #0d6efd;
  border-bottom-color: #dee2e6;
}

/* ── Sub-tabs (pills) ── */
#patientSubTabs .nav-link,
#informantSubTabs .nav-link {
  font-size: 0.85rem;
  padding: 0.4rem 0.9rem;
}

/* ── Report side panel ── */
.report-side-panel {
  width: 420px;
  min-width: 420px;
  max-height: calc(100vh - 110px);
  overflow-y: auto;
  transition: margin-right 0.3s ease, opacity 0.3s ease;
}
.report-side-panel.collapsed {
  margin-right: -420px;
  opacity: 0;
  pointer-events: none;
}
.report-preview-body {
  font-size: 0.85rem;
  line-height: 1.55;
}
.report-preview-body h6 {
  font-size: 0.9rem;
  color: #0d6efd;
  border-bottom: 1px solid #dee2e6;
  padding-bottom: 4px;
  margin-top: 1rem;
}
.report-preview-body .score-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 600;
  font-size: 0.8rem;
}
.report-preview-body .score-good { background: #d1e7dd; color: #0f5132; }
.report-preview-body .score-moderate { background: #fff3cd; color: #664d03; }
.report-preview-body .score-poor { background: #f8d7da; color: #842029; }

/* ── AUDIT unified table (mirrors paper form) ── */
.audit-unified-table th {
  background: #e8edf3;
}
.audit-unified-table td.cg-label {
  font-size: 0.85rem;
  line-height: 1.4;
  min-width: 280px;
  padding: 10px 12px;
}
.audit-unified-table td.cg-cell {
  font-size: 0.78rem;
  line-height: 1.3;
  padding: 8px 6px;
  vertical-align: middle;
}
.audit-unified-table td.audit-empty-cell {
  border: 1px solid #dee2e6;
  cursor: default;
}
.audit-unified-table td.audit-your-score {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  min-width: 60px;
  color: #0d6efd;
}
.audit-unified-table .audit-total-row td {
  background: #f0f4ff;
  border: 2px solid #dee2e6;
  border-top: 2px solid #0d6efd;
  padding: 10px 12px;
}

/* ── Clickable grid (radio-table) ── */
.clickable-grid {
  width: 100%;
  border-collapse: collapse;
}
.clickable-grid th {
  background: #f8f9fa;
  font-size: 0.8rem;
  font-weight: 600;
  text-align: center;
  padding: 8px 6px;
  border: 1px solid #dee2e6;
  position: sticky;
  top: 0;
  z-index: 1;
}
.clickable-grid td {
  border: 1px solid #dee2e6;
  padding: 8px 6px;
  vertical-align: middle;
}
.clickable-grid td.cg-label {
  font-size: 0.88rem;
  min-width: 200px;
  background: #fdfdfd;
}
.clickable-grid td.cg-cell {
  text-align: center;
  cursor: pointer;
  min-width: 44px;
  min-height: 44px;
  font-size: 0.82rem;
  transition: background-color 0.15s ease, color 0.15s ease;
  user-select: none;
}
.clickable-grid td.cg-cell:hover {
  background: #e7f1ff;
}
.clickable-grid td.cg-cell.selected {
  background: #0d6efd;
  color: #fff;
  font-weight: 600;
}
.clickable-grid td.cg-cell:focus {
  outline: 3px solid #86b7fe;
  outline-offset: -3px;
}
/* Row striping */
.clickable-grid tbody tr:nth-child(even) td.cg-label {
  background: #f8f9fa;
}

/* ── Section cards ── */
.instrument-card {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 1.25rem;
  margin-bottom: 1.25rem;
  background: #fff;
}
.instrument-card h5 {
  font-size: 1.05rem;
  font-weight: 600;
  color: #212529;
  margin-bottom: 0.15rem;
}
.instrument-card .instrument-subtitle {
  font-size: 0.82rem;
  color: #6c757d;
  margin-bottom: 1rem;
}

/* ── Score summary bar (shown at top of each instrument) ── */
.score-summary {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.6rem 1rem;
  background: #f0f4ff;
  border-radius: 6px;
  margin-bottom: 1rem;
  font-size: 0.88rem;
}
.score-summary .score-label {
  font-weight: 600;
  color: #495057;
}
.score-summary .score-value {
  font-size: 1.2rem;
  font-weight: 700;
  color: #0d6efd;
}
.score-summary .score-interp {
  font-size: 0.82rem;
  color: #6c757d;
  flex: 1;
}

/* ── Completeness indicator ── */
.completeness-bar {
  height: 4px;
  border-radius: 2px;
  background: #e9ecef;
  overflow: hidden;
  margin-top: 0.5rem;
}
.completeness-bar .fill {
  height: 100%;
  background: #0d6efd;
  transition: width 0.3s ease;
}
.completeness-text {
  font-size: 0.75rem;
  color: #6c757d;
  margin-top: 2px;
}

/* ── Form field styles ── */
.bhm-field-group {
  margin-bottom: 1rem;
}
.bhm-field-group label {
  font-weight: 500;
  font-size: 0.88rem;
  margin-bottom: 0.25rem;
  display: block;
}
.bhm-field-group .form-control,
.bhm-field-group .form-select {
  font-size: 0.9rem;
}
.bhm-field-group .form-text {
  font-size: 0.78rem;
}

/* ── Yes/No toggle cells ── */
.yn-group {
  display: inline-flex;
  gap: 4px;
}
.yn-group .yn-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 52px;
  min-height: 44px;
  padding: 6px 14px;
  border: 2px solid #dee2e6;
  border-radius: 6px;
  background: #fff;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.15s ease;
  user-select: none;
}
.yn-group .yn-btn:hover { border-color: #86b7fe; background: #e7f1ff; }
.yn-group .yn-btn.selected-yes { background: #198754; color: #fff; border-color: #198754; }
.yn-group .yn-btn.selected-no { background: #dc3545; color: #fff; border-color: #dc3545; }

/* ── Conditional sections ── */
.conditional-section {
  border-left: 3px solid #0d6efd;
  padding-left: 1rem;
  margin-left: 0.5rem;
  margin-top: 0.5rem;
}

/* ── Report full view ── */
.report-full {
  max-width: 800px;
  margin: 0 auto;
  font-size: 0.95rem;
  line-height: 1.7;
}
.report-full h4 {
  color: #0d6efd;
  border-bottom: 2px solid #0d6efd;
  padding-bottom: 6px;
  margin-top: 2rem;
}
.report-full .report-header {
  text-align: center;
  padding: 1.5rem 0;
  border-bottom: 2px solid #212529;
  margin-bottom: 2rem;
}
.report-full .clinician-insert {
  background: #fff9e6;
  border: 1px dashed #ffc107;
  border-radius: 6px;
  padding: 0.75rem;
  margin: 0.75rem 0;
}
.report-full .clinician-insert textarea {
  width: 100%;
  border: none;
  background: transparent;
  resize: vertical;
  min-height: 60px;
  font-size: 0.9rem;
}

/* ── Chart containers ── */
.chart-container {
  position: relative;
  max-width: 500px;
  margin: 1rem 0;
}
.chart-container-sm {
  max-width: 280px;
  max-height: 160px;
}

/* ── Audit log table ── */
.audit-table {
  font-size: 0.82rem;
}
.audit-table th {
  position: sticky;
  top: 0;
  background: #f8f9fa;
  z-index: 1;
}

/* ── Print styles ── */
@media print {
  .navbar, .main-tabs, .report-side-panel, #patientSubTabs, #informantSubTabs,
  .no-print, .btn, .dropdown, #storageModeBadge {
    display: none !important;
  }
  .report-full {
    max-width: 100%;
    font-size: 11pt;
  }
  .report-full h4 {
    page-break-after: avoid;
  }
  .chart-container {
    max-width: 400px;
    page-break-inside: avoid;
  }
  @page {
    size: A4;
    margin: 15mm;
  }
  body {
    font-family: "Segoe UI", Arial, sans-serif;
  }
  .report-full .report-footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    font-size: 8pt;
    color: #999;
    border-top: 1px solid #ccc;
    padding-top: 4px;
  }
}

/* ── MBI-C unified table ── */
.mbic-unified-table .mbic-domain-header td {
  background: #e8edf3;
  padding: 10px 12px;
  font-size: 0.88rem;
  border: 1px solid #dee2e6;
  border-top: 2px solid #0d6efd;
}
.mbic-unified-table td.cg-label {
  font-size: 0.84rem;
  line-height: 1.4;
  min-width: 350px;
  padding: 8px 12px;
}
.mbic-unified-table td.cg-cell {
  font-size: 0.88rem;
  min-width: 60px;
  padding: 8px 4px;
}

/* ── NPI-Q unified inline table ── */
.npiq-unified-table {
  border-collapse: collapse;
}
.npiq-unified-table .npiq-group-header {
  background: #e8edf3;
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
  border-left: 2px solid #c0cfe0;
  padding: 6px 4px;
}
.npiq-unified-table .npiq-sub-header th {
  font-size: 0.75rem;
  font-weight: 600;
  padding: 4px 2px;
  background: #f0f2f5;
}
.npiq-unified-table .npiq-num-header {
  text-align: center;
  min-width: 36px;
}
.npiq-unified-table .npiq-label-cell {
  font-size: 0.84rem;
  min-width: 200px;
  max-width: 300px;
  line-height: 1.35;
  padding: 8px 10px;
}
.npiq-unified-table .npiq-item-desc {
  font-size: 0.74rem;
  color: #6c757d;
  line-height: 1.3;
  margin-top: 2px;
}
.npiq-unified-table .npiq-yn-cell {
  font-size: 0.78rem;
  font-weight: 600;
  min-width: 40px;
  padding: 6px 4px;
}
.npiq-unified-table .npiq-yes-selected {
  background: #198754 !important;
  color: #fff !important;
}
.npiq-unified-table .npiq-no-selected {
  background: #6c757d !important;
  color: #fff !important;
}
.npiq-unified-table .npiq-rating-cell {
  font-size: 0.82rem;
  min-width: 36px;
  padding: 6px 3px;
}
.npiq-unified-table .npiq-rating-cell.npiq-disabled {
  background: #f0f0f0;
  color: #ccc;
  cursor: default;
  pointer-events: none;
}
.npiq-unified-table .npiq-rating-cell.npiq-disabled:hover {
  background: #f0f0f0;
}
/* Severity column left border */
.npiq-unified-table td.npiq-rating-cell[data-type="severity"]:first-of-type,
.npiq-unified-table tbody td:nth-child(4) {
  border-left: 2px solid #c0cfe0;
}
/* Distress column left border */
.npiq-unified-table tbody td:nth-child(7) {
  border-left: 2px solid #c0cfe0;
}

/* ── CDR Worksheet Tables (Assessment tab) ── */
.cdr-worksheet-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 0.75rem;
  font-size: 0.84rem;
}
.cdr-worksheet-table th {
  background: #e8edf3;
  text-align: center;
  padding: 6px 8px;
  border: 1px solid #dee2e6;
  font-size: 0.78rem;
  font-weight: 700;
  vertical-align: middle;
}
.cdr-worksheet-table th:first-child {
  text-align: left;
  min-width: 45%;
}
.cdr-worksheet-table td {
  border: 1px solid #dee2e6;
  padding: 6px 8px;
  vertical-align: middle;
}
.cdr-worksheet-table td:first-child {
  text-align: left;
  font-size: 0.84rem;
  line-height: 1.35;
}
.cdr-worksheet-table td:not(:first-child) {
  text-align: center;
  width: 12%;
  min-width: 70px;
}
.cdr-worksheet-table .cdr-ws-btn {
  width: 100%;
  border: none;
  background: transparent;
  padding: 4px 2px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 0.78rem;
  transition: background-color 0.12s;
}
.cdr-worksheet-table .cdr-ws-btn:hover {
  background-color: #e2e6ea;
}
.cdr-worksheet-table .cdr-ws-btn.active {
  background-color: #0d6efd;
  color: #fff;
  font-weight: 600;
}
.cdr-ws-section {
  margin-top: 1.25rem;
  margin-bottom: 0.5rem;
}
.cdr-ws-section h6 {
  font-size: 0.92rem;
  font-weight: 700;
  color: #0d6efd;
  border-bottom: 2px solid #0d6efd;
  padding-bottom: 4px;
  margin-bottom: 0.5rem;
}
.cdr-ws-subsection {
  font-weight: 600;
  font-size: 0.82rem;
  background: #f0f4f8;
  padding: 4px 8px;
}
.cdr-ws-note-cell {
  padding: 4px 6px !important;
}
.cdr-ws-note-cell textarea,
.cdr-ws-note-cell input {
  width: 100%;
  border: 1px solid #ced4da;
  border-radius: 4px;
  padding: 3px 6px;
  font-size: 0.82rem;
}
.cdr-ws-note-cell textarea {
  resize: vertical;
  min-height: 36px;
}
/* Personal care Blessed table */
.cdr-blessed-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.82rem;
  margin-bottom: 0.5rem;
}
.cdr-blessed-table th {
  background: #e8edf3;
  text-align: center;
  padding: 5px 6px;
  border: 1px solid #dee2e6;
  font-size: 0.78rem;
  font-weight: 700;
}
.cdr-blessed-table td {
  border: 1px solid #dee2e6;
  padding: 5px 6px;
  text-align: center;
  vertical-align: middle;
}
.cdr-blessed-table td:first-child {
  text-align: left;
  font-weight: 600;
  width: 22%;
}
.cdr-blessed-table .cdr-ws-btn {
  width: 100%;
  border: none;
  background: transparent;
  padding: 3px 2px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 0.76rem;
  transition: background-color 0.12s;
}
.cdr-blessed-table .cdr-ws-btn:hover {
  background-color: #e2e6ea;
}
.cdr-blessed-table .cdr-ws-btn.active {
  background-color: #0d6efd;
  color: #fff;
  font-weight: 600;
}

/* ── CDR Assessment Table ── */
.cdr-assessment-table {
  width: 100%;
  border-collapse: collapse;
}
.cdr-assessment-table th {
  background: #e8edf3;
  text-align: center;
  padding: 8px 12px;
  border: 1px solid #dee2e6;
  font-size: 0.9rem;
  font-weight: 700;
  width: 16%;
}
.cdr-assessment-table th:first-child {
  width: 18%;
}
.cdr-domain-label {
  font-weight: 700;
  text-align: center;
  padding: 10px 12px;
  border: 1px solid #dee2e6;
  background: #f8f9fa;
  cursor: default;
  font-size: 0.85rem;
  vertical-align: middle;
}
.cdr-score-cell {
  padding: 8px 6px;
  border: 1px solid #dee2e6;
  text-align: center;
  cursor: pointer;
  vertical-align: top;
  font-size: 0.78rem;
  line-height: 1.3;
  transition: background-color 0.15s;
  min-height: 44px;
}
.cdr-score-cell:hover {
  background-color: #daf1ee;
}
.cdr-score-cell.selected {
  background-color: #daf1ee;
  font-weight: 600;
  box-shadow: inset 0 0 0 2px #0d6efd;
}
.cdr-score-cell:focus {
  outline: 2px solid #0d6efd;
  outline-offset: -2px;
}
.cdr-empty-cell {
  background: #f0f0f0;
  cursor: default;
}

/* ── Responsive ── */
@media (max-width: 768px) {
  .report-side-panel {
    width: 100%;
    min-width: 100%;
    position: fixed;
    right: 0;
    top: 110px;
    bottom: 0;
    z-index: 1040;
  }
  .report-side-panel.collapsed {
    margin-right: 0;
    transform: translateX(100%);
  }
  .main-tabs {
    overflow-x: auto;
    flex-wrap: nowrap;
  }
  .main-tabs .nav-item {
    white-space: nowrap;
  }
  .clickable-grid td.cg-label {
    min-width: 150px;
  }
}

/* ── Dictation mic button ── */
.dictation-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border: none;
  border-radius: 50%;
  background: #e9ecef;
  color: #495057;
  cursor: pointer;
  font-size: 0.88rem;
  transition: all 0.2s ease;
  vertical-align: middle;
  margin-left: 6px;
  padding: 0;
}
.dictation-btn:hover {
  background: #dee2e6;
  color: #212529;
}
.dictation-btn.recording {
  background: #dc3545;
  color: #fff;
  animation: mic-pulse 1.2s ease-in-out infinite;
}
@keyframes mic-pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0.5); }
  50%      { box-shadow: 0 0 0 6px rgba(220,53,69,0); }
}
.dictation-btn.unsupported {
  opacity: 0.3;
  cursor: not-allowed;
}

/* ── RBANS Results ── */
.rbans-results-table th {
  font-size: 0.82rem;
  font-weight: 700;
  background: #f8f9fa;
}
.rbans-results-table td {
  font-size: 0.84rem;
  vertical-align: middle;
}
.rbans-input {
  width: 100%;
  border: 1px solid #ced4da;
  border-radius: 4px;
  padding: 3px 6px;
  font-size: 0.84rem;
  text-align: center;
}
.rbans-input:focus {
  border-color: #0d6efd;
  outline: none;
  box-shadow: 0 0 0 2px rgba(13,110,253,0.15);
}
  </style>
</head>
<body>

  <!-- ═══════════════════════════════════════════════════════
       TOP NAVBAR / HEADER
       ═══════════════════════════════════════════════════════ -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <!-- Placeholder logo -->
        <span class="brand-logo-placeholder me-2">BHM</span>
        <span class="d-none d-md-inline">brainHEALTH Manchester</span>
      </a>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-warning text-dark" id="storageModeBadge">
          <i class="bi bi-exclamation-triangle me-1"></i>Local Mode — Not saved to server
        </span>
        <button class="btn btn-outline-light btn-sm" id="toggleReportPanelBtn" title="Toggle Report Panel">
          <i class="bi bi-layout-sidebar-reverse"></i> Report
        </button>
        <button class="btn btn-outline-light btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="Export">
          <i class="bi bi-download"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" id="exportJSON"><i class="bi bi-filetype-json me-2"></i>Export JSON</a></li>
          <li><a class="dropdown-item" href="#" id="exportCSV"><i class="bi bi-filetype-csv me-2"></i>Export Scores CSV</a></li>
          <li><a class="dropdown-item" href="#" id="exportAudit"><i class="bi bi-journal-text me-2"></i>Export Audit Log</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" id="printReport"><i class="bi bi-printer me-2"></i>Print Report</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ═══════════════════════════════════════════════════════
       MAIN TAB NAVIGATION
       ═══════════════════════════════════════════════════════ -->
  <div class="container-fluid px-0">
    <ul class="nav nav-tabs bg-light px-3 pt-2 main-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-session" data-bs-toggle="tab" data-bs-target="#panel-session" type="button" role="tab">
          <i class="bi bi-person-badge me-1"></i>Session
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-patient" data-bs-toggle="tab" data-bs-target="#panel-patient" type="button" role="tab">
          <i class="bi bi-journal-medical me-1"></i>Patient Booklet
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-informant" data-bs-toggle="tab" data-bs-target="#panel-informant" type="button" role="tab">
          <i class="bi bi-people me-1"></i>Informant Booklet
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-rbans" data-bs-toggle="tab" data-bs-target="#panel-rbans" type="button" role="tab">
          <i class="bi bi-calculator me-1"></i>RBANS
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-clinical" data-bs-toggle="tab" data-bs-target="#panel-clinical" type="button" role="tab">
          <i class="bi bi-clipboard2-pulse me-1"></i>Clinical Interview
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-report" data-bs-toggle="tab" data-bs-target="#panel-report" type="button" role="tab">
          <i class="bi bi-file-earmark-text me-1"></i>Report
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-audit" data-bs-toggle="tab" data-bs-target="#panel-audit" type="button" role="tab">
          <i class="bi bi-clock-history me-1"></i>Audit
        </button>
      </li>
    </ul>
  </div>

  <!-- ═══════════════════════════════════════════════════════
       MAIN CONTENT AREA  (form panels + report side-panel)
       ═══════════════════════════════════════════════════════ -->
  <div class="d-flex" id="mainLayout">

    <!-- ─── Form content (left) ─── -->
    <div class="flex-grow-1 overflow-auto" id="formArea" style="min-height:calc(100vh - 110px)">
      <div class="tab-content p-3" id="mainTabContent">

        <!-- ══════ SESSION TAB ══════ -->
        <div class="tab-pane fade show active" id="panel-session" role="tabpanel">
          <div id="sessionContent"></div>
        </div>

        <!-- ══════ PATIENT BOOKLET TAB ══════ -->
        <div class="tab-pane fade" id="panel-patient" role="tabpanel">
          <ul class="nav nav-pills mb-3" id="patientSubTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#sub-psqi" type="button" role="tab">PSQI</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-epworth" type="button" role="tab">Epworth</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-gad7" type="button" role="tab">GAD-7</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-depression" type="button" role="tab">Depression</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-diet" type="button" role="tab">Diet</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-audit-tool" type="button" role="tab">AUDIT</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-casp19" type="button" role="tab">CASP-19</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-hearing" type="button" role="tab">Hearing</button>
            </li>
          </ul>
          <div class="tab-content" id="patientSubContent">
            <div class="tab-pane fade show active" id="sub-psqi" role="tabpanel"><div id="psqiContent"></div></div>
            <div class="tab-pane fade" id="sub-epworth" role="tabpanel"><div id="epworthContent"></div></div>
            <div class="tab-pane fade" id="sub-gad7" role="tabpanel"><div id="gad7Content"></div></div>
            <div class="tab-pane fade" id="sub-depression" role="tabpanel"><div id="depressionContent"></div></div>
            <div class="tab-pane fade" id="sub-diet" role="tabpanel"><div id="dietContent"></div></div>
            <div class="tab-pane fade" id="sub-audit-tool" role="tabpanel"><div id="auditToolContent"></div></div>
            <div class="tab-pane fade" id="sub-casp19" role="tabpanel"><div id="casp19Content"></div></div>
            <div class="tab-pane fade" id="sub-hearing" role="tabpanel"><div id="hearingContent"></div></div>
          </div>
        </div>

        <!-- ══════ INFORMANT BOOKLET TAB ══════ -->
        <div class="tab-pane fade" id="panel-informant" role="tabpanel">
          <ul class="nav nav-pills mb-3" id="informantSubTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#sub-mbic" type="button" role="tab">MBI-C</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-npiq" type="button" role="tab">NPI-Q</button>
            </li>
          </ul>
          <div class="tab-content" id="informantSubContent">
            <div class="tab-pane fade show active" id="sub-mbic" role="tabpanel"><div id="mbicContent"></div></div>
            <div class="tab-pane fade" id="sub-npiq" role="tabpanel"><div id="npiqContent"></div></div>
          </div>
        </div>

        <!-- ══════ RBANS TAB ══════ -->
        <div class="tab-pane fade" id="panel-rbans" role="tabpanel">
          <div id="rbansContent"></div>
        </div>

        <!-- ══════ CLINICAL INTERVIEW TAB ══════ -->
        <div class="tab-pane fade" id="panel-clinical" role="tabpanel">
          <ul class="nav nav-pills mb-3" id="clinicalSubTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#sub-interview" type="button" role="tab">Interview</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-cdr-assess" type="button" role="tab">CDR Assessment</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-cdr-scoring" type="button" role="tab">CDR Scoring</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sub-diamond-lewy" type="button" role="tab">DIAMOND Lewy</button>
            </li>
          </ul>
          <div class="tab-content" id="clinicalSubContent">
            <div class="tab-pane fade show active" id="sub-interview" role="tabpanel"><div id="clinicalContent"></div></div>
            <div class="tab-pane fade" id="sub-cdr-assess" role="tabpanel"><div id="cdrAssessContent"></div></div>
            <div class="tab-pane fade" id="sub-cdr-scoring" role="tabpanel"><div id="cdrScoringContent"></div></div>
            <div class="tab-pane fade" id="sub-diamond-lewy" role="tabpanel"><div id="diamondLewyContent"></div></div>
          </div>
        </div>

        <!-- ══════ REPORT TAB ══════ -->
        <div class="tab-pane fade" id="panel-report" role="tabpanel">
          <div id="reportFullContent"></div>
        </div>

        <!-- ══════ AUDIT TAB ══════ -->
        <div class="tab-pane fade" id="panel-audit" role="tabpanel">
          <div id="auditContent"></div>
        </div>

      </div>
    </div>

    <!-- ─── Report side panel (right, toggleable) ─── -->
    <div class="report-side-panel border-start bg-white shadow-sm" id="reportSidePanel">
      <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0"><i class="bi bi-file-earmark-text me-1"></i>Live Report Preview</h6>
          <button class="btn btn-sm btn-outline-secondary" id="closeSidePanel">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div id="reportSidePanelBody" class="report-preview-body">
          <p class="text-muted fst-italic">Complete form fields to generate the report...</p>
        </div>
      </div>
    </div>

  </div>

  <!-- ═══════════════════════════════════════════════════════
       SCRIPTS
       ═══════════════════════════════════════════════════════ -->
  <!-- Bootstrap JS Bundle from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

  <!-- App modules (load order matters) -->
  <script>

/* ── state.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.State — Centralised State Store & Audit Log
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};

BHM.State = (function () {
  'use strict';

  var STORAGE_KEY = 'bhm_assessment_session';
  var VERSION = '1.0.0';

  // ── Default session structure ──
  function createEmptySession() {
    return {
      version: VERSION,
      meta: {
        created: new Date().toISOString(),
        lastEdited: new Date().toISOString(),
        operator: '',
        sourceMode: 'transcribed'  // 'transcribed' | 'live'
      },
      patient: {
        name: '',
        dob: '',
        nhsNumber: '',
        dateOfCompletion: '',
        clinicianName: '',
        informantName: '',
        informantRelationship: ''
      },
      instruments: {
        psqi: {},
        epworth: {},
        gad7: {},
        depression: {},
        diet: {},
        auditTool: {},
        casp19: {},
        hearing: {},
        mbiC: {},
        npiQ: {},
        rbans: {},
        cdr: {},
        diamondLewy: {},
        clinical: {}
      },
      scores: {},
      clinicianInserts: {
        overallSummary: '',
        agreedToday: '',
        safetyFollowUp: ''
      },
      auditLog: []
    };
  }

  var _session = createEmptySession();
  var _listeners = [];

  // ── Persistence ──
  function save() {
    try {
      _session.meta.lastEdited = new Date().toISOString();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(_session));
    } catch (e) {
      console.warn('BHM: localStorage save failed', e);
    }
  }

  function load() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        var parsed = JSON.parse(raw);
        // Merge into default to handle missing keys on upgrade
        _session = deepMerge(createEmptySession(), parsed);
        return true;
      }
    } catch (e) {
      console.warn('BHM: localStorage load failed', e);
    }
    return false;
  }

  function clearSession() {
    _session = createEmptySession();
    save();
    notifyAll();
  }

  // ── Deep merge utility ──
  function deepMerge(target, source) {
    var result = Object.assign({}, target);
    for (var key in source) {
      if (source.hasOwnProperty(key)) {
        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])
            && target[key] && typeof target[key] === 'object' && !Array.isArray(target[key])) {
          result[key] = deepMerge(target[key], source[key]);
        } else {
          result[key] = source[key];
        }
      }
    }
    return result;
  }

  // ── Getters ──
  function getSession() { return _session; }

  function get(path) {
    var parts = path.split('.');
    var obj = _session;
    for (var i = 0; i < parts.length; i++) {
      if (obj == null) return undefined;
      obj = obj[parts[i]];
    }
    return obj;
  }

  // ── Setters (with audit) ──
  function set(path, value, source) {
    var parts = path.split('.');
    var obj = _session;
    for (var i = 0; i < parts.length - 1; i++) {
      if (obj[parts[i]] == null) obj[parts[i]] = {};
      obj = obj[parts[i]];
    }
    var lastKey = parts[parts.length - 1];
    var oldValue = obj[lastKey];

    // Don't log if no actual change
    if (oldValue === value) return;

    obj[lastKey] = value;

    // Audit log entry
    _session.auditLog.push({
      timestamp: new Date().toISOString(),
      field: path,
      oldValue: oldValue === undefined ? null : oldValue,
      newValue: value,
      operator: _session.meta.operator || 'unknown',
      sourceMode: _session.meta.sourceMode
    });

    save();
    notifyAll(path);
  }

  // ── Batch set (no per-field notification, single notify at end) ──
  function setBatch(updates) {
    for (var i = 0; i < updates.length; i++) {
      var u = updates[i];
      var parts = u.path.split('.');
      var obj = _session;
      for (var j = 0; j < parts.length - 1; j++) {
        if (obj[parts[j]] == null) obj[parts[j]] = {};
        obj = obj[parts[j]];
      }
      var lastKey = parts[parts.length - 1];
      var oldValue = obj[lastKey];
      if (oldValue !== u.value) {
        obj[lastKey] = u.value;
        _session.auditLog.push({
          timestamp: new Date().toISOString(),
          field: u.path,
          oldValue: oldValue === undefined ? null : oldValue,
          newValue: u.value,
          operator: _session.meta.operator || 'unknown',
          sourceMode: _session.meta.sourceMode
        });
      }
    }
    save();
    notifyAll();
  }

  // ── Computed scores cache ──
  function setScore(instrumentKey, scoreObj) {
    _session.scores[instrumentKey] = scoreObj;
    save();
  }
  function getScore(instrumentKey) {
    return _session.scores[instrumentKey] || null;
  }

  // ── Listeners (reactive updates) ──
  function subscribe(fn) {
    _listeners.push(fn);
    return function unsubscribe() {
      _listeners = _listeners.filter(function (l) { return l !== fn; });
    };
  }

  function notifyAll(changedPath) {
    for (var i = 0; i < _listeners.length; i++) {
      try {
        _listeners[i](changedPath);
      } catch (e) {
        console.error('BHM: listener error', e);
      }
    }
  }

  // ── Public API ──
  return {
    VERSION: VERSION,
    createEmptySession: createEmptySession,
    getSession: getSession,
    get: get,
    set: set,
    setBatch: setBatch,
    setScore: setScore,
    getScore: getScore,
    subscribe: subscribe,
    save: save,
    load: load,
    clearSession: clearSession
  };
})();

/* ── clickableGrid.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.ClickableGrid — Reusable radio-table grid component
   ═══════════════════════════════════════════════════════
   Renders a table where each row is a question and columns
   are response options. Clicking a cell selects that option.
   Supports keyboard navigation (arrow keys, Enter/Space).
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};

BHM.ClickableGrid = (function () {
  'use strict';

  /**
   * Create a clickable grid table.
   * @param {Object} config
   * @param {string}   config.id          - Unique ID for the grid
   * @param {string}   config.statePath   - Base state path (e.g. 'instruments.gad7')
   * @param {string[]} config.columns     - Column header labels
   * @param {(number|string)[]} config.values - Value for each column
   * @param {Object[]} config.rows        - Array of { key, label, sublabel? }
   * @param {Function} [config.onChange]   - Called after value change (key, value)
   * @returns {HTMLElement} The table element
   */
  function create(config) {
    var table = document.createElement('table');
    table.className = 'clickable-grid';
    table.id = config.id;
    table.setAttribute('role', 'grid');

    // ── Header ──
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    var th0 = document.createElement('th');
    th0.textContent = '';
    th0.style.minWidth = '200px';
    headerRow.appendChild(th0);
    for (var c = 0; c < config.columns.length; c++) {
      var th = document.createElement('th');
      th.textContent = config.columns[c];
      th.scope = 'col';
      headerRow.appendChild(th);
    }
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // ── Body ──
    var tbody = document.createElement('tbody');
    for (var r = 0; r < config.rows.length; r++) {
      var row = config.rows[r];
      var tr = document.createElement('tr');
      tr.setAttribute('role', 'row');

      // Label cell
      var tdLabel = document.createElement('td');
      tdLabel.className = 'cg-label';
      tdLabel.innerHTML = row.label + (row.sublabel ? '<br><small class="text-muted">' + row.sublabel + '</small>' : '');
      tr.appendChild(tdLabel);

      // Option cells
      for (var ci = 0; ci < config.values.length; ci++) {
        var td = document.createElement('td');
        td.className = 'cg-cell';
        td.setAttribute('role', 'gridcell');
        td.setAttribute('tabindex', (r === 0 && ci === 0) ? '0' : '-1');
        td.dataset.row = row.key;
        td.dataset.col = ci;
        td.dataset.value = config.values[ci];
        td.textContent = config.columns[ci];

        // Restore from state
        var currentVal = BHM.State.get(config.statePath + '.' + row.key);
        if (currentVal !== undefined && String(currentVal) === String(config.values[ci])) {
          td.classList.add('selected');
        }

        td.addEventListener('click', cellClickHandler(config, row.key, config.values[ci], tr));
        td.addEventListener('keydown', cellKeyHandler(config));

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }
    table.appendChild(tbody);

    return table;
  }

  function cellClickHandler(config, rowKey, value, tr) {
    return function () {
      // Deselect siblings in same row
      var cells = tr.querySelectorAll('.cg-cell');
      for (var i = 0; i < cells.length; i++) cells[i].classList.remove('selected');
      this.classList.add('selected');
      this.focus();

      BHM.State.set(config.statePath + '.' + rowKey, value);
      if (config.onChange) config.onChange(rowKey, value);
    };
  }

  function cellKeyHandler(config) {
    return function (e) {
      var td = e.target;
      var table = td.closest('table');
      var row = parseInt(td.dataset.col, 10);
      var allRows = table.querySelectorAll('tbody tr');
      var parentTr = td.closest('tr');
      var rowIdx = Array.prototype.indexOf.call(allRows, parentTr);
      var cells = parentTr.querySelectorAll('.cg-cell');
      var colIdx = Array.prototype.indexOf.call(cells, td);
      var target = null;

      switch (e.key) {
        case 'ArrowRight':
          if (colIdx < cells.length - 1) target = cells[colIdx + 1];
          break;
        case 'ArrowLeft':
          if (colIdx > 0) target = cells[colIdx - 1];
          break;
        case 'ArrowDown':
          if (rowIdx < allRows.length - 1) {
            var nextCells = allRows[rowIdx + 1].querySelectorAll('.cg-cell');
            if (nextCells[colIdx]) target = nextCells[colIdx];
          }
          break;
        case 'ArrowUp':
          if (rowIdx > 0) {
            var prevCells = allRows[rowIdx - 1].querySelectorAll('.cg-cell');
            if (prevCells[colIdx]) target = prevCells[colIdx];
          }
          break;
        case 'Enter':
        case ' ':
          e.preventDefault();
          td.click();
          return;
      }

      if (target) {
        e.preventDefault();
        td.setAttribute('tabindex', '-1');
        target.setAttribute('tabindex', '0');
        target.focus();
      }
    };
  }

  /**
   * Create a Yes/No toggle pair.
   * @param {Object} config
   * @param {string} config.statePath - Full state path
   * @param {string} [config.yesLabel='Yes']
   * @param {string} [config.noLabel='No']
   * @param {Function} [config.onChange]
   * @returns {HTMLElement}
   */
  function createYesNo(config) {
    var group = document.createElement('div');
    group.className = 'yn-group';

    var yesBtn = document.createElement('button');
    yesBtn.type = 'button';
    yesBtn.className = 'yn-btn';
    yesBtn.textContent = config.yesLabel || 'Yes';
    yesBtn.dataset.value = 'yes';

    var noBtn = document.createElement('button');
    noBtn.type = 'button';
    noBtn.className = 'yn-btn';
    noBtn.textContent = config.noLabel || 'No';
    noBtn.dataset.value = 'no';

    // Restore state
    var current = BHM.State.get(config.statePath);
    if (current === 'yes' || current === true) yesBtn.classList.add('selected-yes');
    if (current === 'no' || current === false) noBtn.classList.add('selected-no');

    yesBtn.addEventListener('click', function () {
      noBtn.classList.remove('selected-no');
      yesBtn.classList.add('selected-yes');
      BHM.State.set(config.statePath, 'yes');
      if (config.onChange) config.onChange('yes');
    });
    noBtn.addEventListener('click', function () {
      yesBtn.classList.remove('selected-yes');
      noBtn.classList.add('selected-no');
      BHM.State.set(config.statePath, 'no');
      if (config.onChange) config.onChange('no');
    });

    group.appendChild(yesBtn);
    group.appendChild(noBtn);
    return group;
  }

  /**
   * Helper: create a labelled text/number input bound to state.
   */
  function createField(config) {
    var div = document.createElement('div');
    div.className = 'bhm-field-group';
    if (config.colClass) div.classList.add(config.colClass);

    var label = document.createElement('label');
    label.textContent = config.label;
    label.htmlFor = config.id || config.statePath;
    div.appendChild(label);

    var input;
    if (config.type === 'textarea') {
      input = document.createElement('textarea');
      input.rows = config.rows || 3;
    } else if (config.type === 'select') {
      input = document.createElement('select');
      input.className = 'form-select';
      if (config.options) {
        var blank = document.createElement('option');
        blank.value = '';
        blank.textContent = config.placeholder || '-- Select --';
        input.appendChild(blank);
        for (var i = 0; i < config.options.length; i++) {
          var opt = document.createElement('option');
          opt.value = config.options[i].value !== undefined ? config.options[i].value : config.options[i];
          opt.textContent = config.options[i].label || config.options[i];
          input.appendChild(opt);
        }
      }
    } else {
      input = document.createElement('input');
      input.type = config.type || 'text';
      if (config.min !== undefined) input.min = config.min;
      if (config.max !== undefined) input.max = config.max;
      if (config.step !== undefined) input.step = config.step;
    }

    if (input.tagName !== 'SELECT') input.className = 'form-control';
    input.id = config.id || config.statePath;
    if (config.placeholder) input.placeholder = config.placeholder;

    // Restore state
    var current = BHM.State.get(config.statePath);
    if (current !== undefined && current !== null) input.value = current;

    input.addEventListener('change', function () {
      BHM.State.set(config.statePath, this.value);
      if (config.onChange) config.onChange(this.value);
    });
    if (config.type !== 'select') {
      input.addEventListener('input', function () {
        BHM.State.set(config.statePath, this.value);
        if (config.onChange) config.onChange(this.value);
      });
    }

    div.appendChild(input);

    if (config.helpText) {
      var help = document.createElement('div');
      help.className = 'form-text';
      help.textContent = config.helpText;
      div.appendChild(help);
    }

    return div;
  }

  /**
   * Helper: compute completeness for a grid.
   * @param {string} statePath - Base path
   * @param {string[]} keys - Expected row keys
   * @returns {{ completed: number, total: number, pct: number }}
   */
  function completeness(statePath, keys) {
    var completed = 0;
    for (var i = 0; i < keys.length; i++) {
      var val = BHM.State.get(statePath + '.' + keys[i]);
      if (val !== undefined && val !== null && val !== '') completed++;
    }
    return {
      completed: completed,
      total: keys.length,
      pct: keys.length > 0 ? Math.round((completed / keys.length) * 100) : 0
    };
  }

  /**
   * Helper: render a completeness bar element.
   */
  function completenessBar(statePath, keys) {
    var c = completeness(statePath, keys);
    var wrapper = document.createElement('div');

    var text = document.createElement('div');
    text.className = 'completeness-text';
    text.textContent = c.completed + ' of ' + c.total + ' completed (' + c.pct + '%)';

    var bar = document.createElement('div');
    bar.className = 'completeness-bar';
    var fill = document.createElement('div');
    fill.className = 'fill';
    fill.style.width = c.pct + '%';
    bar.appendChild(fill);

    wrapper.appendChild(text);
    wrapper.appendChild(bar);
    wrapper.dataset.statePath = statePath;
    wrapper.dataset.keys = keys.join(',');
    wrapper.className = 'mb-2';
    return wrapper;
  }

  return {
    create: create,
    createYesNo: createYesNo,
    createField: createField,
    completeness: completeness,
    completenessBar: completenessBar
  };
})();

/* ── session.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.Session — Session & Patient Identifiers
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.Session = (function () {
  'use strict';
  var F = BHM.ClickableGrid;  // shorthand for field helpers

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    card.innerHTML =
      '<h5>Assessment Session</h5>' +
      '<p class="instrument-subtitle">Enter session identifiers and context before transcribing booklet responses.</p>';

    // ── Session metadata ──
    var metaSection = document.createElement('div');
    metaSection.innerHTML = '<h6 class="mt-3 mb-3"><i class="bi bi-gear me-1"></i>Session Metadata</h6>';

    var metaRow = document.createElement('div');
    metaRow.className = 'row g-3';

    metaRow.appendChild(wrapCol(F.createField({
      label: 'Operator Name / Initials',
      statePath: 'meta.operator',
      placeholder: 'e.g. JD'
    }), 'col-md-4'));

    metaRow.appendChild(wrapCol(F.createField({
      label: 'Date of Completion',
      statePath: 'patient.dateOfCompletion',
      type: 'date'
    }), 'col-md-4'));

    var modeDiv = document.createElement('div');
    modeDiv.className = 'col-md-4 bhm-field-group';
    var modeLabel = document.createElement('label');
    modeLabel.textContent = 'Entry Mode';
    modeDiv.appendChild(modeLabel);
    var modeSelect = F.createField({
      label: '',
      statePath: 'meta.sourceMode',
      type: 'select',
      options: [
        { value: 'transcribed', label: 'Transcribed from paper' },
        { value: 'live', label: 'Completed live on screen' }
      ]
    });
    metaRow.appendChild(wrapCol(modeSelect, 'col-md-4'));

    metaSection.appendChild(metaRow);
    card.appendChild(metaSection);

    // ── Patient identifiers ──
    var patientSection = document.createElement('div');
    patientSection.innerHTML = '<h6 class="mt-4 mb-3"><i class="bi bi-person me-1"></i>Patient Identifiers</h6>';

    var patRow = document.createElement('div');
    patRow.className = 'row g-3';

    patRow.appendChild(wrapCol(F.createField({
      label: 'Patient Name',
      statePath: 'patient.name',
      placeholder: 'As shown on booklet'
    }), 'col-md-4'));

    patRow.appendChild(wrapCol(F.createField({
      label: 'Date of Birth',
      statePath: 'patient.dob',
      type: 'date'
    }), 'col-md-4'));

    patRow.appendChild(wrapCol(F.createField({
      label: 'NHS Number',
      statePath: 'patient.nhsNumber',
      placeholder: 'Optional',
      helpText: 'Optional — for clinical linking'
    }), 'col-md-4'));

    patientSection.appendChild(patRow);
    card.appendChild(patientSection);

    // ── Clinician / Informant ──
    var clinSection = document.createElement('div');
    clinSection.innerHTML = '<h6 class="mt-4 mb-3"><i class="bi bi-clipboard2-pulse me-1"></i>Clinician & Informant</h6>';

    var clinRow = document.createElement('div');
    clinRow.className = 'row g-3';

    clinRow.appendChild(wrapCol(F.createField({
      label: 'Clinician Name',
      statePath: 'patient.clinicianName',
      placeholder: 'Assessing clinician'
    }), 'col-md-4'));

    clinRow.appendChild(wrapCol(F.createField({
      label: 'Informant Name',
      statePath: 'patient.informantName',
      placeholder: 'Friend or relative'
    }), 'col-md-4'));

    clinRow.appendChild(wrapCol(F.createField({
      label: 'Informant Relationship',
      statePath: 'patient.informantRelationship',
      type: 'select',
      options: [
        'Spouse / Partner', 'Son / Daughter', 'Sibling',
        'Friend', 'Carer', 'Other'
      ]
    }), 'col-md-4'));

    clinSection.appendChild(clinRow);
    card.appendChild(clinSection);

    // ── Session actions ──
    var actionsDiv = document.createElement('div');
    actionsDiv.className = 'mt-4 pt-3 border-top d-flex gap-2';
    var newBtn = document.createElement('button');
    newBtn.className = 'btn btn-outline-danger btn-sm';
    newBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i>New Session (clear all)';
    newBtn.addEventListener('click', function () {
      if (confirm('This will clear all data and start a new session. Are you sure?')) {
        BHM.State.clearSession();
        BHM.App.renderAll();
      }
    });
    actionsDiv.appendChild(newBtn);
    card.appendChild(actionsDiv);

    container.appendChild(card);
  }

  function wrapCol(el, colClass) {
    var col = document.createElement('div');
    col.className = colClass;
    col.appendChild(el);
    return col;
  }

  return { render: render };
})();

/* ── psqi.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.PSQI — Pittsburgh Sleep Quality Index
   ═══════════════════════════════════════════════════════
   Layout mirrors the paper booklet exactly:
   - Q1-4 as free-text fields
   - Q5a-j, Q6, Q7 in ONE unified frequency table
   - Q8 separate (problem scale)
   - Q9 separate (quality scale)
   - Q10 separate (partner status)
   - Partner items in own frequency table
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.PSQI = (function () {
  'use strict';

  var SP = 'instruments.psqi';
  var F = BHM.ClickableGrid;

  // Frequency columns — exact wording from booklet
  var FREQ_COLS = [
    'Not during the past month',
    'Less than once a week',
    'Once or twice a week',
    'Three or more times a week'
  ];
  var FREQ_VALS = [0, 1, 2, 3];

  // Q5 items + Q6 + Q7 — all share the same frequency table in the booklet
  var FREQ_TABLE_ROWS = [
    { key: 'q5a', label: 'a. Cannot get to sleep within 30 minutes', isSubItem: true },
    { key: 'q5b', label: 'b. Wake up in the middle of the night or early morning', isSubItem: true },
    { key: 'q5c', label: 'c. Have to get up to use the bathroom', isSubItem: true },
    { key: 'q5d', label: 'd. Cannot breathe comfortably', isSubItem: true },
    { key: 'q5e', label: 'e. Cough or snore loudly', isSubItem: true },
    { key: 'q5f', label: 'f. Feel too cold', isSubItem: true },
    { key: 'q5g', label: 'g. Feel too hot', isSubItem: true },
    { key: 'q5h', label: 'h. Have bad dreams', isSubItem: true },
    { key: 'q5i', label: 'i. Have pain', isSubItem: true },
    { key: 'q5j', label: 'j. Other reason(s), please describe:', isSubItem: true },
    { key: 'q6_medication', label: '6. During the past month, how often have you taken medicine to help you sleep (prescribed or \u201cover the counter\u201d)?', isSubItem: false },
    { key: 'q7_drowsiness', label: '7. During the past month, how often have you had trouble staying awake while driving, eating meals, or engaging in social activity?', isSubItem: false }
  ];

  // Partner-reported items — exact wording from booklet
  var PARTNER_ITEMS = [
    { key: 'q10a', label: 'a. Loud snoring' },
    { key: 'q10b', label: 'b. Long pauses between breaths while asleep' },
    { key: 'q10c', label: 'c. Legs twitching or jerking while you sleep' },
    { key: 'q10d', label: 'd. Episodes of disorientation or confusion during sleep' },
    { key: 'q10e', label: 'e. Other restlessness while you sleep, please describe:' }
  ];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // ── Title & instructions — exact booklet wording ──
    card.innerHTML =
      '<h5>Pittsburgh Sleep Quality Index (PSQI)</h5>' +
      '<p class="instrument-subtitle">' +
        '<strong>Instructions:</strong> The following questions relate to your usual sleep habits during the past month only. ' +
        'Your answers should indicate the most accurate reply for the majority of days and nights in the past month. ' +
        'Please answer all questions.' +
      '</p>';

    // Score summary
    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.id = 'psqi-score-summary';
    summary.innerHTML = '<span class="score-label">Global PSQI Score:</span>' +
      '<span class="score-value" id="psqi-total">--</span>' +
      '<span class="score-interp" id="psqi-interp">Complete all required items to calculate</span>';
    card.appendChild(summary);

    // ── Q1: Bedtime ──
    var q1 = document.createElement('div');
    q1.className = 'row g-3 mb-3';
    q1.appendChild(wrapCol(F.createField({
      label: '1. During the past month, what time have you usually gone to bed at night?',
      statePath: SP + '.q1_bedtime',
      placeholder: 'e.g. 22:30 or 10:30pm',
      helpText: 'Usual bedtime',
      onChange: recalc
    }), 'col-md-6'));
    card.appendChild(q1);

    // ── Q2: Sleep latency ──
    var q2 = document.createElement('div');
    q2.className = 'row g-3 mb-3';
    q2.appendChild(wrapCol(F.createField({
      label: '2. During the past month, how long (in minutes) has it usually taken you to fall asleep each night?',
      statePath: SP + '.q2_latency_min',
      placeholder: 'Minutes (e.g. 20 or 15-30)',
      helpText: 'If a range, the midpoint will be used for scoring',
      onChange: recalc
    }), 'col-md-6'));
    card.appendChild(q2);

    // ── Q3: Wake time ──
    var q3 = document.createElement('div');
    q3.className = 'row g-3 mb-3';
    q3.appendChild(wrapCol(F.createField({
      label: '3. During the past month, what time have you usually gotten up in the morning?',
      statePath: SP + '.q3_waketime',
      placeholder: 'e.g. 07:00 or 7am',
      onChange: recalc
    }), 'col-md-6'));
    card.appendChild(q3);

    // ── Q4: Hours of sleep — exact wording: "different than" ──
    var q4 = document.createElement('div');
    q4.className = 'row g-3 mb-3';
    q4.appendChild(wrapCol(F.createField({
      label: '4. During the past month, how many hours of actual sleep did you get at night? (This may be different than the number of hours you spent in bed.)',
      statePath: SP + '.q4_sleep_hours',
      type: 'number',
      min: 0,
      max: 24,
      step: 0.5,
      placeholder: 'Hours',
      onChange: recalc
    }), 'col-md-6'));
    card.appendChild(q4);

    // ── Q5 intro + unified frequency table (Q5a-j, Q6, Q7) ──
    // This mirrors the paper form: one table with shared frequency columns
    var q5Header = document.createElement('div');
    q5Header.className = 'mb-2 mt-3';
    q5Header.innerHTML = '<strong>5. During the past month, how often have you had trouble sleeping because you\u2026</strong>';
    card.appendChild(q5Header);

    var freqGrid = F.create({
      id: 'psqi-freq-grid',
      statePath: SP,
      columns: FREQ_COLS,
      values: FREQ_VALS,
      rows: FREQ_TABLE_ROWS,
      onChange: recalc
    });
    card.appendChild(freqGrid);

    // Q5j other reason text
    var q5jText = F.createField({
      label: '',
      statePath: SP + '.q5j_text',
      type: 'textarea',
      rows: 2,
      placeholder: 'Describe other reason(s) for sleep trouble'
    });
    q5jText.classList.add('mt-2');
    card.appendChild(q5jText);

    // ── Q8: Enthusiasm problem — own column headers ──
    var q8Header = document.createElement('div');
    q8Header.className = 'mb-2 mt-4';
    q8Header.innerHTML = '<strong>8. During the past month, how much of a problem has it been for you to keep up enough enthusiasm to get things done?</strong>';
    card.appendChild(q8Header);
    var q8Grid = F.create({
      id: 'psqi-q8-grid',
      statePath: SP,
      columns: ['No problem at all', 'Only a very slight problem', 'Somewhat of a problem', 'A very big problem'],
      values: [0, 1, 2, 3],
      rows: [{ key: 'q8_enthusiasm', label: 'Enthusiasm to get things done' }],
      onChange: recalc
    });
    card.appendChild(q8Grid);

    // ── Q9: Overall sleep quality — own column headers ──
    var q9Header = document.createElement('div');
    q9Header.className = 'mb-2 mt-4';
    q9Header.innerHTML = '<strong>9. During the past month, how would you rate your sleep quality overall?</strong>';
    card.appendChild(q9Header);
    var q9Grid = F.create({
      id: 'psqi-q9-grid',
      statePath: SP,
      columns: ['Very good', 'Fairly good', 'Fairly bad', 'Very bad'],
      values: [0, 1, 2, 3],
      rows: [{ key: 'q9_quality', label: 'Overall sleep quality' }],
      onChange: recalc
    });
    card.appendChild(q9Grid);

    // ── Page break hint (matches booklet page 2) ──
    var pageBreak = document.createElement('hr');
    pageBreak.className = 'my-4';
    card.appendChild(pageBreak);

    // ── Q10: Bed partner — exact column wording from booklet ──
    var q10Header = document.createElement('div');
    q10Header.className = 'mb-2';
    q10Header.innerHTML = '<strong>10. Do you have a bed partner or room mate?</strong>';
    card.appendChild(q10Header);
    var q10Grid = F.create({
      id: 'psqi-q10-grid',
      statePath: SP,
      columns: [
        'No bed partner or room mate',
        'Partner/room mate in other room',
        'Partner in same room but not same bed',
        'Partner in same bed'
      ],
      values: [0, 1, 2, 3],
      rows: [{ key: 'q10_partner', label: 'Bed partner or room mate' }],
      onChange: function (key, val) {
        togglePartnerSection(val);
        recalc();
      }
    });
    card.appendChild(q10Grid);

    // ── Partner-reported items (conditional) ──
    var partnerSection = document.createElement('div');
    partnerSection.className = 'conditional-section mt-3';
    partnerSection.id = 'psqi-partner-section';
    partnerSection.style.display = 'none';
    partnerSection.innerHTML =
      '<p class="text-muted mb-2">If you have a room mate or bed partner, ask him/her how often in the past month you have had:</p>';

    var partnerGrid = F.create({
      id: 'psqi-partner-grid',
      statePath: SP,
      columns: FREQ_COLS,
      values: FREQ_VALS,
      rows: PARTNER_ITEMS,
      onChange: recalc
    });
    partnerSection.appendChild(partnerGrid);

    // Partner item e describe text
    var q10eText = F.createField({
      label: '',
      statePath: SP + '.q10e_text',
      type: 'textarea',
      rows: 2,
      placeholder: 'Describe other restlessness'
    });
    q10eText.classList.add('mt-2');
    partnerSection.appendChild(q10eText);

    card.appendChild(partnerSection);

    // Restore partner section visibility
    var partnerVal = BHM.State.get(SP + '.q10_partner');
    if (partnerVal !== undefined && partnerVal > 0) {
      togglePartnerSection(partnerVal);
    }

    // ── Name / Date fields (as on booklet page) ──
    var nameDate = document.createElement('div');
    nameDate.className = 'row g-3 mt-4 pt-3 border-top';
    nameDate.appendChild(wrapCol(F.createField({
      label: 'Name:',
      statePath: 'patient.name',
      placeholder: ''
    }), 'col-md-6'));
    nameDate.appendChild(wrapCol(F.createField({
      label: 'Date:',
      statePath: 'patient.dateOfCompletion',
      type: 'date'
    }), 'col-md-6'));
    card.appendChild(nameDate);

    // Completeness
    var allKeys = ['q1_bedtime', 'q2_latency_min', 'q3_waketime', 'q4_sleep_hours',
      'q5a', 'q5b', 'q5c', 'q5d', 'q5e', 'q5f', 'q5g', 'q5h', 'q5i',
      'q6_medication', 'q7_drowsiness', 'q8_enthusiasm', 'q9_quality', 'q10_partner'];
    card.appendChild(F.completenessBar(SP, allKeys));

    container.appendChild(card);
    recalc();
  }

  function togglePartnerSection(val) {
    var sec = document.getElementById('psqi-partner-section');
    if (sec) sec.style.display = (val > 0) ? 'block' : 'none';
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.psqi) {
      BHM.Scoring.psqi();
    }
  }

  function wrapCol(el, colClass) {
    var col = document.createElement('div');
    col.className = colClass;
    col.appendChild(el);
    return col;
  }

  return { render: render };
})();

/* ── epworth.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.Epworth — Epworth Sleepiness Scale
   ═══════════════════════════════════════════════════════
   Layout mirrors the paper booklet exactly:
   - Full multi-paragraph instruction text
   - Situation table with "Chance of dozing" column
   - Scale key shown above the table
   - Total row at the bottom
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.Epworth = (function () {
  'use strict';

  var SP = 'instruments.epworth';
  var F = BHM.ClickableGrid;

  // Situation items — exact wording from booklet
  var ITEMS = [
    { key: 'e1', label: 'Sitting and reading' },
    { key: 'e2', label: 'Watching TV' },
    { key: 'e3', label: 'Sitting, inactive in a public place (e.g. a theatre or a meeting)' },
    { key: 'e4', label: 'As a passenger in a car for an hour without a break' },
    { key: 'e5', label: 'Lying down to rest in the afternoon when circumstances permit' },
    { key: 'e6', label: 'Sitting and talking to someone' },
    { key: 'e7', label: 'Sitting quietly after a lunch without alcohol' },
    { key: 'e8', label: 'In a car, while stopped for a few minutes in the traffic' }
  ];

  // Column labels — exact case from booklet scale key
  var COLS = [
    'would never doze (0)',
    'Slight chance of dozing (1)',
    'Moderate chance of dozing (2)',
    'High chance of dozing (3)'
  ];
  var VALS = [0, 1, 2, 3];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // ── Title ──
    card.innerHTML = '<h5>Epworth Sleepiness Scale</h5>';

    // ── Name / Date fields (as on booklet) ──
    var nameDate = document.createElement('div');
    nameDate.className = 'row g-3 mb-3';
    nameDate.appendChild(wrapCol(F.createField({
      label: 'Name:',
      statePath: 'patient.name',
      placeholder: ''
    }), 'col-md-6'));
    nameDate.appendChild(wrapCol(F.createField({
      label: 'Date:',
      statePath: 'patient.dateOfCompletion',
      type: 'date'
    }), 'col-md-6'));
    card.appendChild(nameDate);

    // ── Instructions — exact multi-paragraph text from booklet ──
    var instructions = document.createElement('div');
    instructions.className = 'instrument-subtitle';
    instructions.innerHTML =
      '<p>How likely are you to doze off or fall asleep in the situations described below, in contrast to feeling tired?</p>' +
      '<p>This refers to your usual way of life in recent times.</p>' +
      '<p>Even if you haven\u2019t done some of these things recently try to work out how they would have affected you.</p>' +
      '<p class="mb-2">Use the following scale to choose the most appropriate number for each situation:</p>' +
      '<div class="mb-3 ps-3" style="font-size:0.88rem; line-height:1.7;">' +
        '<strong>0</strong> = would never doze<br>' +
        '<strong>1</strong> = Slight chance of dozing<br>' +
        '<strong>2</strong> = Moderate chance of dozing<br>' +
        '<strong>3</strong> = High chance of dozing' +
      '</div>';
    card.appendChild(instructions);

    // Score summary
    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.innerHTML = '<span class="score-label">Total:</span>' +
      '<span class="score-value" id="epworth-total">--</span>' +
      '<span class="score-interp" id="epworth-interp">out of 24</span>';
    card.appendChild(summary);

    // ── Build table matching booklet: "Situation | Chance of dozing" ──
    // The booklet has a two-column layout (Situation | Chance of dozing)
    // but since we use clickable cells, we expand "Chance of dozing" into
    // the 4 scale options as clickable columns.
    var tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive';

    var table = document.createElement('table');
    table.className = 'clickable-grid epworth-table';
    table.id = 'epworth-grid';
    table.setAttribute('role', 'grid');

    // ── Header ──
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');

    var thSit = document.createElement('th');
    thSit.textContent = 'Situation';
    thSit.style.textAlign = 'left';
    thSit.style.minWidth = '280px';
    headerRow.appendChild(thSit);

    // "Chance of dozing" spans the 4 scale columns
    for (var h = 0; h < COLS.length; h++) {
      var th = document.createElement('th');
      th.textContent = COLS[h];
      th.style.minWidth = '90px';
      headerRow.appendChild(th);
    }

    thead.appendChild(headerRow);
    table.appendChild(thead);

    // ── Body rows ──
    var tbody = document.createElement('tbody');

    for (var i = 0; i < ITEMS.length; i++) {
      var item = ITEMS[i];
      var tr = document.createElement('tr');
      tr.setAttribute('role', 'row');

      var tdLabel = document.createElement('td');
      tdLabel.className = 'cg-label';
      tdLabel.textContent = item.label;
      tr.appendChild(tdLabel);

      for (var c = 0; c < VALS.length; c++) {
        var td = document.createElement('td');
        td.className = 'cg-cell';
        td.setAttribute('role', 'gridcell');
        td.setAttribute('tabindex', (i === 0 && c === 0) ? '0' : '-1');
        td.dataset.row = item.key;
        td.dataset.col = c;
        td.dataset.value = VALS[c];
        td.textContent = String(VALS[c]);

        // Restore from state
        var currentVal = BHM.State.get(SP + '.' + item.key);
        if (currentVal !== undefined && currentVal !== null &&
            String(currentVal) === String(VALS[c])) {
          td.classList.add('selected');
        }

        td.addEventListener('click', makeCellHandler(item.key, VALS[c], tr));
        td.addEventListener('keydown', makeKeyHandler());
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    // ── Total row ──
    var totalRow = document.createElement('tr');
    totalRow.className = 'epworth-total-row';
    var tdTotalLabel = document.createElement('td');
    tdTotalLabel.className = 'fw-bold text-end';
    tdTotalLabel.textContent = 'Total';
    tdTotalLabel.style.background = '#f0f4ff';
    tdTotalLabel.style.borderTop = '2px solid #0d6efd';
    totalRow.appendChild(tdTotalLabel);

    var tdTotalVal = document.createElement('td');
    tdTotalVal.colSpan = 4;
    tdTotalVal.className = 'fw-bold';
    tdTotalVal.id = 'epworth-total-row';
    tdTotalVal.style.background = '#f0f4ff';
    tdTotalVal.style.borderTop = '2px solid #0d6efd';
    tdTotalVal.style.fontSize = '1.1rem';
    tdTotalVal.style.textAlign = 'center';
    totalRow.appendChild(tdTotalVal);
    tbody.appendChild(totalRow);

    table.appendChild(tbody);
    tableWrap.appendChild(table);
    card.appendChild(tableWrap);

    // Completeness
    var keys = ITEMS.map(function (item) { return item.key; });
    card.appendChild(F.completenessBar(SP, keys));

    container.appendChild(card);
    recalc();
  }

  // ── Cell click handler ──
  function makeCellHandler(rowKey, value, tr) {
    return function () {
      var cells = tr.querySelectorAll('.cg-cell');
      for (var i = 0; i < cells.length; i++) cells[i].classList.remove('selected');
      this.classList.add('selected');
      this.focus();

      BHM.State.set(SP + '.' + rowKey, value);
      recalc();
    };
  }

  // ── Keyboard navigation ──
  function makeKeyHandler() {
    return function (e) {
      var td = e.target;
      var table = td.closest('table');
      var allRows = table.querySelectorAll('tbody tr');
      var parentTr = td.closest('tr');
      var rowIdx = Array.prototype.indexOf.call(allRows, parentTr);
      var cells = parentTr.querySelectorAll('.cg-cell');
      var colIdx = Array.prototype.indexOf.call(cells, td);
      var target = null;

      switch (e.key) {
        case 'ArrowRight':
          if (colIdx < cells.length - 1) target = cells[colIdx + 1];
          break;
        case 'ArrowLeft':
          if (colIdx > 0) target = cells[colIdx - 1];
          break;
        case 'ArrowDown':
          if (rowIdx < allRows.length - 1) {
            var nextCells = allRows[rowIdx + 1].querySelectorAll('.cg-cell');
            if (nextCells[colIdx]) target = nextCells[colIdx];
          }
          break;
        case 'ArrowUp':
          if (rowIdx > 0) {
            var prevCells = allRows[rowIdx - 1].querySelectorAll('.cg-cell');
            if (prevCells[colIdx]) target = prevCells[colIdx];
          }
          break;
        case 'Enter':
        case ' ':
          e.preventDefault();
          td.click();
          return;
      }

      if (target) {
        e.preventDefault();
        td.setAttribute('tabindex', '-1');
        target.setAttribute('tabindex', '0');
        target.focus();
      }
    };
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.epworth) BHM.Scoring.epworth();

    // Update total row
    var total = 0, answered = 0;
    for (var i = 0; i < ITEMS.length; i++) {
      var val = BHM.State.get(SP + '.' + ITEMS[i].key);
      if (val !== undefined && val !== null && val !== '') {
        total += Number(val);
        answered++;
      }
    }
    var totalCell = document.getElementById('epworth-total-row');
    if (totalCell) {
      totalCell.textContent = answered > 0 ? total : '';
    }
  }

  function wrapCol(el, colClass) {
    var col = document.createElement('div');
    col.className = colClass;
    col.appendChild(el);
    return col;
  }

  return { render: render };
})();

/* ── gad7.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.GAD7 — Anxiety (GAD-7)
   Exact wording from Pre-Assessment Booklet page 4.
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.GAD7 = (function () {
  'use strict';

  var SP = 'instruments.gad7';
  var F = BHM.ClickableGrid;

  // Items — exact wording from booklet (note commas)
  var ITEMS = [
    { key: 'g1', label: '1. Feeling nervous, anxious, or on edge' },
    { key: 'g2', label: '2. Not being able to stop or control worrying' },
    { key: 'g3', label: '3. Worrying too much about different things' },
    { key: 'g4', label: '4. Trouble relaxing' },
    { key: 'g5', label: '5. Being so restless that it is hard to sit still' },
    { key: 'g6', label: '6. Becoming easily annoyed or irritable' },
    { key: 'g7', label: '7. Feeling afraid, as if something awful might happen' }
  ];

  // Column headers — exact from booklet (no score numbers in headers)
  var COLS = ['Not at all', 'Several days', 'More than half the days', 'Nearly every day'];
  var VALS = [0, 1, 2, 3];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // Title — booklet just says "Anxiety"
    card.innerHTML =
      '<h5>Anxiety</h5>' +
      '<p style="font-size:0.85rem; color:#6c757d; margin-bottom:0.5rem;">' +
        'Column totals _____ + _____ + _____ + _____ = Total score _______' +
      '</p>';

    // Score summary
    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.innerHTML = '<span class="score-label">GAD-7 Score:</span>' +
      '<span class="score-value" id="gad7-total">--</span>' +
      '<span class="score-interp" id="gad7-interp">out of 21</span>';
    card.appendChild(summary);

    // Instruction — exact from booklet
    var instrDiv = document.createElement('div');
    instrDiv.className = 'mb-2';
    instrDiv.innerHTML = '<strong>Over the last two weeks, how often have you been bothered by the following problems?</strong>';
    card.appendChild(instrDiv);

    var grid = F.create({
      id: 'gad7-grid',
      statePath: SP,
      columns: COLS,
      values: VALS,
      rows: ITEMS,
      onChange: recalc
    });
    card.appendChild(grid);

    // Impairment question — exact wording from booklet
    var impDiv = document.createElement('div');
    impDiv.className = 'mt-3';
    impDiv.innerHTML =
      '<strong>If you checked any problems, how difficult have they made it for you to do your work, take care of things at home, or get along with other people?</strong>';
    var impGrid = F.create({
      id: 'gad7-impairment-grid',
      statePath: SP,
      columns: ['Not difficult at all', 'Somewhat difficult', 'Very difficult', 'Extremely difficult'],
      values: ['not_difficult', 'somewhat', 'very', 'extremely'],
      rows: [{ key: 'impairment', label: 'Difficulty level' }],
      onChange: recalc
    });
    impDiv.appendChild(impGrid);
    card.appendChild(impDiv);

    var keys = ITEMS.map(function (i) { return i.key; });
    card.appendChild(F.completenessBar(SP, keys));

    container.appendChild(card);
    recalc();
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.gad7) BHM.Scoring.gad7();
  }

  return { render: render };
})();

/* ── depression.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.Depression — 15-item Yes/No (GDS-15)
   Exact wording from Pre-Assessment Booklet page 5.
   ═══════════════════════════════════════════════════════
   Critical: The booklet ALTERNATES the Yes/No column order.
   For each item, the depressive answer is printed FIRST.
   Items 1,5,7,11,13: show "No Yes" (depressive answer = No)
   All others: show "Yes No" (depressive answer = Yes)
   The on-screen layout mirrors this alternation exactly.
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.Depression = (function () {
  'use strict';

  var SP = 'instruments.depression';
  var F = BHM.ClickableGrid;

  // Items — exact wording from booklet, with column order matching paper
  // firstCol/secondCol reflect the printed order on the paper form
  var ITEMS = [
    { key: 'd1',  label: '1 Are you basically satisfied with your life?',                                    firstCol: 'No',  secondCol: 'Yes', depressiveAnswer: 'no'  },
    { key: 'd2',  label: '2 Have you dropped many of your activities or interests?',                          firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd3',  label: '3 Do you feel that your life is empty?',                                            firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd4',  label: '4 Do you often feel bored?',                                                        firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd5',  label: '5 Are you in good spirits most of the time?',                                       firstCol: 'No',  secondCol: 'Yes', depressiveAnswer: 'no'  },
    { key: 'd6',  label: '6 Are you afraid that something bad is going to happen to you?',                    firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd7',  label: '7 Do you feel happy most of the time?',                                             firstCol: 'No',  secondCol: 'Yes', depressiveAnswer: 'no'  },
    { key: 'd8',  label: '8 Do you often feel helpless?',                                                     firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd9',  label: '9 Do you prefer to stay at home, rather than going out and doing new things?',      firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd10', label: '10 Do you feel you have more problems with your memory than most?',                 firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd11', label: '11 Do you think it is wonderful to be alive?',                                      firstCol: 'No',  secondCol: 'Yes', depressiveAnswer: 'no'  },
    { key: 'd12', label: '12 Do you feel pretty worthless the way you are now',                               firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd13', label: '13 Do you feel full of energy?',                                                    firstCol: 'No',  secondCol: 'Yes', depressiveAnswer: 'no'  },
    { key: 'd14', label: '14 Do you feel that your situation is hopeless?',                                   firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' },
    { key: 'd15', label: '15 Do you think that most people are better off than you are?',                     firstCol: 'Yes', secondCol: 'No',  depressiveAnswer: 'yes' }
  ];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // Title — booklet just says "Depression"
    card.innerHTML = '<h5>Depression</h5>';

    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.innerHTML = '<span class="score-label">Score:</span>' +
      '<span class="score-value" id="depression-total">--</span>' +
      '<span class="score-interp" id="depression-interp">out of 15</span>';
    card.appendChild(summary);

    // Build custom table that mirrors the paper's alternating Yes/No order
    var tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive';

    var table = document.createElement('table');
    table.className = 'clickable-grid depression-table';
    table.id = 'depression-grid';
    table.setAttribute('role', 'grid');

    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    var thQ = document.createElement('th');
    thQ.textContent = '';
    thQ.style.textAlign = 'left';
    thQ.style.minWidth = '350px';
    headerRow.appendChild(thQ);
    // Two option columns — labels vary per row, so headers are generic
    var th1 = document.createElement('th');
    th1.textContent = '';
    th1.style.minWidth = '70px';
    headerRow.appendChild(th1);
    var th2 = document.createElement('th');
    th2.textContent = '';
    th2.style.minWidth = '70px';
    headerRow.appendChild(th2);
    thead.appendChild(headerRow);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');

    for (var i = 0; i < ITEMS.length; i++) {
      var item = ITEMS[i];
      var tr = document.createElement('tr');
      tr.setAttribute('role', 'row');

      var tdLabel = document.createElement('td');
      tdLabel.className = 'cg-label';
      tdLabel.textContent = item.label;
      tr.appendChild(tdLabel);

      // First column option (matches paper print order)
      var td1 = createCell(item.key, item.firstCol.toLowerCase(), item.firstCol, i, tr);
      tr.appendChild(td1);

      // Second column option
      var td2 = createCell(item.key, item.secondCol.toLowerCase(), item.secondCol, i, tr);
      tr.appendChild(td2);

      tbody.appendChild(tr);
    }

    // Total row
    var totalRow = document.createElement('tr');
    var tdTotalLabel = document.createElement('td');
    tdTotalLabel.className = 'text-end fw-bold';
    tdTotalLabel.textContent = 'TOTAL:';
    tdTotalLabel.style.background = '#f0f4ff';
    tdTotalLabel.style.borderTop = '2px solid #0d6efd';
    totalRow.appendChild(tdTotalLabel);
    var tdTotalVal = document.createElement('td');
    tdTotalVal.colSpan = 2;
    tdTotalVal.className = 'fw-bold text-center';
    tdTotalVal.id = 'depression-total-row';
    tdTotalVal.style.background = '#f0f4ff';
    tdTotalVal.style.borderTop = '2px solid #0d6efd';
    tdTotalVal.style.fontSize = '1.1rem';
    totalRow.appendChild(tdTotalVal);
    tbody.appendChild(totalRow);

    table.appendChild(tbody);
    tableWrap.appendChild(table);
    card.appendChild(tableWrap);

    var keys = ITEMS.map(function (item) { return item.key; });
    card.appendChild(F.completenessBar(SP, keys));

    container.appendChild(card);
    recalc();
  }

  function createCell(rowKey, value, displayText, rowIdx, tr) {
    var td = document.createElement('td');
    td.className = 'cg-cell';
    td.setAttribute('role', 'gridcell');
    td.setAttribute('tabindex', '-1');
    td.dataset.row = rowKey;
    td.dataset.value = value;
    td.textContent = displayText;

    var currentVal = BHM.State.get(SP + '.' + rowKey);
    if (currentVal !== undefined && currentVal !== null && currentVal === value) {
      td.classList.add('selected');
    }

    td.addEventListener('click', function () {
      var cells = tr.querySelectorAll('.cg-cell');
      for (var i = 0; i < cells.length; i++) cells[i].classList.remove('selected');
      this.classList.add('selected');
      this.focus();
      BHM.State.set(SP + '.' + rowKey, value);
      recalc();
    });

    return td;
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.depression) BHM.Scoring.depression();

    // Update total row
    var items = getItems();
    var total = 0, answered = 0;
    for (var i = 0; i < items.length; i++) {
      var val = BHM.State.get(SP + '.' + items[i].key);
      if (val !== undefined && val !== null && val !== '') {
        answered++;
        if (val === items[i].depressiveAnswer) total++;
      }
    }
    var totalCell = document.getElementById('depression-total-row');
    if (totalCell) totalCell.textContent = answered > 0 ? total : '';
  }

  function getItems() { return ITEMS; }

  return { render: render, getItems: getItems };
})();

/* ── diet.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.Diet — MEDITERRANEAN DIET SCORE TOOL
   Exact wording from Pre-Assessment Booklet pages 5-6.
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.Diet = (function () {
  'use strict';

  var SP = 'instruments.diet';
  var F = BHM.ClickableGrid;

  // Items — exact wording from booklet (Question column)
  var ITEMS = [
    { key: 'md1',  label: '1. Is olive oil the main culinary fat used?' },
    { key: 'md2',  label: '2. Are \u2265 4 tablespoons of olive oil used each day?' },
    { key: 'md3',  label: '3. Are \u2265 2 servings (of 200g each) of vegetables eaten each day?' },
    { key: 'md4',  label: '4. Are \u2265 3 servings of fruit (of 80g each) eaten each day?' },
    { key: 'md5',  label: '5. Is < 1 serving (100-150g) of red meat/ hamburgers/ other meat products eaten each day?' },
    { key: 'md6',  label: '6. Is < 1 serving (12g) of butter, margarine or cream eaten each day?' },
    { key: 'md7',  label: '7. Is < 1 serving (330ml) of sweet or sugar sweetened carbonated beverages consumed each day?' },
    { key: 'md8',  label: '8. Are \u2265 3 glasses (of 125ml) of wine consumed each week?' },
    { key: 'md9',  label: '9. Are \u2265 3 servings (of 150g) of legumes consumed each week?' },
    { key: 'md10', label: '10. Are \u2265 3 servings of fish (100-150g) or seafood (200g) eaten each week?' },
    { key: 'md11', label: '11. Is < 3 servings of commercial sweets/pastries eaten each week?' },
    { key: 'md12', label: '12. Is \u2265 1 serving (of 30g) of nuts consumed each week?' },
    { key: 'md13', label: '13. Is chicken, turkey or rabbit routinely eaten instead of veal, pork, hamburger or sausage?' },
    { key: 'md14', label: '14. Are pasta, vegetable or rice dishes flavoured with garlic, tomato, leek or onion eaten \u2265 twice a week?' }
  ];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // Title — exact from booklet (all caps) + version line
    card.innerHTML =
      '<p style="font-size:0.75rem; color:#6c757d; margin-bottom:0.25rem;">26.09.13 Version 1 Alison Hornby, Katherine Paterson</p>' +
      '<h5 style="text-transform:uppercase; letter-spacing:0.5px;">Mediterranean Diet Score Tool</h5>';

    // Introductory paragraphs — exact from booklet
    var intro = document.createElement('div');
    intro.className = 'instrument-subtitle';
    intro.style.fontSize = '0.82rem';
    intro.innerHTML =
      '<p>A Mediterranean dietary pattern (\u2018Med diet\u2019) is typically one based on whole or minimally processed foods. ' +
      'It\u2019s rich in protective foods (fruits, vegetables, legumes, wholegrains, fish and olive oil) and low in adverse dietary ' +
      'factors (fast food, sugar-sweetened beverages, refined grain products and processed or energy-dense foods) with moderate ' +
      'red meat and alcohol intake.</p>' +
      '<p>Evidence shows overall dietary pattern (reflected in TOTAL SCORE) as well as individual components reflect risk; a higher ' +
      'score is associated with lower risk of CVD and all-cause mortality (BMJ 2008;337:a1344). During rehabilitation patient scores ' +
      'should ideally rise in response to dietary advice and support.</p>' +
      '<p>This tool can be used by health professionals with appropriate nutritional knowledge and competencies, such as Registered ' +
      'Dietitians (NICE, 2007, 2013). It can be used as both an audit tool and as part of a dietary assessment at baseline, end of ' +
      'programme and 1 year follow-up, along with assessment and advice for weight management, salt intake and eating behaviours. ' +
      'For information on complete requirements for dietary assessments and advice, please refer to the latest NICE/Joint British ' +
      'Societies guidelines (BACPR, 2012. The BACPR Standards and Core Components for Cardiovascular Disease Prevention and ' +
      'Rehabilitation, 2nd Ed.).</p>';
    card.appendChild(intro);

    // Score summary
    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.innerHTML = '<span class="score-label">TOTAL SCORE (total no. of \u2018yes\u2019 answers):</span>' +
      '<span class="score-value" id="diet-total">--</span>' +
      '<span class="score-interp" id="diet-interp">out of 14</span>';
    card.appendChild(summary);

    // Build table matching booklet: Question | Yes | No
    var grid = F.create({
      id: 'diet-grid',
      statePath: SP,
      columns: ['Yes', 'No'],
      values: ['yes', 'no'],
      rows: ITEMS.map(function (item) {
        return { key: item.key, label: item.label };
      }),
      onChange: recalc
    });
    card.appendChild(grid);

    // Total row label — exact from booklet
    var totalDiv = document.createElement('div');
    totalDiv.className = 'score-summary mt-2';
    totalDiv.innerHTML =
      '<span class="score-label">TOTAL SCORE (total no. of \u2018yes\u2019 answers):</span>' +
      '<span class="score-value" id="diet-total-bottom">--</span>';
    card.appendChild(totalDiv);

    var keys = ITEMS.map(function (i) { return i.key; });
    card.appendChild(F.completenessBar(SP, keys));

    container.appendChild(card);
    recalc();
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.diet) BHM.Scoring.diet();

    // Also update bottom total
    var total = 0, answered = 0;
    for (var i = 1; i <= 14; i++) {
      var val = BHM.State.get(SP + '.md' + i);
      if (val === 'yes') { total++; answered++; }
      else if (val === 'no') { answered++; }
    }
    var el = document.getElementById('diet-total-bottom');
    if (el) el.textContent = answered > 0 ? total : '--';
  }

  return { render: render };
})();

/* ── auditTool.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.AuditTool — AUDIT Alcohol Use Disorders
   Identification Test
   ═══════════════════════════════════════════════════════
   Layout mirrors the paper form exactly: one unified table
   with scoring columns 0–4 across the top.
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.AuditTool = (function () {
  'use strict';

  var SP = 'instruments.auditTool';
  var F = BHM.ClickableGrid;

  /* ── Question definitions matching the source booklet exactly ──
     Each item: key, label (exact booklet wording),
     options array of { text, score } for each scoring column.
     Q1-8 have 5 options (scores 0-4).
     Q9-10 have 3 options (scores 0, 2, 4). */

  var QUESTIONS = [
    {
      key: 'a1',
      label: 'How often do you have a drink containing alcohol?',
      options: [
        { text: 'Never',           score: 0 },
        { text: 'Monthly or less', score: 1 },
        { text: '2 to 4 times per month', score: 2 },
        { text: '2 to 3 times per week',  score: 3 },
        { text: '4 times or more per week', score: 4 }
      ]
    },
    {
      key: 'a2',
      label: 'How many units of alcohol do you drink on a typical day when you are drinking?',
      options: [
        { text: '0 to 2',    score: 0 },
        { text: '3 to 4',    score: 1 },
        { text: '5 to 6',    score: 2 },
        { text: '7 to 9',    score: 3 },
        { text: '10 or more', score: 4 }
      ]
    },
    {
      key: 'a3',
      label: 'How often have you had 6 or more units if female, or 8 or more if male, on a single occasion in the last year?',
      options: [
        { text: 'Never',            score: 0 },
        { text: 'Less than monthly', score: 1 },
        { text: 'Monthly',          score: 2 },
        { text: 'Weekly',           score: 3 },
        { text: 'Daily or almost daily', score: 4 }
      ]
    },
    {
      key: 'a4',
      label: 'How often during the last year have you found that you were not able to stop drinking once you had started?',
      options: [
        { text: 'Never',            score: 0 },
        { text: 'Less than monthly', score: 1 },
        { text: 'Monthly',          score: 2 },
        { text: 'Weekly',           score: 3 },
        { text: 'Daily or almost daily', score: 4 }
      ]
    },
    {
      key: 'a5',
      label: 'How often during the last year have you failed to do what was normally expected from you because of your drinking?',
      options: [
        { text: 'Never',            score: 0 },
        { text: 'Less than monthly', score: 1 },
        { text: 'Monthly',          score: 2 },
        { text: 'Weekly',           score: 3 },
        { text: 'Daily or almost daily', score: 4 }
      ]
    },
    {
      key: 'a6',
      label: 'How often during the last year have you needed an alcoholic drink in the morning to get yourself going after a heavy drinking session?',
      options: [
        { text: 'Never',            score: 0 },
        { text: 'Less than monthly', score: 1 },
        { text: 'Monthly',          score: 2 },
        { text: 'Weekly',           score: 3 },
        { text: 'Daily or almost daily', score: 4 }
      ]
    },
    {
      key: 'a7',
      label: 'How often during the last year have you had a feeling of guilt or remorse after drinking?',
      options: [
        { text: 'Never',            score: 0 },
        { text: 'Less than monthly', score: 1 },
        { text: 'Monthly',          score: 2 },
        { text: 'Weekly',           score: 3 },
        { text: 'Daily or almost daily', score: 4 }
      ]
    },
    {
      key: 'a8',
      label: 'How often during the last year have you been unable to remember what happened the night before because you had been drinking?',
      options: [
        { text: 'Never',            score: 0 },
        { text: 'Less than monthly', score: 1 },
        { text: 'Monthly',          score: 2 },
        { text: 'Weekly',           score: 3 },
        { text: 'Daily or almost daily', score: 4 }
      ]
    },
    {
      key: 'a9',
      label: 'Have you or somebody else been injured as a result of your drinking?',
      options: [
        { text: 'No',    score: 0 },
        { text: 'Yes, but not in the last year', score: 2 },
        { text: 'Yes, during the last year',     score: 4 }
      ]
    },
    {
      key: 'a10',
      label: 'Has a relative or friend, doctor or other health worker been concerned about your drinking or suggested that you cut down?',
      options: [
        { text: 'No',    score: 0 },
        { text: 'Yes, but not in the last year', score: 2 },
        { text: 'Yes, during the last year',     score: 4 }
      ]
    }
  ];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // ── Title & subtitle matching booklet exactly ──
    card.innerHTML =
      '<h5>Alcohol use disorders identification test (AUDIT)</h5>' +
      '<p class="instrument-subtitle">' +
        'AUDIT is a comprehensive 10 question alcohol harm screening tool. It was developed by the World ' +
        'Health Organisation (WHO) and modified for use in the UK and has been used in a variety of health ' +
        'and social care settings.' +
      '</p>' +
      '<p style="font-size:0.88rem; margin-bottom:1rem;">' +
        'Please circle the box that applies to you in each row:' +
      '</p>';

    // ── Score summary ──
    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.innerHTML = '<span class="score-label">AUDIT Score:</span>' +
      '<span class="score-value" id="audit-total">--</span>' +
      '<span class="score-interp" id="audit-interp">out of 40</span>';
    card.appendChild(summary);

    // ── Build one unified table matching the paper form ──
    var tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive';

    var table = document.createElement('table');
    table.className = 'clickable-grid audit-unified-table';
    table.id = 'audit-grid';
    table.setAttribute('role', 'grid');

    // ── Header row: "Questions | Scoring system 0 | 1 | 2 | 3 | 4 | Your score" ──
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');

    var thQ = document.createElement('th');
    thQ.textContent = 'Questions';
    thQ.style.minWidth = '280px';
    thQ.style.textAlign = 'left';
    headerRow.appendChild(thQ);

    var scoreHeaders = ['0', '1', '2', '3', '4'];
    for (var h = 0; h < scoreHeaders.length; h++) {
      var th = document.createElement('th');
      th.textContent = scoreHeaders[h];
      th.style.minWidth = '100px';
      headerRow.appendChild(th);
    }

    var thScore = document.createElement('th');
    thScore.textContent = 'Your score';
    thScore.style.minWidth = '70px';
    headerRow.appendChild(thScore);

    thead.appendChild(headerRow);
    table.appendChild(thead);

    // ── Body rows ──
    var tbody = document.createElement('tbody');

    for (var i = 0; i < QUESTIONS.length; i++) {
      var q = QUESTIONS[i];
      var tr = document.createElement('tr');
      tr.setAttribute('role', 'row');

      // Question label cell
      var tdLabel = document.createElement('td');
      tdLabel.className = 'cg-label';
      tdLabel.textContent = q.label;
      tr.appendChild(tdLabel);

      if (q.options.length === 5) {
        // Q1-8: five cells, one per scoring column
        for (var c = 0; c < 5; c++) {
          var td = document.createElement('td');
          td.className = 'cg-cell';
          td.setAttribute('role', 'gridcell');
          td.setAttribute('tabindex', (i === 0 && c === 0) ? '0' : '-1');
          td.dataset.row = q.key;
          td.dataset.col = c;
          td.dataset.value = q.options[c].score;
          td.textContent = q.options[c].text;

          // Restore from state
          var currentVal = BHM.State.get(SP + '.' + q.key);
          if (currentVal !== undefined && currentVal !== null &&
              String(currentVal) === String(q.options[c].score)) {
            td.classList.add('selected');
          }

          td.addEventListener('click', makeCellHandler(q.key, q.options[c].score, tr));
          td.addEventListener('keydown', makeKeyHandler());
          tr.appendChild(td);
        }
      } else {
        // Q9-10: three options spanning the 5 scoring columns
        // Option 1 (score 0): spans column "0"
        var td0 = createMergedCell(q.key, q.options[0], 1, i, tr);
        tr.appendChild(td0);

        // Empty cell for column "1"
        var tdEmpty1 = document.createElement('td');
        tdEmpty1.className = 'audit-empty-cell';
        tdEmpty1.style.background = '#f0f0f0';
        tr.appendChild(tdEmpty1);

        // Option 2 (score 2): spans column "2"
        var td2 = createMergedCell(q.key, q.options[1], 1, i, tr);
        tr.appendChild(td2);

        // Empty cell for column "3"
        var tdEmpty3 = document.createElement('td');
        tdEmpty3.className = 'audit-empty-cell';
        tdEmpty3.style.background = '#f0f0f0';
        tr.appendChild(tdEmpty3);

        // Option 3 (score 4): spans column "4"
        var td4 = createMergedCell(q.key, q.options[2], 1, i, tr);
        tr.appendChild(td4);
      }

      // "Your score" cell — shows the selected score
      var tdYourScore = document.createElement('td');
      tdYourScore.className = 'audit-your-score text-center fw-bold';
      tdYourScore.id = 'audit-row-score-' + q.key;
      tdYourScore.style.fontSize = '0.95rem';
      var rowVal = BHM.State.get(SP + '.' + q.key);
      tdYourScore.textContent = (rowVal !== undefined && rowVal !== null) ? rowVal : '';
      tr.appendChild(tdYourScore);

      tbody.appendChild(tr);
    }

    // ── Total AUDIT score row ──
    var totalRow = document.createElement('tr');
    totalRow.className = 'audit-total-row';
    var tdTotalLabel = document.createElement('td');
    tdTotalLabel.colSpan = 6;
    tdTotalLabel.className = 'text-end fw-bold';
    tdTotalLabel.style.fontSize = '0.95rem';
    tdTotalLabel.textContent = 'Total AUDIT score';
    totalRow.appendChild(tdTotalLabel);
    var tdTotalVal = document.createElement('td');
    tdTotalVal.className = 'text-center fw-bold';
    tdTotalVal.id = 'audit-total-row';
    tdTotalVal.style.fontSize = '1.1rem';
    tdTotalVal.style.background = '#f0f4ff';
    totalRow.appendChild(tdTotalVal);
    tbody.appendChild(totalRow);

    table.appendChild(tbody);
    tableWrap.appendChild(table);
    card.appendChild(tableWrap);

    // Completeness bar
    var allKeys = QUESTIONS.map(function (q) { return q.key; });
    card.appendChild(F.completenessBar(SP, allKeys));

    container.appendChild(card);
    recalc();
  }

  // ── Cell click handler ──
  function makeCellHandler(rowKey, score, tr) {
    return function () {
      // Deselect all option cells in this row
      var cells = tr.querySelectorAll('.cg-cell');
      for (var i = 0; i < cells.length; i++) cells[i].classList.remove('selected');
      this.classList.add('selected');
      this.focus();

      BHM.State.set(SP + '.' + rowKey, score);

      // Update "Your score" cell for this row
      var scoreCell = document.getElementById('audit-row-score-' + rowKey);
      if (scoreCell) scoreCell.textContent = score;

      recalc();
    };
  }

  // ── Merged cell for Q9-10 ──
  function createMergedCell(rowKey, option, colspan, rowIdx, tr) {
    var td = document.createElement('td');
    td.className = 'cg-cell';
    td.setAttribute('role', 'gridcell');
    td.setAttribute('tabindex', '-1');
    if (colspan > 1) td.colSpan = colspan;
    td.dataset.row = rowKey;
    td.dataset.value = option.score;
    td.textContent = option.text;
    td.style.fontSize = '0.78rem';

    // Restore from state
    var currentVal = BHM.State.get(SP + '.' + rowKey);
    if (currentVal !== undefined && currentVal !== null &&
        String(currentVal) === String(option.score)) {
      td.classList.add('selected');
    }

    td.addEventListener('click', makeCellHandler(rowKey, option.score, tr));
    td.addEventListener('keydown', makeKeyHandler());
    return td;
  }

  // ── Keyboard navigation ──
  function makeKeyHandler() {
    return function (e) {
      var td = e.target;
      var table = td.closest('table');
      var allRows = table.querySelectorAll('tbody tr');
      var parentTr = td.closest('tr');
      var rowIdx = Array.prototype.indexOf.call(allRows, parentTr);
      var cells = parentTr.querySelectorAll('.cg-cell');
      var colIdx = Array.prototype.indexOf.call(cells, td);
      var target = null;

      switch (e.key) {
        case 'ArrowRight':
          if (colIdx < cells.length - 1) target = cells[colIdx + 1];
          break;
        case 'ArrowLeft':
          if (colIdx > 0) target = cells[colIdx - 1];
          break;
        case 'ArrowDown':
          if (rowIdx < allRows.length - 1) {
            var nextCells = allRows[rowIdx + 1].querySelectorAll('.cg-cell');
            var nextIdx = Math.min(colIdx, nextCells.length - 1);
            if (nextCells[nextIdx]) target = nextCells[nextIdx];
          }
          break;
        case 'ArrowUp':
          if (rowIdx > 0) {
            var prevCells = allRows[rowIdx - 1].querySelectorAll('.cg-cell');
            var prevIdx = Math.min(colIdx, prevCells.length - 1);
            if (prevCells[prevIdx]) target = prevCells[prevIdx];
          }
          break;
        case 'Enter':
        case ' ':
          e.preventDefault();
          td.click();
          return;
      }

      if (target) {
        e.preventDefault();
        td.setAttribute('tabindex', '-1');
        target.setAttribute('tabindex', '0');
        target.focus();
      }
    };
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.auditTool) BHM.Scoring.auditTool();

    // Update the total row
    var total = 0, answered = 0;
    for (var i = 0; i < QUESTIONS.length; i++) {
      var val = BHM.State.get(SP + '.' + QUESTIONS[i].key);
      if (val !== undefined && val !== null && val !== '') {
        total += Number(val);
        answered++;
      }
    }
    var totalCell = document.getElementById('audit-total-row');
    if (totalCell) {
      totalCell.textContent = answered > 0 ? total : '';
    }
  }

  return { render: render };
})();

/* ── casp19.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.CASP19 — Quality of Life (ELSA version)
   Exact wording from Pre-Assessment Booklet pages 7-8.
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.CASP19 = (function () {
  'use strict';

  var SP = 'instruments.casp19';
  var F = BHM.ClickableGrid;

  // Items — exact wording from booklet, with sub-domain codes and scoring direction
  // reverse: true means negative wording (Often=0, Never=3)
  // reverse: false means positive wording (Often=3, Never=0)
  var ITEMS = [
    { key: 'c1',  label: 'My age prevents me from doing the things I would like to',                   code: 'C1',  domain: 'Control',          reverse: true  },
    { key: 'c2',  label: 'I feel that what happens to me is out of my control',                         code: 'C2',  domain: 'Control',          reverse: true  },
    { key: 'c3',  label: 'I feel free to plan for the future',                                          code: 'C3',  domain: 'Control',          reverse: false },
    { key: 'c4',  label: 'I feel left out of things',                                                   code: 'C4',  domain: 'Control',          reverse: true  },
    { key: 'c5',  label: 'I can do the things that I want to do',                                       code: 'A1',  domain: 'Autonomy',         reverse: false },
    { key: 'c6',  label: 'Family responsibilities prevent me from doing what I want to do',              code: 'A2',  domain: 'Autonomy',         reverse: true  },
    { key: 'c7',  label: 'I feel that I can please myself what I do',                                   code: 'A3',  domain: 'Autonomy',         reverse: false },
    { key: 'c8',  label: 'My health stops me from doing things I want to do',                           code: 'A4',  domain: 'Autonomy',         reverse: true  },
    { key: 'c9',  label: 'Shortage of money stops me from doing the things I want to do',               code: 'A5',  domain: 'Autonomy',         reverse: true  },
    { key: 'c10', label: 'I look forward to each day',                                                  code: 'P1',  domain: 'Pleasure',         reverse: false },
    { key: 'c11', label: 'I feel that my life has meaning',                                              code: 'P2',  domain: 'Pleasure',         reverse: false },
    { key: 'c12', label: 'I enjoy the things that I do',                                                 code: 'P3',  domain: 'Pleasure',         reverse: false },
    { key: 'c13', label: 'I enjoy being in the company of others',                                       code: 'P4',  domain: 'Pleasure',         reverse: false },
    { key: 'c14', label: 'On balance, I look back on my life with a sense of happiness',                 code: 'P5',  domain: 'Pleasure',         reverse: false },
    { key: 'c15', label: 'I feel full of energy these days',                                             code: 'SR1', domain: 'Self-realisation', reverse: false },
    { key: 'c16', label: 'I choose to do things that I have never done before',                          code: 'SR2', domain: 'Self-realisation', reverse: false },
    { key: 'c17', label: 'I feel satisfied with the way my life has turned out',                         code: 'SR3', domain: 'Self-realisation', reverse: false },
    { key: 'c18', label: 'I feel that life is full of opportunities',                                    code: 'SR4', domain: 'Self-realisation', reverse: false },
    { key: 'c19', label: 'I feel that the future looks good for me',                                     code: 'SR5', domain: 'Self-realisation', reverse: false }
  ];

  var COLS = ['Often', 'Sometimes', 'Not often', 'Never'];
  var VALS = [0, 1, 2, 3];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // Title — exact from booklet
    card.innerHTML =
      '<h5>CASP19 Quality of Life Scale (ELSA version)</h5>' +
      '<p class="instrument-subtitle">Please circle the number that corresponds with how much you agree with the phrase</p>';

    // Score summary
    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.innerHTML = '<span class="score-label">CASP-19 Score:</span>' +
      '<span class="score-value" id="casp19-total">--</span>' +
      '<span class="score-interp" id="casp19-interp">out of 57 (higher = better quality of life)</span>';
    card.appendChild(summary);

    // Build table matching booklet structure:
    // Sub-domain | Item no | Statement | Often | Sometimes | Not often | Never
    var tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive';

    var table = document.createElement('table');
    table.className = 'clickable-grid casp19-table';
    table.id = 'casp19-grid';
    table.setAttribute('role', 'grid');

    // Header
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    var headers = ['', 'Sub-domain', 'Item no', 'Often', 'Sometimes', 'Not often', 'Never'];
    for (var h = 0; h < headers.length; h++) {
      var th = document.createElement('th');
      th.textContent = headers[h];
      if (h === 0) { th.style.minWidth = '300px'; th.style.textAlign = 'left'; }
      if (h === 1) { th.style.minWidth = '50px'; th.style.fontSize = '0.75rem'; }
      if (h === 2) { th.style.minWidth = '50px'; th.style.fontSize = '0.75rem'; }
      headerRow.appendChild(th);
    }
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Body
    var tbody = document.createElement('tbody');
    for (var i = 0; i < ITEMS.length; i++) {
      var item = ITEMS[i];
      var tr = document.createElement('tr');
      tr.setAttribute('role', 'row');

      // Statement
      var tdLabel = document.createElement('td');
      tdLabel.className = 'cg-label';
      tdLabel.textContent = item.label;
      tr.appendChild(tdLabel);

      // Sub-domain code
      var tdDomain = document.createElement('td');
      tdDomain.className = 'text-center text-muted';
      tdDomain.style.fontSize = '0.75rem';
      tdDomain.textContent = item.code;
      tr.appendChild(tdDomain);

      // Item number
      var tdNum = document.createElement('td');
      tdNum.className = 'text-center text-muted';
      tdNum.style.fontSize = '0.75rem';
      tdNum.textContent = String(i + 1);
      tr.appendChild(tdNum);

      // Scoring cells — show the score number in each cell (as on paper)
      // reverse items: Often=0, Sometimes=1, Not often=2, Never=3
      // positive items: Often=3, Sometimes=2, Not often=1, Never=0
      for (var c = 0; c < 4; c++) {
        var scoreVal = item.reverse ? c : (3 - c);
        var td = document.createElement('td');
        td.className = 'cg-cell';
        td.setAttribute('role', 'gridcell');
        td.setAttribute('tabindex', (i === 0 && c === 0) ? '0' : '-1');
        td.dataset.row = item.key;
        td.dataset.col = c;
        td.dataset.value = c; // store column index
        td.textContent = String(scoreVal);

        var currentVal = BHM.State.get(SP + '.' + item.key);
        if (currentVal !== undefined && currentVal !== null && String(currentVal) === String(c)) {
          td.classList.add('selected');
        }

        td.addEventListener('click', makeCellHandler(item.key, c, tr));
        td.addEventListener('keydown', makeKeyHandler());
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    tableWrap.appendChild(table);
    card.appendChild(tableWrap);

    var keys = ITEMS.map(function (i) { return i.key; });
    card.appendChild(F.completenessBar(SP, keys));

    container.appendChild(card);
    recalc();
  }

  function makeCellHandler(rowKey, colIdx, tr) {
    return function () {
      var cells = tr.querySelectorAll('.cg-cell');
      for (var i = 0; i < cells.length; i++) cells[i].classList.remove('selected');
      this.classList.add('selected');
      this.focus();
      BHM.State.set(SP + '.' + rowKey, colIdx);
      recalc();
    };
  }

  function makeKeyHandler() {
    return function (e) {
      var td = e.target;
      var table = td.closest('table');
      var allRows = table.querySelectorAll('tbody tr');
      var parentTr = td.closest('tr');
      var rowIdx = Array.prototype.indexOf.call(allRows, parentTr);
      var cells = parentTr.querySelectorAll('.cg-cell');
      var colIdx = Array.prototype.indexOf.call(cells, td);
      var target = null;
      switch (e.key) {
        case 'ArrowRight': if (colIdx < cells.length - 1) target = cells[colIdx + 1]; break;
        case 'ArrowLeft': if (colIdx > 0) target = cells[colIdx - 1]; break;
        case 'ArrowDown': if (rowIdx < allRows.length - 1) { var nc = allRows[rowIdx + 1].querySelectorAll('.cg-cell'); if (nc[colIdx]) target = nc[colIdx]; } break;
        case 'ArrowUp': if (rowIdx > 0) { var pc = allRows[rowIdx - 1].querySelectorAll('.cg-cell'); if (pc[colIdx]) target = pc[colIdx]; } break;
        case 'Enter': case ' ': e.preventDefault(); td.click(); return;
      }
      if (target) { e.preventDefault(); td.setAttribute('tabindex', '-1'); target.setAttribute('tabindex', '0'); target.focus(); }
    };
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.casp19) BHM.Scoring.casp19();
  }

  function getItems() { return ITEMS; }

  return { render: render, getItems: getItems };
})();

/* ── hearing.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.Hearing — Your ears and hearing
   Exact wording from Pre-Assessment Booklet pages 8-10.
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.Hearing = (function () {
  'use strict';

  var SP = 'instruments.hearing';
  var F = BHM.ClickableGrid;

  // Yes/No items — exact question wording from booklet
  var YN_ITEMS = [
    { key: 'suddenChange', label: 'Have you had any sudden or rapid changes in your hearing (within 90 days)?' },
    { key: 'fluctuation',  label: 'Does your hearing change on different days?' },
    { key: 'pain',         label: 'Do you get pain in your ears?' },
    { key: 'discharge',    label: 'Do you get any infections or discharge from your ears (not including wax)?' },
    { key: 'operations',   label: 'Have you had any ear-related operations?' },
    { key: 'perforation',  label: 'Have you ever had a perforated eardrum?' },
    { key: 'tinnitus',     label: 'Do you hear any rushing, hissing, ringing, beating, pulsing or any other noises in your ears, often called tinnitus?' },
    { key: 'hyperacusis',  label: 'Do you have a strong sensitivity to everyday loud sounds that do not bother other people?' }
  ];

  // Hearing difficulties situations — exact wording from booklet page 9
  var SITUATIONS = [
    { key: 'hs1',  label: '1. One to one conversation in quiet.' },
    { key: 'hs2',  label: '2. One to one conversation in noise.' },
    { key: 'hs3',  label: '3. Conversations in a group with no background noise.' },
    { key: 'hs4',  label: '4. Conversation in a group with background noise.' },
    { key: 'hs5',  label: '5. Hearing the television or radio at normal volume.' },
    { key: 'hs6',  label: '6. Hearing a familiar speaker on the telephone.' },
    { key: 'hs7',  label: '7. Hearing an unfamiliar speaker on the telephone.' },
    { key: 'hs8',  label: '8. Hearing the phone ring from another room.' },
    { key: 'hs9',  label: '9. Hearing the doorbell or knocker.' },
    { key: 'hs10', label: '10. Hearing in church or in a meeting' },
    { key: 'hs11', label: '11. Hearing traffic.' },
    { key: 'hs12', label: '12. Hearing the fire alarm.' },
    { key: 'hs13', label: '13. Decreased social contact.' },
    { key: 'hs14', label: '14. Feeling embarrassed or stupid.' },
    { key: 'hs15', label: '15. Feeling left out.' },
    { key: 'hs16', label: '16. Feeling upset or angry.' },
    { key: 'hs17', label: '17. Other:' }
  ];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // ═══ PAGE 1: Your ears and hearing ═══
    // Title — exact from booklet
    card.innerHTML = '<h5>Your ears and hearing</h5>';

    // Opening questions
    var q1 = document.createElement('div');
    q1.className = 'row g-3 mb-3';
    q1.appendChild(wrapCol(F.createField({
      label: 'How long have you had a problem with your hearing?',
      statePath: SP + '.duration',
      placeholder: ''
    }), 'col-md-6'));
    q1.appendChild(wrapCol(F.createField({
      label: 'Which ear(s) does your hearing problem affect?',
      statePath: SP + '.earAffected',
      placeholder: ''
    }), 'col-md-6'));
    card.appendChild(q1);

    // Instruction
    var instrDiv = document.createElement('div');
    instrDiv.className = 'mb-3';
    instrDiv.innerHTML = '<p style="font-size:0.88rem;">Please click \u2018Yes\u2019 or \u2018No\u2019 for each question.</p>';
    card.appendChild(instrDiv);

    // Yes/No items — exact question wording
    for (var i = 0; i < YN_ITEMS.length; i++) {
      var item = YN_ITEMS[i];
      var row = document.createElement('div');
      row.className = 'd-flex align-items-center justify-content-between py-2 border-bottom';
      var lbl = document.createElement('span');
      lbl.className = 'me-3';
      lbl.style.fontSize = '0.88rem';
      lbl.textContent = item.label;
      row.appendChild(lbl);
      row.appendChild(F.createYesNo({
        statePath: SP + '.' + item.key,
        onChange: recalc
      }));
      card.appendChild(row);
    }

    // "If you have answered 'Yes'..." — exact from booklet
    card.appendChild(F.createField({
      label: 'If you have answered \u2018Yes\u2019 to any of these please give more information:',
      statePath: SP + '.yesDetails',
      type: 'textarea',
      rows: 2,
      placeholder: ''
    }));

    // Follow-up questions — exact wording from booklet
    var fuSection = document.createElement('div');
    fuSection.className = 'mt-3';

    fuSection.appendChild(F.createField({
      label: 'Have you ever seen an Ear, Nose and Throat specialist for ear, hearing or dizziness problems?',
      statePath: SP + '.entSeen',
      type: 'select',
      options: ['', 'Yes', 'No']
    }));

    fuSection.appendChild(F.createField({
      label: 'If yes, what was the outcome of this appointment?',
      statePath: SP + '.entOutcome',
      type: 'textarea',
      rows: 2,
      placeholder: ''
    }));

    fuSection.appendChild(F.createField({
      label: 'Do you wear hearing aids?',
      statePath: SP + '.hearingAids',
      type: 'select',
      options: ['', 'Yes', 'No']
    }));

    fuSection.appendChild(F.createField({
      label: 'If yes, do you experience any problems with your hearing aids?',
      statePath: SP + '.hearingAidProblems',
      type: 'textarea',
      rows: 2,
      placeholder: ''
    }));

    fuSection.appendChild(F.createField({
      label: 'If no, would you want to hearing aids if they may help you to hear better?',
      statePath: SP + '.wantHearingAids',
      type: 'select',
      options: ['', 'Yes', 'No', 'Not sure']
    }));

    card.appendChild(fuSection);

    // ═══ PAGE 2: Hearing difficulties ═══
    var page2 = document.createElement('div');
    page2.className = 'mt-4 pt-3 border-top';
    page2.innerHTML =
      '<h5>Hearing difficulties</h5>' +
      '<p style="font-size:0.88rem;">' +
        'Please click the boxes to select any the situations in which you may find that your hearing ' +
        'affects you. If you feel no situations apply please leave this section blank.' +
      '</p>';

    // Situations as a checklist (tick boxes — matching booklet format)
    for (var s = 0; s < SITUATIONS.length; s++) {
      var sit = SITUATIONS[s];
      var sitRow = document.createElement('div');
      sitRow.className = 'd-flex align-items-center py-1';

      var cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'form-check-input me-2';
      cb.id = 'hearing-sit-' + sit.key;
      cb.style.minWidth = '20px';
      cb.style.minHeight = '20px';

      // Restore from state
      var currentVal = BHM.State.get(SP + '.' + sit.key);
      if (currentVal === 'yes') cb.checked = true;

      cb.addEventListener('change', (function (key) {
        return function () {
          BHM.State.set(SP + '.' + key, this.checked ? 'yes' : 'no');
          recalc();
        };
      })(sit.key));

      var sitLabel = document.createElement('label');
      sitLabel.className = 'form-check-label';
      sitLabel.htmlFor = 'hearing-sit-' + sit.key;
      sitLabel.style.fontSize = '0.88rem';
      sitLabel.textContent = sit.label;

      sitRow.appendChild(cb);
      sitRow.appendChild(sitLabel);
      page2.appendChild(sitRow);
    }

    // Other specify text
    page2.appendChild(F.createField({
      label: '',
      statePath: SP + '.hs17_text',
      placeholder: 'Please specify other situation',
    }));

    // Top 3 — exact wording from booklet
    var top3 = document.createElement('div');
    top3.className = 'mt-3';
    top3.innerHTML =
      '<p style="font-size:0.88rem; font-weight:500;">' +
        'Of the situations you ticked, which 3 are most affected by your hearing?<br>' +
        'Please enter the numbers that apply here.' +
      '</p>';

    var top3Row = document.createElement('div');
    top3Row.className = 'row g-2';
    for (var t = 1; t <= 3; t++) {
      top3Row.appendChild(wrapCol(F.createField({
        label: '',
        statePath: SP + '.top' + t,
        placeholder: '#',
        type: 'number',
        min: 1,
        max: 17
      }), 'col-4'));
    }
    top3.appendChild(top3Row);
    page2.appendChild(top3);

    card.appendChild(page2);

    // Score summary
    var summaryDiv = document.createElement('div');
    summaryDiv.className = 'score-summary mt-3';
    summaryDiv.innerHTML = '<span class="score-label">Affected situations:</span>' +
      '<span class="score-value" id="hearing-count">--</span>' +
      '<span class="score-interp" id="hearing-interp">out of 17</span>';
    card.appendChild(summaryDiv);

    container.appendChild(card);
    recalc();
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.hearing) BHM.Scoring.hearing();
  }

  function wrapCol(el, colClass) {
    var col = document.createElement('div');
    col.className = colClass;
    col.appendChild(el);
    return col;
  }

  function getSituations() { return SITUATIONS; }

  return { render: render, getSituations: getSituations };
})();

/* ── mbiC.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.MBIC — Mild Behavioural Impairment Checklist
   Exact wording from Pre-Assessment Booklet pages 11-13.
   Modified from J Alzheimers Dis. 2017; 56(3): 929-938.
   doi:10.3233/JAD-160979.
   ─────────────────────────────────────────────────────
   Layout: ONE single unified table. Domain headings are
   full-width header rows within the table (matches paper).
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.MBIC = (function () {
  'use strict';

  var SP = 'instruments.mbiC';
  var F = BHM.ClickableGrid;

  // Domains and items — exact wording, order and counts from booklet
  var DOMAINS = [
    {
      name: 'Interest, motivation, and drive',
      items: [
        { key: 'imd1', label: 'Does the person lack curiosity in topics that would usually have attracted her/his interest?' },
        { key: 'imd2', label: 'Has the person lost interest in friends, family, or home activities?' },
        { key: 'imd3', label: 'Has the person become less spontaneous and active \u2013 for example, is she/he less likely to initiate or maintain conversation?' },
        { key: 'imd4', label: 'Has the person lost the motivation to act on their obligations or interests?' },
        { key: 'imd5', label: 'Is the person less affectionate and/or lacking in emotions when compared to her/his usual self?' }
      ]
    },
    {
      name: 'Mood or anxiety symptoms',
      items: [
        { key: 'ma1', label: 'Has the person developed sadness or appear to be in low spirits? Does she/he have episodes of tearfulness?' },
        { key: 'ma2', label: 'Has the person become less able to experience pleasure?' },
        { key: 'ma3', label: 'Has become discouraged about their future or feel that he/she is a failure?' },
        { key: 'ma4', label: 'Does the person view herself/himself as a burden to family?' },
        { key: 'ma5', label: 'Has the person become more anxious or worried about things that are routine (e.g. events, visits, etc.)?' },
        { key: 'ma6', label: 'Does the person feel very tense, having developed an inability to relax, or shakiness, or symptoms of panic?' }
      ]
    },
    {
      name: 'Delayed gratification and control behavior, impulses, oral intake and/or changes in reward',
      items: [
        { key: 'dg1',  label: 'Has the person become agitated, aggressive, irritable, or temperamental?' },
        { key: 'dg2',  label: 'Has she/he become unreasonably or uncharacteristically argumentative?' },
        { key: 'dg3',  label: 'Has the person become more impulsive, seeming to act without considering things?' },
        { key: 'dg4',  label: 'Does the person display sexually disinhibited or intrusive behaviour, such as touching (themselves/others), hugging, groping, etc., in a manner that is out of character or may cause offence?' },
        { key: 'dg5',  label: 'Has the person become more easily frustrated or impatient? Does she/he have troubles coping with delays, or waiting for events or for their turn?' },
        { key: 'dg6',  label: 'Does the person display a new recklessness or lack of judgement when driving (e.g. speeding, erratic swerving, abrupt lane changes, etc.)?' },
        { key: 'dg7',  label: 'Has the person become more stubborn or rigid, i.e., uncharacteristically insistent on having their way, or unwilling/unable to see/hear other views?' },
        { key: 'dg8',  label: 'Is there a change in eating behaviours (e.g., overeating, cramming the mouth, insistent on eating only specific foods, or eating the food in exactly the same order)?' },
        { key: 'dg9',  label: 'Does the person no longer find food tasteful or enjoyable? Are they eating less?' },
        { key: 'dg10', label: 'Does the person hoard objects when she/he did not do so before?' },
        { key: 'dg11', label: 'Has the person developed simple repetitive behaviours or compulsions?' },
        { key: 'dg12', label: 'Has the person recently developed trouble regulating smoking, alcohol, drug intake or gambling, or started shoplifting?' }
      ]
    },
    {
      name: 'Societal norms and having social graces, tact, and empathy',
      items: [
        { key: 'sn1', label: 'Has the person become less concerned about how her/his words or actions affect others? Has she/he become insensitive to others\u2019 feelings?' },
        { key: 'sn2', label: 'Has the person started talking openly about very personal or private matters not usually discussed in public?' },
        { key: 'sn3', label: 'Does the person say rude or crude things or make lewd sexual remarks that she/he would not have said before?' },
        { key: 'sn4', label: 'Does the person seem to lack the social judgement she/he previously had about what to say or how to behave in public or private?' },
        { key: 'sn5', label: 'Does the person now talk to strangers as if familiar, or intrude on their activities?' }
      ]
    },
    {
      name: 'Strongly held beliefs and sensory experiences',
      items: [
        { key: 'sb1', label: 'Has the person developed beliefs that they are in danger, or that others are planning to harm them or steal their belongings?' },
        { key: 'sb2', label: 'Has the person developed suspiciousness about the intentions or motives of other people?' },
        { key: 'sb3', label: 'Does she/he have unrealistic beliefs about her/his power, wealth or skills?' },
        { key: 'sb4', label: 'Does the person describe hearing voices or does she/he talk to imaginary people or \u201cspirits\u201d?' },
        { key: 'sb5', label: 'Does the person report or complain about, or act as if seeing things (e.g. people, animals or insects) that are not there, i.e., that are imaginary to others?' }
      ]
    }
  ];

  var COLS = ['None', 'Mild', 'Moderate', 'Severe'];
  var VALS = [0, 1, 2, 3];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';

    // Title — exact from booklet
    card.innerHTML =
      '<h5>Mild Behavioural Impairment Checklist (MBI-C)</h5>';

    // ID number field
    card.appendChild(F.createField({
      label: 'ID Number:',
      statePath: SP + '.idNumber',
      placeholder: ''
    }));

    // Citation
    var cite = document.createElement('p');
    cite.style.fontSize = '0.75rem';
    cite.style.color = '#6c757d';
    cite.textContent = 'Modified from J Alzheimers Dis. 2017 ; 56(3): 929\u2013938. doi:10.3233/JAD-160979.';
    card.appendChild(cite);

    // Score summary
    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.innerHTML = '<span class="score-label">MBI-C Total:</span>' +
      '<span class="score-value" id="mbic-total">--</span>' +
      '<span class="score-interp" id="mbic-interp">Domain scores shown below</span>';
    card.appendChild(summary);

    // Domain scores display
    var domainScores = document.createElement('div');
    domainScores.className = 'd-flex flex-wrap gap-2 mb-3';
    domainScores.id = 'mbic-domain-scores';
    for (var d = 0; d < DOMAINS.length; d++) {
      var badge = document.createElement('span');
      badge.className = 'badge bg-light text-dark border';
      badge.style.fontSize = '0.72rem';
      badge.id = 'mbic-domain-' + d;
      badge.textContent = DOMAINS[d].name.substring(0, 30) + '\u2026: --';
      badge.title = DOMAINS[d].name;
      domainScores.appendChild(badge);
    }
    card.appendChild(domainScores);

    // ── Build ONE single unified table ──
    var tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive';

    var table = document.createElement('table');
    table.className = 'clickable-grid mbic-unified-table';
    table.id = 'mbic-grid';
    table.setAttribute('role', 'grid');

    // Header row
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');
    var thQ = document.createElement('th');
    thQ.textContent = '';
    thQ.style.textAlign = 'left';
    thQ.style.minWidth = '350px';
    headerRow.appendChild(thQ);

    for (var c = 0; c < COLS.length; c++) {
      var th = document.createElement('th');
      th.textContent = COLS[c];
      th.style.minWidth = '70px';
      headerRow.appendChild(th);
    }
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Body — domains flow continuously as section header rows + item rows
    var tbody = document.createElement('tbody');
    var allKeys = [];
    var globalRowIdx = 0;

    for (var di = 0; di < DOMAINS.length; di++) {
      var domain = DOMAINS[di];

      // Domain header row (spans all columns)
      var domainRow = document.createElement('tr');
      domainRow.className = 'mbic-domain-header';
      var domainTd = document.createElement('td');
      domainTd.colSpan = COLS.length + 1;
      domainTd.innerHTML = '<strong>' + domain.name + '</strong>';
      domainRow.appendChild(domainTd);
      tbody.appendChild(domainRow);

      // Item rows
      for (var ii = 0; ii < domain.items.length; ii++) {
        var item = domain.items[ii];
        allKeys.push(item.key);

        var tr = document.createElement('tr');
        tr.setAttribute('role', 'row');

        // Label cell
        var tdLabel = document.createElement('td');
        tdLabel.className = 'cg-label';
        tdLabel.textContent = item.label;
        tr.appendChild(tdLabel);

        // Clickable cells (None / Mild / Moderate / Severe)
        for (var ci = 0; ci < VALS.length; ci++) {
          var td = document.createElement('td');
          td.className = 'cg-cell';
          td.setAttribute('role', 'gridcell');
          td.setAttribute('tabindex', (globalRowIdx === 0 && ci === 0) ? '0' : '-1');
          td.dataset.row = item.key;
          td.dataset.col = ci;
          td.dataset.value = VALS[ci];
          td.innerHTML = '\u2610'; // empty checkbox char

          // Restore from state
          var currentVal = BHM.State.get(SP + '.' + item.key);
          if (currentVal !== undefined && currentVal !== null && Number(currentVal) === VALS[ci]) {
            td.classList.add('selected');
            td.innerHTML = '\u2611';
          }

          td.addEventListener('click', makeCellHandler(item.key, VALS[ci], tr));
          td.addEventListener('keydown', makeKeyHandler());
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
        globalRowIdx++;
      }
    }

    table.appendChild(tbody);
    tableWrap.appendChild(table);
    card.appendChild(tableWrap);

    card.appendChild(F.completenessBar(SP, allKeys));
    container.appendChild(card);
    recalc();
  }

  function makeCellHandler(rowKey, value, tr) {
    return function () {
      // Deselect siblings
      var cells = tr.querySelectorAll('.cg-cell');
      for (var i = 0; i < cells.length; i++) {
        cells[i].classList.remove('selected');
        cells[i].innerHTML = '\u2610';
      }
      // Select this one
      this.classList.add('selected');
      this.innerHTML = '\u2611';
      this.focus();
      BHM.State.set(SP + '.' + rowKey, value);
      recalc();
    };
  }

  function makeKeyHandler() {
    return function (e) {
      var td = e.target;
      var table = td.closest('table');
      // Get only item rows (skip domain header rows)
      var allItemRows = table.querySelectorAll('tbody tr:not(.mbic-domain-header)');
      var parentTr = td.closest('tr');
      var rowIdx = Array.prototype.indexOf.call(allItemRows, parentTr);
      var cells = parentTr.querySelectorAll('.cg-cell');
      var colIdx = Array.prototype.indexOf.call(cells, td);
      var target = null;
      switch (e.key) {
        case 'ArrowRight': if (colIdx < cells.length - 1) target = cells[colIdx + 1]; break;
        case 'ArrowLeft': if (colIdx > 0) target = cells[colIdx - 1]; break;
        case 'ArrowDown':
          if (rowIdx < allItemRows.length - 1) {
            var nc = allItemRows[rowIdx + 1].querySelectorAll('.cg-cell');
            if (nc[colIdx]) target = nc[colIdx];
          }
          break;
        case 'ArrowUp':
          if (rowIdx > 0) {
            var pc = allItemRows[rowIdx - 1].querySelectorAll('.cg-cell');
            if (pc[colIdx]) target = pc[colIdx];
          }
          break;
        case 'Enter': case ' ': e.preventDefault(); td.click(); return;
      }
      if (target) { e.preventDefault(); td.setAttribute('tabindex', '-1'); target.setAttribute('tabindex', '0'); target.focus(); }
    };
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.mbiC) BHM.Scoring.mbiC();
  }

  function getDomains() { return DOMAINS; }

  return { render: render, getDomains: getDomains };
})();

/* ── npiQ.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.NPIQ — Neuropsychiatric Inventory
   Questionnaire (NPI-Q)
   Exact wording from Pre-Assessment Booklet pages 13-16.
   ─────────────────────────────────────────────────────
   Layout: Single unified table. Each symptom is one row:
     Label | Yes No | SEVERITY 1 2 3 | DISTRESS 0 1 2 3 4 5
   Severity & distress cells are greyed out until Yes.
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.NPIQ = (function () {
  'use strict';

  var SP = 'instruments.npiQ';
  var F = BHM.ClickableGrid;

  var SYMPTOMS = [
    { key: 'delusions',        label: 'Delusions',             desc: 'Does the patient have false beliefs, such as thinking that others are stealing from him/her or planning to harm him/her in some way?' },
    { key: 'hallucinations',   label: 'Hallucinations',        desc: 'Does the patient have hallucinations such as false visions or voices? Does he or she seem to hear or see things that are not present?' },
    { key: 'agitation',        label: 'Agitation/Aggression',  desc: 'Is the patient resistive to help from others at times, or hard to handle?' },
    { key: 'depression',       label: 'Depression/Dysphoria',  desc: 'Does the patient seem sad or say that he/she is depressed?' },
    { key: 'anxiety',          label: 'Anxiety',               desc: 'Does the patient become upset when separated from you? Does he/she have any other signs of nervousness such as shortness of breath, sighing, being unable to relax, or feeling excessively tense?' },
    { key: 'elation',          label: 'Elation/Euphoria',      desc: 'Does the patient appear to feel too good or act excessively happy?' },
    { key: 'apathy',           label: 'Apathy/Indifference',   desc: 'Does the patient seem less interested in his/her usual activities or in the activities and plans of others?' },
    { key: 'disinhibition',    label: 'Disinhibition',         desc: 'Does the patient seem to act impulsively, for example, talking to strangers as if he/she knows them, or saying things that may hurt people\u2019s feelings?' },
    { key: 'irritability',     label: 'Irritability/Lability', desc: 'Is the patient impatient and cranky? Does he/she have difficulty coping with delays or waiting for planned activities?' },
    { key: 'motorDisturbance', label: 'Motor Disturbance',     desc: 'Does the patient engage in repetitive activities such as pacing around the house, handling buttons, wrapping string, or doing other things repeatedly?' },
    { key: 'nightBehaviour',   label: 'Nightime Behaviors',    desc: 'Does the patient awaken you during the night, rise too early in the morning, or take excessive naps during the day?' },
    { key: 'appetite',         label: 'Appetite/Eating',       desc: 'Has the patient lost or gained weight, or had a change in the type of food he/she likes?' }
  ];

  var SEV_VALS = [1, 2, 3];
  var DIST_VALS = [0, 1, 2, 3, 4, 5];

  function render(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';
    card.innerHTML = '<h5>Neuropsychiatric Inventory Questionnaire (NPI-Q)</h5>';

    // Instructions — exact from booklet
    var instrDiv = document.createElement('div');
    instrDiv.className = 'instrument-subtitle';
    instrDiv.style.fontSize = '0.85rem';
    instrDiv.innerHTML =
      '<p>Please answer the following questions based on changes that have occurred since the patient first began to experience memory problems.</p>' +
      '<p>Circle \u201cYes\u201d only if the symptom(s) has been present in the last month. Otherwise, circle \u201cNo\u201d. For each item marked \u201cYes\u201d:</p>' +
      '<p>a) Rate the <strong>SEVERITY</strong> of the symptom (how it affects the patient):</p>' +
      '<div class="ps-3 mb-2" style="line-height:1.6;">' +
        '1 = Mild (noticeable, but not a significant change)<br>' +
        '2 = Moderate (significant, but not a dramatic change)<br>' +
        '3 = Severe (very marked or prominent, a dramatic change)' +
      '</div>' +
      '<p>b) Rate the <strong>DISTRESS</strong> you experience due to that symptom (how it affects you):</p>' +
      '<div class="ps-3 mb-2" style="line-height:1.6;">' +
        '0 = Not distressing at all<br>' +
        '1 = Minimal (slightly distressing, not a problem to cope with)<br>' +
        '2 = Mild (not very distressing, generally easy to cope with)<br>' +
        '3 = Moderate (fairly distressing, not always easy to cope with)<br>' +
        '4 = Severe (very distressing, difficult to cope with)<br>' +
        '5 = Extreme or Very Severe (extremely distressing, unable to cope with)' +
      '</div>' +
      '<p>Please answer each question carefully. Ask for assistance if you have any questions.</p>';
    card.appendChild(instrDiv);

    // Score summary
    var summary = document.createElement('div');
    summary.className = 'score-summary';
    summary.innerHTML =
      '<span class="score-label">Symptom count:</span><span class="score-value" id="npiq-count">--</span>' +
      '<span class="score-label ms-3">Severity total:</span><span class="score-value" id="npiq-severity">--</span>' +
      '<span class="score-label ms-3">Distress total:</span><span class="score-value" id="npiq-distress">--</span>';
    card.appendChild(summary);

    // ═══ UNIFIED TABLE ═══
    var tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive';

    var table = document.createElement('table');
    table.className = 'clickable-grid npiq-unified-table';
    table.id = 'npiq-grid';
    table.setAttribute('role', 'grid');

    // ── Header row ──
    var thead = document.createElement('thead');
    var headerRow = document.createElement('tr');

    // Symptom column
    var thSym = document.createElement('th');
    thSym.textContent = '';
    thSym.style.textAlign = 'left';
    thSym.style.minWidth = '220px';
    headerRow.appendChild(thSym);

    // Yes / No columns
    var thYes = document.createElement('th');
    thYes.textContent = 'Yes';
    thYes.style.minWidth = '44px';
    headerRow.appendChild(thYes);
    var thNo = document.createElement('th');
    thNo.textContent = 'No';
    thNo.style.minWidth = '44px';
    headerRow.appendChild(thNo);

    // Severity header spanning 3 cols
    var thSev = document.createElement('th');
    thSev.textContent = 'SEVERITY:';
    thSev.colSpan = 3;
    thSev.className = 'npiq-group-header';
    headerRow.appendChild(thSev);

    // Distress header spanning 6 cols
    var thDist = document.createElement('th');
    thDist.textContent = 'DISTRESS:';
    thDist.colSpan = 6;
    thDist.className = 'npiq-group-header';
    headerRow.appendChild(thDist);

    thead.appendChild(headerRow);

    // Sub-header row with the numeric labels
    var subRow = document.createElement('tr');
    subRow.className = 'npiq-sub-header';

    // Empty for symptom + yes + no
    var subEmpty1 = document.createElement('th');
    subEmpty1.textContent = '';
    subRow.appendChild(subEmpty1);
    var subEmpty2 = document.createElement('th');
    subEmpty2.textContent = '';
    subRow.appendChild(subEmpty2);
    var subEmpty3 = document.createElement('th');
    subEmpty3.textContent = '';
    subRow.appendChild(subEmpty3);

    // Severity sub-headers: 1 2 3
    for (var s = 0; s < SEV_VALS.length; s++) {
      var thS = document.createElement('th');
      thS.textContent = String(SEV_VALS[s]);
      thS.className = 'npiq-num-header';
      subRow.appendChild(thS);
    }
    // Distress sub-headers: 0 1 2 3 4 5
    for (var d = 0; d < DIST_VALS.length; d++) {
      var thD = document.createElement('th');
      thD.textContent = String(DIST_VALS[d]);
      thD.className = 'npiq-num-header';
      subRow.appendChild(thD);
    }
    thead.appendChild(subRow);
    table.appendChild(thead);

    // ── Body rows ──
    var tbody = document.createElement('tbody');

    for (var i = 0; i < SYMPTOMS.length; i++) {
      var sym = SYMPTOMS[i];
      var tr = document.createElement('tr');
      tr.setAttribute('role', 'row');
      tr.id = 'npiq-row-' + sym.key;

      // Label cell
      var tdLabel = document.createElement('td');
      tdLabel.className = 'cg-label npiq-label-cell';
      tdLabel.innerHTML = '<strong>' + sym.label + '</strong>' +
        '<div class="npiq-item-desc">' + sym.desc + '</div>';
      tr.appendChild(tdLabel);

      // Yes cell
      var tdYes = document.createElement('td');
      tdYes.className = 'cg-cell npiq-yn-cell';
      tdYes.setAttribute('role', 'gridcell');
      tdYes.setAttribute('tabindex', '-1');
      tdYes.textContent = 'Yes';
      tdYes.dataset.row = sym.key;
      tdYes.dataset.type = 'present';
      tdYes.dataset.value = 'yes';
      tr.appendChild(tdYes);

      // No cell
      var tdNo = document.createElement('td');
      tdNo.className = 'cg-cell npiq-yn-cell';
      tdNo.setAttribute('role', 'gridcell');
      tdNo.setAttribute('tabindex', '-1');
      tdNo.textContent = 'No';
      tdNo.dataset.row = sym.key;
      tdNo.dataset.type = 'present';
      tdNo.dataset.value = 'no';
      tr.appendChild(tdNo);

      // Severity cells: 1 2 3
      for (var si = 0; si < SEV_VALS.length; si++) {
        var tdSev = document.createElement('td');
        tdSev.className = 'cg-cell npiq-rating-cell npiq-disabled';
        tdSev.setAttribute('role', 'gridcell');
        tdSev.setAttribute('tabindex', '-1');
        tdSev.textContent = String(SEV_VALS[si]);
        tdSev.dataset.row = sym.key;
        tdSev.dataset.type = 'severity';
        tdSev.dataset.value = SEV_VALS[si];
        tr.appendChild(tdSev);
      }

      // Distress cells: 0 1 2 3 4 5
      for (var di = 0; di < DIST_VALS.length; di++) {
        var tdDist = document.createElement('td');
        tdDist.className = 'cg-cell npiq-rating-cell npiq-disabled';
        tdDist.setAttribute('role', 'gridcell');
        tdDist.setAttribute('tabindex', '-1');
        tdDist.textContent = String(DIST_VALS[di]);
        tdDist.dataset.row = sym.key;
        tdDist.dataset.type = 'distress';
        tdDist.dataset.value = DIST_VALS[di];
        tr.appendChild(tdDist);
      }

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    tableWrap.appendChild(table);
    card.appendChild(tableWrap);

    // Footer
    var footer = document.createElement('p');
    footer.style.fontSize = '0.75rem';
    footer.style.color = '#6c757d';
    footer.className = 'mt-3';
    footer.textContent = 'Developed by Daniel Kaufer, MD. Final Version 6/99. \u00A9 JL Cummings, 1994; all rights reserved';
    card.appendChild(footer);

    container.appendChild(card);

    // ── Bind all cell clicks ──
    var allCells = table.querySelectorAll('.cg-cell');
    for (var ci = 0; ci < allCells.length; ci++) {
      allCells[ci].addEventListener('click', handleCellClick);
      allCells[ci].addEventListener('keydown', handleKeyDown);
    }

    // Restore saved state
    restoreState();
    recalc();
  }

  function handleCellClick(e) {
    var td = e.target.closest('.cg-cell');
    if (!td) return;
    var key = td.dataset.row;
    var type = td.dataset.type;
    var value = td.dataset.value;
    var tr = td.closest('tr');

    if (type === 'present') {
      // Yes/No toggle — clear previous selection in this pair
      var ynCells = tr.querySelectorAll('.npiq-yn-cell');
      for (var i = 0; i < ynCells.length; i++) {
        ynCells[i].classList.remove('selected', 'npiq-yes-selected', 'npiq-no-selected');
      }
      td.classList.add('selected');
      td.classList.add(value === 'yes' ? 'npiq-yes-selected' : 'npiq-no-selected');
      BHM.State.set(SP + '.' + key + '_present', value);

      // Enable/disable severity + distress cells
      var ratingCells = tr.querySelectorAll('.npiq-rating-cell');
      for (var r = 0; r < ratingCells.length; r++) {
        if (value === 'yes') {
          ratingCells[r].classList.remove('npiq-disabled');
        } else {
          ratingCells[r].classList.add('npiq-disabled');
          ratingCells[r].classList.remove('selected');
          // Clear severity/distress if switching to No
          var rType = ratingCells[r].dataset.type;
          BHM.State.set(SP + '.' + key + '_' + rType, undefined, { silent: true });
        }
      }

    } else if (type === 'severity') {
      if (td.classList.contains('npiq-disabled')) return;
      // Clear other severity cells in this row
      var sevCells = tr.querySelectorAll('.npiq-rating-cell[data-type="severity"]');
      for (var s = 0; s < sevCells.length; s++) sevCells[s].classList.remove('selected');
      td.classList.add('selected');
      BHM.State.set(SP + '.' + key + '_severity', Number(value));

    } else if (type === 'distress') {
      if (td.classList.contains('npiq-disabled')) return;
      var distCells = tr.querySelectorAll('.npiq-rating-cell[data-type="distress"]');
      for (var d = 0; d < distCells.length; d++) distCells[d].classList.remove('selected');
      td.classList.add('selected');
      BHM.State.set(SP + '.' + key + '_distress', Number(value));
    }

    td.focus();
    recalc();
  }

  function handleKeyDown(e) {
    var td = e.target;
    var tr = td.closest('tr');
    var table = td.closest('table');
    var allRows = table.querySelectorAll('tbody tr');
    var rowIdx = Array.prototype.indexOf.call(allRows, tr);
    var allCells = tr.querySelectorAll('.cg-cell');
    var colIdx = Array.prototype.indexOf.call(allCells, td);
    var target = null;

    switch (e.key) {
      case 'ArrowRight': if (colIdx < allCells.length - 1) target = allCells[colIdx + 1]; break;
      case 'ArrowLeft':  if (colIdx > 0) target = allCells[colIdx - 1]; break;
      case 'ArrowDown':
        if (rowIdx < allRows.length - 1) {
          var nc = allRows[rowIdx + 1].querySelectorAll('.cg-cell');
          if (nc[colIdx]) target = nc[colIdx];
        }
        break;
      case 'ArrowUp':
        if (rowIdx > 0) {
          var pc = allRows[rowIdx - 1].querySelectorAll('.cg-cell');
          if (pc[colIdx]) target = pc[colIdx];
        }
        break;
      case 'Enter': case ' ': e.preventDefault(); td.click(); return;
    }
    if (target) { e.preventDefault(); td.setAttribute('tabindex', '-1'); target.setAttribute('tabindex', '0'); target.focus(); }
  }

  function restoreState() {
    for (var i = 0; i < SYMPTOMS.length; i++) {
      var key = SYMPTOMS[i].key;
      var tr = document.getElementById('npiq-row-' + key);
      if (!tr) continue;

      var present = BHM.State.get(SP + '.' + key + '_present');
      if (present === 'yes' || present === 'no') {
        var ynCells = tr.querySelectorAll('.npiq-yn-cell');
        for (var y = 0; y < ynCells.length; y++) {
          if (ynCells[y].dataset.value === present) {
            ynCells[y].classList.add('selected');
            ynCells[y].classList.add(present === 'yes' ? 'npiq-yes-selected' : 'npiq-no-selected');
          }
        }
        // Enable rating cells if yes
        if (present === 'yes') {
          var ratingCells = tr.querySelectorAll('.npiq-rating-cell');
          for (var r = 0; r < ratingCells.length; r++) ratingCells[r].classList.remove('npiq-disabled');
        }
      }

      // Restore severity
      var sev = BHM.State.get(SP + '.' + key + '_severity');
      if (sev !== undefined && sev !== null) {
        var sevCells = tr.querySelectorAll('.npiq-rating-cell[data-type="severity"]');
        for (var s = 0; s < sevCells.length; s++) {
          if (Number(sevCells[s].dataset.value) === Number(sev)) sevCells[s].classList.add('selected');
        }
      }

      // Restore distress
      var dist = BHM.State.get(SP + '.' + key + '_distress');
      if (dist !== undefined && dist !== null) {
        var distCells = tr.querySelectorAll('.npiq-rating-cell[data-type="distress"]');
        for (var d = 0; d < distCells.length; d++) {
          if (Number(distCells[d].dataset.value) === Number(dist)) distCells[d].classList.add('selected');
        }
      }
    }
  }

  function recalc() {
    if (BHM.Scoring && BHM.Scoring.npiQ) BHM.Scoring.npiQ();
  }

  function getSymptoms() { return SYMPTOMS; }

  return { render: render, getSymptoms: getSymptoms };
})();

/* ── clinicalInterview.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.ClinicalInterview
   Semi-Structured Clinical Interview — exact layout from
   Semistructured_Clinical_Interview_BHM_formatted_v3.docx
   Sections A-I
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.ClinicalInterview = (function () {
  'use strict';

  var SP = 'instruments.clinical';
  var F = BHM.ClickableGrid;

  // ── Section A: New learning / memory ──
  var MEM_ITEMS = [
    { key: 'memA1', label: 'Rapid forgetfulness (new information)' },
    { key: 'memA2', label: 'Repetitive questioning' },
    { key: 'memA3', label: 'Misplacing objects' },
    { key: 'memA4', label: 'Forgetting appointments' },
    { key: 'memA5', label: 'Increased reliance on lists/calendars' },
    { key: 'memA6', label: 'Losing things around the house' }
  ];

  // ── Section B: Word-finding / language ──
  var LANG_ITEMS = [
    { key: 'langB1', label: 'Tip-of-the-tongue episodes' },
    { key: 'langB2', label: 'Pauses / hesitations in speech' },
    { key: 'langB3', label: 'Uses the wrong word (semantic errors)' },
    { key: 'langB4', label: 'Circumlocution (talking around a word)' },
    { key: 'langB5', label: 'Difficulty following complex conversation' },
    { key: 'langB6', label: 'Reduced reading comprehension' }
  ];

  // ── Section C: Wayfinding / visuospatial ──
  var VIS_ITEMS = [
    { key: 'visC1', label: 'Gets lost while driving somewhere familiar' },
    { key: 'visC2', label: 'Gets lost while driving somewhere unfamiliar' },
    { key: 'visC3', label: 'Gets lost while walking somewhere familiar' },
    { key: 'visC4', label: 'Gets lost while walking somewhere unfamiliar' },
    { key: 'visC5', label: 'Difficulty with maps / satnav / route planning' }
  ];

  var YN_COLS = ['Yes', 'No'];
  var YN_VALS = ['yes', 'no'];
  var FREQ_COLS = ['Daily', 'Weekly', 'Monthly', 'Occasional'];
  var FREQ_VALS = ['daily', 'weekly', 'monthly', 'occasional'];

  // ── Section F: Premorbid personality traits ──
  var PERSONALITY_ITEMS = [
    { key: 'persSocAnx',   label: 'Social anxiety' },
    { key: 'persInhib',    label: 'Inhibition/withdrawal' },
    { key: 'persPersist',  label: 'Persistence/perfectionism' },
    { key: 'persImpuls',   label: 'Impulsivity/risk-taking' },
    { key: 'persEmpathy',  label: 'Baseline empathy' }
  ];

  function render(container) {
    container.innerHTML = '';
    var card = document.createElement('div');
    card.className = 'instrument-card';

    card.innerHTML =
      '<h5>Semi-Structured Clinical Interview</h5>' +
      '<p class="instrument-subtitle">Brain Health Manchester — Clinician-completed interview covering cognitive symptoms, personal history, and background context.</p>';

    // ── Header identifiers ──
    var hdr = section('Interview Details', 'bi-card-heading');
    var r1 = row(4);
    r1.appendChild(wrapCol(F.createField({ label: 'Date', statePath: SP + '.interviewDate', type: 'date' }), 'col-md-3'));
    r1.appendChild(wrapCol(F.createField({ label: 'Clinician', statePath: SP + '.interviewer', placeholder: '' }), 'col-md-3'));
    r1.appendChild(wrapCol(F.createField({ label: 'Client', statePath: SP + '.clientName', placeholder: '' }), 'col-md-3'));
    r1.appendChild(wrapCol(F.createField({ label: 'NHS Number', statePath: SP + '.nhsNumber', placeholder: '' }), 'col-md-3'));
    hdr.appendChild(r1);
    var r2 = row(3);
    r2.appendChild(wrapCol(F.createField({ label: 'Informant', statePath: SP + '.informantName', placeholder: '' }), 'col-md-4'));
    r2.appendChild(wrapCol(F.createField({ label: 'Relationship', statePath: SP + '.informantRel', placeholder: '' }), 'col-md-4'));
    r2.appendChild(wrapCol(F.createField({ label: 'Informant Present', statePath: SP + '.informantPresent', type: 'select', options: ['', 'Yes', 'No', 'By phone'] }), 'col-md-4'));
    hdr.appendChild(r2);
    card.appendChild(hdr);

    // ══════════════════════════════════════
    // A. NEW LEARNING / MEMORY
    // ══════════════════════════════════════
    var secA = section('A. New Learning / Memory', 'bi-brain');
    secA.appendChild(subLabel('Tick where present. For frequency, tick one option.'));
    secA.appendChild(cogTable('mem', MEM_ITEMS));
    secA.appendChild(F.createField({ label: 'Examples / impact (optional)', statePath: SP + '.memoryNotes', type: 'textarea', rows: 2, placeholder: '' }));
    card.appendChild(secA);

    // ══════════════════════════════════════
    // B. WORD-FINDING / LANGUAGE
    // ══════════════════════════════════════
    var secB = section('B. Word-finding / Language', 'bi-chat-dots');
    secB.appendChild(cogTable('lang', LANG_ITEMS));
    var bExtras = row(3);
    bExtras.appendChild(wrapCol(F.createField({ label: 'Primary language', statePath: SP + '.primaryLanguage', placeholder: '' }), 'col-md-4'));
    bExtras.appendChild(wrapCol(F.createField({ label: 'Other languages', statePath: SP + '.otherLanguages', placeholder: '' }), 'col-md-4'));
    bExtras.appendChild(wrapCol(F.createField({ label: 'Any longstanding speech/language difficulty?', statePath: SP + '.langDifficulty', type: 'select', options: ['', 'No', 'Yes — dyslexia', 'Yes — ADHD', 'Yes — other'] }), 'col-md-4'));
    secB.appendChild(bExtras);
    var bExtras2 = row(2);
    bExtras2.appendChild(wrapCol(F.createField({ label: 'Hearing impairment?', statePath: SP + '.hearingImpairment', type: 'select', options: ['', 'No', 'Yes', 'Yes — with aids'] }), 'col-md-6'));
    bExtras2.appendChild(wrapCol(F.createField({ label: 'Details', statePath: SP + '.hearingDetails', placeholder: '' }), 'col-md-6'));
    secB.appendChild(bExtras2);
    secB.appendChild(F.createField({ label: 'Examples / Notes', statePath: SP + '.languageNotes', type: 'textarea', rows: 2 }));
    card.appendChild(secB);

    // ══════════════════════════════════════
    // C. WAYFINDING / VISUOSPATIAL
    // ══════════════════════════════════════
    var secC = section('C. Wayfinding / Visuospatial', 'bi-geo-alt');
    secC.appendChild(visTable());
    secC.appendChild(F.createField({ label: 'Examples (where/when, consequences)', statePath: SP + '.visuospatialNotes', type: 'textarea', rows: 2 }));
    card.appendChild(secC);

    // ══════════════════════════════════════
    // D. PERSONAL HISTORY (brief)
    // ══════════════════════════════════════
    var secD = section('D. Personal History (brief)', 'bi-person-lines-fill');
    var d1 = row(3);
    d1.appendChild(wrapCol(F.createField({ label: 'Place of birth', statePath: SP + '.birthPlace', placeholder: '' }), 'col-md-4'));
    d1.appendChild(wrapCol(F.createField({ label: 'Current living situation', statePath: SP + '.livingSituation', placeholder: 'e.g. Lives alone, with spouse' }), 'col-md-4'));
    d1.appendChild(wrapCol(F.createField({ label: 'Siblings (number/order)', statePath: SP + '.siblings', placeholder: '' }), 'col-md-4'));
    secD.appendChild(d1);
    var d2 = row(3);
    d2.appendChild(wrapCol(F.createField({ label: 'Significant migration history', statePath: SP + '.migration', type: 'select', options: ['', 'No', 'Yes'] }), 'col-md-4'));
    d2.appendChild(wrapCol(F.createField({ label: 'Migration details (if yes)', statePath: SP + '.migrationDetails', placeholder: '' }), 'col-md-4'));
    d2.appendChild(wrapCol(F.createField({ label: 'Father/primary carer occupation', statePath: SP + '.parentOccupation', placeholder: '' }), 'col-md-4'));
    secD.appendChild(d2);
    var d3 = row(3);
    d3.appendChild(wrapCol(F.createField({ label: 'Discipline at home', statePath: SP + '.discipline', type: 'select', options: ['', 'None', 'Typical', 'Harsh/strict', 'Other'] }), 'col-md-4'));
    d3.appendChild(wrapCol(F.createField({ label: 'History of abuse/trauma', statePath: SP + '.trauma', type: 'select', options: ['', 'No', 'Yes'] }), 'col-md-4'));
    d3.appendChild(wrapCol(F.createField({ label: 'Trauma details (if disclosed)', statePath: SP + '.traumaDetails', placeholder: 'Type/age' }), 'col-md-4'));
    secD.appendChild(d3);
    var d4 = row(3);
    d4.appendChild(wrapCol(F.createField({ label: 'Military service', statePath: SP + '.military', type: 'select', options: ['', 'No', 'Yes'] }), 'col-md-4'));
    d4.appendChild(wrapCol(F.createField({ label: 'Relationships / marriages', statePath: SP + '.relationships', placeholder: '' }), 'col-md-4'));
    d4.appendChild(wrapCol(F.createField({ label: 'Children', statePath: SP + '.children', placeholder: '' }), 'col-md-4'));
    secD.appendChild(d4);
    secD.appendChild(F.createField({ label: 'Key cultural/religious factors (if relevant)', statePath: SP + '.culturalFactors', placeholder: '' }));
    secD.appendChild(F.createField({ label: 'Other key life events', statePath: SP + '.otherLifeEvents', type: 'textarea', rows: 2, placeholder: '' }));
    card.appendChild(secD);

    // ══════════════════════════════════════
    // E. HEAD INJURY
    // ══════════════════════════════════════
    var secE = section('E. Head Injury', 'bi-bandaid');
    var e1 = row(3);
    e1.appendChild(wrapCol(F.createField({ label: 'Any head injury?', statePath: SP + '.headInjury', type: 'select', options: ['', 'No', 'Yes'] }), 'col-md-4'));
    e1.appendChild(wrapCol(F.createField({ label: 'Contact sports history?', statePath: SP + '.contactSports', type: 'select', options: ['', 'No', 'Yes'] }), 'col-md-4'));
    e1.appendChild(wrapCol(F.createField({ label: 'Sport / years', statePath: SP + '.contactSportsDetails', placeholder: '' }), 'col-md-4'));
    secE.appendChild(e1);
    secE.appendChild(subLabel('Most significant injury (if any)'));
    var e2 = row(3);
    e2.appendChild(wrapCol(F.createField({ label: 'Date/age', statePath: SP + '.headInjuryDate', placeholder: '' }), 'col-md-4'));
    e2.appendChild(wrapCol(F.createField({ label: 'Mechanism', statePath: SP + '.headInjuryMech', placeholder: 'e.g. Fall, RTA' }), 'col-md-4'));
    e2.appendChild(wrapCol(F.createField({ label: 'Loss of consciousness', statePath: SP + '.headInjuryLOC', type: 'select', options: ['', 'No', 'Yes — <1 min', 'Yes — 1-30 min', 'Yes — >30 min'] }), 'col-md-4'));
    secE.appendChild(e2);
    var e3 = row(3);
    e3.appendChild(wrapCol(F.createField({ label: 'Post-traumatic amnesia', statePath: SP + '.headInjuryPTA', type: 'select', options: ['', 'No', 'Yes — <1 hr', 'Yes — 1-24 hr', 'Yes — >24 hr'] }), 'col-md-4'));
    e3.appendChild(wrapCol(F.createField({ label: 'Repeated concussions', statePath: SP + '.repeatedConcussions', type: 'select', options: ['', 'No', 'Yes'] }), 'col-md-4'));
    e3.appendChild(wrapCol(F.createField({ label: 'Approx. number', statePath: SP + '.concussionCount', type: 'number', min: 0 }), 'col-md-4'));
    secE.appendChild(e3);
    secE.appendChild(F.createField({ label: 'Ongoing symptoms attributed to head injury', statePath: SP + '.headInjuryOngoing', type: 'textarea', rows: 2, placeholder: '' }));
    var e4 = row(1);
    e4.appendChild(wrapCol(F.createField({ label: 'Anticoagulants/bleed risk at time?', statePath: SP + '.anticoagulants', type: 'select', options: ['', 'No', 'Yes', 'Unknown'] }), 'col-md-4'));
    secE.appendChild(e4);
    card.appendChild(secE);

    // ══════════════════════════════════════
    // F. PREMORBID PERSONALITY
    // ══════════════════════════════════════
    var secF = section('F. Premorbid Personality (clinician-rated)', 'bi-person-check');
    secF.appendChild(subLabel('Tick one per line'));
    secF.appendChild(personalityTable());
    var f1 = row(2);
    f1.appendChild(wrapCol(F.createField({ label: 'Handling conflict', statePath: SP + '.persConflict', type: 'select', options: ['', 'Avoidant', 'Direct', 'Escalates', 'Other'] }), 'col-md-6'));
    f1.appendChild(wrapCol(F.createField({ label: 'Baseline mood', statePath: SP + '.persMood', type: 'select', options: ['', 'Mostly positive', 'Neutral', 'Low/anxious'] }), 'col-md-6'));
    secF.appendChild(f1);
    var f2 = row(1);
    f2.appendChild(wrapCol(F.createField({ label: 'Baseline social engagement', statePath: SP + '.persSocial', type: 'select', options: ['', 'High', 'Typical', 'Low'] }), 'col-md-6'));
    secF.appendChild(f2);
    card.appendChild(secF);

    // ══════════════════════════════════════
    // G. EDUCATION AND OCCUPATION
    // ══════════════════════════════════════
    var secG = section('G. Education and Occupation', 'bi-mortarboard');
    var g1 = row(3);
    g1.appendChild(wrapCol(F.createField({ label: 'Academic performance (self-rating)', statePath: SP + '.academicPerf', type: 'select', options: ['', 'Top', 'Middle', 'Bottom'] }), 'col-md-4'));
    g1.appendChild(wrapCol(F.createField({ label: 'Age left school', statePath: SP + '.schoolLeaveAge', type: 'number', min: 10, max: 25 }), 'col-md-4'));
    g1.appendChild(wrapCol(F.createField({ label: 'Highest qualification', statePath: SP + '.highestQual', type: 'select', options: ['', 'None', 'GCSE/O-level', 'A-level', 'Degree', 'Postgrad', 'Other'] }), 'col-md-4'));
    secG.appendChild(g1);
    var g2 = row(3);
    g2.appendChild(wrapCol(F.createField({ label: 'Years of education', statePath: SP + '.yearsEdu', type: 'number', min: 0, max: 30 }), 'col-md-4'));
    g2.appendChild(wrapCol(F.createField({ label: 'Learning difficulties?', statePath: SP + '.learningDiff', type: 'select', options: ['', 'No', 'Yes — dyslexia', 'Yes — ADHD', 'Yes — other'] }), 'col-md-4'));
    g2.appendChild(wrapCol(F.createField({ label: 'Occupational status', statePath: SP + '.occStatus', type: 'select', options: ['', 'Employed', 'Retired', 'Unemployed', 'Sick leave', 'Other'] }), 'col-md-4'));
    secG.appendChild(g2);
    var g3 = row(3);
    g3.appendChild(wrapCol(F.createField({ label: 'First job after school', statePath: SP + '.firstJob', placeholder: '' }), 'col-md-4'));
    g3.appendChild(wrapCol(F.createField({ label: 'Peak occupation', statePath: SP + '.peakOccupation', placeholder: '' }), 'col-md-4'));
    g3.appendChild(wrapCol(F.createField({ label: 'Last job (if retired)', statePath: SP + '.lastJob', placeholder: '' }), 'col-md-4'));
    secG.appendChild(g3);
    var g4 = row(1);
    g4.appendChild(wrapCol(F.createField({ label: 'Work domain', statePath: SP + '.workDomain', type: 'select', options: ['', 'Manual', 'Clerical', 'Professional', 'Caring', 'Managerial', 'Other'] }), 'col-md-4'));
    secG.appendChild(g4);
    card.appendChild(secG);

    // ══════════════════════════════════════
    // H. SUBSTANCE USE
    // ══════════════════════════════════════
    var secH = section('H. Substance Use', 'bi-cup-straw');
    var h1 = row(3);
    h1.appendChild(wrapCol(F.createField({ label: 'Alcohol (current) — units/week', statePath: SP + '.alcUnitsWk', type: 'select', options: ['', 'None', '1-7', '8-14', '15-35', '>35'] }), 'col-md-4'));
    h1.appendChild(wrapCol(F.createField({ label: 'AUDIT completed?', statePath: SP + '.auditCompleted', type: 'select', options: ['', 'No', 'Yes'] }), 'col-md-4'));
    h1.appendChild(wrapCol(F.createField({ label: 'AUDIT score (if known)', statePath: SP + '.auditScore', type: 'number', min: 0, max: 40 }), 'col-md-4'));
    secH.appendChild(h1);
    var h2 = row(2);
    h2.appendChild(wrapCol(F.createField({ label: 'Alcohol (past)', statePath: SP + '.alcPast', type: 'select', options: ['', 'No concerns', 'Past harmful use'] }), 'col-md-6'));
    h2.appendChild(wrapCol(F.createField({ label: 'Past use details', statePath: SP + '.alcPastDetails', placeholder: '' }), 'col-md-6'));
    secH.appendChild(h2);
    var h3 = row(3);
    h3.appendChild(wrapCol(F.createField({ label: 'Tobacco', statePath: SP + '.tobacco', type: 'select', options: ['', 'Never', 'Ex-smoker', 'Current'] }), 'col-md-4'));
    h3.appendChild(wrapCol(F.createField({ label: 'Packs/day', statePath: SP + '.tobaccoPacks', placeholder: '' }), 'col-md-4'));
    h3.appendChild(wrapCol(F.createField({ label: 'Years smoking', statePath: SP + '.tobaccoYears', placeholder: '' }), 'col-md-4'));
    secH.appendChild(h3);
    var h4 = row(2);
    h4.appendChild(wrapCol(F.createField({ label: 'Cannabis', statePath: SP + '.cannabis', type: 'select', options: ['', 'Never', 'Past', 'Current — daily', 'Current — weekly', 'Current — monthly', 'Current — occasional'] }), 'col-md-6'));
    h4.appendChild(wrapCol(F.createField({ label: 'Other substances', statePath: SP + '.otherSubstances', type: 'select', options: ['', 'None', 'Stimulants', 'Opiates', 'Sedatives', 'Other'] }), 'col-md-6'));
    secH.appendChild(h4);
    var h5 = row(2);
    h5.appendChild(wrapCol(F.createField({ label: 'Caffeine cups/day', statePath: SP + '.caffeine', placeholder: '' }), 'col-md-6'));
    h5.appendChild(wrapCol(F.createField({ label: 'Substance-related harms', statePath: SP + '.substanceHarms', type: 'select', options: ['', 'No', 'Yes — falls', 'Yes — driving', 'Yes — withdrawal', 'Yes — other'] }), 'col-md-6'));
    secH.appendChild(h5);
    secH.appendChild(F.createField({ label: 'Substance use notes', statePath: SP + '.substanceNotes', type: 'textarea', rows: 2 }));
    card.appendChild(secH);

    // ══════════════════════════════════════
    // I. OTHER COMMENTS / CLINICIAN NOTES
    // ══════════════════════════════════════
    var secI = section('I. Other Comments / Clinician Notes', 'bi-pencil-square');
    secI.appendChild(F.createField({ label: 'Key positives / concerns', statePath: SP + '.keyPositives', type: 'textarea', rows: 3, placeholder: 'Key positive findings, onset patterns, impressions' }));
    secI.appendChild(F.createField({ label: 'Safety concerns', statePath: SP + '.safetyConcerns', type: 'textarea', rows: 2, placeholder: 'Any immediate safety or risk issues' }));
    card.appendChild(secI);

    container.appendChild(card);
  }

  // ── Cognitive symptom table (A & B) — Y/N + frequency + onset per item ──
  function cogTable(prefix, items) {
    var wrap = document.createElement('div');
    wrap.className = 'table-responsive';
    var t = document.createElement('table');
    t.className = 'cdr-worksheet-table';
    t.style.width = '100%';

    // Header
    var thead = document.createElement('thead');
    var hr = document.createElement('tr');
    ['Item', 'Y/N', 'Daily', 'Weekly', 'Monthly', 'Occasional', 'Onset (approx)'].forEach(function (h) {
      var th = document.createElement('th');
      th.textContent = h;
      th.style.padding = '6px 8px';
      th.style.fontSize = '0.82rem';
      if (h === 'Item') th.style.minWidth = '220px';
      if (h === 'Onset (approx)') th.style.minWidth = '120px';
      hr.appendChild(th);
    });
    thead.appendChild(hr);
    t.appendChild(thead);

    var tbody = document.createElement('tbody');
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      var tr = document.createElement('tr');

      // Label
      var tdL = document.createElement('td');
      tdL.textContent = item.label;
      tdL.style.fontSize = '0.84rem';
      tdL.style.padding = '5px 8px';
      tr.appendChild(tdL);

      // Y/N buttons
      var tdYN = document.createElement('td');
      tdYN.style.textAlign = 'center';
      tdYN.appendChild(makeToggle(item.key, YN_VALS, YN_COLS));
      tr.appendChild(tdYN);

      // Frequency buttons
      for (var f = 0; f < FREQ_VALS.length; f++) {
        var tdF = document.createElement('td');
        tdF.style.textAlign = 'center';
        tdF.appendChild(makeRadioBtn(item.key + '_freq', FREQ_VALS[f], FREQ_COLS[f].charAt(0)));
        tr.appendChild(tdF);
      }

      // Onset field
      var tdO = document.createElement('td');
      var inp = document.createElement('input');
      inp.type = 'text';
      inp.className = 'rbans-input';
      inp.style.width = '100%';
      inp.placeholder = '';
      var curOnset = BHM.State.get(SP + '.' + item.key + '_onset');
      if (curOnset) inp.value = curOnset;
      inp.addEventListener('input', (function (k) { return function () { BHM.State.set(SP + '.' + k + '_onset', this.value); }; })(item.key));
      tdO.appendChild(inp);
      tr.appendChild(tdO);

      tbody.appendChild(tr);
    }
    t.appendChild(tbody);
    wrap.appendChild(t);
    return wrap;
  }

  // ── Visuospatial table (C) — Present / Stopped / Safety concern / Onset ──
  function visTable() {
    var wrap = document.createElement('div');
    wrap.className = 'table-responsive';
    var t = document.createElement('table');
    t.className = 'cdr-worksheet-table';
    t.style.width = '100%';

    var thead = document.createElement('thead');
    var hr = document.createElement('tr');
    ['Situation', 'Present', 'Stopped', 'Safety concern', 'Onset'].forEach(function (h) {
      var th = document.createElement('th');
      th.textContent = h;
      th.style.padding = '6px 8px';
      th.style.fontSize = '0.82rem';
      if (h === 'Situation') th.style.minWidth = '260px';
      hr.appendChild(th);
    });
    thead.appendChild(hr);
    t.appendChild(thead);

    var tbody = document.createElement('tbody');
    for (var i = 0; i < VIS_ITEMS.length; i++) {
      var item = VIS_ITEMS[i];
      var tr = document.createElement('tr');

      var tdL = document.createElement('td');
      tdL.textContent = item.label;
      tdL.style.fontSize = '0.84rem';
      tdL.style.padding = '5px 8px';
      tr.appendChild(tdL);

      // Present / Stopped / Safety — each is a checkbox
      ['_present', '_stopped', '_safety'].forEach(function (suffix) {
        var td = document.createElement('td');
        td.style.textAlign = 'center';
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'form-check-input';
        cb.style.width = '20px';
        cb.style.height = '20px';
        var cur = BHM.State.get(SP + '.' + item.key + suffix);
        if (cur === 'yes') cb.checked = true;
        cb.addEventListener('change', (function (k, suf) {
          return function () { BHM.State.set(SP + '.' + k + suf, this.checked ? 'yes' : 'no'); };
        })(item.key, suffix));
        td.appendChild(cb);
        tr.appendChild(td);
      });

      // Onset text
      var tdO = document.createElement('td');
      var inp = document.createElement('input');
      inp.type = 'text';
      inp.className = 'rbans-input';
      inp.style.width = '100%';
      var curO = BHM.State.get(SP + '.' + item.key + '_onset');
      if (curO) inp.value = curO;
      inp.addEventListener('input', (function (k) { return function () { BHM.State.set(SP + '.' + k + '_onset', this.value); }; })(item.key));
      tdO.appendChild(inp);
      tr.appendChild(tdO);

      tbody.appendChild(tr);
    }
    t.appendChild(tbody);
    wrap.appendChild(t);
    return wrap;
  }

  // ── Personality table (F) — Low / Typical / High per item ──
  function personalityTable() {
    var wrap = document.createElement('div');
    wrap.className = 'table-responsive';
    var t = document.createElement('table');
    t.className = 'cdr-worksheet-table';
    t.style.width = '100%';

    var thead = document.createElement('thead');
    var hr = document.createElement('tr');
    ['Trait', 'Low', 'Typical', 'High / marked'].forEach(function (h) {
      var th = document.createElement('th');
      th.textContent = h;
      th.style.padding = '6px 8px';
      th.style.fontSize = '0.82rem';
      if (h === 'Trait') th.style.minWidth = '200px';
      hr.appendChild(th);
    });
    thead.appendChild(hr);
    t.appendChild(thead);

    var tbody = document.createElement('tbody');
    var vals = ['low', 'typical', 'high'];
    for (var i = 0; i < PERSONALITY_ITEMS.length; i++) {
      var item = PERSONALITY_ITEMS[i];
      var tr = document.createElement('tr');
      var tdL = document.createElement('td');
      tdL.textContent = item.label;
      tdL.style.fontSize = '0.84rem';
      tdL.style.padding = '5px 8px';
      tr.appendChild(tdL);
      for (var v = 0; v < vals.length; v++) {
        var td = document.createElement('td');
        td.style.textAlign = 'center';
        td.appendChild(makeRadioBtn(item.key, vals[v], ''));
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    t.appendChild(tbody);
    wrap.appendChild(t);
    return wrap;
  }

  // ── UI helpers ──
  function makeToggle(key, vals, labels) {
    var grp = document.createElement('div');
    grp.className = 'btn-group btn-group-sm';
    for (var i = 0; i < vals.length; i++) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline-secondary btn-sm';
      btn.textContent = labels[i];
      btn.style.fontSize = '0.78rem';
      btn.style.padding = '2px 8px';
      var cur = BHM.State.get(SP + '.' + key);
      if (cur === vals[i]) btn.classList.add('active', vals[i] === 'yes' ? 'btn-primary' : 'btn-secondary');
      btn.addEventListener('click', (function (k, v, g) {
        return function () {
          BHM.State.set(SP + '.' + k, v);
          var btns = g.querySelectorAll('.btn');
          for (var j = 0; j < btns.length; j++) { btns[j].classList.remove('active', 'btn-primary', 'btn-secondary'); btns[j].classList.add('btn-outline-secondary'); }
          this.classList.remove('btn-outline-secondary');
          this.classList.add('active', v === 'yes' ? 'btn-primary' : 'btn-secondary');
        };
      })(key, vals[i], grp));
      grp.appendChild(btn);
    }
    return grp;
  }

  function makeRadioBtn(key, val, label) {
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-outline-secondary btn-sm';
    btn.textContent = label || '\u25CB';
    btn.style.fontSize = '0.75rem';
    btn.style.padding = '1px 6px';
    btn.style.borderRadius = '50%';
    btn.style.width = '26px';
    btn.style.height = '26px';
    var cur = BHM.State.get(SP + '.' + key);
    if (cur === val) { btn.classList.remove('btn-outline-secondary'); btn.classList.add('btn-primary', 'active'); }
    btn.addEventListener('click', (function (k, v) {
      return function () {
        // Deselect siblings
        var parent = this.parentNode.parentNode;
        var allBtns = parent.querySelectorAll('.btn');
        // Actually just deselect freq siblings in same row
        var row = this.closest('tr');
        if (row) {
          var rBtns = row.querySelectorAll('td .btn.active');
          // Only deselect same-key group (frequency only)
          var myTd = this.closest('td');
          if (myTd) {
            var rowTds = row.querySelectorAll('td');
            // Determine if this is a frequency column (cols 2-5)
            var tdIdx = Array.prototype.indexOf.call(rowTds, myTd);
            if (tdIdx >= 2 && tdIdx <= 5) {
              for (var t = 2; t <= 5; t++) {
                var b = rowTds[t] ? rowTds[t].querySelector('.btn') : null;
                if (b) { b.classList.remove('btn-primary', 'active'); b.classList.add('btn-outline-secondary'); }
              }
            }
          }
        }
        BHM.State.set(SP + '.' + k, v);
        this.classList.remove('btn-outline-secondary');
        this.classList.add('btn-primary', 'active');
      };
    })(key, val));
    return btn;
  }

  function section(title, icon) {
    var div = document.createElement('div');
    div.className = 'mt-4';
    div.innerHTML = '<h6 class="text-primary"><i class="bi ' + icon + ' me-1"></i>' + title + '</h6>';
    return div;
  }

  function subLabel(text) {
    var div = document.createElement('div');
    div.className = 'mb-2';
    div.innerHTML = '<span style="font-size:0.84rem;color:#6c757d">' + text + '</span>';
    return div;
  }

  function row() {
    var div = document.createElement('div');
    div.className = 'row g-3 mb-2';
    return div;
  }

  function wrapCol(el, colClass) {
    var col = document.createElement('div');
    col.className = colClass;
    col.appendChild(el);
    return col;
  }

  // Public getters for report generation
  function getMemItems() { return MEM_ITEMS; }
  function getLangItems() { return LANG_ITEMS; }
  function getVisItems() { return VIS_ITEMS; }
  function getPersonalityItems() { return PERSONALITY_ITEMS; }

  return {
    render: render,
    getMemItems: getMemItems,
    getLangItems: getLangItems,
    getVisItems: getVisItems,
    getPersonalityItems: getPersonalityItems
  };
})();

/* ── rbansNorms.js ── */
/* RBANS Normative Lookup Tables
   Extracted from rbanscalc.html
   ============================================================= */
var BHM = window.BHM || {};

BHM.RBANSNorms = (function () {
  'use strict';

  function GetZPercent(z) {

            // z == number of standard deviations from the mean

            // if z is greater than 6.5 standard deviations from the mean the
            // number of significant digits will be outside of a reasonable range

            if (z < -6.5) {
                return 0.0;
            }

            if (z > 6.5) {
                return 1.0;
            }

            var factK = 1;
            var sum = 0;
            var term = 1;
            var k = 0;
            var loopStop = Math.exp(-23);

            while (Math.abs(term) > loopStop) {
                term = .3989422804 * Math.pow(-1, k) * Math.pow(z, k) / (2 * k + 1) / Math.pow(2, k) * Math.pow(z, k + 1) / factK;
                sum += term;
                k++;
                factK *= k;
            }

            sum += 0.5;

            return sum;
        }

  var immediate50 = [
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [44, 44, 44, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 65, 73, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 65, 73, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 65, 73, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 65, 73, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [49, 49, 49, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 69, 76, 78, 83, 83, 83, 83, 83, 87, 94, 100],
            [49, 49, 49, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 69, 76, 78, 83, 83, 83, 83, 83, 87, 94, 100],
            [53, 53, 53, 53, 53, 57, 57, 57, 61, 61, 65, 65, 69, 73, 73, 78, 81, 85, 85, 85, 85, 85, 90, 97, 103],
            [53, 53, 53, 53, 53, 57, 57, 57, 61, 61, 65, 65, 69, 73, 73, 78, 81, 85, 85, 85, 85, 85, 90, 97, 103],
            [53, 53, 53, 53, 53, 57, 57, 57, 61, 61, 65, 65, 69, 73, 73, 78, 81, 85, 85, 85, 85, 85, 90, 97, 103],
            [57, 57, 57, 57, 57, 61, 61, 61, 65, 65, 69, 69, 73, 76, 76, 81, 83, 87, 87, 87, 87, 87, 94, 100, 106],
            [61, 61, 61, 61, 61, 65, 65, 65, 69, 69, 73, 73, 76, 78, 78, 83, 85, 90, 90, 90, 90, 90, 97, 103, 109],
            [61, 61, 61, 61, 61, 65, 65, 65, 69, 69, 73, 73, 76, 78, 78, 83, 85, 90, 90, 90, 90, 90, 97, 103, 109],
            [65, 65, 65, 65, 65, 69, 69, 69, 73, 73, 76, 76, 78, 81, 81, 85, 87, 94, 94, 94, 94, 94, 100, 106, 112],
            [69, 69, 69, 69, 69, 73, 73, 73, 76, 76, 78, 78, 81, 83, 83, 87, 90, 97, 97, 97, 97, 97, 103, 109, 114],
            [73, 73, 73, 73, 73, 76, 76, 76, 78, 78, 81, 81, 83, 85, 85, 90, 94, 100, 100, 100, 100, 100, 106, 112, 117],
            [76, 76, 76, 76, 76, 78, 78, 78, 81, 81, 83, 83, 85, 87, 87, 94, 97, 103, 103, 103, 103, 103, 109, 114, 120],
            [76, 76, 76, 76, 76, 78, 78, 78, 81, 81, 83, 83, 85, 87, 87, 94, 97, 103, 103, 103, 103, 103, 109, 114, 120],
            [78, 78, 78, 78, 78, 81, 81, 81, 83, 83, 85, 85, 87, 90, 90, 97, 100, 106, 106, 106, 106, 106, 112, 117, 123],
            [81, 81, 81, 81, 81, 83, 83, 83, 85, 85, 87, 87, 90, 94, 94, 100, 103, 109, 109, 109, 109, 109, 114, 120, 126],
            [81, 81, 81, 81, 81, 83, 83, 83, 85, 85, 87, 87, 90, 94, 94, 100, 103, 109, 109, 109, 109, 109, 114, 120, 126],
            [81, 81, 81, 81, 81, 83, 83, 83, 85, 85, 87, 87, 90, 94, 94, 100, 103, 109, 109, 109, 109, 109, 114, 120, 126],
            [83, 83, 83, 83, 83, 85, 85, 85, 87, 87, 90, 90, 94, 97, 97, 103, 106, 112, 112, 112, 112, 112, 117, 123, 129],
            [85, 85, 85, 85, 85, 87, 87, 87, 90, 90, 94, 94, 97, 100, 100, 106, 109, 114, 114, 114, 114, 114, 120, 126, 132],
            [87, 87, 87, 87, 87, 90, 90, 90, 94, 94, 97, 97, 100, 103, 103, 109, 112, 117, 117, 117, 117, 117, 123, 129, 136],
            [87, 87, 87, 87, 87, 90, 90, 90, 94, 94, 97, 97, 100, 103, 103, 109, 112, 117, 117, 117, 117, 117, 123, 129, 136],
            [90, 90, 90, 90, 90, 94, 94, 94, 97, 97, 100, 100, 103, 106, 106, 112, 114, 120, 120, 120, 120, 120, 126, 132, 140],
            [94, 94, 94, 94, 94, 97, 97, 97, 100, 100, 103, 103, 106, 109, 109, 114, 117, 123, 123, 123, 123, 123, 129, 136, 144],
            [97, 97, 97, 97, 97, 100, 100, 100, 103, 103, 106, 106, 109, 112, 112, 117, 120, 126, 126, 126, 126, 126, 132, 140, 148],
            [100, 100, 100, 100, 100, 103, 103, 103, 106, 106, 109, 109, 112, 114, 114, 120, 123, 129, 129, 129, 129, 129, 136, 144, 152]];

  var immediate60 = [
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 40, 44, 44, 44, 49, 49, 53, 53, 57, 61, 61, 69, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [44, 44, 44, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 65, 73, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 65, 73, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 65, 73, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 65, 73, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [49, 49, 49, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 69, 76, 78, 83, 83, 83, 83, 83, 87, 94, 100],
            [49, 49, 49, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 69, 76, 78, 83, 83, 83, 83, 83, 87, 94, 100],
            [49, 49, 49, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 69, 76, 78, 83, 83, 83, 83, 83, 87, 94, 100],
            [53, 53, 53, 53, 53, 57, 57, 57, 61, 61, 65, 65, 69, 73, 73, 78, 81, 85, 85, 85, 85, 85, 90, 97, 103],
            [53, 53, 53, 53, 53, 57, 57, 57, 61, 61, 65, 65, 69, 73, 73, 78, 81, 85, 85, 85, 85, 85, 90, 97, 103],
            [53, 53, 53, 53, 53, 57, 57, 57, 61, 61, 65, 65, 69, 73, 73, 78, 81, 85, 85, 85, 85, 85, 90, 97, 103],
            [57, 57, 57, 57, 57, 61, 61, 61, 65, 65, 69, 69, 73, 76, 76, 81, 83, 87, 87, 87, 87, 87, 94, 100, 106],
            [61, 61, 61, 61, 61, 65, 65, 65, 69, 69, 73, 73, 76, 78, 78, 83, 85, 90, 90, 90, 90, 90, 97, 103, 109],
            [61, 61, 61, 61, 61, 65, 65, 65, 69, 69, 73, 73, 76, 78, 78, 83, 85, 90, 90, 90, 90, 90, 97, 103, 109],
            [65, 65, 65, 65, 65, 69, 69, 69, 73, 73, 76, 76, 78, 81, 81, 85, 87, 94, 94, 94, 94, 94, 100, 106, 112],
            [69, 69, 69, 69, 69, 73, 73, 73, 76, 76, 78, 78, 81, 83, 83, 87, 90, 97, 97, 97, 97, 97, 103, 109, 114],
            [73, 73, 73, 73, 73, 76, 76, 76, 78, 78, 81, 81, 83, 85, 85, 90, 94, 100, 100, 100, 100, 100, 106, 112, 117],
            [76, 76, 76, 76, 76, 78, 78, 78, 81, 81, 83, 83, 85, 87, 87, 94, 97, 103, 103, 103, 103, 103, 109, 114, 120],
            [78, 78, 78, 78, 78, 81, 81, 81, 83, 83, 85, 85, 87, 90, 90, 97, 100, 106, 106, 106, 106, 106, 112, 117, 123],
            [78, 78, 78, 78, 78, 81, 81, 81, 83, 83, 85, 85, 87, 90, 90, 97, 100, 106, 106, 106, 106, 106, 112, 117, 123],
            [81, 81, 81, 81, 81, 83, 83, 83, 85, 85, 87, 87, 90, 94, 94, 100, 103, 109, 109, 109, 109, 109, 114, 120, 126],
            [81, 81, 81, 81, 81, 83, 83, 83, 85, 85, 87, 87, 90, 94, 94, 100, 103, 109, 109, 109, 109, 109, 114, 120, 126],
            [81, 81, 81, 81, 81, 83, 83, 83, 85, 85, 87, 87, 90, 94, 94, 100, 103, 109, 109, 109, 109, 109, 114, 120, 126],
            [83, 83, 83, 83, 83, 85, 85, 85, 87, 87, 90, 90, 94, 97, 97, 103, 106, 112, 112, 112, 112, 112, 117, 123, 129],
            [85, 85, 85, 85, 85, 87, 87, 87, 90, 90, 94, 94, 97, 100, 100, 106, 109, 114, 114, 114, 114, 114, 120, 126, 132],
            [87, 87, 87, 87, 87, 90, 90, 90, 94, 94, 97, 97, 100, 103, 103, 109, 112, 117, 117, 117, 117, 117, 123, 129, 136],
            [90, 90, 90, 90, 90, 94, 94, 94, 97, 97, 100, 100, 103, 106, 106, 112, 114, 120, 120, 120, 120, 120, 126, 132, 140],
            [94, 94, 94, 94, 94, 97, 97, 97, 100, 100, 103, 103, 106, 109, 109, 114, 117, 123, 123, 123, 123, 123, 129, 136, 144],
            [94, 94, 94, 94, 94, 97, 97, 97, 100, 100, 103, 103, 106, 109, 109, 114, 117, 123, 123, 123, 123, 123, 129, 136, 144],
            [97, 97, 97, 97, 97, 100, 100, 100, 103, 103, 106, 106, 109, 112, 112, 117, 120, 126, 126, 126, 126, 126, 132, 140, 148],
            [100, 100, 100, 100, 100, 103, 103, 103, 106, 106, 109, 109, 112, 114, 114, 120, 123, 129, 129, 129, 129, 129, 136, 144, 152]];

  var immediate70 = [
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [40, 40, 40, 40, 44, 49, 49, 49, 53, 53, 57, 57, 61, 65, 69, 73, 73, 78, 78, 78, 78, 78, 83, 87, 94],
            [44, 44, 44, 44, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 73, 76, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 73, 76, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 73, 76, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [44, 44, 44, 44, 49, 53, 53, 53, 57, 57, 61, 61, 65, 69, 73, 76, 76, 81, 81, 81, 81, 81, 85, 90, 97],
            [49, 49, 49, 49, 53, 57, 57, 57, 61, 61, 65, 65, 69, 73, 76, 78, 78, 83, 83, 83, 83, 83, 87, 94, 100],
            [49, 49, 49, 49, 53, 57, 57, 57, 61, 61, 65, 65, 69, 73, 76, 78, 78, 83, 83, 83, 83, 83, 87, 94, 100],
            [53, 53, 53, 53, 57, 61, 61, 61, 65, 65, 69, 69, 73, 76, 78, 81, 81, 85, 85, 85, 85, 85, 90, 97, 103],
            [53, 53, 53, 53, 57, 61, 61, 61, 65, 65, 69, 69, 73, 76, 78, 81, 81, 85, 85, 85, 85, 85, 90, 97, 103],
            [57, 57, 57, 57, 61, 65, 65, 65, 69, 69, 73, 73, 76, 78, 81, 83, 83, 87, 87, 87, 87, 87, 94, 100, 106],
            [61, 61, 61, 61, 65, 69, 69, 69, 73, 73, 76, 76, 78, 81, 83, 85, 85, 90, 90, 90, 90, 90, 97, 103, 109],
            [61, 61, 61, 61, 65, 69, 69, 69, 73, 73, 76, 76, 78, 81, 85, 87, 87, 94, 94, 94, 94, 94, 100, 106, 112],
            [65, 65, 65, 65, 69, 73, 73, 73, 76, 76, 78, 78, 81, 83, 85, 87, 87, 94, 94, 94, 94, 94, 100, 106, 112],
            [65, 65, 65, 65, 69, 73, 73, 73, 76, 76, 78, 78, 81, 83, 85, 87, 87, 94, 94, 94, 94, 94, 100, 106, 112],
            [69, 69, 69, 69, 73, 76, 76, 76, 78, 78, 81, 81, 83, 85, 87, 90, 90, 97, 97, 97, 97, 97, 103, 109, 114],
            [73, 73, 73, 73, 76, 78, 78, 78, 81, 81, 83, 83, 85, 87, 90, 94, 94, 100, 100, 100, 100, 100, 106, 112, 117],
            [73, 73, 73, 73, 76, 78, 78, 78, 81, 81, 83, 83, 85, 87, 90, 94, 94, 100, 100, 100, 100, 100, 106, 112, 117],
            [76, 76, 76, 76, 78, 81, 81, 81, 83, 83, 85, 85, 87, 90, 94, 97, 97, 103, 103, 103, 103, 103, 109, 114, 120],
            [78, 78, 78, 78, 81, 83, 83, 83, 85, 85, 87, 87, 90, 94, 97, 100, 100, 106, 106, 106, 106, 106, 112, 117, 123],
            [78, 78, 78, 78, 81, 83, 83, 83, 85, 85, 87, 87, 90, 94, 97, 100, 100, 106, 106, 106, 106, 106, 112, 117, 123],
            [81, 81, 81, 81, 83, 85, 85, 85, 87, 87, 90, 90, 94, 97, 100, 103, 103, 109, 109, 109, 109, 109, 114, 120, 126],
            [81, 81, 81, 81, 83, 85, 85, 85, 87, 87, 90, 90, 94, 97, 100, 103, 103, 109, 109, 109, 109, 109, 114, 120, 126],
            [83, 83, 83, 83, 85, 87, 87, 87, 90, 90, 94, 94, 97, 100, 103, 106, 106, 112, 112, 112, 112, 112, 117, 123, 129],
            [85, 85, 85, 85, 87, 90, 90, 90, 94, 94, 97, 97, 100, 103, 106, 109, 109, 114, 114, 114, 114, 114, 120, 126, 132],
            [87, 87, 87, 87, 90, 94, 94, 94, 97, 97, 100, 100, 103, 106, 109, 112, 112, 117, 117, 117, 117, 117, 123, 129, 136],
            [87, 87, 87, 87, 90, 94, 94, 94, 97, 97, 100, 100, 103, 106, 109, 112, 112, 117, 117, 117, 117, 117, 123, 129, 136],
            [90, 90, 90, 90, 94, 97, 97, 97, 100, 100, 103, 103, 106, 109, 112, 114, 114, 120, 120, 120, 120, 120, 126, 132, 140],
            [90, 90, 90, 90, 94, 97, 97, 97, 100, 100, 106, 106, 106, 109, 112, 114, 114, 120, 120, 120, 120, 120, 126, 132, 140],
            [94, 94, 94, 94, 97, 100, 100, 100, 103, 103, 106, 106, 109, 112, 114, 117, 117, 123, 123, 123, 123, 123, 129, 136, 144],
            [97, 97, 97, 97, 100, 103, 103, 103, 106, 106, 109, 109, 112, 114, 117, 120, 120, 126, 126, 126, 126, 126, 132, 140, 148],
            [97, 97, 97, 97, 100, 103, 103, 103, 106, 106, 109, 109, 112, 114, 117, 120, 120, 126, 126, 126, 126, 126, 132, 140, 148],
            [100, 100, 100, 100, 103, 106, 106, 106, 109, 109, 112, 112, 114, 117, 120, 123, 123, 129, 129, 129, 129, 129, 136, 144, 152]];

  var immediate80 = [
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [40, 40, 44, 44, 49, 49, 49, 53, 53, 57, 57, 61, 69, 73, 73, 76, 76, 78, 81, 83, 83, 85, 87, 90, 94],
            [44, 44, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 73, 76, 76, 78, 78, 81, 83, 85, 85, 87, 90, 94, 97],
            [44, 44, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 73, 76, 76, 78, 78, 81, 83, 85, 85, 87, 90, 94, 97],
            [44, 44, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 73, 76, 76, 78, 78, 81, 83, 85, 85, 87, 90, 94, 97],
            [44, 44, 49, 49, 53, 53, 53, 57, 57, 61, 61, 65, 73, 76, 76, 78, 78, 81, 83, 85, 85, 87, 90, 94, 97],
            [49, 49, 53, 53, 57, 57, 57, 61, 61, 65, 65, 69, 76, 78, 78, 81, 81, 83, 85, 87, 87, 90, 94, 97, 100],
            [49, 49, 53, 53, 57, 57, 57, 61, 61, 65, 65, 69, 76, 78, 78, 81, 81, 83, 85, 87, 87, 90, 94, 97, 100],
            [53, 53, 57, 57, 61, 61, 61, 65, 65, 69, 69, 73, 78, 81, 81, 83, 83, 85, 87, 90, 90, 94, 97, 100, 103],
            [57, 57, 61, 61, 65, 65, 65, 69, 69, 73, 73, 76, 81, 83, 83, 85, 85, 87, 90, 94, 94, 97, 100, 103, 106],
            [61, 61, 65, 65, 69, 69, 69, 73, 73, 76, 76, 78, 83, 85, 85, 87, 87, 90, 94, 97, 97, 100, 103, 106, 109],
            [61, 61, 65, 65, 69, 69, 69, 73, 73, 76, 76, 78, 83, 85, 85, 87, 87, 90, 94, 97, 97, 100, 103, 106, 109],
            [65, 65, 69, 69, 73, 73, 73, 76, 76, 78, 78, 81, 85, 87, 87, 90, 90, 94, 97, 100, 100, 103, 106, 109, 112],
            [69, 69, 73, 73, 76, 76, 76, 78, 78, 81, 81, 83, 87, 90, 90, 94, 94, 97, 100, 103, 103, 106, 109, 112, 114],
            [73, 73, 76, 76, 78, 78, 78, 81, 81, 83, 83, 85, 90, 94, 94, 97, 97, 100, 103, 106, 106, 109, 112, 114, 117],
            [73, 73, 76, 76, 78, 78, 78, 81, 81, 83, 83, 85, 90, 94, 94, 97, 97, 100, 103, 106, 106, 109, 112, 114, 117],
            [76, 76, 78, 78, 81, 81, 81, 83, 83, 85, 85, 87, 94, 97, 97, 100, 100, 103, 106, 109, 109, 112, 114, 117, 120],
            [78, 78, 81, 81, 83, 83, 83, 85, 85, 87, 87, 90, 97, 100, 100, 103, 103, 106, 109, 112, 112, 114, 117, 120, 123],
            [78, 78, 81, 81, 83, 83, 83, 85, 85, 87, 87, 90, 97, 100, 100, 103, 103, 106, 109, 112, 112, 114, 117, 120, 123],
            [81, 81, 83, 83, 85, 85, 85, 87, 87, 90, 90, 94, 100, 103, 103, 106, 106, 109, 112, 114, 114, 117, 120, 123, 126],
            [83, 83, 85, 85, 87, 87, 87, 90, 90, 94, 94, 97, 103, 106, 106, 109, 109, 112, 114, 117, 117, 120, 123, 126, 129],
            [83, 83, 85, 85, 87, 87, 87, 90, 90, 94, 94, 97, 103, 106, 106, 109, 109, 112, 114, 117, 117, 120, 123, 126, 129],
            [85, 85, 87, 87, 90, 90, 90, 94, 94, 97, 97, 100, 106, 109, 109, 112, 112, 114, 117, 120, 120, 123, 126, 129, 132],
            [85, 85, 87, 87, 90, 90, 90, 94, 94, 97, 97, 100, 106, 109, 109, 112, 112, 114, 117, 120, 120, 123, 126, 129, 132],
            [87, 87, 90, 90, 94, 94, 94, 97, 97, 100, 100, 103, 109, 112, 112, 114, 114, 117, 120, 123, 123, 126, 129, 132, 136],
            [87, 87, 90, 90, 94, 94, 94, 97, 97, 100, 100, 103, 109, 112, 112, 114, 114, 117, 120, 123, 123, 126, 129, 132, 136],
            [90, 90, 94, 94, 97, 97, 97, 100, 100, 103, 103, 106, 112, 114, 114, 117, 117, 120, 123, 126, 126, 129, 132, 136, 140],
            [90, 90, 94, 94, 97, 97, 97, 100, 100, 106, 106, 106, 112, 114, 114, 117, 117, 120, 123, 126, 126, 129, 132, 136, 140],
            [94, 94, 97, 97, 100, 100, 100, 103, 103, 106, 106, 109, 114, 117, 117, 120, 120, 123, 126, 129, 129, 132, 136, 140, 144],
            [94, 94, 97, 97, 100, 100, 100, 103, 103, 106, 106, 109, 114, 117, 117, 120, 120, 123, 126, 129, 129, 132, 136, 140, 144],
            [97, 97, 100, 100, 103, 103, 103, 106, 106, 109, 109, 112, 117, 120, 120, 123, 123, 126, 129, 132, 132, 136, 140, 144, 148],
            [97, 97, 100, 100, 103, 103, 103, 106, 106, 109, 109, 112, 117, 120, 120, 123, 123, 126, 129, 132, 132, 136, 140, 144, 148],
            [100, 100, 103, 103, 106, 106, 106, 109, 109, 112, 112, 114, 120, 123, 123, 126, 126, 129, 132, 136, 136, 140, 144, 148, 152],
            [100, 100, 103, 103, 106, 106, 106, 109, 109, 112, 112, 114, 120, 123, 123, 126, 126, 129, 132, 136, 136, 140, 144, 148, 152]];

  var visuo50 = [
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 53, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [53, 53, 53, 53, 53, 53, 56, 56, 58, 60, 62, 62, 64, 66, 66, 69, 72, 75, 81, 84, 87],
            [56, 56, 56, 56, 56, 56, 58, 58, 60, 62, 64, 64, 66, 69, 69, 72, 75, 78, 84, 87, 89],
            [58, 58, 58, 58, 58, 58, 60, 60, 62, 64, 66, 66, 69, 72, 72, 75, 78, 81, 87, 89, 92],
            [60, 60, 60, 60, 60, 60, 62, 62, 64, 66, 69, 69, 72, 75, 75, 78, 81, 84, 89, 92, 96],
            [62, 62, 62, 62, 62, 62, 64, 64, 66, 69, 72, 72, 75, 78, 78, 81, 84, 87, 92, 96, 100],
            [66, 66, 66, 66, 66, 66, 69, 69, 72, 75, 78, 78, 81, 84, 84, 87, 89, 92, 100, 102, 105],
            [72, 72, 72, 72, 72, 72, 75, 75, 78, 81, 84, 84, 87, 89, 89, 92, 96, 100, 105, 109, 112],
            [75, 75, 75, 75, 75, 75, 78, 78, 81, 84, 87, 87, 89, 92, 92, 96, 100, 102, 109, 112, 116],
            [81, 81, 81, 81, 81, 81, 84, 84, 87, 89, 92, 92, 96, 100, 100, 102, 105, 109, 116, 121, 126]
        ];

  var visuo60 = [
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [53, 53, 53, 53, 53, 53, 56, 58, 58, 60, 62, 62, 64, 66, 66, 69, 72, 75, 81, 84, 87],
            [53, 53, 53, 53, 53, 53, 56, 58, 58, 60, 62, 62, 64, 66, 66, 69, 72, 75, 81, 84, 87],
            [56, 56, 56, 56, 56, 56, 58, 60, 60, 62, 64, 64, 66, 69, 69, 72, 75, 78, 84, 87, 89],
            [58, 58, 58, 58, 58, 58, 60, 62, 62, 64, 66, 66, 69, 72, 72, 75, 78, 81, 87, 89, 92],
            [60, 60, 60, 60, 60, 60, 62, 64, 64, 66, 69, 69, 72, 75, 75, 78, 81, 84, 89, 92, 96],
            [62, 62, 62, 62, 62, 62, 64, 66, 66, 69, 72, 72, 75, 78, 78, 81, 84, 87, 92, 96, 100],
            [66, 66, 66, 66, 66, 66, 69, 72, 72, 75, 78, 78, 81, 84, 84, 87, 89, 92, 100, 102, 105],
            [72, 72, 72, 72, 72, 72, 75, 78, 78, 81, 84, 84, 87, 89, 89, 92, 96, 100, 105, 109, 112],
            [75, 75, 75, 75, 75, 75, 78, 81, 81, 84, 87, 87, 89, 92, 92, 96, 100, 102, 109, 112, 116],
            [84, 84, 84, 84, 84, 84, 87, 89, 89, 92, 96, 96, 100, 102, 102, 105, 109, 112, 121, 126, 131]
        ];

  var visuo70 = [
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [50, 50, 50, 50, 50, 50, 53, 56, 58, 58, 60, 60, 62, 64, 64, 66, 69, 72, 78, 81, 84],
            [53, 53, 53, 53, 53, 53, 56, 58, 60, 60, 62, 62, 64, 66, 66, 69, 72, 75, 81, 84, 87],
            [56, 56, 56, 56, 56, 56, 58, 60, 62, 62, 64, 64, 66, 69, 69, 72, 75, 78, 84, 87, 89],
            [58, 58, 58, 58, 58, 58, 60, 62, 64, 64, 66, 66, 69, 72, 72, 75, 78, 81, 87, 89, 92],
            [58, 58, 58, 58, 58, 58, 60, 62, 64, 64, 66, 66, 69, 72, 72, 75, 78, 81, 87, 89, 92],
            [60, 60, 60, 60, 60, 60, 62, 64, 66, 66, 69, 69, 72, 75, 75, 78, 81, 84, 89, 92, 96],
            [64, 64, 64, 64, 64, 64, 66, 69, 72, 72, 75, 75, 78, 81, 81, 84, 87, 89, 96, 100, 102],
            [69, 69, 69, 69, 69, 69, 72, 75, 78, 78, 81, 81, 84, 87, 87, 89, 92, 96, 102, 105, 109],
            [72, 72, 72, 72, 72, 72, 75, 78, 81, 81, 84, 84, 87, 89, 89, 92, 96, 100, 105, 109, 112],
            [78, 78, 78, 78, 78, 78, 81, 84, 87, 87, 89, 89, 92, 96, 96, 100, 102, 105, 112, 116, 121],
            [84, 84, 84, 84, 84, 84, 87, 89, 92, 92, 96, 96, 100, 102, 102, 105, 109, 112, 121, 126, 131]
        ];

  var visuo80 = [
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [50, 50, 50, 50, 50, 53, 53, 56, 58, 58, 60, 60, 62, 64, 64, 69, 72, 78, 81, 84, 87],
            [53, 53, 53, 53, 53, 53, 56, 58, 60, 60, 62, 62, 64, 66, 66, 72, 75, 81, 84, 87, 89],
            [53, 53, 53, 53, 53, 53, 56, 58, 60, 60, 62, 62, 64, 66, 66, 72, 75, 81, 84, 87, 89],
            [56, 56, 56, 56, 56, 58, 58, 60, 62, 62, 64, 64, 66, 69, 69, 75, 78, 84, 87, 89, 92],
            [58, 58, 58, 58, 58, 60, 60, 62, 64, 64, 66, 66, 69, 72, 72, 78, 81, 87, 89, 92, 96],
            [60, 60, 60, 60, 60, 62, 62, 64, 66, 66, 69, 69, 72, 75, 75, 81, 84, 89, 92, 96, 100],
            [62, 62, 62, 62, 62, 64, 64, 66, 69, 69, 72, 72, 75, 78, 78, 84, 87, 92, 96, 100, 102],
            [66, 66, 66, 66, 66, 69, 69, 72, 75, 75, 78, 78, 81, 84, 84, 89, 92, 100, 102, 105, 109],
            [72, 72, 72, 72, 72, 75, 75, 78, 81, 81, 84, 84, 87, 89, 89, 96, 100, 105, 109, 112, 116],
            [75, 75, 75, 75, 75, 78, 78, 81, 84, 84, 87, 87, 89, 92, 92, 100, 102, 109, 112, 116, 121],
            [78, 78, 78, 78, 78, 81, 81, 84, 87, 87, 89, 89, 92, 96, 96, 102, 105, 112, 116, 121, 126],
            [84, 84, 84, 84, 84, 87, 87, 89, 92, 92, 96, 96, 100, 102, 102, 109, 112, 121, 126, 131, 136]
        ];

  var language50 = [
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 71, 71],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 71, 71],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 71, 71],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 71, 71],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 71, 71],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 71, 71],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 71, 71],
            [44, 44, 44, 44, 44, 47, 51, 54, 60, 75, 75],
            [44, 44, 44, 44, 44, 47, 51, 54, 60, 75, 75],
            [47, 47, 47, 47, 47, 51, 54, 57, 64, 79, 79],
            [47, 47, 47, 47, 47, 51, 54, 57, 64, 79, 79],
            [47, 47, 47, 47, 47, 51, 54, 57, 64, 79, 79],
            [51, 51, 51, 51, 51, 54, 57, 60, 68, 82, 82],
            [51, 51, 51, 51, 51, 54, 57, 60, 68, 82, 82],
            [54, 54, 54, 54, 54, 57, 60, 64, 71, 84, 84],
            [57, 57, 57, 57, 57, 60, 64, 68, 75, 87, 87],
            [60, 60, 60, 60, 60, 64, 68, 71, 79, 90, 90],
            [60, 60, 60, 60, 60, 64, 68, 71, 79, 90, 90],
            [64, 64, 64, 64, 64, 68, 71, 75, 83, 94, 94],
            [64, 64, 64, 64, 64, 68, 71, 75, 83, 94, 94],
            [68, 68, 68, 68, 68, 71, 75, 79, 87, 97, 97],
            [71, 71, 71, 71, 71, 75, 79, 83, 90, 99, 99],
            [71, 71, 71, 71, 71, 75, 79, 83, 90, 99, 99],
            [75, 75, 75, 75, 75, 79, 83, 87, 92, 102, 102],
            [75, 75, 75, 75, 75, 79, 83, 87, 92, 102, 102],
            [79, 79, 79, 79, 79, 83, 87, 90, 94, 105, 105],
            [83, 83, 83, 83, 83, 87, 90, 92, 96, 109, 109],
            [83, 83, 83, 83, 83, 87, 90, 92, 96, 109, 109],
            [87, 87, 87, 87, 87, 90, 92, 94, 100, 113, 113],
            [87, 87, 87, 87, 87, 90, 92, 94, 100, 113, 113],
            [90, 90, 90, 90, 90, 92, 94, 96, 102, 117, 117],
            [92, 92, 92, 92, 92, 94, 96, 100, 104, 120, 120],
            [92, 92, 92, 92, 92, 94, 96, 100, 104, 120, 120],
            [94, 94, 94, 94, 94, 96, 100, 102, 108, 124, 124],
            [96, 96, 96, 96, 96, 100, 102, 104, 112, 127, 127],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 131, 131],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 131, 131],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 131, 131],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 131, 131],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 131, 131],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 131, 131]];

  var language60 = [
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 44, 47, 51, 57, 74, 74],
            [44, 44, 44, 44, 44, 47, 51, 54, 60, 78, 78],
            [44, 44, 44, 44, 44, 47, 51, 54, 60, 78, 78],
            [44, 44, 44, 44, 44, 47, 51, 54, 60, 78, 78],
            [47, 47, 47, 47, 47, 51, 54, 57, 64, 82, 82],
            [47, 47, 47, 47, 47, 51, 54, 57, 64, 82, 82],
            [47, 47, 47, 47, 47, 51, 54, 57, 64, 82, 82],
            [51, 51, 51, 51, 51, 54, 57, 60, 68, 85, 85],
            [51, 51, 51, 51, 51, 54, 57, 60, 68, 85, 85],
            [54, 54, 54, 54, 54, 57, 60, 64, 71, 87, 87],
            [57, 57, 57, 57, 57, 60, 64, 68, 75, 90, 90],
            [60, 60, 60, 60, 60, 64, 68, 71, 79, 92, 92],
            [60, 60, 60, 60, 60, 64, 68, 71, 79, 92, 92],
            [64, 64, 64, 64, 64, 68, 71, 75, 83, 96, 96],
            [64, 64, 64, 64, 64, 68, 71, 75, 83, 96, 96],
            [68, 68, 68, 68, 68, 71, 75, 79, 87, 98, 98],
            [71, 71, 71, 71, 71, 75, 79, 83, 90, 101, 101],
            [71, 71, 71, 71, 71, 75, 79, 83, 90, 101, 101],
            [75, 75, 75, 75, 75, 79, 83, 87, 92, 104, 104],
            [75, 75, 75, 75, 75, 79, 83, 87, 92, 104, 104],
            [79, 79, 79, 79, 79, 83, 87, 90, 94, 108, 108],
            [83, 83, 83, 83, 83, 87, 90, 92, 96, 111, 111],
            [87, 87, 87, 87, 87, 90, 92, 94, 100, 116, 116],
            [87, 87, 87, 87, 87, 90, 92, 94, 100, 116, 116],
            [90, 90, 90, 90, 90, 92, 94, 96, 102, 120, 120],
            [90, 90, 90, 90, 90, 92, 94, 96, 102, 120, 120],
            [94, 94, 94, 94, 94, 96, 100, 102, 108, 127, 127],
            [94, 94, 94, 94, 94, 96, 100, 102, 108, 127, 127],
            [94, 94, 94, 94, 94, 96, 100, 102, 108, 127, 127],
            [96, 96, 96, 96, 96, 100, 102, 104, 112, 130, 130],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134]];

  var language70 = [
            [40, 40, 40, 40, 40, 47, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 47, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 47, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 47, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 47, 47, 51, 57, 74, 74],
            [40, 40, 40, 40, 40, 47, 47, 51, 57, 74, 74],
            [44, 44, 44, 44, 44, 51, 51, 54, 60, 78, 78],
            [44, 44, 44, 44, 44, 51, 51, 54, 60, 78, 78],
            [47, 47, 47, 47, 47, 54, 54, 57, 64, 82, 82],
            [47, 47, 47, 47, 47, 54, 54, 57, 64, 82, 82],
            [51, 51, 51, 51, 51, 57, 57, 60, 68, 85, 85],
            [51, 51, 51, 51, 51, 57, 57, 60, 68, 85, 85],
            [54, 54, 54, 54, 54, 60, 60, 64, 71, 88, 88],
            [54, 54, 54, 54, 54, 60, 60, 64, 71, 88, 88],
            [57, 57, 57, 57, 57, 64, 64, 68, 75, 90, 90],
            [60, 60, 60, 60, 60, 68, 68, 71, 79, 92, 92],
            [60, 60, 60, 60, 60, 68, 68, 71, 79, 92, 92],
            [64, 64, 64, 64, 64, 71, 71, 75, 83, 96, 96],
            [64, 64, 64, 64, 64, 71, 71, 75, 83, 96, 96],
            [68, 68, 68, 68, 68, 75, 75, 79, 87, 99, 99],
            [71, 71, 71, 71, 71, 79, 79, 83, 90, 101, 101],
            [75, 75, 75, 75, 75, 83, 83, 87, 92, 105, 105],
            [75, 75, 75, 75, 75, 83, 83, 87, 92, 105, 105],
            [79, 79, 79, 79, 79, 87, 87, 90, 94, 108, 108],
            [79, 79, 79, 79, 79, 87, 87, 90, 94, 108, 108],
            [83, 83, 83, 83, 83, 90, 90, 92, 96, 112, 112],
            [83, 83, 83, 83, 83, 90, 90, 92, 96, 112, 112],
            [87, 87, 87, 87, 87, 92, 92, 94, 100, 117, 117],
            [90, 90, 90, 90, 90, 94, 94, 96, 102, 120, 120],
            [92, 92, 92, 92, 92, 96, 96, 100, 104, 124, 124],
            [92, 92, 92, 92, 92, 96, 96, 100, 104, 124, 124],
            [94, 94, 94, 94, 94, 100, 100, 102, 108, 128, 128],
            [94, 94, 94, 94, 94, 100, 100, 102, 108, 128, 128],
            [96, 96, 96, 96, 96, 102, 102, 104, 112, 131, 131],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134],
            [100, 100, 100, 100, 100, 102, 104, 108, 116, 134, 134]];

  var language80 = [
            [40, 40, 40, 40, 40, 47, 51, 54, 57, 76, 76],
            [40, 40, 40, 40, 40, 47, 51, 54, 57, 76, 76],
            [40, 40, 40, 40, 40, 47, 51, 54, 57, 76, 76],
            [40, 40, 40, 40, 40, 47, 51, 54, 57, 76, 76],
            [40, 40, 40, 40, 40, 47, 51, 54, 57, 76, 76],
            [44, 44, 44, 44, 44, 51, 54, 57, 60, 80, 80],
            [44, 44, 44, 44, 44, 51, 54, 57, 60, 80, 80],
            [44, 44, 44, 44, 44, 51, 54, 57, 60, 80, 80],
            [47, 47, 47, 47, 47, 54, 57, 60, 64, 83, 83],
            [51, 51, 51, 51, 51, 57, 60, 64, 68, 86, 86],
            [51, 51, 51, 51, 51, 57, 60, 64, 68, 86, 86],
            [54, 54, 54, 54, 54, 60, 64, 68, 71, 89, 89],
            [57, 57, 57, 57, 57, 64, 68, 71, 75, 92, 92],
            [57, 57, 57, 57, 57, 64, 68, 71, 75, 92, 92],
            [60, 60, 60, 60, 60, 68, 71, 75, 79, 95, 95],
            [64, 64, 64, 64, 64, 71, 75, 79, 83, 97, 97],
            [68, 68, 68, 68, 68, 75, 79, 83, 87, 99, 99],
            [71, 71, 71, 71, 71, 79, 83, 87, 90, 103, 103],
            [71, 71, 71, 71, 71, 79, 83, 87, 90, 103, 103],
            [75, 75, 75, 75, 75, 83, 87, 90, 92, 107, 107],
            [79, 79, 79, 79, 79, 87, 90, 92, 94, 110, 110],
            [83, 83, 83, 83, 83, 90, 92, 94, 96, 113, 113],
            [87, 87, 87, 87, 87, 92, 94, 96, 100, 117, 117],
            [90, 90, 90, 90, 90, 94, 96, 100, 102, 122, 122],
            [90, 90, 90, 90, 90, 94, 96, 100, 102, 122, 122],
            [92, 92, 92, 92, 92, 96, 100, 102, 104, 125, 125],
            [92, 92, 92, 92, 92, 96, 100, 102, 104, 125, 125],
            [94, 94, 94, 94, 94, 100, 102, 104, 108, 129, 129],
            [94, 94, 94, 94, 94, 100, 102, 104, 108, 129, 129],
            [94, 94, 94, 94, 94, 100, 102, 104, 108, 129, 129],
            [96, 96, 96, 96, 96, 102, 104, 108, 112, 133, 133],
            [96, 96, 96, 96, 96, 102, 104, 108, 112, 133, 133],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137],
            [100, 100, 100, 100, 100, 104, 108, 112, 116, 137, 137]];

  var att50 = [
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 56, 64, 72, 75, 79, 82, 85, 88, 91],
            [43, 43, 43, 43, 46, 49, 53, 56, 60, 68, 75, 79, 82, 85, 88, 91, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 60, 68, 75, 79, 82, 85, 88, 91, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 60, 68, 75, 79, 82, 85, 88, 91, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 60, 68, 75, 79, 82, 85, 88, 91, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 60, 68, 75, 79, 82, 85, 88, 91, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 60, 68, 75, 79, 82, 85, 88, 91, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 60, 68, 75, 79, 82, 85, 88, 91, 94],
            [46, 46, 46, 46, 49, 53, 56, 60, 64, 72, 79, 82, 85, 88, 91, 94, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 64, 72, 79, 82, 85, 88, 91, 94, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 64, 72, 79, 82, 85, 88, 91, 94, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 64, 72, 79, 82, 85, 88, 91, 94, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 64, 72, 79, 82, 85, 88, 91, 94, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 64, 72, 79, 82, 85, 88, 91, 94, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 64, 72, 79, 82, 85, 88, 91, 94, 97],
            [49, 49, 49, 49, 53, 56, 60, 64, 68, 75, 82, 85, 88, 91, 94, 97, 100],
            [49, 49, 49, 49, 53, 56, 60, 64, 68, 75, 82, 85, 88, 91, 94, 97, 100],
            [49, 49, 49, 49, 53, 56, 60, 64, 68, 75, 82, 85, 88, 91, 94, 97, 100],
            [49, 49, 49, 49, 53, 56, 60, 64, 68, 75, 82, 85, 88, 91, 94, 97, 100],
            [49, 49, 49, 49, 53, 56, 60, 64, 68, 75, 82, 85, 88, 91, 94, 97, 100],
            [53, 53, 53, 53, 56, 60, 64, 68, 72, 79, 85, 88, 91, 94, 97, 100, 103],
            [53, 53, 53, 53, 56, 60, 64, 68, 72, 79, 85, 88, 91, 94, 97, 100, 103],
            [53, 53, 53, 53, 56, 60, 64, 68, 72, 79, 85, 88, 91, 94, 97, 100, 103],
            [56, 56, 56, 56, 60, 64, 68, 72, 75, 82, 88, 91, 94, 97, 100, 103, 106],
            [56, 56, 56, 56, 60, 64, 68, 72, 75, 82, 88, 91, 94, 97, 100, 103, 106],
            [56, 56, 56, 56, 60, 64, 68, 72, 75, 82, 88, 91, 94, 97, 100, 103, 106],
            [60, 60, 60, 60, 64, 68, 72, 75, 79, 85, 91, 94, 97, 100, 103, 106, 109],
            [60, 60, 60, 60, 64, 68, 72, 75, 79, 85, 91, 94, 97, 100, 103, 106, 109],
            [60, 60, 60, 60, 64, 68, 72, 75, 79, 85, 91, 94, 97, 100, 103, 106, 109],
            [60, 60, 60, 60, 64, 68, 72, 75, 79, 85, 91, 94, 97, 100, 103, 106, 109],
            [64, 64, 64, 64, 68, 72, 75, 79, 82, 88, 94, 97, 100, 103, 106, 109, 112],
            [64, 64, 64, 64, 68, 72, 75, 79, 82, 88, 94, 97, 100, 103, 106, 109, 112],
            [68, 68, 68, 68, 72, 75, 79, 82, 85, 91, 97, 100, 103, 106, 109, 112, 115],
            [68, 68, 68, 68, 72, 75, 79, 82, 85, 91, 97, 100, 103, 106, 109, 112, 115],
            [72, 72, 72, 72, 75, 79, 82, 85, 88, 94, 100, 103, 106, 109, 112, 115, 118],
            [72, 72, 72, 72, 75, 79, 82, 85, 88, 94, 100, 103, 106, 109, 112, 115, 118],
            [72, 72, 72, 72, 75, 79, 82, 85, 88, 94, 100, 103, 106, 109, 112, 115, 118],
            [72, 72, 72, 72, 75, 79, 82, 85, 88, 94, 100, 103, 106, 109, 112, 115, 118],
            [75, 75, 75, 75, 79, 82, 85, 88, 91, 97, 103, 106, 109, 112, 115, 118, 122],
            [75, 75, 75, 75, 79, 82, 85, 88, 91, 97, 103, 106, 109, 112, 115, 118, 122],
            [79, 79, 79, 79, 82, 85, 88, 91, 94, 100, 106, 109, 112, 115, 118, 122, 125],
            [79, 79, 79, 79, 82, 85, 88, 91, 94, 100, 106, 109, 112, 115, 118, 122, 125],
            [79, 79, 79, 79, 82, 85, 88, 91, 94, 100, 106, 109, 112, 115, 118, 122, 125],
            [82, 82, 82, 82, 85, 88, 91, 94, 97, 103, 109, 112, 115, 118, 122, 125, 128],
            [82, 82, 82, 82, 85, 88, 91, 94, 97, 103, 109, 112, 115, 118, 122, 125, 128],
            [82, 82, 82, 82, 85, 88, 91, 94, 97, 103, 109, 112, 115, 118, 122, 125, 128],
            [85, 85, 85, 85, 88, 91, 94, 97, 100, 106, 112, 115, 118, 122, 125, 128, 132],
            [85, 85, 85, 85, 88, 91, 94, 97, 100, 106, 112, 115, 118, 122, 125, 128, 132],
            [85, 85, 85, 85, 88, 91, 94, 97, 100, 106, 112, 115, 118, 122, 125, 128, 132],
            [85, 85, 85, 85, 88, 91, 94, 97, 100, 106, 112, 115, 118, 122, 125, 128, 132],
            [88, 88, 88, 88, 91, 94, 97, 100, 103, 109, 115, 118, 122, 125, 128, 132, 135],
            [88, 88, 88, 88, 91, 94, 97, 100, 103, 109, 115, 118, 122, 125, 128, 132, 135],
            [91, 91, 91, 91, 94, 97, 100, 103, 106, 112, 118, 122, 125, 128, 132, 135, 138],
            [91, 91, 91, 91, 94, 97, 100, 103, 106, 112, 118, 122, 125, 128, 132, 135, 138],
            [94, 94, 94, 94, 97, 100, 103, 106, 109, 115, 122, 125, 128, 132, 135, 138, 142],
            [94, 94, 94, 94, 97, 100, 103, 106, 109, 115, 122, 125, 128, 132, 135, 138, 142],
            [94, 94, 94, 94, 97, 100, 103, 106, 109, 115, 122, 125, 128, 132, 135, 138, 142],
            [97, 97, 97, 97, 100, 103, 106, 109, 112, 118, 125, 128, 132, 135, 138, 142, 146],
            [97, 97, 97, 97, 100, 103, 106, 109, 112, 118, 125, 128, 132, 135, 138, 142, 146],
            [97, 97, 97, 97, 100, 103, 106, 109, 112, 118, 125, 128, 132, 135, 138, 142, 146],
            [97, 97, 97, 97, 100, 103, 106, 109, 112, 118, 125, 128, 132, 135, 138, 142, 146],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150]];

  var att60 = [
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 40, 43, 46, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [43, 43, 43, 43, 46, 49, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 43, 46, 49, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [46, 46, 46, 46, 49, 53, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [46, 46, 46, 46, 49, 53, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [49, 49, 49, 49, 53, 56, 60, 64, 72, 75, 82, 85, 88, 94, 97, 100, 100],
            [49, 49, 49, 49, 53, 56, 60, 64, 72, 75, 82, 85, 88, 94, 97, 100, 100],
            [49, 49, 49, 49, 53, 56, 60, 64, 72, 75, 82, 85, 88, 94, 97, 100, 100],
            [49, 49, 49, 49, 53, 56, 60, 64, 72, 75, 82, 85, 88, 94, 97, 100, 100],
            [53, 53, 53, 53, 56, 60, 64, 72, 75, 82, 85, 88, 91, 97, 100, 103, 103],
            [53, 53, 53, 53, 56, 60, 64, 72, 75, 82, 85, 88, 91, 97, 100, 103, 103],
            [53, 53, 53, 53, 56, 60, 64, 72, 75, 82, 85, 88, 91, 97, 100, 103, 103],
            [53, 53, 53, 53, 56, 60, 64, 72, 75, 82, 85, 88, 91, 97, 100, 103, 103],
            [56, 56, 56, 56, 60, 64, 68, 72, 79, 82, 88, 91, 94, 100, 103, 106, 106],
            [56, 56, 56, 56, 60, 64, 68, 72, 79, 82, 88, 91, 94, 100, 103, 106, 106],
            [56, 56, 56, 56, 60, 64, 68, 72, 79, 82, 88, 91, 94, 100, 103, 106, 106],
            [56, 56, 56, 56, 60, 64, 68, 72, 79, 82, 88, 91, 94, 100, 103, 106, 106],
            [60, 60, 60, 60, 64, 68, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [60, 60, 60, 60, 64, 68, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [60, 60, 60, 60, 64, 68, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [60, 60, 60, 60, 64, 68, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [60, 60, 60, 60, 64, 68, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [64, 64, 64, 64, 68, 72, 75, 79, 85, 88, 94, 97, 100, 106, 109, 112, 112],
            [64, 64, 64, 64, 68, 72, 75, 79, 85, 88, 94, 97, 100, 106, 109, 112, 112],
            [68, 68, 68, 68, 72, 75, 79, 82, 88, 91, 97, 100, 103, 109, 112, 115, 115],
            [68, 68, 68, 68, 72, 75, 79, 82, 88, 91, 97, 100, 103, 109, 112, 115, 115],
            [72, 72, 72, 72, 75, 79, 82, 85, 91, 94, 100, 103, 106, 112, 115, 118, 118],
            [72, 72, 72, 72, 75, 79, 82, 85, 91, 94, 100, 103, 106, 112, 115, 118, 118],
            [72, 72, 72, 72, 75, 79, 82, 85, 91, 94, 100, 103, 106, 112, 115, 118, 118],
            [72, 72, 72, 72, 75, 79, 82, 85, 91, 94, 100, 103, 106, 112, 115, 118, 118],
            [75, 75, 75, 75, 79, 82, 85, 88, 94, 97, 103, 106, 109, 115, 118, 122, 122],
            [79, 79, 79, 79, 82, 85, 88, 91, 97, 100, 106, 109, 112, 118, 122, 125, 125],
            [79, 79, 79, 79, 82, 85, 88, 91, 97, 100, 106, 109, 112, 118, 122, 125, 125],
            [82, 82, 82, 82, 85, 88, 91, 94, 100, 103, 109, 112, 115, 122, 125, 128, 128],
            [82, 82, 82, 82, 85, 88, 91, 94, 100, 103, 109, 112, 115, 122, 125, 128, 128],
            [85, 85, 85, 85, 88, 91, 94, 97, 103, 106, 112, 115, 118, 125, 128, 132, 132],
            [85, 85, 85, 85, 88, 91, 94, 97, 103, 106, 112, 115, 118, 125, 128, 132, 132],
            [88, 88, 88, 88, 91, 94, 97, 103, 106, 109, 115, 118, 122, 128, 132, 135, 135],
            [88, 88, 88, 88, 91, 94, 97, 103, 106, 109, 115, 118, 122, 128, 132, 135, 135],
            [88, 88, 88, 88, 91, 94, 97, 103, 106, 109, 115, 118, 122, 128, 132, 135, 135],
            [91, 91, 91, 91, 94, 97, 100, 103, 109, 112, 118, 122, 125, 132, 135, 138, 138],
            [91, 91, 91, 91, 94, 97, 100, 103, 109, 112, 118, 122, 125, 132, 135, 138, 138],
            [94, 94, 94, 94, 97, 100, 103, 106, 112, 115, 122, 125, 128, 135, 138, 142, 142],
            [94, 94, 94, 94, 97, 100, 103, 106, 112, 115, 122, 125, 128, 135, 138, 142, 142],
            [94, 94, 94, 94, 97, 100, 103, 106, 112, 115, 122, 125, 128, 135, 138, 142, 142],
            [94, 94, 94, 94, 97, 100, 103, 106, 112, 115, 122, 125, 128, 135, 138, 142, 142],
            [97, 97, 97, 97, 100, 103, 106, 109, 115, 118, 125, 128, 132, 138, 142, 146, 146],
            [97, 97, 97, 97, 100, 103, 106, 109, 115, 118, 125, 128, 132, 138, 142, 146, 146],
            [97, 97, 97, 97, 100, 103, 106, 109, 115, 118, 125, 128, 132, 138, 142, 146, 146],
            [97, 97, 97, 97, 100, 103, 106, 109, 115, 118, 125, 128, 132, 138, 142, 146, 146],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150]];

  var att70 = [
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [40, 40, 40, 43, 46, 49, 49, 53, 60, 64, 72, 75, 79, 85, 88, 91, 91],
            [43, 43, 43, 46, 49, 53, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 46, 49, 53, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 46, 49, 53, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 46, 49, 53, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 46, 49, 53, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [43, 43, 43, 46, 49, 53, 53, 56, 64, 68, 75, 79, 82, 88, 91, 94, 94],
            [46, 46, 46, 49, 53, 56, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [46, 46, 46, 49, 53, 56, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [46, 46, 46, 49, 53, 56, 56, 60, 68, 72, 79, 82, 85, 91, 94, 97, 97],
            [49, 49, 49, 53, 56, 60, 60, 64, 72, 75, 82, 85, 88, 94, 97, 100, 100],
            [49, 49, 49, 53, 56, 60, 60, 64, 72, 75, 82, 85, 88, 94, 97, 100, 100],
            [49, 49, 49, 53, 56, 60, 60, 64, 72, 75, 82, 85, 88, 94, 97, 100, 100],
            [53, 53, 53, 56, 60, 64, 64, 68, 75, 79, 85, 88, 91, 97, 100, 103, 103],
            [53, 53, 53, 56, 60, 64, 64, 68, 75, 79, 85, 88, 91, 97, 100, 103, 103],
            [56, 56, 56, 60, 64, 68, 68, 72, 79, 82, 88, 91, 94, 100, 103, 106, 106],
            [56, 56, 56, 60, 64, 68, 68, 72, 79, 82, 88, 91, 94, 100, 103, 106, 106],
            [56, 56, 56, 60, 64, 68, 68, 72, 79, 82, 88, 91, 94, 100, 103, 106, 106],
            [60, 60, 60, 64, 68, 72, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [60, 60, 60, 64, 68, 72, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [60, 60, 60, 64, 68, 72, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [60, 60, 60, 64, 68, 72, 72, 75, 82, 85, 91, 94, 97, 103, 106, 109, 109],
            [64, 64, 64, 68, 72, 75, 75, 79, 85, 88, 94, 97, 100, 106, 109, 112, 112],
            [64, 64, 64, 68, 72, 75, 75, 79, 85, 88, 94, 97, 100, 106, 109, 112, 112],
            [64, 64, 64, 68, 72, 75, 75, 79, 85, 88, 94, 97, 100, 106, 109, 112, 112],
            [64, 64, 64, 68, 72, 75, 75, 79, 85, 88, 94, 97, 100, 106, 109, 112, 112],
            [64, 64, 64, 68, 72, 75, 75, 79, 85, 88, 94, 97, 100, 106, 109, 112, 112],
            [68, 68, 68, 72, 75, 79, 79, 82, 88, 91, 97, 100, 103, 109, 112, 115, 115],
            [68, 68, 68, 72, 75, 79, 79, 82, 88, 91, 97, 100, 103, 109, 112, 115, 115],
            [68, 68, 68, 72, 75, 79, 79, 82, 88, 91, 97, 100, 103, 109, 112, 115, 115],
            [72, 72, 72, 75, 79, 82, 82, 85, 91, 94, 100, 103, 106, 112, 115, 118, 118],
            [72, 72, 72, 75, 79, 82, 82, 85, 91, 94, 100, 103, 106, 112, 115, 118, 118],
            [72, 72, 72, 75, 79, 82, 82, 85, 91, 94, 100, 103, 106, 112, 115, 118, 118],
            [75, 75, 75, 79, 82, 85, 85, 88, 94, 97, 103, 106, 109, 115, 118, 122, 122],
            [75, 75, 75, 79, 82, 85, 85, 88, 94, 97, 103, 106, 109, 115, 118, 122, 122],
            [75, 75, 75, 79, 82, 85, 85, 88, 94, 97, 103, 106, 109, 115, 118, 122, 122],
            [79, 79, 79, 82, 85, 88, 88, 91, 97, 100, 106, 109, 112, 118, 122, 125, 125],
            [79, 79, 79, 82, 85, 88, 88, 91, 97, 100, 106, 109, 112, 118, 122, 125, 125],
            [82, 82, 82, 85, 88, 91, 91, 94, 100, 103, 109, 112, 115, 122, 125, 128, 128],
            [82, 82, 82, 85, 88, 91, 91, 94, 100, 103, 109, 112, 115, 122, 125, 128, 128],
            [82, 82, 82, 85, 88, 91, 91, 94, 100, 103, 109, 112, 115, 122, 125, 128, 128],
            [85, 85, 85, 88, 91, 94, 94, 97, 103, 106, 112, 115, 118, 125, 128, 132, 132],
            [85, 85, 85, 88, 91, 94, 94, 97, 103, 106, 112, 115, 118, 125, 128, 132, 132],
            [85, 85, 85, 88, 91, 94, 94, 97, 103, 106, 112, 115, 118, 125, 128, 132, 132],
            [88, 88, 88, 91, 94, 97, 97, 100, 106, 109, 115, 118, 122, 128, 132, 135, 135],
            [88, 88, 88, 91, 94, 97, 97, 100, 106, 109, 115, 118, 122, 128, 132, 135, 135],
            [88, 88, 88, 91, 94, 97, 97, 100, 106, 109, 115, 118, 122, 128, 132, 135, 135],
            [91, 91, 91, 94, 97, 100, 100, 103, 109, 112, 118, 122, 125, 132, 135, 138, 138],
            [91, 91, 91, 94, 97, 100, 100, 103, 109, 112, 118, 122, 125, 132, 135, 138, 138],
            [91, 91, 91, 94, 97, 100, 100, 103, 109, 112, 118, 122, 125, 132, 135, 138, 138],
            [91, 91, 91, 94, 97, 100, 100, 103, 109, 112, 118, 122, 125, 132, 135, 138, 138],
            [94, 94, 94, 97, 100, 103, 103, 106, 112, 115, 122, 125, 128, 135, 138, 142, 142],
            [94, 94, 94, 97, 100, 103, 103, 106, 112, 115, 122, 125, 128, 135, 138, 142, 142],
            [94, 94, 94, 97, 100, 103, 103, 106, 112, 115, 122, 125, 128, 135, 138, 142, 142],
            [97, 97, 97, 100, 103, 106, 106, 109, 115, 118, 125, 128, 132, 138, 142, 146, 146],
            [97, 97, 97, 100, 103, 106, 106, 109, 115, 118, 125, 128, 132, 138, 142, 146, 146],
            [97, 97, 97, 100, 103, 106, 106, 109, 115, 118, 125, 128, 132, 138, 142, 146, 146],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150],
            [100, 100, 100, 100, 103, 106, 109, 112, 115, 122, 128, 132, 135, 138, 142, 146, 150]];

  var att80 = [
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 72, 79, 82, 85, 88, 88, 91, 94],
            [40, 40, 40, 43, 46, 49, 53, 56, 68, 75, 79, 82, 85, 88, 88, 91, 94],
            [43, 43, 43, 46, 49, 53, 56, 60, 72, 75, 82, 85, 88, 91, 91, 94, 97],
            [43, 43, 43, 46, 49, 53, 56, 60, 72, 75, 82, 85, 88, 91, 91, 94, 97],
            [43, 43, 43, 46, 49, 53, 56, 60, 72, 75, 82, 85, 88, 91, 91, 94, 97],
            [43, 43, 43, 46, 49, 53, 56, 60, 72, 75, 82, 85, 88, 91, 91, 94, 97],
            [43, 43, 43, 46, 49, 53, 56, 60, 72, 75, 82, 85, 88, 91, 91, 94, 97],
            [46, 46, 46, 49, 53, 56, 60, 64, 75, 79, 85, 88, 91, 94, 94, 97, 100],
            [46, 46, 46, 49, 53, 56, 60, 64, 75, 79, 85, 88, 91, 94, 94, 97, 100],
            [46, 46, 46, 49, 53, 56, 60, 64, 75, 79, 85, 88, 91, 94, 94, 97, 100],
            [49, 49, 49, 53, 56, 60, 64, 68, 79, 82, 88, 91, 94, 97, 97, 100, 103],
            [49, 49, 49, 53, 56, 60, 64, 68, 79, 82, 88, 91, 94, 97, 97, 100, 103],
            [49, 49, 49, 53, 56, 60, 64, 68, 79, 82, 88, 91, 94, 97, 97, 100, 103],
            [53, 53, 53, 56, 60, 64, 68, 72, 82, 85, 91, 94, 97, 100, 100, 103, 106],
            [53, 53, 53, 56, 60, 64, 68, 72, 82, 85, 91, 94, 97, 100, 100, 103, 106],
            [56, 56, 56, 60, 64, 68, 72, 75, 85, 88, 94, 97, 100, 103, 103, 106, 109],
            [56, 56, 56, 60, 64, 68, 72, 75, 85, 88, 94, 97, 100, 103, 103, 106, 109],
            [56, 56, 56, 60, 64, 68, 72, 75, 85, 88, 94, 97, 100, 103, 103, 106, 109],
            [60, 60, 60, 64, 68, 72, 75, 79, 88, 91, 97, 100, 103, 106, 106, 109, 112],
            [60, 60, 60, 64, 68, 72, 75, 79, 88, 91, 97, 100, 103, 106, 106, 109, 112],
            [64, 64, 64, 68, 72, 75, 79, 82, 91, 94, 100, 103, 106, 109, 109, 112, 115],
            [64, 64, 64, 68, 72, 75, 79, 82, 91, 94, 100, 103, 106, 109, 109, 112, 115],
            [68, 68, 68, 72, 75, 79, 82, 85, 94, 97, 103, 106, 109, 112, 112, 115, 118],
            [68, 68, 68, 72, 75, 79, 82, 85, 94, 97, 103, 106, 109, 112, 112, 115, 118],
            [72, 72, 72, 75, 79, 82, 85, 88, 97, 100, 106, 109, 112, 115, 115, 118, 122],
            [72, 72, 72, 75, 79, 82, 85, 88, 97, 100, 106, 109, 112, 115, 115, 118, 122],
            [75, 75, 75, 79, 82, 85, 88, 91, 100, 103, 109, 112, 115, 118, 118, 122, 125],
            [75, 75, 75, 79, 82, 85, 88, 91, 100, 103, 109, 112, 115, 118, 118, 122, 125],
            [75, 75, 75, 79, 82, 85, 88, 91, 100, 103, 109, 112, 115, 118, 118, 122, 125],
            [79, 79, 79, 82, 85, 88, 91, 94, 103, 106, 112, 115, 118, 122, 122, 125, 128],
            [79, 79, 79, 82, 85, 88, 91, 94, 103, 106, 112, 115, 118, 122, 122, 125, 128],
            [82, 82, 82, 85, 88, 91, 94, 97, 100, 109, 115, 118, 122, 125, 125, 128, 132],
            [82, 82, 82, 85, 88, 91, 94, 97, 100, 109, 115, 118, 122, 125, 125, 128, 132],
            [85, 85, 85, 88, 91, 94, 97, 100, 109, 112, 118, 122, 125, 128, 128, 132, 135],
            [85, 85, 85, 88, 91, 94, 97, 100, 109, 112, 118, 122, 125, 128, 128, 132, 135],
            [88, 88, 88, 91, 94, 97, 100, 103, 112, 115, 122, 125, 128, 132, 132, 135, 138],
            [88, 88, 88, 91, 94, 97, 100, 103, 112, 115, 122, 125, 128, 132, 132, 135, 138],
            [91, 91, 91, 94, 97, 100, 103, 106, 115, 118, 125, 128, 132, 135, 135, 138, 142],
            [91, 91, 91, 94, 97, 100, 103, 106, 115, 118, 125, 128, 132, 135, 135, 138, 142],
            [91, 91, 91, 94, 97, 100, 103, 106, 115, 118, 125, 128, 132, 135, 135, 138, 142],
            [94, 94, 94, 97, 100, 103, 106, 109, 118, 122, 128, 132, 135, 138, 138, 142, 146],
            [94, 94, 94, 97, 100, 103, 106, 109, 118, 122, 128, 132, 135, 138, 138, 142, 146],
            [94, 94, 94, 97, 100, 103, 106, 109, 118, 122, 128, 132, 135, 138, 138, 142, 146],
            [94, 94, 94, 97, 100, 103, 106, 109, 118, 122, 128, 132, 135, 138, 138, 142, 146],
            [97, 97, 97, 100, 103, 106, 109, 112, 122, 125, 132, 135, 138, 142, 142, 146, 150],
            [97, 97, 97, 100, 103, 106, 109, 112, 122, 125, 132, 135, 138, 142, 142, 146, 150],
            [97, 97, 97, 100, 103, 106, 109, 112, 122, 125, 132, 135, 138, 142, 142, 146, 150],
            [97, 97, 97, 100, 103, 106, 109, 112, 122, 125, 132, 135, 138, 142, 142, 146, 150],
            [97, 97, 97, 100, 103, 106, 109, 112, 122, 125, 132, 135, 138, 142, 142, 146, 150],
            [97, 97, 97, 100, 103, 106, 109, 112, 122, 125, 132, 135, 138, 142, 142, 146, 150],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154],
            [100, 100, 100, 103, 106, 109, 112, 115, 125, 128, 135, 138, 142, 146, 146, 150, 154]];

  var mem50 =[
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,44,48,48,52,60,77,77,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,44,48,48,52,60,77,77,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,44,48,48,52,60,77,77,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,44,48,48,52,60,77,77,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,44,48,48,52,60,77,77,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,44,48,48,52,60,77,77,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,44,48,48,52,60,77,77,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,44,48,48,52,60,77,77,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,48,52,52,56,64,80,80,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,48,52,52,56,64,80,80,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,52,56,56,60,68,82,82,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,52,56,56,60,68,82,82,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,52,56,56,60,68,82,82,],
            [52,52,52,52,52,52,52,52,52,52,52,52,52,56,56,60,60,64,71,85,85,],
            [52,52,52,52,52,52,52,52,52,52,52,52,52,56,56,60,60,64,71,85,85,],
            [56,56,56,56,56,56,56,56,56,56,56,56,56,60,60,64,64,68,75,88,88,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,64,68,68,71,78,91,91,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,64,68,68,71,78,91,91,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,64,68,68,71,78,91,91,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,64,68,68,71,78,91,91,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,64,68,68,71,78,91,91,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,68,71,71,75,81,94,94,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,68,71,71,75,81,94,94,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,68,71,71,75,81,94,94,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,68,71,71,75,81,94,94,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,71,75,75,78,84,97,97,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,71,75,75,78,84,97,97,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,75,78,78,81,86,99,99,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,75,78,78,81,86,99,99,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,78,81,81,84,88,101,101,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,78,81,81,84,88,101,101,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,81,84,84,86,91,105,105,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,81,84,84,86,91,105,105,],
            [81,81,81,81,81,81,81,81,81,81,81,81,81,84,84,86,86,88,94,108,108,],
            [81,81,81,81,81,81,81,81,81,81,81,81,81,84,84,86,86,88,94,108,108,],
            [84,84,84,84,84,84,84,84,84,84,84,84,84,86,86,88,88,91,97,111,111,],
            [86,86,86,86,86,86,86,86,86,86,86,86,86,88,88,91,91,94,100,115,115,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,91,94,94,97,102,119,119,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,91,94,94,97,102,119,119,],
            [91,91,91,91,91,91,91,91,91,91,91,91,91,94,94,97,97,100,104,124,124,],
            [91,91,91,91,91,91,91,91,91,91,91,91,91,94,94,97,97,100,104,124,124,],
            [94,94,94,94,94,94,94,94,94,94,94,94,94,97,97,100,100,102,108,127,127,],
            [97,97,97,97,97,97,97,97,97,97,97,97,97,100,102,102,102,104,112,131,131,]];

  var mem60 = [
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,48,56,60,78,78,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,48,56,60,78,78,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,48,56,60,78,78,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,48,56,60,78,78,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,48,56,60,78,78,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,48,56,60,78,78,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,48,56,60,78,78,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,52,52,60,64,81,81,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,52,52,60,64,81,81,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,52,52,60,64,81,81,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,56,56,64,68,84,84,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,56,56,64,68,84,84,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,56,56,64,68,84,84,],
            [52,52,52,52,52,52,52,52,52,52,52,52,52,56,60,60,60,68,71,86,86,],
            [52,52,52,52,52,52,52,52,52,52,52,52,52,56,60,60,60,68,71,86,86,],
            [56,56,56,56,56,56,56,56,56,56,56,56,56,60,64,64,64,71,75,89,89,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,68,68,68,75,78,92,92,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,68,68,68,75,78,92,92,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,68,68,68,75,78,92,92,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,71,71,78,81,95,95,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,71,71,78,81,95,95,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,71,71,78,81,95,95,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,71,71,78,81,95,95,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,75,75,75,81,84,98,98,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,75,75,75,81,84,98,98,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,75,75,75,81,84,98,98,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,78,78,78,84,86,100,100,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,78,78,78,84,86,100,100,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,81,81,81,86,88,102,102,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,81,81,81,86,88,102,102,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,81,81,81,86,88,102,102,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,84,84,84,88,91,106,106,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,84,84,84,88,91,106,106,],
            [81,81,81,81,81,81,81,81,81,81,81,81,81,84,86,86,86,91,94,110,110,],
            [84,84,84,84,84,84,84,84,84,84,84,84,84,86,88,88,88,94,97,112,112,],
            [84,84,84,84,84,84,84,84,84,84,84,84,84,86,88,88,88,94,97,112,112,],
            [86,86,86,86,86,86,86,86,86,86,86,86,86,88,91,91,91,97,100,116,116,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,94,94,94,100,102,121,121,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,94,94,94,100,102,121,121,],
            [91,91,91,91,91,91,91,91,91,91,91,91,91,94,97,97,97,102,104,126,126,],
            [91,91,91,91,91,91,91,91,91,91,91,91,91,94,97,97,97,102,104,126,126,],
            [94,94,94,94,94,94,94,94,94,94,94,94,94,97,100,100,100,104,108,129,129,],
            [97,97,97,97,97,97,97,97,97,97,97,97,97,100,102,102,102,108,112,133,133,]];

  var mem70 = [
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,52,56,60,79,79,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,52,56,60,79,79,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,52,56,60,79,79,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,52,56,60,79,79,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,48,52,56,60,79,79,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,52,56,60,64,82,82,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,52,56,60,64,82,82,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,52,56,60,64,82,82,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,52,56,60,64,82,82,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,56,60,64,68,85,85,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,56,60,64,68,85,85,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,56,60,64,68,85,85,],
            [52,52,52,52,52,52,52,52,52,52,52,52,52,56,60,60,64,68,71,87,87,],
            [52,52,52,52,52,52,52,52,52,52,52,52,52,56,60,60,64,68,71,87,87,],
            [56,56,56,56,56,56,56,56,56,56,56,56,56,60,64,64,68,71,75,90,90,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,68,68,71,75,78,93,93,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,68,68,71,75,78,93,93,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,68,68,71,75,78,93,93,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,71,75,78,81,95,95,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,71,75,78,81,95,95,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,71,75,78,81,95,95,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,75,75,78,81,84,98,98,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,75,75,78,81,84,98,98,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,78,78,81,84,86,101,101,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,78,78,81,84,86,101,101,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,78,78,81,84,86,101,101,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,81,81,84,86,88,103,103,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,81,81,84,86,88,103,103,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,84,84,86,88,91,107,107,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,84,84,86,88,91,107,107,],
            [81,81,81,81,81,81,81,81,81,81,81,81,81,84,86,86,88,91,94,110,110,],
            [81,81,81,81,81,81,81,81,81,81,81,81,81,84,86,86,88,91,94,110,110,],
            [84,84,84,84,84,84,84,84,84,84,84,84,84,86,88,88,91,94,97,113,113,],
            [84,84,84,84,84,84,84,84,84,84,84,84,84,86,88,88,91,94,97,113,113,],
            [86,86,86,86,86,86,86,86,86,86,86,86,86,88,91,91,94,97,102,117,117,],
            [86,86,86,86,86,86,86,86,86,86,86,86,86,88,91,91,94,97,102,117,117,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,94,94,97,100,102,122,122,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,94,94,97,100,102,122,122,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,94,94,97,100,102,122,122,],
            [91,91,91,91,91,91,91,91,91,91,91,91,91,94,97,97,100,102,104,127,127,],
            [94,94,94,94,94,94,94,94,94,94,94,94,94,97,100,100,102,104,108,130,130,],
            [97,97,97,97,97,97,97,97,97,97,97,97,97,100,102,102,104,108,112,134,134,],
            [100,100,100,100,100,100,100,100,100,100,100,100,100,102,104,108,104,108,112,115,137]];

  var mem80 = [
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,52,52,56,64,80,80,],
            [40,40,40,40,40,40,40,40,40,40,40,40,40,44,48,52,52,56,64,80,80,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,56,56,60,68,82,82,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,56,56,60,68,82,82,],
            [44,44,44,44,44,44,44,44,44,44,44,44,44,48,52,56,56,60,68,82,82,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,60,60,64,71,85,85,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,60,60,64,71,85,85,],
            [48,48,48,48,48,48,48,48,48,48,48,48,48,52,56,60,60,64,71,85,85,],
            [52,52,52,52,52,52,52,52,52,52,52,52,52,56,60,64,64,68,75,88,88,],
            [52,52,52,52,52,52,52,52,52,52,52,52,52,56,60,64,64,68,75,88,88,],
            [56,56,56,56,56,56,56,56,56,56,56,56,56,60,64,68,68,71,78,90,90,],
            [56,56,56,56,56,56,56,56,56,56,56,56,56,60,64,68,68,71,78,90,90,],
            [56,56,56,56,56,56,56,56,56,56,56,56,56,60,64,68,68,71,78,90,90,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,68,71,71,75,81,93,93,],
            [60,60,60,60,60,60,60,60,60,60,60,60,60,64,68,71,71,75,81,93,93,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,75,75,78,84,96,96,],
            [64,64,64,64,64,64,64,64,64,64,64,64,64,68,71,75,75,78,84,96,96,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,75,78,78,81,86,98,98,],
            [68,68,68,68,68,68,68,68,68,68,68,68,68,71,75,78,78,81,86,98,98,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,78,81,81,84,88,101,101,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,78,81,81,84,88,101,101,],
            [71,71,71,71,71,71,71,71,71,71,71,71,71,75,78,81,81,84,88,101,101,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,81,84,84,86,91,104,104,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,81,84,84,86,91,104,104,],
            [75,75,75,75,75,75,75,75,75,75,75,75,75,78,81,84,84,86,91,104,104,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,84,86,86,88,94,107,107,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,84,86,86,88,94,107,107,],
            [78,78,78,78,78,78,78,78,78,78,78,78,78,81,84,86,86,88,94,107,107,],
            [81,81,81,81,81,81,81,81,81,81,81,81,81,84,86,88,88,91,97,110,110,],
            [81,81,81,81,81,81,81,81,81,81,81,81,81,84,86,88,88,91,97,110,110,],
            [84,84,84,84,84,84,84,84,84,84,84,84,84,86,88,91,91,94,100,114,114,],
            [84,84,84,84,84,84,84,84,84,84,84,84,84,86,88,91,91,94,100,114,114,],
            [84,84,84,84,84,84,84,84,84,84,84,84,84,86,88,91,91,94,100,114,114,],
            [86,86,86,86,86,86,86,86,86,86,86,86,86,88,91,94,94,97,102,119,119,],
            [86,86,86,86,86,86,86,86,86,86,86,86,86,88,91,94,94,97,102,119,119,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,94,97,97,100,104,123,123,],
            [88,88,88,88,88,88,88,88,88,88,88,88,88,91,94,97,97,100,104,123,123,],
            [91,91,91,91,91,91,91,91,91,91,91,91,91,94,97,100,100,102,108,126,126,],
            [91,91,91,91,91,91,91,91,91,91,91,91,91,94,97,100,100,102,108,126,126,],
            [94,94,94,94,94,94,94,94,94,94,94,94,94,97,100,102,102,104,112,131,131,],
            [94,94,94,94,94,94,94,94,94,94,94,94,94,97,100,102,102,104,112,131,131,],
            [97,97,97,97,97,97,97,97,97,97,97,97,97,100,102,104,104,108,115,134,134,],
            [100,100,100,100,100,100,100,100,100,100,100,100,100,102,104,108,108,112,119,137,137,]];

  var total_array = [40, 40, 40, 40, 40, 40, 40, 40, 41, 41, 41, 41, 41, 41, 41, 41, 42, 42, 42, 42, 42, 42, 42, 42, 43, 43, 43, 43, 43, 43, 43, 43, 44, 44, 44, 44, 44, 44, 44, 44, 45, 45, 45, 45, 45, 45, 45, 45, 46, 46, 46, 46, 46, 46, 46, 46, 47, 47, 47, 47, 47, 47, 47, 47, 48, 48, 48, 48, 48, 48, 48, 48, 49, 49, 49, 49, 49, 49, 49, 49, 50, 50, 50, 50, 50, 50, 50, 50, 51, 51, 51, 51, 51, 51, 51, 51, 52, 52, 52, 52, 52, 52, 52, 52, 53, 53, 53, 53, 53, 53, 53, 53, 54, 54, 54, 54, 54, 54, 54, 54, 55, 55, 55, 55, 55, 55, 55, 55, 56, 56, 56, 57, 57, 57, 58, 58, 58, 59, 59, 59, 60, 60, 60, 60, 61, 61, 61, 61, 62, 62, 62, 62, 63, 63, 63, 63, 64, 64, 64, 64, 65, 65, 65, 65, 66, 66, 66, 66, 67, 67, 67, 67, 67, 68, 68, 68, 68, 69, 69, 69, 69, 70, 70, 70, 70, 71, 71, 71, 72, 72, 72, 72, 73, 73, 73, 74, 74, 74, 74, 75, 75, 75, 75, 76, 76, 76, 77, 77, 77, 77, 78, 78, 78, 78, 78, 79, 79, 79, 79, 79, 80, 80, 80, 80, 80, 80, 80, 81, 81, 81, 81, 82, 82, 82, 82, 82, 83, 83, 83, 83, 83, 84, 84, 84, 84, 85, 85, 85, 85, 85, 86, 86, 86, 86, 86, 87, 87, 87, 87, 88, 88, 88, 89, 89, 89, 90, 90, 90, 90, 91, 91, 91, 92, 92, 92, 92, 93, 93, 93, 93, 94, 94, 94, 94, 95, 95, 95, 95, 96, 96, 96, 97, 97, 97, 98, 98, 98, 99, 99, 99, 100, 100, 100, 100, 100, 100, 101, 101, 101, 101, 102, 102, 102, 102, 103, 103, 103, 104, 104, 104, 104, 105, 105, 105, 106, 106, 106, 106, 107, 107, 107, 108, 108, 108, 109, 109, 109, 110, 110, 110, 111, 111, 111, 112, 112, 112, 113, 113, 113, 114, 114, 114, 115, 115, 115, 116, 116, 117, 117, 117, 118, 118, 118, 119, 119, 119, 119, 120, 120, 120, 120, 121, 121, 121, 122, 122, 122, 123, 123, 123, 123, 124, 124, 124, 124, 124, 124, 126, 126, 127, 127, 127, 128, 128, 129, 129, 129, 130, 130, 131, 131, 132, 132, 133, 133, 134, 134, 135, 135, 136, 136, 137, 137, 138, 139, 139, 140, 140, 141, 141, 142, 142, 143, 143, 143, 144, 144, 144, 144, 145, 145, 145, 145, 146, 146, 146, 146, 147, 147, 147, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 148, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 149, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 151, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 152, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 153, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 154, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 156, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 157, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 158, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 159, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160];

  return {
    GetZPercent: GetZPercent,
    immediate50: immediate50,
    immediate60: immediate60,
    immediate70: immediate70,
    immediate80: immediate80,
    visuo50: visuo50,
    visuo60: visuo60,
    visuo70: visuo70,
    visuo80: visuo80,
    language50: language50,
    language60: language60,
    language70: language70,
    language80: language80,
    att50: att50,
    att60: att60,
    att70: att70,
    att80: att80,
    mem50: mem50,
    mem60: mem60,
    mem70: mem70,
    mem80: mem80,
    total_array: total_array
  };
})();

/* ── rbans.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Instruments.RBANS — RBANS Calculator & Supplementary Analysis
   Re-implemented from rbanscalc.html with improved styling
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.RBANS = (function () {
  'use strict';

  var S = BHM.State;
  var N = BHM.RBANSNorms;
  var PREFIX = 'instruments.rbans';
  var _chart = null; // Chart.js instance

  // ── Subtest definitions ──
  var SUBTESTS = [
    { id: 'listlearning',    label: 'List Learning',     max: 40,  domain: 'Immediate Memory' },
    { id: 'storylearning',   label: 'Story Learning',    max: 24,  domain: 'Immediate Memory' },
    { id: 'figurecopy',      label: 'Figure Copy',       max: 20,  domain: 'Visuospatial/Constructional' },
    { id: 'lineorientation', label: 'Line Orientation',  max: 20,  domain: 'Visuospatial/Constructional' },
    { id: 'naming',          label: 'Picture Naming',    max: 10,  domain: 'Language' },
    { id: 'semanticfluency', label: 'Semantic Fluency',  max: 40,  domain: 'Language' },
    { id: 'digitspan',       label: 'Digit Span',        max: 16,  domain: 'Attention' },
    { id: 'coding',          label: 'Coding',            max: 89,  domain: 'Attention' },
    { id: 'listrecall',      label: 'List Recall',       max: 10,  domain: 'Delayed Memory' },
    { id: 'listrecog',       label: 'List Recognition',  max: 20,  domain: 'Delayed Memory' },
    { id: 'storyrecall',     label: 'Story Recall',      max: 12,  domain: 'Delayed Memory' },
    { id: 'figurerecall',    label: 'Figure Recall',     max: 20,  domain: 'Delayed Memory' }
  ];

  // ═══════════════════════════════════════════
  //  RENDER
  // ═══════════════════════════════════════════
  function render(container) {
    if (!container) return;
    container.innerHTML = '';

    var html = '';
    html += '<h5 class="mb-3"><i class="bi bi-calculator me-2"></i>RBANS Calculator &amp; Supplementary Analysis</h5>';

    // ── Two-column layout: inputs left, results right ──
    html += '<div class="row g-3">';

    // ═══ LEFT COLUMN: Inputs ═══
    html += '<div class="col-lg-5">';

    // -- Demographics card --
    html += '<div class="card mb-3">';
    html += '<div class="card-header bg-primary text-white py-2"><i class="bi bi-person me-1"></i> Demographics</div>';
    html += '<div class="card-body p-2">';
    html += '<table class="cdr-worksheet-table mb-0">';
    html += '<colgroup><col style="width:50%"><col style="width:50%"></colgroup>';
    html += demoRow('topf', 'TOPF Score', 'number', '0–70');
    html += demoRow('age', 'Age', 'number', 'Years');
    html += demoRow('years_of_education', 'Years of Education', 'number', 'Years');
    html += '<tr><td>Gender at Birth</td><td class="cdr-ws-note-cell">' +
      radioGroup('gender', [{ v: 'Male', l: 'Male' }, { v: 'Female', l: 'Female' }]) + '</td></tr>';
    html += '<tr><td>Ethnicity</td><td class="cdr-ws-note-cell">' +
      radioGroup('ethnicity', [{ v: 'White', l: 'White' }, { v: 'Non-White', l: 'Non-White' }]) + '</td></tr>';
    html += '</table>';
    html += '</div></div>';

    // -- Subtests card --
    html += '<div class="card mb-3">';
    html += '<div class="card-header bg-primary text-white py-2"><i class="bi bi-pencil-square me-1"></i> Subtest Raw Scores</div>';
    html += '<div class="card-body p-2">';
    html += '<table class="cdr-worksheet-table mb-0">';
    html += '<colgroup><col style="width:50%"><col style="width:30%"><col style="width:20%"></colgroup>';
    html += '<thead><tr><th style="text-align:left">Subtest</th><th>Score</th><th>Max</th></tr></thead>';
    html += '<tbody>';

    var lastDomain = '';
    for (var i = 0; i < SUBTESTS.length; i++) {
      var st = SUBTESTS[i];
      if (st.domain !== lastDomain) {
        html += '<tr class="cdr-ws-subsection"><td colspan="3">' + st.domain + '</td></tr>';
        lastDomain = st.domain;
      }
      var savedVal = S.get(PREFIX + '.' + st.id);
      html += '<tr><td>' + st.label + '</td>';
      html += '<td class="cdr-ws-note-cell"><input type="number" id="rbans-' + st.id + '" ' +
        'min="0" max="' + st.max + '" class="rbans-input" data-key="' + st.id + '" ' +
        (savedVal !== undefined && savedVal !== null ? 'value="' + savedVal + '"' : '') +
        ' placeholder="0–' + st.max + '"></td>';
      html += '<td style="text-align:center;color:#6c757d;font-size:0.8rem">/' + st.max + '</td>';
      html += '</tr>';
    }
    html += '</tbody></table>';
    html += '</div></div>';

    // -- Calculate button --
    html += '<div class="d-grid mb-3"><button class="btn btn-primary" id="rbans-calculate-btn">' +
      '<i class="bi bi-calculator me-1"></i>Calculate All Scores</button></div>';

    html += '</div>'; // end left column

    // ═══ RIGHT COLUMN: Results ═══
    html += '<div class="col-lg-7">';
    html += '<div id="rbans-results">';
    html += '<div class="card mb-3"><div class="card-body text-center text-muted py-4">' +
      '<i class="bi bi-arrow-left-circle me-1"></i>Enter demographics and subtest scores, then click Calculate</div></div>';
    html += '</div>';
    html += '</div>'; // end right column

    html += '</div>'; // end row

    container.innerHTML = html;

    // ── Bind events ──
    var inputs = container.querySelectorAll('.rbans-input');
    for (var j = 0; j < inputs.length; j++) {
      inputs[j].addEventListener('change', function () {
        var key = this.getAttribute('data-key');
        var val = this.value !== '' ? parseInt(this.value, 10) : null;
        S.set(PREFIX + '.' + key, val);
      });
    }

    // Radio buttons
    var radios = container.querySelectorAll('.rbans-radio');
    for (var k = 0; k < radios.length; k++) {
      radios[k].addEventListener('change', function () {
        var key = this.getAttribute('data-key');
        S.set(PREFIX + '.' + key, this.value);
      });
    }

    // Calculate button
    var calcBtn = container.querySelector('#rbans-calculate-btn');
    if (calcBtn) {
      calcBtn.addEventListener('click', function () {
        calculate();
      });
    }

    // Restore radio selections
    var savedGender = S.get(PREFIX + '.gender');
    if (savedGender) {
      var gEl = container.querySelector('input.rbans-radio[data-key="gender"][value="' + savedGender + '"]');
      if (gEl) gEl.checked = true;
    }
    var savedEth = S.get(PREFIX + '.ethnicity');
    if (savedEth) {
      var eEl = container.querySelector('input.rbans-radio[data-key="ethnicity"][value="' + savedEth + '"]');
      if (eEl) eEl.checked = true;
    }
  }

  // ── Helper: demographic input row ──
  function demoRow(id, label, type, placeholder) {
    var savedVal = S.get(PREFIX + '.' + id);
    return '<tr><td>' + label + '</td><td class="cdr-ws-note-cell">' +
      '<input type="' + type + '" id="rbans-' + id + '" class="rbans-input" data-key="' + id + '" ' +
      'placeholder="' + placeholder + '" ' +
      (savedVal !== undefined && savedVal !== null ? 'value="' + savedVal + '"' : '') +
      '></td></tr>';
  }

  // ── Helper: radio button group ──
  function radioGroup(key, options) {
    var html = '<div class="d-flex gap-3">';
    for (var i = 0; i < options.length; i++) {
      var uid = 'rbans-' + key + '-' + options[i].v;
      html += '<div class="form-check form-check-inline mb-0">' +
        '<input class="form-check-input rbans-radio" type="radio" name="rbans_' + key + '" ' +
        'id="' + uid + '" value="' + options[i].v + '" data-key="' + key + '">' +
        '<label class="form-check-label" for="' + uid + '" style="font-size:0.84rem">' + options[i].l + '</label></div>';
    }
    html += '</div>';
    return html;
  }

  // ═══════════════════════════════════════════
  //  CALCULATE
  // ═══════════════════════════════════════════
  function calculate() {
    var d = S.getSession().instruments.rbans || {};
    var SD = 15;

    // Validate required fields
    var missing = [];
    if (d.age === undefined || d.age === null) missing.push('Age');
    if (!d.gender) missing.push('Gender');
    if (!d.ethnicity) missing.push('Ethnicity');
    if (d.years_of_education === undefined || d.years_of_education === null) missing.push('Years of Education');
    for (var i = 0; i < SUBTESTS.length; i++) {
      if (d[SUBTESTS[i].id] === undefined || d[SUBTESTS[i].id] === null) {
        missing.push(SUBTESTS[i].label);
      }
    }
    if (missing.length > 0) {
      showError('Please complete: ' + missing.join(', '));
      return;
    }

    var age = parseInt(d.age, 10);
    var topf = d.topf !== undefined && d.topf !== null ? parseInt(d.topf, 10) : null;
    var yearsEd = parseInt(d.years_of_education, 10);

    // Get raw scores
    var listlearning = parseInt(d.listlearning, 10);
    var storylearning = parseInt(d.storylearning, 10);
    var figurecopy = parseInt(d.figurecopy, 10);
    var lineorientation = parseInt(d.lineorientation, 10);
    var naming = parseInt(d.naming, 10);
    var semanticfluency = parseInt(d.semanticfluency, 10);
    var digitspan = parseInt(d.digitspan, 10);
    var coding = parseInt(d.coding, 10);
    var listrecall = parseInt(d.listrecall, 10);
    var listrecog = parseInt(d.listrecog, 10);
    var storyrecall = parseInt(d.storyrecall, 10);
    var figurerecall = parseInt(d.figurerecall, 10);

    // Select age-normed tables
    var ageGroup;
    if (age > 79) ageGroup = '80';
    else if (age >= 70) ageGroup = '70';
    else if (age >= 60) ageGroup = '60';
    else ageGroup = '50';

    var memArray = N['mem' + ageGroup];
    var immArray = N['immediate' + ageGroup];
    var visuoArray = N['visuo' + ageGroup];
    var langArray = N['language' + ageGroup];
    var attArray = N['att' + ageGroup];

    // ── DELAYED MEMORY INDEX ──
    var delayedMemoryRaw = listrecall + storyrecall + figurerecall;
    var delayedMemoryIndex = safeTableLookup(memArray, delayedMemoryRaw, listrecog);

    // ── IMMEDIATE MEMORY INDEX ──
    var immediateMemoryIndex = safeTableLookup(immArray, listlearning, storylearning);

    // ── VISUOSPATIAL INDEX ──
    var visuospatialIndex = safeTableLookup(visuoArray, figurecopy, lineorientation);

    // ── LANGUAGE INDEX ──
    var languageIndex = safeTableLookup(langArray, semanticfluency, naming);

    // ── ATTENTION INDEX ──
    var attentionIndex = safeTableLookup(attArray, coding, digitspan);

    // ── TOTAL SCALE ──
    var totalIndexRaw = attentionIndex + languageIndex + visuospatialIndex + immediateMemoryIndex + delayedMemoryIndex - 200;
    var totalArray = N.total_array;
    var totalScaledScore = totalIndexRaw >= 0 && totalIndexRaw < totalArray.length
      ? totalArray[totalIndexRaw]
      : (totalIndexRaw < 0 ? totalArray[0] : totalArray[totalArray.length - 1]);

    // Percentiles
    var centile = function (idx) { return (100 * N.GetZPercent((idx - 100) / SD)).toFixed(1); };
    var immCentile = centile(immediateMemoryIndex);
    var visuoCentile = centile(visuospatialIndex);
    var langCentile = centile(languageIndex);
    var attCentile = centile(attentionIndex);
    var memCentile = centile(delayedMemoryIndex);
    var totalCentile = centile(totalScaledScore);

    // ── DUFF REGRESSION NORMS ──
    var sexbeta = d.gender === 'Male' ? 1 : 0;
    var ethnicbeta = d.ethnicity === 'White' ? 0 : 1;
    var yoebeta;
    if (yearsEd < 12) yoebeta = 1;
    else if (yearsEd === 12) yoebeta = 2;
    else if (yearsEd > 12 && yearsEd < 16) yoebeta = 3;
    else yoebeta = 4;

    var duff = {};
    // Immediate Memory
    duff.immPred = 95.54 - (age * 0.13) - (sexbeta * 4.36) + (yoebeta * 2.93) - (ethnicbeta * 6.65);
    duff.immZ = (immediateMemoryIndex - duff.immPred) / 17.24;
    duff.immIndex = (100 + duff.immZ * 15).toFixed(1);
    duff.immCentile = (100 * N.GetZPercent(duff.immZ)).toFixed(1);

    // Visuospatial
    duff.visuoPred = 103.34 - (age * 0.18) + (sexbeta * 5.20) + (yoebeta * 2.94) - (ethnicbeta * 8.79);
    duff.visuoZ = (visuospatialIndex - duff.visuoPred) / 16.20;
    duff.visuoIndex = (100 + duff.visuoZ * 15).toFixed(1);
    duff.visuoCentile = (100 * N.GetZPercent(duff.visuoZ)).toFixed(1);

    // Language
    duff.langPred = 92.77 - (age * 0.01) - (sexbeta * 3.25) + (yoebeta * 1.23) - (ethnicbeta * 5.74);
    duff.langZ = (languageIndex - duff.langPred) / 10.94;
    duff.langIndex = (100 + duff.langZ * 15).toFixed(1);
    duff.langCentile = (100 * N.GetZPercent(duff.langZ)).toFixed(1);

    // Attention
    duff.attPred = 106.92 - (age * 0.21) - (sexbeta * 2.07) + (yoebeta * 2.55) - (ethnicbeta * 7.35);
    duff.attZ = (attentionIndex - duff.attPred) / 15.43;
    duff.attIndex = (100 + duff.attZ * 15).toFixed(1);
    duff.attCentile = (100 * N.GetZPercent(duff.attZ)).toFixed(1);

    // Delayed Memory
    duff.memPred = 125.23 - (age * 0.43) - (sexbeta * 5.20) + (yoebeta * 2.12) - (ethnicbeta * 9.93);
    duff.memZ = (delayedMemoryIndex - duff.memPred) / 16.02;
    duff.memIndex = (100 + duff.memZ * 15).toFixed(1);
    duff.memCentile = (100 * N.GetZPercent(duff.memZ)).toFixed(1);

    // Total
    duff.totalPred = 105.01 - (age * 0.24) - (sexbeta * 2.86) + (yoebeta * 3.24) - (ethnicbeta * 10.33);
    duff.totalZ = (totalScaledScore - duff.totalPred) / 14.60;
    duff.totalIndex = (100 + duff.totalZ * 15).toFixed(1);
    duff.totalCentile = (100 * N.GetZPercent(duff.totalZ)).toFixed(1);

    // ── TOPF ──
    var fsiq = null;
    if (topf !== null && !isNaN(topf)) {
      fsiq = (29.991 + 2.0942600 * topf + (-0.0404559 * topf * topf) +
        (0.000340705 * topf * topf * topf) + yearsEd * 1.4617126 + 4.925 * (sexbeta + 1)).toFixed(0);
    }

    // ── EFFORT INDICES ──
    // Silverberg
    var digitEffort;
    if (digitspan < 5) digitEffort = 6;
    else if (digitspan === 5) digitEffort = 5;
    else if (digitspan === 6) digitEffort = 3;
    else if (digitspan === 7) digitEffort = 2;
    else digitEffort = 0;

    var recogEffort;
    if (listrecog < 10) recogEffort = 6;
    else if (listrecog === 10) recogEffort = 5;
    else if (listrecog >= 11 && listrecog <= 12) recogEffort = 4;
    else if (listrecog >= 13 && listrecog <= 14) recogEffort = 3;
    else if (listrecog >= 15 && listrecog <= 16) recogEffort = 2;
    else if (listrecog === 17) recogEffort = 1;
    else recogEffort = 0;

    var silverbergEI = digitEffort + recogEffort;

    // Novitski
    var novitskiES = digitspan + (listrecog - (listrecall + storylearning + figurerecall));

    // ── CORTICAL-SUBCORTICAL INDEX ──
    var corticalSub = ((visuospatialIndex + attentionIndex) / 2) - ((languageIndex + delayedMemoryIndex) / 2);

    // ── Save scores ──
    var scoreObj = {
      indices: {
        immediateMemory: immediateMemoryIndex,
        visuospatial: visuospatialIndex,
        language: languageIndex,
        attention: attentionIndex,
        delayedMemory: delayedMemoryIndex,
        totalScale: totalScaledScore
      },
      centiles: {
        immediateMemory: parseFloat(immCentile),
        visuospatial: parseFloat(visuoCentile),
        language: parseFloat(langCentile),
        attention: parseFloat(attCentile),
        delayedMemory: parseFloat(memCentile),
        totalScale: parseFloat(totalCentile)
      },
      duff: duff,
      fsiq: fsiq,
      silverbergEI: silverbergEI,
      novitskiES: novitskiES,
      corticalSubcortical: corticalSub
    };
    S.setScore('rbans', scoreObj);

    // ── Render results ──
    renderResults({
      age: age,
      topf: topf,
      fsiq: fsiq,
      indices: scoreObj.indices,
      centiles: scoreObj.centiles,
      duff: duff,
      silverbergEI: silverbergEI,
      novitskiES: novitskiES,
      corticalSub: corticalSub,
      rawScores: {
        listlearning: listlearning, storylearning: storylearning,
        figurecopy: figurecopy, lineorientation: lineorientation,
        naming: naming, semanticfluency: semanticfluency,
        digitspan: digitspan, coding: coding,
        listrecall: listrecall, listrecog: listrecog,
        storyrecall: storyrecall, figurerecall: figurerecall
      }
    });

    // Trigger report update
    if (BHM.Scoring && BHM.Scoring.triggerReport) BHM.Scoring.triggerReport();
  }

  // ── Safe table lookup with bounds clamping ──
  function safeTableLookup(table, row, col) {
    if (!table) return 40;
    var r = Math.max(0, Math.min(row, table.length - 1));
    var c = Math.max(0, Math.min(col, table[r].length - 1));
    return table[r][c];
  }

  // ── Show error in results area ──
  function showError(msg) {
    var el = document.getElementById('rbans-results');
    if (el) {
      el.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle me-1"></i>' + msg + '</div>';
    }
  }

  // ═══════════════════════════════════════════
  //  RENDER RESULTS
  // ═══════════════════════════════════════════
  function renderResults(r) {
    var el = document.getElementById('rbans-results');
    if (!el) return;

    var html = '';

    // ── TOPF Card ──
    if (r.fsiq !== null) {
      html += '<div class="card mb-3">';
      html += '<div class="card-header bg-info text-white py-2"><i class="bi bi-book me-1"></i> Test of Premorbid Functioning (TOPF)</div>';
      html += '<div class="card-body p-3">';
      html += '<p class="mb-1">The TOPF is a reading/vocabulary test to estimate premorbid ability. ' +
        'Score: <strong>' + r.topf + '/70</strong> — Estimated FSIQ: <strong>' + r.fsiq + '</strong>.</p>';
      html += '</div></div>';
    }

    // ── Domain Index Summary Table ──
    html += '<div class="card mb-3">';
    html += '<div class="card-header bg-primary text-white py-2"><i class="bi bi-bar-chart me-1"></i> Index Scores &amp; Centiles</div>';
    html += '<div class="card-body p-2">';
    html += '<table class="table table-sm table-hover mb-0 rbans-results-table">';
    html += '<thead><tr><th>Domain</th><th class="text-center">Index</th><th class="text-center">Centile</th>' +
      '<th class="text-center">Classification</th></tr></thead><tbody>';

    var domains = [
      { label: 'Immediate Memory', idx: r.indices.immediateMemory, cent: r.centiles.immediateMemory },
      { label: 'Visuospatial/Constructional', idx: r.indices.visuospatial, cent: r.centiles.visuospatial },
      { label: 'Language', idx: r.indices.language, cent: r.centiles.language },
      { label: 'Attention', idx: r.indices.attention, cent: r.centiles.attention },
      { label: 'Delayed Memory', idx: r.indices.delayedMemory, cent: r.centiles.delayedMemory }
    ];

    for (var i = 0; i < domains.length; i++) {
      var d = domains[i];
      var cls = classifyIndex(d.idx);
      html += '<tr><td><strong>' + d.label + '</strong></td>';
      html += '<td class="text-center"><span class="badge ' + cls.badge + '">' + d.idx + '</span></td>';
      html += '<td class="text-center">' + d.cent + '%</td>';
      html += '<td class="text-center"><small>' + cls.label + '</small></td></tr>';
    }

    // Total row
    var totalCls = classifyIndex(r.indices.totalScale);
    html += '<tr class="table-active"><td><strong>Total Scale</strong></td>';
    html += '<td class="text-center"><span class="badge ' + totalCls.badge + '">' + r.indices.totalScale + '</span></td>';
    html += '<td class="text-center">' + r.centiles.totalScale + '%</td>';
    html += '<td class="text-center"><small>' + totalCls.label + '</small></td></tr>';

    html += '</tbody></table></div></div>';

    // ── Chart ──
    html += '<div class="card mb-3">';
    html += '<div class="card-header bg-primary text-white py-2"><i class="bi bi-graph-up me-1"></i> RBANS Profile</div>';
    html += '<div class="card-body p-2"><div style="position:relative;height:380px">';
    html += '<canvas id="rbans-chart"></canvas>';
    html += '</div></div></div>';

    // ── Duff Regression Norms ──
    html += '<div class="card mb-3">';
    html += '<div class="card-header py-2" style="background:#fd7e14;color:#fff"><i class="bi bi-graph-down me-1"></i> Duff Demographically-Corrected Norms</div>';
    html += '<div class="card-body p-2">';
    html += '<p class="mb-2" style="font-size:0.82rem">Regression-based norms correcting for age, education, sex, and ethnicity (Duff &amp; Ramezani, 2015).</p>';
    html += '<table class="table table-sm table-hover mb-0 rbans-results-table">';
    html += '<thead><tr><th>Domain</th><th class="text-center">Predicted</th><th class="text-center">Adjusted Index</th>' +
      '<th class="text-center">Centile</th></tr></thead><tbody>';

    var duffRows = [
      { label: 'Immediate Memory', pred: r.duff.immPred, idx: r.duff.immIndex, cent: r.duff.immCentile },
      { label: 'Visuospatial', pred: r.duff.visuoPred, idx: r.duff.visuoIndex, cent: r.duff.visuoCentile },
      { label: 'Language', pred: r.duff.langPred, idx: r.duff.langIndex, cent: r.duff.langCentile },
      { label: 'Attention', pred: r.duff.attPred, idx: r.duff.attIndex, cent: r.duff.attCentile },
      { label: 'Delayed Memory', pred: r.duff.memPred, idx: r.duff.memIndex, cent: r.duff.memCentile },
      { label: 'Total Scale', pred: r.duff.totalPred, idx: r.duff.totalIndex, cent: r.duff.totalCentile }
    ];
    for (var j = 0; j < duffRows.length; j++) {
      var dr = duffRows[j];
      html += '<tr><td>' + dr.label + '</td><td class="text-center">' + dr.pred.toFixed(1) + '</td>';
      html += '<td class="text-center">' + dr.idx + '</td><td class="text-center">' + dr.cent + '%</td></tr>';
    }
    html += '</tbody></table></div></div>';

    // ── Effort Indices ──
    html += '<div class="card mb-3">';
    html += '<div class="card-header py-2" style="background:#6f42c1;color:#fff"><i class="bi bi-shield-check me-1"></i> Effort Indices</div>';
    html += '<div class="card-body p-3">';
    html += '<p class="mb-2"><strong>Silverberg Effort Index:</strong> ' + r.silverbergEI + '</p>';

    // Silverberg table
    html += '<table class="table table-sm table-bordered table-hover mb-3" style="font-size:0.8rem">';
    html += '<thead class="table-light"><tr><th>Cut-off</th><th>MTBI</th><th>Controls</th><th>Clinical Malingerers</th>' +
      '<th>Sim-naive</th><th>Sim-coached</th></tr></thead><tbody>';
    var sData = [
      ['>0', '0.781', '0.964', '0.933', '0.958', '0.857'],
      ['>1', '0.813', '0.964', '0.667', '0.917', '0.750'],
      ['>2', '0.906', '0.964', '0.667', '0.792', '0.500'],
      ['>3', '1.000', '1.000', '0.533', '0.708', '0.464']
    ];
    for (var s = 0; s < sData.length; s++) {
      html += '<tr>';
      for (var c = 0; c < sData[s].length; c++) {
        html += '<td class="text-center">' + sData[s][c] + '</td>';
      }
      html += '</tr>';
    }
    html += '</tbody></table>';

    html += '<p class="mb-0"><strong>Novitski Effort Scale:</strong> ' + r.novitskiES + '</p>';
    html += '</div></div>';

    // ── Cortical-Subcortical ──
    html += '<div class="card mb-3">';
    html += '<div class="card-header py-2" style="background:#198754;color:#fff"><i class="bi bi-diagram-3 me-1"></i> Cortical–Subcortical Index</div>';
    html += '<div class="card-body p-3">';
    html += '<p class="mb-1">The cortical–subcortical index (Beatty, 2003) is <strong>' + r.corticalSub.toFixed(1) + '</strong>.</p>';
    html += '<p class="mb-0 text-muted" style="font-size:0.82rem">Scores above 0 predict a cortical pattern; scores below 0 predict a subcortical pattern.</p>';
    html += '</div></div>';

    // ── Domain Narrative Sections ──
    html += renderNarrative(r);

    // ── References ──
    html += '<div class="card mb-3">';
    html += '<div class="card-header bg-secondary text-white py-2"><i class="bi bi-journal me-1"></i> References</div>';
    html += '<div class="card-body p-3" style="font-size:0.78rem">';
    html += '<ol class="mb-0">';
    html += '<li>Duff K, Ramezani A. Regression-Based Normative Formulae for the RBANS for Older Adults. Arch Clin Neuropsychol. 2015;30(7):600-4.</li>';
    html += '<li>Duff K, Patton D, Schoenberg MR, et al. Age- and education-corrected independent normative data for the RBANS. Clin Neuropsychol. 2003;17(3):351-66.</li>';
    html += '<li>Novitski J, et al. The RBANS Effort Scale. Arch Clin Neuropsychol. 2012;27(2):190-5.</li>';
    html += '<li>Silverberg ND, et al. An Effort Index for the RBANS. Clin Neuropsychol. 2007;21(5):841-54.</li>';
    html += '</ol></div></div>';

    el.innerHTML = html;

    // ── Render Chart ──
    renderChart(r);
  }

  // ── Index classification ──
  function classifyIndex(idx) {
    if (idx >= 130) return { label: 'Very Superior', badge: 'bg-primary' };
    if (idx >= 120) return { label: 'Superior', badge: 'bg-primary' };
    if (idx >= 110) return { label: 'High Average', badge: 'bg-success' };
    if (idx >= 90) return { label: 'Average', badge: 'bg-success' };
    if (idx >= 80) return { label: 'Low Average', badge: 'bg-warning text-dark' };
    if (idx >= 70) return { label: 'Borderline', badge: 'bg-warning text-dark' };
    return { label: 'Extremely Low', badge: 'bg-danger' };
  }

  // ── Domain narrative ──
  function renderNarrative(r) {
    var html = '<div class="card mb-3">';
    html += '<div class="card-header bg-dark text-white py-2"><i class="bi bi-chat-text me-1"></i> Domain Narratives</div>';
    html += '<div class="card-body p-3" style="font-size:0.88rem">';
    var raw = r.rawScores;

    html += '<h6 class="text-primary border-bottom pb-1 mb-2">Immediate Memory</h6>';
    html += '<p>You scored ' + raw.listlearning + '/40 on the word list learning task, a sensitive indicator of verbal learning. ';
    html += 'You scored ' + raw.storylearning + '/24 on the short story learning task. ';
    html += 'This gives an Immediate Memory Index of <strong>' + r.indices.immediateMemory + '</strong> (' + r.centiles.immediateMemory + 'th centile).</p>';

    html += '<h6 class="text-primary border-bottom pb-1 mb-2">Visuospatial Function</h6>';
    html += '<p>You scored ' + raw.lineorientation + '/20 on line orientation (visual perceptual ability) and ';
    html += raw.figurecopy + '/20 on figure copy (visual working memory and motor skill). ';
    html += 'This gives a Visuospatial/Constructional Index of <strong>' + r.indices.visuospatial + '</strong> (' + r.centiles.visuospatial + 'th centile).</p>';

    html += '<h6 class="text-primary border-bottom pb-1 mb-2">Language</h6>';
    html += '<p>You scored ' + raw.naming + '/10 on naming (word recall) and ';
    html += raw.semanticfluency + '/40 on semantic fluency (attention, executive function, and memory). ';
    html += 'This gives a Language Index of <strong>' + r.indices.language + '</strong> (' + r.centiles.language + 'th centile).</p>';

    html += '<h6 class="text-primary border-bottom pb-1 mb-2">Attention &amp; Concentration</h6>';
    html += '<p>You scored ' + raw.digitspan + '/16 on digit span (attention and working memory) and ';
    html += raw.coding + '/89 on digit-symbol coding (attention and processing speed). ';
    html += 'This gives an Attention Index of <strong>' + r.indices.attention + '</strong> (' + r.centiles.attention + 'th centile).</p>';

    html += '<h6 class="text-primary border-bottom pb-1 mb-2">Delayed Memory</h6>';
    html += '<p>You recalled ' + raw.listrecall + '/10 words (free recall), ' + raw.listrecog + '/20 on cued recognition, ';
    html += raw.storyrecall + '/12 story items, and ' + raw.figurerecall + '/20 on the complex figure. ';
    html += 'This gives a Delayed Memory Index of <strong>' + r.indices.delayedMemory + '</strong> (' + r.centiles.delayedMemory + 'th centile).</p>';

    html += '<h6 class="text-primary border-bottom pb-1 mb-2">Overall</h6>';
    html += '<p>The Total Scale score is <strong>' + r.indices.totalScale + '</strong> (' + r.centiles.totalScale + 'th centile). ';
    html += r.centiles.totalScale + '% of healthy people in your age group scored lower overall.</p>';

    html += '</div></div>';
    return html;
  }

  // ═══════════════════════════════════════════
  //  CHART (Chart.js)
  // ═══════════════════════════════════════════
  function renderChart(r) {
    var canvas = document.getElementById('rbans-chart');
    if (!canvas) return;

    // Destroy previous chart if exists
    if (_chart) { _chart.destroy(); _chart = null; }

    var labels = ['Immediate\nMemory', 'Visuospatial', 'Language', 'Attention', 'Delayed\nMemory'];
    var stdData = [r.indices.immediateMemory, r.indices.visuospatial, r.indices.language, r.indices.attention, r.indices.delayedMemory];
    var duffData = [parseFloat(r.duff.immIndex), parseFloat(r.duff.visuoIndex), parseFloat(r.duff.langIndex),
      parseFloat(r.duff.attIndex), parseFloat(r.duff.memIndex)];

    _chart = new Chart(canvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Standard Norms',
            data: stdData,
            borderColor: 'rgb(17, 157, 255)',
            backgroundColor: 'rgba(17, 157, 255, 0.1)',
            borderWidth: 2.5,
            pointRadius: 6,
            pointBackgroundColor: 'rgb(17, 157, 255)',
            tension: 0.1
          },
          {
            label: 'Duff Adjusted',
            data: duffData,
            borderColor: 'rgb(255, 102, 0)',
            backgroundColor: 'rgba(255, 102, 0, 0.1)',
            borderWidth: 2.5,
            borderDash: [6, 3],
            pointRadius: 6,
            pointBackgroundColor: 'rgb(255, 102, 0)',
            pointStyle: 'rectRot',
            tension: 0.1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'RBANS Index Profile',
            font: { size: 14, weight: 'bold' }
          },
          legend: {
            position: 'bottom'
          },
          annotation: undefined // no plugin needed
        },
        scales: {
          y: {
            min: 40,
            max: 160,
            ticks: {
              stepSize: 10,
              callback: function (val) {
                // Show percentile on the right
                return val;
              }
            },
            title: {
              display: true,
              text: 'Index Score'
            }
          }
        }
      },
      plugins: [{
        id: 'rbans-bands',
        beforeDraw: function (chart) {
          var ctx = chart.ctx;
          var yScale = chart.scales.y;
          var area = chart.chartArea;

          // Severity bands
          var bands = [
            { lo: 40, hi: 55, color: 'rgba(255,77,77,0.10)' },    // Extremely Low
            { lo: 55, hi: 70, color: 'rgba(255,165,0,0.10)' },    // Borderline
            { lo: 70, hi: 85, color: 'rgba(255,255,0,0.08)' },    // Low Average
            { lo: 85, hi: 115, color: 'rgba(204,255,204,0.12)' },  // Average
            { lo: 115, hi: 130, color: 'rgba(153,255,153,0.10)' }, // High Average+
            { lo: 130, hi: 160, color: 'rgba(77,255,77,0.10)' }   // Superior+
          ];

          ctx.save();
          for (var b = 0; b < bands.length; b++) {
            var top = yScale.getPixelForValue(bands[b].hi);
            var bottom = yScale.getPixelForValue(bands[b].lo);
            ctx.fillStyle = bands[b].color;
            ctx.fillRect(area.left, top, area.right - area.left, bottom - top);
          }

          // Mean line
          var meanY = yScale.getPixelForValue(100);
          ctx.strokeStyle = 'rgba(0,0,0,0.2)';
          ctx.lineWidth = 1;
          ctx.setLineDash([4, 4]);
          ctx.beginPath();
          ctx.moveTo(area.left, meanY);
          ctx.lineTo(area.right, meanY);
          ctx.stroke();
          ctx.restore();
        }
      }]
    });
  }

  return {
    render: render,
    calculate: calculate
  };
})();

/* ── cdr.js ── */
/* CDR Instrument - Clinical Dementia Rating Scale
   Assessment interview worksheet + Scoring grid/calculator
   Based on: CDR English United States (Washington University)
   ========================================================== */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.CDR = (function () {
  'use strict';

  var SP = 'instruments.cdr';
  var S = BHM.State;
  var F = BHM.ClickableGrid;

  /* ═══════════════════════════════════════
     DOMAIN DATA for scoring grid
     ═══════════════════════════════════════ */
  var DOMAINS = [
    { key: 'memory', label: 'Memory', descriptions: [
        'No memory loss or slight inconsistent forgetfulness',
        'Consistent slight forgetfulness; partial recollection of events; \u201cbenign\u201d forgetfulness',
        'Moderate memory loss; more marked for recent events; defect interferes with everyday activities',
        'Severe memory loss; only highly learned material retained; new material rapidly lost',
        'Severe memory loss; only fragments remain'
    ]},
    { key: 'orientation', label: 'Orientation', descriptions: [
        'Fully oriented',
        'Fully oriented except for slight difficulty with time relationships',
        'Moderate difficulty with time relationships; oriented for place at examination; may have geographic disorientation elsewhere',
        'Severe difficulty with time relationships; usually disoriented to time, often to place',
        'Oriented to person only'
    ]},
    { key: 'judgment', label: 'Judgment & Problem Solving', descriptions: [
        'Solves everyday problems & handles business & financial affairs well; judgment good in relation to past performance',
        'Slight impairment in solving problems, similarities, and differences',
        'Moderate difficulty in handling problems, similarities, and differences; social judgment usually maintained',
        'Severely impaired in handling problems, similarities, and differences; social judgment usually impaired',
        'Unable to make judgments or solve problems'
    ]},
    { key: 'community', label: 'Community Affairs', descriptions: [
        'Independent function at usual level in job, shopping, volunteer and social groups',
        'Slight impairment in these activities',
        'Unable to function independently at these activities although may still be engaged in some; appears normal to casual inspection',
        'No pretense of independent function outside home. Appears well enough to be taken to functions outside a family home',
        'No pretense of independent function outside home. Appears too ill to be taken to functions outside a family home'
    ]},
    { key: 'homeHobbies', label: 'Home and Hobbies', descriptions: [
        'Life at home, hobbies, and intellectual interests well maintained',
        'Life at home, hobbies, and intellectual interests slightly impaired',
        'Mild but definite impairment of function at home; more difficult chores abandoned; more complicated hobbies and interests abandoned',
        'Only simple chores preserved; very restricted interests, poorly maintained',
        'No significant function in home'
    ]},
    { key: 'personalCare', label: 'Personal Care', isPersonalCare: true, descriptions: [
        'Fully capable of self-care',
        null,
        'Needs prompting',
        'Requires assistance in dressing, hygiene, keeping of personal effects',
        'Requires much help with personal care; frequent incontinence'
    ]}
  ];

  var SCORE_VALUES = [0, 0.5, 1, 2, 3];

  /* ═══════════════════════════════════════
     ASSESSMENT TAB - Semi-structured interview worksheet
     Tabular layout based on CDR English United States
     (Washington University)
     ═══════════════════════════════════════ */
  function renderAssessment(container) {
    container.innerHTML = '';
    var card = document.createElement('div');
    card.className = 'instrument-card';
    card.innerHTML =
      '<h5>Clinical Dementia Rating Worksheet</h5>' +
      '<p class="instrument-subtitle">This is a semi-structured interview. Please ask all of these questions. Ask any additional questions necessary to determine the subject\u2019s CDR.</p>' +
      '<p class="text-muted small mb-0">All rights reserved. Copyright 2001 by Washington University in St. Louis, Missouri.</p>';

    // ═══ MEMORY - INFORMANT ═══
    card.appendChild(wsSection('Memory Questions for Informant'));
    card.appendChild(wsTable(['Question', 'Yes', 'No'], [
      ['Does he/she have a problem with his/her memory or thinking?', 'mem_inf_problem'],
      ['1a. If yes, is this a consistent problem (as opposed to inconsistent)?', 'mem_inf_consistent']
    ]));
    card.appendChild(wsTable(['Question', 'Usually', 'Sometimes', 'Rarely'], [
      ['Can he/she recall recent events?', 'mem_inf_recall'],
      ['Can he/she remember a short list of items (shopping)?', 'mem_inf_list']
    ]));
    card.appendChild(wsTable(['Question', 'Yes', 'No'], [
      ['Has there been some decline in memory during the past year?', 'mem_inf_decline'],
      ['Is his/her memory impaired to such a degree that it would have interfered with his/her activities of daily life a few years ago (or pre-retirement activities)?', 'mem_inf_adl']
    ]));
    card.appendChild(wsTable(['Question', 'Usually', 'Sometimes', 'Rarely'], [
      ['Does he/she completely forget a major event (e.g., trip, party, family wedding) within a few weeks of the event?', 'mem_inf_forget_event'],
      ['Does he/she forget pertinent details of the major event?', 'mem_inf_forget_details'],
      ['Does he/she completely forget important information of the distant past (e.g., birthdate, wedding date, place of employment)?', 'mem_inf_forget_distant']
    ]));
    card.appendChild(wsNoteRow('mem_inf_recent_event', 'Tell me about some recent event in his/her life that he/she should remember. (For later testing, obtain details such as location, time, participants, how long, when ended, how they got there).'));
    card.appendChild(wsFieldGrid([
      ['mem_inf_event_1wk', 'Within 1 week:'],
      ['mem_inf_event_1mo', 'Within 1 month:']
    ], 2));
    card.appendChild(wsFieldGrid([
      ['mem_inf_born_when', 'When was he/she born?'],
      ['mem_inf_born_where', 'Where was he/she born?'],
      ['mem_inf_school', 'Last school attended?']
    ], 3));
    card.appendChild(wsFieldGrid([
      ['mem_inf_occupation', 'Main occupation/job?'],
      ['mem_inf_last_job', 'Last major job?'],
      ['mem_inf_retire', 'When retire and why?']
    ], 3));

    // ═══ ORIENTATION - INFORMANT ═══
    card.appendChild(wsSection('Orientation Questions for Informant'));
    card.appendChild(wsSubLabel('How often does he/she know the exact:'));
    card.appendChild(wsTable(['Question', 'Usually', 'Sometimes', 'Rarely', "Don't Know"], [
      ['Date of the Month?', 'ori_inf_date'],
      ['Month?', 'ori_inf_month'],
      ['Year?', 'ori_inf_year'],
      ['Day of the Week?', 'ori_inf_day'],
      ['Does he/she have difficulty with time relationships (when events happened in relation to each other)?', 'ori_inf_time_rel'],
      ['Can he/she find his/her way about familiar streets?', 'ori_inf_streets'],
      ['How often does he/she know how to get from one place to another outside his/her neighbourhood?', 'ori_inf_outside'],
      ['How often can he/she find his/her way about indoors?', 'ori_inf_indoors']
    ]));

    // ═══ JUDGMENT - INFORMANT ═══
    card.appendChild(wsSection('Judgment and Problem Solving Questions for Informant'));
    card.appendChild(wsTable(['In general, rate his/her problem-solving abilities:', 'As good as ever', 'Good, not as good', 'Fair', 'Poor', 'No ability'], [
      ['Rate his/her abilities to solve problems at the present time', 'judg_inf_rate']
    ]));
    card.appendChild(wsTable(['Rate ability to handle money:', 'No loss', 'Some loss', 'Severe loss'], [
      ['Cope with small sums of money (e.g., make change, leave a small tip)', 'judg_inf_money'],
      ['Handle complicated financial or business transactions (e.g., balance chequebook, pay bills)', 'judg_inf_financial']
    ]));
    card.appendChild(wsTable(['Question', 'As well as before', 'Worse (thinking)', 'Worse (other)'], [
      ['Can he/she handle a household emergency (e.g., plumbing leak, small fire)?', 'judg_inf_emergency']
    ]));
    card.appendChild(wsTable(['Question', 'Usually', 'Sometimes', 'Rarely', "Don't Know"], [
      ['Can he/she understand situations or explanations?', 'judg_inf_understand'],
      ['Does he/she behave appropriately in social situations and interactions?', 'judg_inf_behave']
    ]));

    // ═══ COMMUNITY AFFAIRS - INFORMANT ═══
    card.appendChild(wsSection('Community Affairs Questions for Informant'));
    card.appendChild(wsSubLabel('Occupational'));
    card.appendChild(wsTable(['Question', 'Yes', 'No', 'N/A'], [
      ['1. Is the subject still working?', 'comm_inf_working']
    ]));
    card.appendChild(wsTable(['Question', 'Yes', 'No'], [
      ['2. Did memory or thinking problems contribute to the subject\u2019s decision to retire?', 'comm_inf_retire_reason']
    ]));
    card.appendChild(wsTable(['Question', 'Rarely/Never', 'Sometimes', 'Usually', "Don't Know"], [
      ['3. Does the subject have significant difficulty in his/her job because of problems with memory or thinking?', 'comm_inf_job_diff']
    ]));
    card.appendChild(wsSubLabel('Social'));
    card.appendChild(wsTable(['Question', 'Yes', 'No'], [
      ['4. Did he/she ever drive a car?', 'comm_inf_drive_ever'],
      ['Does the subject drive a car now?', 'comm_inf_drive_now'],
      ['If no, is this because of memory or thinking problems?', 'comm_inf_drive_memory'],
      ['5. If still driving, are there problems or risks because of poor thinking?', 'comm_inf_drive_risk']
    ]));
    card.appendChild(wsTable(['Question', 'Rarely/Never', 'Sometimes', 'Usually', "Don't Know"], [
      ['6. Is he/she able to independently shop for needs?', 'comm_inf_shop'],
      ['7. Is he/she able to independently carry out activities outside the home?', 'comm_inf_activities']
    ]));
    card.appendChild(wsTable(['Question', 'Yes', 'No'], [
      ['Is he/she taken to social functions outside a family home?', 'comm_inf_social_fn'],
      ['Would a casual observer think the subject was ill?', 'comm_inf_observer']
    ]));
    card.appendChild(wsNoteRow('comm_inf_notes', 'Community Affairs notes'));

    // ═══ HOME AND HOBBIES - INFORMANT ═══
    card.appendChild(wsSection('Home and Hobbies Questions for Informant'));
    card.appendChild(wsFieldGrid([
      ['home_inf_chore_changes', '1a. What changes have occurred in his/her abilities to perform household chores?'],
      ['home_inf_chore_can', '1b. What can he/she still do well?']
    ], 2));
    card.appendChild(wsFieldGrid([
      ['home_inf_hobby_changes', '2a. What changes have occurred in his/her abilities to perform hobbies?'],
      ['home_inf_hobby_can', '2b. What can he/she still do well?']
    ], 2));
    card.appendChild(wsTable(['Household chore level:', 'Normal function', 'Not at usual level', 'Independent in some', 'Limited only', 'No meaningful function'], [
      ['Is he/she able to perform household chores at the level of:', 'home_inf_household_level']
    ]));
    card.appendChild(wsNoteRow('home_inf_notes', 'Home and Hobbies notes'));

    // ═══ PERSONAL CARE - INFORMANT ═══
    card.appendChild(wsSection('Personal Care Questions for Informant'));
    card.appendChild(wsSubLabel('What is your estimate of his/her mental ability in the following areas:'));
    card.appendChild(wsBlessedTable());
    card.appendChild(wsSubLabel('* A box-score of 1 can be considered if the subject\u2019s personal care is impaired from a previous level, even if they do not receive prompting.'));

    // ═══ MEMORY - SUBJECT ═══
    card.appendChild(wsSection('Memory Questions for Subject'));
    card.appendChild(wsTable(['Question', 'Yes', 'No'], [
      ['Do you have problems with memory or thinking?', 'mem_subj_problem']
    ]));
    card.appendChild(wsSubLabel('A few moments ago your informant told me a few recent experiences you had. Will you tell me something about those?'));
    card.appendChild(wsTable(['Recall', '1.0 \u2013 Largely correct', '0.5', '0.0 \u2013 Largely incorrect'], [
      ['Within 1 week', 'mem_subj_recall_1wk'],
      ['Within 1 month', 'mem_subj_recall_1mo']
    ]));
    card.appendChild(wsSubLabel('Name and address memory test: John Brown, 42 Market Street, Chicago'));
    card.appendChild(wsFieldGrid([
      ['mem_subj_trial1', 'Trial 1 (elements correct):'],
      ['mem_subj_trial2', 'Trial 2 (elements correct):'],
      ['mem_subj_trial3', 'Trial 3 (elements correct):']
    ], 3));
    card.appendChild(wsFieldGrid([
      ['mem_subj_born_when', 'When were you born?'],
      ['mem_subj_born_where', 'Where were you born?'],
      ['mem_subj_school', 'Last school attended?']
    ], 3));
    card.appendChild(wsFieldGrid([
      ['mem_subj_occupation', 'Main occupation/job?'],
      ['mem_subj_last_job', 'Last major job?'],
      ['mem_subj_retire', 'When retire and why?']
    ], 3));
    card.appendChild(wsSubLabel('Repeat the name and address I asked you to remember:'));
    card.appendChild(wsFieldGrid([
      ['mem_subj_delayed', 'Delayed recall (elements correct):']
    ], 1));

    // ═══ ORIENTATION - SUBJECT ═══
    card.appendChild(wsSection('Orientation Questions for Subject'));
    card.appendChild(wsSubLabel('Record the subject\u2019s answer verbatim for each question'));
    card.appendChild(wsOrientationSubjectTable());

    // ═══ JUDGMENT - SUBJECT ═══
    card.appendChild(wsSection('Judgment and Problem Solving Questions for Subject'));
    card.appendChild(wsSubLabel('Similarities'));
    card.appendChild(wsTable(['Item', '0', '1', '2'], [
      ['Turnip \u2026 cauliflower (0 = vegetables; 1 = edible/living/cooked; 2 = not pertinent)', 'judg_subj_sim1'],
      ['Desk \u2026 bookcase (0 = furniture; 1 = wooden/legs; 2 = not pertinent)', 'judg_subj_sim2']
    ]));
    card.appendChild(wsSubLabel('Differences'));
    card.appendChild(wsTable(['Item', '0', '1', '2'], [
      ['Lie \u2026 mistake (0 = deliberate vs unintentional; 1 = one bad/one good; 2 = other)', 'judg_subj_diff1'],
      ['River \u2026 canal (0 = natural vs artificial; 2 = anything else)', 'judg_subj_diff2']
    ]));
    card.appendChild(wsSubLabel('Calculations'));
    card.appendChild(wsTable(['Question', 'Correct', 'Incorrect'], [
      ['How many nickels in a dollar?', 'judg_subj_calc1'],
      ['How many quarters in $6.75?', 'judg_subj_calc2'],
      ['Subtract 3 from 20 and keep subtracting 3 all the way down', 'judg_subj_calc3']
    ]));
    card.appendChild(wsSubLabel('Judgment'));
    card.appendChild(wsTable(['Question', '0', '1', '2'], [
      ['Upon arriving in a strange city, how would you locate a friend? (0=phone book/courthouse; 1=police/operator; 2=no clear response)', 'judg_subj_city']
    ]));
    card.appendChild(wsTable(['Subject\u2019s assessment of disability and understanding:', 'Good Insight', 'Partial Insight', 'Little Insight'], [
      ['Rate insight', 'judg_subj_insight']
    ]));

    container.appendChild(card);
  }

  /* ── Tabular helper: build a worksheet table ── */
  function wsTable(headers, rows) {
    var wrap = document.createElement('div');
    wrap.className = 'table-responsive';
    var table = document.createElement('table');
    table.className = 'cdr-worksheet-table';
    // header
    var thead = document.createElement('thead');
    var htr = document.createElement('tr');
    for (var h = 0; h < headers.length; h++) {
      var th = document.createElement('th');
      th.textContent = headers[h];
      htr.appendChild(th);
    }
    thead.appendChild(htr);
    table.appendChild(thead);
    // body
    var tbody = document.createElement('tbody');
    var optCount = headers.length - 1;
    for (var r = 0; r < rows.length; r++) {
      var tr = document.createElement('tr');
      var tdQ = document.createElement('td');
      tdQ.textContent = rows[r][0];
      tr.appendChild(tdQ);
      var key = rows[r][1];
      for (var o = 0; o < optCount; o++) {
        var tdO = document.createElement('td');
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'cdr-ws-btn';
        btn.textContent = '\u25CB';
        var val = headers[o + 1].toLowerCase();
        btn.setAttribute('data-key', key);
        btn.setAttribute('data-val', val);
        btn.addEventListener('click', wsBtnHandler);
        var cur = S.get(SP + '.' + key);
        if (cur === val) { btn.classList.add('active'); btn.textContent = '\u25CF'; }
        tdO.appendChild(btn);
        tr.appendChild(tdO);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  function wsBtnHandler(e) {
    var btn = e.target;
    var key = btn.getAttribute('data-key');
    var val = btn.getAttribute('data-val');
    // deselect siblings in same row
    var row = btn.closest('tr');
    var btns = row.querySelectorAll('.cdr-ws-btn');
    for (var i = 0; i < btns.length; i++) { btns[i].classList.remove('active'); btns[i].textContent = '\u25CB'; }
    btn.classList.add('active');
    btn.textContent = '\u25CF';
    S.set(SP + '.' + key, val);
  }

  /* ── Section heading ── */
  function wsSection(title) {
    var div = document.createElement('div');
    div.className = 'cdr-ws-section';
    div.innerHTML = '<h6><i class="bi bi-chat-square-text me-1"></i>' + title + '</h6>';
    return div;
  }
  function wsSubLabel(text) {
    var div = document.createElement('div');
    div.className = 'cdr-ws-subsection mb-1';
    div.textContent = text;
    return div;
  }

  /* ── Note / textarea row ── */
  function wsNoteRow(key, label) {
    var div = document.createElement('div');
    div.className = 'mb-2';
    var lbl = document.createElement('div');
    lbl.className = 'cdr-ws-subsection mb-1';
    lbl.textContent = label;
    div.appendChild(lbl);
    var ta = document.createElement('textarea');
    ta.className = 'form-control form-control-sm';
    ta.rows = 2;
    ta.style.fontSize = '0.82rem';
    var cur = S.get(SP + '.' + key);
    if (cur) ta.value = cur;
    ta.addEventListener('input', function () { S.set(SP + '.' + key, this.value); });
    div.appendChild(ta);
    return div;
  }

  /* ── Grid of text fields ── */
  function wsFieldGrid(fields, cols) {
    var row = document.createElement('div');
    row.className = 'row g-2 mb-2';
    var colCls = cols >= 3 ? 'col-md-4' : cols === 2 ? 'col-md-6' : 'col-12';
    for (var i = 0; i < fields.length; i++) {
      var col = document.createElement('div');
      col.className = colCls;
      var lbl = document.createElement('label');
      lbl.className = 'form-label mb-0';
      lbl.style.fontSize = '0.82rem';
      lbl.textContent = fields[i][1];
      col.appendChild(lbl);
      var inp = document.createElement('input');
      inp.type = 'text';
      inp.className = 'form-control form-control-sm';
      inp.style.fontSize = '0.82rem';
      var key = fields[i][0];
      var cur = S.get(SP + '.' + key);
      if (cur) inp.value = cur;
      inp.setAttribute('data-key', key);
      inp.addEventListener('input', function () { S.set(SP + '.' + this.getAttribute('data-key'), this.value); });
      col.appendChild(inp);
      row.appendChild(col);
    }
    return row;
  }

  /* ── Blessed personal care scoring table ── */
  function wsBlessedTable() {
    var blessedData = [
      { key: 'pc_inf_dressing', label: 'A. Dressing', opts: ['Unaided', 'Occasionally misplaced buttons, etc.', 'Wrong sequence, commonly forgotten items', 'Unable to dress'] },
      { key: 'pc_inf_washing', label: 'B. Washing, grooming', opts: ['Unaided', 'Needs prompting', 'Sometimes needs help', 'Always or nearly always needs help'] },
      { key: 'pc_inf_eating', label: 'C. Eating habits', opts: ['Cleanly; proper utensils', 'Messily; spoon', 'Simple solids', 'Has to be fed completely'] },
      { key: 'pc_inf_sphincter', label: 'D. Sphincter control', opts: ['Normal complete control', 'Occasionally wets bed', 'Frequently wets bed', 'Doubly incontinent'] }
    ];
    var wrap = document.createElement('div');
    wrap.className = 'table-responsive';
    var table = document.createElement('table');
    table.className = 'cdr-blessed-table';
    var thead = document.createElement('thead');
    var htr = document.createElement('tr');
    var hLabels = ['', '0', '1', '2', '3'];
    for (var h = 0; h < hLabels.length; h++) {
      var th = document.createElement('th');
      th.textContent = hLabels[h];
      htr.appendChild(th);
    }
    thead.appendChild(htr);
    table.appendChild(thead);
    var tbody = document.createElement('tbody');
    for (var r = 0; r < blessedData.length; r++) {
      var item = blessedData[r];
      var tr = document.createElement('tr');
      var tdLabel = document.createElement('td');
      tdLabel.textContent = item.label;
      tr.appendChild(tdLabel);
      for (var c = 0; c < item.opts.length; c++) {
        var td = document.createElement('td');
        td.title = item.opts[c];
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'cdr-ws-btn';
        btn.innerHTML = '<small>' + esc(item.opts[c]) + '</small>';
        btn.setAttribute('data-key', item.key);
        btn.setAttribute('data-val', String(c));
        btn.addEventListener('click', wsBtnHandler);
        var cur = S.get(SP + '.' + item.key);
        if (cur === String(c)) { btn.classList.add('active'); }
        td.appendChild(btn);
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  /* ── Orientation subject table (question + answer + correct/incorrect) ── */
  function wsOrientationSubjectTable() {
    var qs = [
      ['ori_subj_date', 'What is the date today?'],
      ['ori_subj_day', 'What day of the week is it?'],
      ['ori_subj_month', 'What is the month?'],
      ['ori_subj_year', 'What is the year?'],
      ['ori_subj_place', 'What is the name of this place?'],
      ['ori_subj_town', 'What town or city are we in?'],
      ['ori_subj_time', 'What time is it?'],
      ['ori_subj_knows_informant', 'Does the subject know who the informant is?']
    ];
    var wrap = document.createElement('div');
    wrap.className = 'table-responsive';
    var table = document.createElement('table');
    table.className = 'cdr-worksheet-table';
    var thead = document.createElement('thead');
    var htr = document.createElement('tr');
    var headers = ['Question', 'Answer', 'Correct', 'Incorrect'];
    for (var h = 0; h < headers.length; h++) {
      var th = document.createElement('th');
      th.textContent = headers[h];
      htr.appendChild(th);
    }
    thead.appendChild(htr);
    table.appendChild(thead);
    var tbody = document.createElement('tbody');
    for (var r = 0; r < qs.length; r++) {
      var tr = document.createElement('tr');
      var tdQ = document.createElement('td');
      tdQ.textContent = qs[r][1];
      tr.appendChild(tdQ);
      // answer field
      var tdA = document.createElement('td');
      tdA.className = 'cdr-ws-note-cell';
      var inp = document.createElement('input');
      inp.type = 'text';
      inp.setAttribute('data-key', qs[r][0] + '_ans');
      var curA = S.get(SP + '.' + qs[r][0] + '_ans');
      if (curA) inp.value = curA;
      inp.addEventListener('input', function () { S.set(SP + '.' + this.getAttribute('data-key'), this.value); });
      tdA.appendChild(inp);
      tr.appendChild(tdA);
      // correct/incorrect buttons
      var ciBtns = ['correct', 'incorrect'];
      for (var ci = 0; ci < ciBtns.length; ci++) {
        var tdCI = document.createElement('td');
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'cdr-ws-btn';
        btn.textContent = '\u25CB';
        btn.setAttribute('data-key', qs[r][0]);
        btn.setAttribute('data-val', ciBtns[ci]);
        btn.addEventListener('click', wsBtnHandler);
        var cur = S.get(SP + '.' + qs[r][0]);
        if (cur === ciBtns[ci]) { btn.classList.add('active'); btn.textContent = '\u25CF'; }
        tdCI.appendChild(btn);
        tr.appendChild(tdCI);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  /* ═══════════════════════════════════════
     SCORING TAB - Clickable CDR grid + calculator
     ═══════════════════════════════════════ */
  function renderScoring(container) {
    container.innerHTML = '';
    var card = document.createElement('div');
    card.className = 'instrument-card';
    card.innerHTML =
      '<h5>Clinical Dementia Rating (CDR) \u2014 Scoring</h5>' +
      '<p class="instrument-subtitle">Based on the interview, rate each domain below. Scores are calculated using the Washington University algorithm.</p>' +
      '<p class="fw-bold text-center mb-3">Score only as decline from previous usual level due to cognitive loss, not impairment due to other factors.</p>';

    // ── CDR Total Score header table ──
    var totalCard = document.createElement('div');
    totalCard.className = 'card mb-3';
    totalCard.innerHTML =
      '<div class="card-header"><strong>Clinical Dementia Rating (CDR):</strong></div>' +
      '<div class="card-body p-0">' +
        '<table class="table table-bordered mb-0 text-center" id="cdr-score-table">' +
          '<tr><td class="fw-bold">CDR Score</td><td>0</td><td>0.5</td><td>1</td><td>2</td><td>3</td></tr>' +
        '</table>' +
      '</div>';
    card.appendChild(totalCard);

    // ── Clickable CDR rating grid ──
    var tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive mb-3';

    var table = document.createElement('table');
    table.className = 'clickable-grid cdr-assessment-table';
    table.id = 'cdr-rating-grid';

    var thead = document.createElement('thead');
    var htr = document.createElement('tr');
    var cols = ['', 'None 0', 'Questionable 0.5', 'Mild 1', 'Moderate 2', 'Severe 3'];
    for (var h = 0; h < cols.length; h++) {
      var th = document.createElement('th');
      th.textContent = cols[h];
      htr.appendChild(th);
    }
    thead.appendChild(htr);
    table.appendChild(thead);

    var tbody = document.createElement('tbody');
    for (var d = 0; d < DOMAINS.length; d++) {
      var domain = DOMAINS[d];
      var tr = document.createElement('tr');
      tr.setAttribute('data-domain', domain.key);
      var tdLabel = document.createElement('td');
      tdLabel.className = 'cdr-domain-label';
      tdLabel.textContent = domain.label;
      tr.appendChild(tdLabel);

      for (var c = 0; c < SCORE_VALUES.length; c++) {
        var td = document.createElement('td');
        td.className = 'cdr-score-cell';
        td.setAttribute('data-domain', domain.key);
        td.setAttribute('data-score', SCORE_VALUES[c]);
        td.setAttribute('tabindex', '0');
        td.setAttribute('role', 'radio');
        td.setAttribute('aria-label', domain.label + ' score ' + SCORE_VALUES[c]);

        if (domain.isPersonalCare && c === 0) {
          td.setAttribute('colspan', '2');
          td.innerHTML = '<small>' + esc(domain.descriptions[0]) + '</small>';
          tr.appendChild(td);
          c++;
          continue;
        }
        if (domain.isPersonalCare && c === 1) { continue; }

        var desc = domain.descriptions[c];
        if (desc) {
          td.innerHTML = '<small>' + esc(desc) + '</small>';
        } else {
          td.className += ' cdr-empty-cell';
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    tableWrap.appendChild(table);
    card.appendChild(tableWrap);

    // ── Box scores summary ──
    var boxCard = document.createElement('div');
    boxCard.className = 'card mb-3';
    boxCard.innerHTML =
      '<div class="card-header"><strong>Box Scores Summary</strong></div>' +
      '<div class="card-body p-0">' +
        '<table class="table table-bordered mb-0 text-center" id="cdr-box-table">' +
          '<thead><tr><th>Memory</th><th>Orientation</th><th>Judgment</th><th>Community</th><th>Home/Hobbies</th><th>Personal Care</th><th class="table-primary">Sum of Boxes</th></tr></thead>' +
          '<tbody><tr>' +
            '<td id="cdr-box-memory">--</td><td id="cdr-box-orientation">--</td><td id="cdr-box-judgment">--</td>' +
            '<td id="cdr-box-community">--</td><td id="cdr-box-homeHobbies">--</td><td id="cdr-box-personalCare">--</td>' +
            '<td id="cdr-box-sob" class="fw-bold table-primary">--</td>' +
          '</tr></tbody>' +
        '</table>' +
      '</div>';
    card.appendChild(boxCard);

    // ── Result display ──
    var resultDiv = document.createElement('div');
    resultDiv.id = 'cdr-result-div';
    resultDiv.className = 'alert alert-info text-center fs-5';
    resultDiv.textContent = 'Rate each domain above to generate scores.';
    card.appendChild(resultDiv);

    // ── Tzeng interpretation ──
    var tzengDiv = document.createElement('div');
    tzengDiv.id = 'cdr-tzeng-div';
    tzengDiv.className = 'text-center text-muted mb-3';
    card.appendChild(tzengDiv);

    // ── CDR-SB classification reference ──
    var classCard = document.createElement('div');
    classCard.className = 'card mt-3';
    classCard.innerHTML =
      '<div class="card-header"><strong>CDR Sum of Boxes Classification</strong> <small class="text-muted">(Bryant et al 2012)</small></div>' +
      '<div class="card-body p-0">' +
        '<table class="table table-bordered table-sm mb-0">' +
          '<thead><tr><th>CDR-SB Range</th><th>Classification</th></tr></thead>' +
          '<tbody>' +
            '<tr><td>0</td><td>Normal cognition</td></tr>' +
            '<tr><td>0.5 \u2013 2.5</td><td>Questionable / mild cognitive impairment</td></tr>' +
            '<tr><td>2.5 \u2013 4.0</td><td>Very mild dementia</td></tr>' +
            '<tr><td>4.0 \u2013 9.0</td><td>Mild dementia</td></tr>' +
            '<tr><td>9.0 \u2013 15.5</td><td>Moderate dementia</td></tr>' +
            '<tr><td>16.0 \u2013 18.0</td><td>Severe dementia</td></tr>' +
          '</tbody>' +
        '</table>' +
      '</div>';
    card.appendChild(classCard);

    container.appendChild(card);
    bindScoringEvents(table);
    restoreScoringState(table);
  }

  function bindScoringEvents(table) {
    table.addEventListener('click', function (e) {
      var cell = e.target.closest('.cdr-score-cell');
      if (!cell) return;
      selectCell(cell, table);
    });
    table.addEventListener('keydown', function (e) {
      var cell = e.target.closest('.cdr-score-cell');
      if (!cell) return;
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectCell(cell, table); }
    });
  }

  function selectCell(cell, table) {
    var domainKey = cell.getAttribute('data-domain');
    var score = parseFloat(cell.getAttribute('data-score'));
    var row = cell.closest('tr');
    var cells = row.querySelectorAll('.cdr-score-cell');
    for (var i = 0; i < cells.length; i++) {
      cells[i].classList.remove('selected');
      cells[i].setAttribute('aria-checked', 'false');
    }
    cell.classList.add('selected');
    cell.setAttribute('aria-checked', 'true');
    S.set(SP + '.' + domainKey, score);
    recalc();
  }

  function restoreScoringState(table) {
    for (var d = 0; d < DOMAINS.length; d++) {
      var val = S.get(SP + '.' + DOMAINS[d].key);
      if (val !== undefined && val !== null && val !== '') {
        var cell = table.querySelector('.cdr-score-cell[data-domain="' + DOMAINS[d].key + '"][data-score="' + val + '"]');
        if (cell) { cell.classList.add('selected'); cell.setAttribute('aria-checked', 'true'); }
      }
    }
    recalc();
  }

  /* ═══════════════════════════════════════
     CDR TOTAL ALGORITHM
     Exact from user's cdr_calculator.html
     (Washington University, Morris algorithm)
     ═══════════════════════════════════════ */
  function calculateCDR(scores) {
    var memory = scores[0];
    var CDR = 0, EQ_MEM = 0, GT_MEM = 0, LT_MEM = 0;
    var BOX_EQ_0 = 0, BOX_EQ_5 = 0, BOX_EQ_1 = 0, BOX_EQ_2 = 0, BOX_EQ_3 = 0;
    var MAXCOUNT = 0, BOX_GE_1 = 0, BOX_GE_5 = 0;

    for (var i = 1; i < scores.length; i++) {
      if (scores[i] > memory) GT_MEM++;
      if (scores[i] === memory) EQ_MEM++;
      if (scores[i] < memory) LT_MEM++;
      if (scores[i] === 0) BOX_EQ_0++;
      if (scores[i] === 0.5) BOX_EQ_5++;
      if (scores[i] === 1) BOX_EQ_1++;
      if (scores[i] === 2) BOX_EQ_2++;
      if (scores[i] === 3) BOX_EQ_3++;
    }

    if (EQ_MEM >= 3) {
      CDR = memory;
    } else if (GT_MEM + LT_MEM >= 3) {
      if (Math.abs(GT_MEM - LT_MEM) > 1) {
        MAXCOUNT = 0;
        if (BOX_EQ_0 >= MAXCOUNT && memory !== 0) { CDR = 0; MAXCOUNT = BOX_EQ_0; }
        if (BOX_EQ_5 >= MAXCOUNT && memory !== 0.5) { CDR = 0.5; MAXCOUNT = BOX_EQ_5; }
        if (BOX_EQ_1 >= MAXCOUNT && memory !== 1) { CDR = 1; MAXCOUNT = BOX_EQ_1; }
        if (BOX_EQ_2 >= MAXCOUNT && memory !== 2) { CDR = 2; MAXCOUNT = BOX_EQ_2; }
        if (BOX_EQ_3 >= MAXCOUNT && memory !== 3) { CDR = 3; MAXCOUNT = BOX_EQ_3; }
      }
    }

    if ((GT_MEM === 3 && LT_MEM === 2) || (GT_MEM === 2 && LT_MEM === 3)) { CDR = memory; }

    if (memory === 0.5) {
      BOX_GE_1 = 0;
      for (var j = 0; j < scores.length; j++) { if (scores[j] >= 1) BOX_GE_1++; }
      CDR = (BOX_GE_1 >= 3) ? 1 : 0.5;
    }

    if (memory === 0) {
      BOX_GE_5 = 0;
      for (var k = 0; k < scores.length; k++) { if (scores[k] >= 0.5) BOX_GE_5++; }
      CDR = (BOX_GE_5 >= 2) ? 0.5 : 0;
    }

    if ((GT_MEM === 4 || LT_MEM === 4) &&
      ((BOX_EQ_0===2&&BOX_EQ_5===2)||(BOX_EQ_0===2&&BOX_EQ_1===2)||(BOX_EQ_0===2&&BOX_EQ_2===2)||
       (BOX_EQ_0===2&&BOX_EQ_3===2)||(BOX_EQ_5===2&&BOX_EQ_1===2)||(BOX_EQ_5===2&&BOX_EQ_2===2)||
       (BOX_EQ_5===2&&BOX_EQ_3===2)||(BOX_EQ_1===2&&BOX_EQ_2===2)||(BOX_EQ_1===2&&BOX_EQ_3===2)||
       (BOX_EQ_2===2&&BOX_EQ_3===2))) {
      if (memory===0&&BOX_EQ_5===2) CDR=0.5;
      else if (memory===0&&BOX_EQ_1===2&&(BOX_EQ_2===2||BOX_EQ_3===2)) CDR=1;
      else if (memory===0&&BOX_EQ_2===2&&BOX_EQ_3===2) CDR=2;
      else if (memory===0.5&&BOX_EQ_1===2&&(BOX_EQ_2===2||BOX_EQ_3===2)) CDR=1;
      else if (memory===0.5&&BOX_EQ_2===2&&BOX_EQ_3===2) CDR=2;
      else if (memory===1&&BOX_EQ_2===2&&BOX_EQ_3===2) CDR=2;
      else if (memory===1&&BOX_EQ_0===2&&BOX_EQ_5===2) CDR=0.5;
      else if (memory===2&&BOX_EQ_1===2&&(BOX_EQ_5===2||BOX_EQ_0===2)) CDR=1;
      else if (memory===2&&BOX_EQ_1===2&&BOX_EQ_5===2) CDR=1;
      else if (memory===3&&BOX_EQ_2===2&&(BOX_EQ_1===2||BOX_EQ_5===2||BOX_EQ_0===2)) CDR=2;
      else if (memory===3&&BOX_EQ_1===2&&(BOX_EQ_5===2||BOX_EQ_0===2)) CDR=1;
      else if (memory===3&&BOX_EQ_5===2&&BOX_EQ_0===2) CDR=0.5;
    }

    if (EQ_MEM===1||EQ_MEM===2) { if (GT_MEM<=2&&LT_MEM<=2) { CDR=memory; } }
    if (memory>=1&&CDR===0) { CDR=0.5; }
    return CDR;
  }

  function classifyCDRSB(sb) {
    if (sb===0) return 'normal cognition';
    if (sb>=0.5&&sb<=2.5) return 'questionable/mild cognitive impairment';
    if (sb>2.5&&sb<=4.0) return 'very mild dementia';
    if (sb>4.0&&sb<=9.0) return 'mild dementia';
    if (sb>9.0&&sb<=15.5) return 'moderate dementia';
    if (sb>=16.0&&sb<=18.0) return 'severe dementia';
    return 'Unknown';
  }

  function interpretationText(x) {
    var t='Compared to a CDR-SB score of 0, the hazard ratio (HR) for progression to CDRt >=1 within 5 years is: ';
    var a=[1.51,1.91,2.58,2.13,3.46,3.85,3.19,5.12,5.22];
    if(x===0.5)return t+a[0];if(x===1)return t+a[1];if(x===1.5)return t+a[2];
    if(x===2)return t+a[3];if(x===2.5)return t+a[4];if(x===3)return t+a[5];
    if(x===3.5)return t+a[6];if(x===4)return t+a[7];if(x>=4.5)return t+a[8];
    return '';
  }

  /* ═══════════════════════════════════════
     RECALC + DISPLAY UPDATE
     ═══════════════════════════════════════ */
  function recalc() {
    var domainKeys = ['memory','orientation','judgment','community','homeHobbies','personalCare'];
    var scores = [], allAnswered = true;
    for (var i=0;i<domainKeys.length;i++) {
      var val = S.get(SP+'.'+domainKeys[i]);
      if (val!==undefined&&val!==null&&val!=='') { scores.push(parseFloat(val)); }
      else { scores.push(null); allAnswered=false; }
    }
    if (allAnswered) {
      var CDRt = calculateCDR(scores);
      var CDRsb = 0;
      for (var j=0;j<scores.length;j++) CDRsb+=scores[j];
      var severity = classifyCDRSB(CDRsb);
      S.setScore('cdr',{total:CDRt,sumOfBoxes:CDRsb,severity:severity,domainScores:{
        memory:scores[0],orientation:scores[1],judgment:scores[2],
        community:scores[3],homeHobbies:scores[4],personalCare:scores[5]
      }});
      updateScoringDisplay();
    } else {
      S.setScore('cdr',{total:null,sumOfBoxes:null,severity:null,domainScores:null});
      updateScoringDisplay();
    }
    if (BHM.Scoring&&BHM.Scoring.triggerReport) BHM.Scoring.triggerReport();
    else if (BHM.Report&&BHM.Report.update) BHM.Report.update();
  }

  function updateScoringDisplay() {
    var cdrScore = S.getScore('cdr');
    var domainKeys = ['memory','orientation','judgment','community','homeHobbies','personalCare'];
    for (var i=0;i<domainKeys.length;i++) {
      var val = S.get(SP+'.'+domainKeys[i]);
      updateEl('cdr-box-'+domainKeys[i], val!==undefined&&val!==null?val:'--');
    }
    if (cdrScore&&cdrScore.total!==null) {
      var CDRt=cdrScore.total, CDRsb=cdrScore.sumOfBoxes, severity=cdrScore.severity;
      updateEl('cdr-box-sob',CDRsb);
      var rd=document.getElementById('cdr-result-div');
      if(rd){rd.className='alert alert-success text-center fs-5';
        rd.innerHTML='<strong>Total CDR score = '+CDRt+'</strong> and <strong>sum of boxes = '+CDRsb+'</strong>, indicating <em>'+severity+'</em>';}
      var st=document.getElementById('cdr-score-table');
      if(st){var row=st.rows[0];var ps=[0,0.5,1,2,3];var idx=ps.indexOf(CDRt);
        for(var j=0;j<row.cells.length;j++)row.cells[j].style.backgroundColor='';
        if(idx>=0)row.cells[idx+1].style.backgroundColor='#daf1ee';}
      var tz=document.getElementById('cdr-tzeng-div');
      if(tz){if(CDRt===0.5){tz.innerHTML=interpretationText(CDRsb)+' <a target="_blank" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9537043/">Tzeng et al 2022</a>';}else{tz.innerHTML='';}}
    } else {
      updateEl('cdr-box-sob','--');
      var rd2=document.getElementById('cdr-result-div');
      if(rd2){rd2.className='alert alert-info text-center fs-5';rd2.textContent='Rate each domain above to generate scores.';}
      var st2=document.getElementById('cdr-score-table');
      if(st2){var r2=st2.rows[0];for(var k=0;k<r2.cells.length;k++)r2.cells[k].style.backgroundColor='';}
      var tz2=document.getElementById('cdr-tzeng-div');if(tz2)tz2.innerHTML='';
    }
  }

  /* ═══════════════════════════════════════
     SHARED HELPERS
     ═══════════════════════════════════════ */
  function updateEl(id, text) {
    var el = document.getElementById(id);
    if (el) el.textContent = text;
  }
  function esc(str) {
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  return {
    renderAssessment: renderAssessment,
    renderScoring: renderScoring,
    calculateCDR: calculateCDR,
    classifyCDRSB: classifyCDRSB,
    recalc: recalc,
    DOMAINS: DOMAINS
  };
})();

/* ── diamondLewy.js ── */
/* DIAMOND Lewy — Assessment Toolkit for Dementia with Lewy Bodies
   Based on: Thomas et al. Int J Geriatr Psychiatry 2018;33:1293-1304
   Aligned with McKeith et al. 4th DLB Consensus Criteria (Neurology 2017)
   ======================================================================= */
var BHM = window.BHM || {};
BHM.Instruments = BHM.Instruments || {};

BHM.Instruments.DiamondLewy = (function () {
  'use strict';

  var SP = 'instruments.diamondLewy';
  var S = BHM.State;

  /* ═══════════════════════════════════════
     DATA DEFINITIONS
     ═══════════════════════════════════════ */

  /* Section 2A: Cognitive Fluctuation — DCFS items */
  var DCFS_ITEMS = [
    { key: 'dcfs_drowsy', text: 'Does the patient have drowsiness or lethargy during the daytime, despite getting enough sleep the night before?' },
    { key: 'dcfs_sleep2h', text: 'Does the patient sleep for more than 2 hours during the daytime?' },
    { key: 'dcfs_disorg', text: 'Does the patient have episodes where their thinking seems quite disorganised or illogical?' },
    { key: 'dcfs_stare', text: 'Does the patient stare into space for long periods?' }
  ];
  var DCFS_OPTIONS = ['Usually (>3 days/week)', 'Sometimes (1\u20133 days/week)', 'Rarely (<1 day/week)', 'Never'];

  /* Section 2D: Parkinsonism — UPDRS motor items */
  var MOTOR_ITEMS = [
    { key: 'motor_expression', text: 'Facial expression (hypomimia / masked face)' },
    { key: 'motor_tremor', text: 'Rest tremor (hands / arms)' },
    { key: 'motor_rigidity', text: 'Rigidity (limbs / neck)' },
    { key: 'motor_bradykinesia', text: 'Bradykinesia (finger tapping / hand movements)' },
    { key: 'motor_gait', text: 'Gait / postural stability' }
  ];
  var MOTOR_SCORES = ['0 \u2013 Normal', '1 \u2013 Slight', '2 \u2013 Mild', '3 \u2013 Moderate', '4 \u2013 Severe'];

  /* Section 3: Indicative Biomarkers */
  var BIOMARKERS = [
    { key: 'bio_dat', text: 'Reduced dopamine transporter uptake in basal ganglia (DaT-SPECT / PET)' },
    { key: 'bio_mibg', text: 'Abnormal \u00b9\u00b2\u00b3I-MIBG myocardial scintigraphy (low uptake)' },
    { key: 'bio_psg', text: 'Polysomnographic confirmation of REM sleep without atonia' }
  ];

  /* Section 4: Supportive Clinical Features */
  var SUPPORTIVE = [
    { key: 'sup_neuroleptic', text: 'Severe sensitivity to antipsychotic agents' },
    { key: 'sup_instability', text: 'Postural instability' },
    { key: 'sup_falls', text: 'Repeated falls' },
    { key: 'sup_syncope', text: 'Syncope or other transient episodes of unresponsiveness' },
    { key: 'sup_autonomic', text: 'Severe autonomic dysfunction (e.g., constipation, orthostatic hypotension, urinary incontinence)' },
    { key: 'sup_hypersomnia', text: 'Hypersomnia' },
    { key: 'sup_hyposmia', text: 'Hyposmia (reduced sense of smell)' },
    { key: 'sup_other_halluc', text: 'Hallucinations in other modalities (auditory, tactile, etc.)' },
    { key: 'sup_delusions', text: 'Systematised delusions' },
    { key: 'sup_apathy', text: 'Apathy' },
    { key: 'sup_anxiety', text: 'Anxiety' },
    { key: 'sup_depression', text: 'Depression' }
  ];

  /* ═══════════════════════════════════════
     RENDER
     ═══════════════════════════════════════ */
  function render(container) {
    container.innerHTML = '';
    var card = document.createElement('div');
    card.className = 'instrument-card';
    card.innerHTML =
      '<h5>DIAMOND Lewy \u2014 Assessment Toolkit for Dementia with Lewy Bodies</h5>' +
      '<p class="instrument-subtitle">Based on the revised DIAMOND Lewy toolkit (Thomas et al., <em>Int J Geriatr Psychiatry</em> 2018) aligned with the 4th DLB Consensus Criteria (McKeith et al., 2017).</p>';

    // ═══ SECTION 1: Essential Criterion ═══
    card.appendChild(dlSection('Section 1: Essential Criterion'));
    card.appendChild(dlSubLabel('Is there progressive cognitive decline of sufficient magnitude to interfere with normal social or occupational functioning?'));
    card.appendChild(dlTable(['Criterion', 'Yes', 'No', 'Uncertain'], [
      ['Progressive cognitive decline (dementia)', 'essential_dementia']
    ]));
    card.appendChild(dlNoteRow('essential_notes', 'Clinical notes (onset, pattern, domains affected):'));

    // ═══ SECTION 2: Core Clinical Features ═══
    card.appendChild(dlSection('Section 2: Core Clinical Features'));
    card.appendChild(dlSubLabel('The presence of two or more core features = probable DLB; one core feature = possible DLB.'));

    // 2A: Fluctuating Cognition
    card.appendChild(dlSection2('2A. Fluctuating Cognition'));
    card.appendChild(dlSubLabel('Dementia Cognitive Fluctuation Scale (DCFS) \u2014 Ask the carer:'));
    card.appendChild(dlTable(
      ['Question (ask carer)', 'Usually (>3d/wk)', 'Sometimes (1\u20133d/wk)', 'Rarely (<1d/wk)', 'Never'],
      DCFS_ITEMS.map(function (item) { return [item.text, item.key]; })
    ));
    card.appendChild(dlTable(['Clinician\u2019s overall assessment: Is fluctuating cognition present?', 'Yes', 'No', 'Uncertain'], [
      ['Fluctuating cognition with pronounced variations in attention and alertness', 'core_fluctuation']
    ]));

    // 2B: REM Sleep Behaviour Disorder
    card.appendChild(dlSection2('2B. REM Sleep Behaviour Disorder (RBD)'));
    card.appendChild(dlSubLabel('Mayo Sleep Questionnaire \u2014 Ask the carer:'));
    card.appendChild(dlTable(['Question (ask carer)', 'Yes', 'No', "Don't Know"], [
      ['Have you ever seen the patient appear to \u201cact out their dreams\u201d while sleeping? (e.g., punching, flailing arms in the air, shouting, screaming)', 'rbd_screen']
    ]));
    card.appendChild(dlTable(['If yes, was the behaviour:', 'Yes', 'No', "Don't Know"], [
      ['Potentially harmful or disruptive to the patient or bed partner?', 'rbd_harmful'],
      ['Occurring on more than one occasion?', 'rbd_recurrent']
    ]));
    card.appendChild(dlTable(['Clinician\u2019s overall assessment: Is RBD present?', 'Yes', 'No', 'Uncertain'], [
      ['REM sleep behaviour disorder', 'core_rbd']
    ]));

    // 2C: Visual Hallucinations
    card.appendChild(dlSection2('2C. Visual Hallucinations'));
    card.appendChild(dlSubLabel('North East Visual Hallucinations Inventory (NEVHI) \u2014 Ask the patient:'));
    card.appendChild(dlTable(['Question (ask patient)', 'Yes', 'No'], [
      ['Do you ever see things that other people cannot see?', 'vh_patient_sees'],
      ['If yes: Are they well-formed images (people, animals, objects)?', 'vh_patient_formed']
    ]));
    card.appendChild(dlNoteRow('vh_patient_describe', 'Patient\u2019s description of what they see:'));
    card.appendChild(dlSubLabel('Ask the carer:'));
    card.appendChild(dlTable(['Question (ask carer)', 'Yes', 'No'], [
      ['Does the patient appear to see things that are not there?', 'vh_carer_sees'],
      ['If yes: Does the patient describe seeing formed images such as people, animals, or objects?', 'vh_carer_formed']
    ]));
    card.appendChild(dlTable(['Clinician\u2019s overall assessment: Are visual hallucinations present?', 'Yes', 'No', 'Uncertain'], [
      ['Recurrent complex visual hallucinations (typically well-formed and detailed)', 'core_hallucinations']
    ]));

    // 2D: Parkinsonism
    card.appendChild(dlSection2('2D. Parkinsonism'));
    card.appendChild(dlSubLabel('Motor assessment (UPDRS items) \u2014 At least one cardinal feature (bradykinesia, rest tremor, or rigidity) required:'));
    card.appendChild(dlTable(
      ['Motor Item', '0\u2013Normal', '1\u2013Slight', '2\u2013Mild', '3\u2013Moderate', '4\u2013Severe'],
      MOTOR_ITEMS.map(function (item) { return [item.text, item.key]; })
    ));
    card.appendChild(dlTable(['Clinician\u2019s overall assessment: Is spontaneous parkinsonism present?', 'Yes', 'No', 'Uncertain'], [
      ['One or more spontaneous cardinal features of parkinsonism (not drug-induced)', 'core_parkinsonism']
    ]));

    // ═══ SECTION 3: Indicative Biomarkers ═══
    card.appendChild(dlSection('Section 3: Indicative Biomarkers'));
    card.appendChild(dlSubLabel('One or more indicative biomarkers + one core feature = probable DLB. Biomarker(s) alone (no core feature) = possible DLB.'));
    card.appendChild(dlTable(['Biomarker', 'Present', 'Absent', 'Not Done'], BIOMARKERS.map(function (b) { return [b.text, b.key]; })));

    // ═══ SECTION 4: Supportive Clinical Features ═══
    card.appendChild(dlSection('Section 4: Supportive Clinical Features'));
    card.appendChild(dlSubLabel('These features support a DLB diagnosis but do not contribute to the diagnostic classification algorithm.'));
    card.appendChild(dlTable(['Feature', 'Present', 'Absent', 'Uncertain'], SUPPORTIVE.map(function (s) { return [s.text, s.key]; })));
    card.appendChild(dlNoteRow('supportive_notes', 'Additional supportive feature notes:'));

    // ═══ DIAGNOSTIC SUMMARY (auto-calculated) ═══
    card.appendChild(dlSection('Diagnostic Summary'));
    var sumDiv = document.createElement('div');
    sumDiv.id = 'dl-summary-div';
    sumDiv.className = 'card';
    sumDiv.innerHTML =
      '<div class="card-body">' +
        '<div class="row text-center mb-3" id="dl-core-summary">' +
          '<div class="col-3"><div class="border rounded p-2"><div class="small text-muted">Fluctuation</div><div id="dl-s-fluct" class="fw-bold">\u2014</div></div></div>' +
          '<div class="col-3"><div class="border rounded p-2"><div class="small text-muted">RBD</div><div id="dl-s-rbd" class="fw-bold">\u2014</div></div></div>' +
          '<div class="col-3"><div class="border rounded p-2"><div class="small text-muted">Hallucinations</div><div id="dl-s-vh" class="fw-bold">\u2014</div></div></div>' +
          '<div class="col-3"><div class="border rounded p-2"><div class="small text-muted">Parkinsonism</div><div id="dl-s-park" class="fw-bold">\u2014</div></div></div>' +
        '</div>' +
        '<div class="row text-center mb-3">' +
          '<div class="col-4"><div class="border rounded p-2"><div class="small text-muted">Core Features Present</div><div id="dl-core-count" class="fw-bold fs-4">\u2014</div></div></div>' +
          '<div class="col-4"><div class="border rounded p-2"><div class="small text-muted">Indicative Biomarkers</div><div id="dl-bio-count" class="fw-bold fs-4">\u2014</div></div></div>' +
          '<div class="col-4"><div class="border rounded p-2"><div class="small text-muted">Supportive Features</div><div id="dl-sup-count" class="fw-bold fs-4">\u2014</div></div></div>' +
        '</div>' +
        '<div class="alert mb-0 text-center fs-5" id="dl-diagnosis-alert">' +
          '<span id="dl-diagnosis-text">Complete the assessment above to generate a diagnostic classification.</span>' +
        '</div>' +
      '</div>';
    card.appendChild(sumDiv);

    container.appendChild(card);

    // Bind events and restore
    bindAllButtons(card);
    recalc();
  }

  /* ═══════════════════════════════════════
     TABLE BUILDER (same tabular style as CDR)
     ═══════════════════════════════════════ */
  function dlTable(headers, rows) {
    var wrap = document.createElement('div');
    wrap.className = 'table-responsive';
    var table = document.createElement('table');
    table.className = 'cdr-worksheet-table';
    var thead = document.createElement('thead');
    var htr = document.createElement('tr');
    for (var h = 0; h < headers.length; h++) {
      var th = document.createElement('th');
      th.textContent = headers[h];
      htr.appendChild(th);
    }
    thead.appendChild(htr);
    table.appendChild(thead);
    var tbody = document.createElement('tbody');
    var optCount = headers.length - 1;
    for (var r = 0; r < rows.length; r++) {
      var tr = document.createElement('tr');
      var tdQ = document.createElement('td');
      tdQ.textContent = rows[r][0];
      tr.appendChild(tdQ);
      var key = rows[r][1];
      for (var o = 0; o < optCount; o++) {
        var tdO = document.createElement('td');
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'cdr-ws-btn';
        btn.textContent = '\u25CB';
        var val = headers[o + 1].toLowerCase();
        btn.setAttribute('data-key', key);
        btn.setAttribute('data-val', val);
        var cur = S.get(SP + '.' + key);
        if (cur === val) { btn.classList.add('active'); btn.textContent = '\u25CF'; }
        tdO.appendChild(btn);
        tr.appendChild(tdO);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    wrap.appendChild(table);
    return wrap;
  }

  /* ═══════════════════════════════════════
     UI HELPERS
     ═══════════════════════════════════════ */
  function dlSection(title) {
    var div = document.createElement('div');
    div.className = 'cdr-ws-section';
    div.innerHTML = '<h6><i class="bi bi-check2-square me-1"></i>' + title + '</h6>';
    return div;
  }
  function dlSection2(title) {
    var div = document.createElement('div');
    div.className = 'mt-3 mb-1';
    div.innerHTML = '<strong class="text-secondary" style="font-size:0.9rem"><i class="bi bi-arrow-return-right me-1"></i>' + title + '</strong>';
    return div;
  }
  function dlSubLabel(text) {
    var div = document.createElement('div');
    div.className = 'cdr-ws-subsection mb-1';
    div.textContent = text;
    return div;
  }
  function dlNoteRow(key, label) {
    var div = document.createElement('div');
    div.className = 'mb-2';
    var lbl = document.createElement('div');
    lbl.className = 'cdr-ws-subsection mb-1';
    lbl.textContent = label;
    div.appendChild(lbl);
    var ta = document.createElement('textarea');
    ta.className = 'form-control form-control-sm';
    ta.rows = 2;
    ta.style.fontSize = '0.82rem';
    var cur = S.get(SP + '.' + key);
    if (cur) ta.value = cur;
    ta.setAttribute('data-key', key);
    ta.addEventListener('input', function () { S.set(SP + '.' + this.getAttribute('data-key'), this.value); });
    div.appendChild(ta);
    return div;
  }

  /* ═══════════════════════════════════════
     EVENT HANDLING
     ═══════════════════════════════════════ */
  function bindAllButtons(root) {
    root.addEventListener('click', function (e) {
      var btn = e.target.closest('.cdr-ws-btn');
      if (!btn) return;
      var key = btn.getAttribute('data-key');
      var val = btn.getAttribute('data-val');
      var row = btn.closest('tr');
      var btns = row.querySelectorAll('.cdr-ws-btn');
      for (var i = 0; i < btns.length; i++) { btns[i].classList.remove('active'); btns[i].textContent = '\u25CB'; }
      btn.classList.add('active');
      btn.textContent = '\u25CF';
      S.set(SP + '.' + key, val);
      recalc();
    });
  }

  /* ═══════════════════════════════════════
     SCORING / DIAGNOSTIC ALGORITHM
     ═══════════════════════════════════════ */
  function recalc() {
    var coreKeys = ['core_fluctuation', 'core_rbd', 'core_hallucinations', 'core_parkinsonism'];
    var coreLabels = ['Fluctuation', 'RBD', 'Hallucinations', 'Parkinsonism'];
    var coreIds = ['dl-s-fluct', 'dl-s-rbd', 'dl-s-vh', 'dl-s-park'];
    var coreCount = 0;
    var coreAnswered = 0;

    for (var c = 0; c < coreKeys.length; c++) {
      var val = S.get(SP + '.' + coreKeys[c]);
      var el = document.getElementById(coreIds[c]);
      if (el) {
        if (val === 'yes') { el.textContent = 'Yes'; el.className = 'fw-bold text-success'; coreCount++; coreAnswered++; }
        else if (val === 'no') { el.textContent = 'No'; el.className = 'fw-bold text-muted'; coreAnswered++; }
        else if (val === 'uncertain') { el.textContent = '?'; el.className = 'fw-bold text-warning'; coreAnswered++; }
        else { el.textContent = '\u2014'; el.className = 'fw-bold'; }
      }
    }

    var bioCount = 0, bioAnswered = 0;
    for (var b = 0; b < BIOMARKERS.length; b++) {
      var bVal = S.get(SP + '.' + BIOMARKERS[b].key);
      if (bVal === 'present') { bioCount++; bioAnswered++; }
      else if (bVal === 'absent' || bVal === 'not done') { bioAnswered++; }
    }

    var supCount = 0;
    for (var s = 0; s < SUPPORTIVE.length; s++) {
      var sVal = S.get(SP + '.' + SUPPORTIVE[s].key);
      if (sVal === 'present') supCount++;
    }

    updateText('dl-core-count', coreCount);
    updateText('dl-bio-count', bioCount);
    updateText('dl-sup-count', supCount);

    // Diagnostic classification
    var essential = S.get(SP + '.essential_dementia');
    var diagEl = document.getElementById('dl-diagnosis-alert');
    var diagText = document.getElementById('dl-diagnosis-text');
    var diagnosis = 'incomplete';

    if (essential === 'yes' && coreAnswered >= 4) {
      if (coreCount >= 2) {
        diagnosis = 'probable';
      } else if (coreCount === 1 && bioCount >= 1) {
        diagnosis = 'probable';
      } else if (coreCount === 1 && bioCount === 0) {
        diagnosis = 'possible';
      } else if (coreCount === 0 && bioCount >= 1) {
        diagnosis = 'possible';
      } else {
        diagnosis = 'not_met';
      }
    } else if (essential === 'no') {
      diagnosis = 'no_dementia';
    }

    if (diagEl && diagText) {
      switch (diagnosis) {
        case 'probable':
          diagEl.className = 'alert alert-success mb-0 text-center fs-5';
          diagText.innerHTML = '<strong>Probable DLB</strong> \u2014 ' +
            (coreCount >= 2 ? coreCount + ' core features present' : '1 core feature + ' + bioCount + ' indicative biomarker(s)') +
            (supCount > 0 ? ' | ' + supCount + ' supportive feature(s)' : '');
          break;
        case 'possible':
          diagEl.className = 'alert alert-warning mb-0 text-center fs-5';
          diagText.innerHTML = '<strong>Possible DLB</strong> \u2014 ' +
            (coreCount === 1 ? '1 core feature (no indicative biomarkers)' : bioCount + ' indicative biomarker(s) (no core features)') +
            (supCount > 0 ? ' | ' + supCount + ' supportive feature(s)' : '');
          break;
        case 'not_met':
          diagEl.className = 'alert alert-secondary mb-0 text-center fs-5';
          diagText.innerHTML = '<strong>DLB criteria not met</strong> \u2014 Dementia present but no core features or indicative biomarkers identified';
          break;
        case 'no_dementia':
          diagEl.className = 'alert alert-secondary mb-0 text-center fs-5';
          diagText.innerHTML = '<strong>Essential criterion not met</strong> \u2014 Progressive cognitive decline (dementia) not established';
          break;
        default:
          diagEl.className = 'alert alert-info mb-0 text-center fs-5';
          diagText.textContent = 'Complete the assessment above to generate a diagnostic classification.';
      }
    }

    // Build supportive features list
    var supList = [];
    for (var sl = 0; sl < SUPPORTIVE.length; sl++) {
      if (S.get(SP + '.' + SUPPORTIVE[sl].key) === 'present') supList.push(SUPPORTIVE[sl].text);
    }

    // Build core features list
    var corePresent = [];
    for (var cl = 0; cl < coreKeys.length; cl++) {
      if (S.get(SP + '.' + coreKeys[cl]) === 'yes') corePresent.push(coreLabels[cl]);
    }

    // Save to scores
    S.setScore('diamondLewy', {
      diagnosis: diagnosis,
      coreCount: coreCount,
      biomarkerCount: bioCount,
      supportiveCount: supCount,
      corePresent: corePresent,
      supportivePresent: supList,
      essential: essential || null
    });

    if (BHM.Scoring && BHM.Scoring.triggerReport) BHM.Scoring.triggerReport();
    else if (BHM.Report && BHM.Report.update) BHM.Report.update();
  }

  function updateText(id, val) {
    var el = document.getElementById(id);
    if (el) el.textContent = val;
  }

  return {
    render: render,
    recalc: recalc
  };
})();

/* ── scoring.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Scoring — All instrument scoring engines
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};

BHM.Scoring = (function () {
  'use strict';

  var S = BHM.State;

  // ── Helper: sum numeric values from state ──
  function sumKeys(basePath, keys) {
    var total = 0, count = 0;
    for (var i = 0; i < keys.length; i++) {
      var val = S.get(basePath + '.' + keys[i]);
      if (val !== undefined && val !== null && val !== '') {
        total += Number(val);
        count++;
      }
    }
    return { total: total, answered: count, expected: keys.length };
  }

  function updateElement(id, text) {
    var el = document.getElementById(id);
    if (el) el.textContent = text;
  }

  // ═══════════════════════════════════════════
  // PSQI — Pittsburgh Sleep Quality Index
  // ═══════════════════════════════════════════
  function psqi() {
    var SP = 'instruments.psqi';
    var d = S.getSession().instruments.psqi || {};

    // Parse helper for time
    function parseTime(str) {
      if (!str) return null;
      str = str.trim().toLowerCase();
      // Handle "2230", "22:30", "10:30pm"
      var match = str.match(/^(\d{1,2}):?(\d{2})\s*(am|pm)?$/);
      if (!match) return null;
      var h = parseInt(match[1], 10);
      var m = parseInt(match[2], 10);
      if (match[3] === 'pm' && h < 12) h += 12;
      if (match[3] === 'am' && h === 12) h = 0;
      return h * 60 + m;
    }

    // Parse latency minutes (handle ranges like "15-30" -> midpoint)
    function parseLatency(str) {
      if (!str) return null;
      str = str.trim();
      var rangeMatch = str.match(/^(\d+)\s*[-–]\s*(\d+)$/);
      if (rangeMatch) {
        return (parseInt(rangeMatch[1], 10) + parseInt(rangeMatch[2], 10)) / 2;
      }
      var num = parseFloat(str);
      return isNaN(num) ? null : num;
    }

    var bedtime = parseTime(d.q1_bedtime);
    var waketime = parseTime(d.q3_waketime);
    var latencyMin = parseLatency(d.q2_latency_min);
    var sleepHours = d.q4_sleep_hours ? parseFloat(d.q4_sleep_hours) : null;

    // Component 1: Subjective Sleep Quality (Q9)
    var c1 = d.q9_quality !== undefined ? Number(d.q9_quality) : null;

    // Component 2: Sleep Latency (Q2 + Q5a)
    var c2 = null;
    if (latencyMin !== null && d.q5a !== undefined) {
      var q2score = latencyMin <= 15 ? 0 : latencyMin <= 30 ? 1 : latencyMin <= 60 ? 2 : 3;
      var q5aScore = Number(d.q5a);
      var c2sum = q2score + q5aScore;
      c2 = c2sum === 0 ? 0 : c2sum <= 2 ? 1 : c2sum <= 4 ? 2 : 3;
    }

    // Component 3: Sleep Duration (Q4)
    var c3 = null;
    if (sleepHours !== null) {
      c3 = sleepHours > 7 ? 0 : sleepHours >= 6 ? 1 : sleepHours >= 5 ? 2 : 3;
    }

    // Component 4: Habitual Sleep Efficiency
    var c4 = null;
    if (bedtime !== null && waketime !== null && sleepHours !== null) {
      var timeInBed = waketime - bedtime;
      if (timeInBed <= 0) timeInBed += 24 * 60; // crosses midnight
      var hoursInBed = timeInBed / 60;
      var efficiency = hoursInBed > 0 ? (sleepHours / hoursInBed) * 100 : 0;
      c4 = efficiency >= 85 ? 0 : efficiency >= 75 ? 1 : efficiency >= 65 ? 2 : 3;
    }

    // Component 5: Sleep Disturbance (Q5b–Q5i, plus Q5j if answered)
    var distKeys = ['q5b', 'q5c', 'q5d', 'q5e', 'q5f', 'q5g', 'q5h', 'q5i'];
    var distSum = 0, distCount = 0;
    for (var i = 0; i < distKeys.length; i++) {
      var val = d[distKeys[i]];
      if (val !== undefined && val !== null) { distSum += Number(val); distCount++; }
    }
    // Q5j: include if answered (per PSQI scoring doc)
    if (d.q5j !== undefined && d.q5j !== null) {
      distSum += Number(d.q5j);
      distCount++;
    }
    var c5 = null;
    if (distCount > 0) {
      c5 = distSum === 0 ? 0 : distSum <= 9 ? 1 : distSum <= 18 ? 2 : 3;
    }

    // Component 6: Use of Sleep Medication (Q6)
    var c6 = d.q6_medication !== undefined ? Number(d.q6_medication) : null;

    // Component 7: Daytime Dysfunction (Q7 + Q8)
    var c7 = null;
    if (d.q7_drowsiness !== undefined && d.q8_enthusiasm !== undefined) {
      var c7sum = Number(d.q7_drowsiness) + Number(d.q8_enthusiasm);
      c7 = c7sum === 0 ? 0 : c7sum <= 2 ? 1 : c7sum <= 4 ? 2 : 3;
    }

    var components = [c1, c2, c3, c4, c5, c6, c7];
    var globalTotal = null;
    var allPresent = true;
    for (var j = 0; j < components.length; j++) {
      if (components[j] === null) { allPresent = false; break; }
    }
    if (allPresent) {
      globalTotal = components.reduce(function (a, b) { return a + b; }, 0);
    }

    var scoreObj = {
      components: {
        subjectiveQuality: c1,
        sleepLatency: c2,
        sleepDuration: c3,
        sleepEfficiency: c4,
        sleepDisturbance: c5,
        sleepMedication: c6,
        daytimeDysfunction: c7
      },
      globalTotal: globalTotal
    };
    S.setScore('psqi', scoreObj);

    // Update UI
    updateElement('psqi-total', globalTotal !== null ? globalTotal : '--');
    if (globalTotal !== null) {
      var interp = globalTotal <= 5
        ? 'Good sleep quality (score ≤ 5)'
        : 'Poor sleep quality (score > 5)';
      updateElement('psqi-interp', interp + ' — out of 21');
    } else {
      updateElement('psqi-interp', 'Complete all required items to calculate');
    }

    triggerReport();
  }

  // ═══════════════════════════════════════════
  // Epworth Sleepiness Scale
  // ═══════════════════════════════════════════
  function epworth() {
    var keys = ['e1', 'e2', 'e3', 'e4', 'e5', 'e6', 'e7', 'e8'];
    var result = sumKeys('instruments.epworth', keys);
    var total = result.answered === 8 ? result.total : null;

    S.setScore('epworth', { total: total, answered: result.answered });

    updateElement('epworth-total', total !== null ? total : '--');
    if (total !== null) {
      var interp = total <= 10 ? 'Normal daytime sleepiness'
        : total <= 14 ? 'Mild excessive daytime sleepiness'
        : total <= 18 ? 'Moderate excessive daytime sleepiness'
        : 'Severe excessive daytime sleepiness';
      updateElement('epworth-interp', interp + ' (out of 24)');
    }
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // GAD-7
  // ═══════════════════════════════════════════
  function gad7() {
    var keys = ['g1', 'g2', 'g3', 'g4', 'g5', 'g6', 'g7'];
    var result = sumKeys('instruments.gad7', keys);
    var total = result.answered === 7 ? result.total : null;
    var impairment = S.get('instruments.gad7.impairment') || null;

    S.setScore('gad7', { total: total, impairment: impairment, answered: result.answered });

    updateElement('gad7-total', total !== null ? total : '--');
    if (total !== null) {
      var interp = total <= 4 ? 'Minimal anxiety'
        : total <= 9 ? 'Mild anxiety'
        : total <= 14 ? 'Moderate anxiety'
        : 'Severe anxiety';
      updateElement('gad7-interp', interp + ' (out of 21)');
    }
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // Depression (GDS-15)
  // ═══════════════════════════════════════════
  function depression() {
    var items = BHM.Instruments.Depression.getItems();
    var total = 0, answered = 0;
    for (var i = 0; i < items.length; i++) {
      var val = S.get('instruments.depression.' + items[i].key);
      if (val !== undefined && val !== null && val !== '') {
        answered++;
        if (val === items[i].depressiveAnswer) total++;
      }
    }
    var score = answered === 15 ? total : null;

    S.setScore('depression', { total: score, answered: answered });

    updateElement('depression-total', score !== null ? score : '--');
    if (score !== null) {
      var interp = score <= 4 ? 'Normal'
        : score <= 8 ? 'Mild depression'
        : score <= 11 ? 'Moderate depression'
        : 'Severe depression';
      updateElement('depression-interp', interp + ' (out of 15)');
    }
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // Mediterranean Diet
  // ═══════════════════════════════════════════
  function diet() {
    var keys = [];
    for (var i = 1; i <= 14; i++) keys.push('md' + i);
    var total = 0, answered = 0;
    for (var j = 0; j < keys.length; j++) {
      var val = S.get('instruments.diet.' + keys[j]);
      if (val !== undefined && val !== null && val !== '') {
        answered++;
        if (val === 'yes') total++;
      }
    }
    var score = answered === 14 ? total : null;

    S.setScore('diet', { total: score, answered: answered });

    updateElement('diet-total', score !== null ? score : '--');
    if (score !== null) {
      var interp = score >= 10 ? 'Good adherence to Mediterranean diet'
        : score >= 7 ? 'Moderate adherence'
        : 'Low adherence to Mediterranean diet';
      updateElement('diet-interp', interp + ' (out of 14)');
    }
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // AUDIT
  // ═══════════════════════════════════════════
  function auditTool() {
    var keys = ['a1', 'a2', 'a3', 'a4', 'a5', 'a6', 'a7', 'a8', 'a9', 'a10'];
    var result = sumKeys('instruments.auditTool', keys);
    var total = result.answered === 10 ? result.total : null;

    S.setScore('auditTool', { total: total, answered: result.answered });

    updateElement('audit-total', total !== null ? total : '--');
    if (total !== null) {
      var interp = total <= 7 ? 'Low risk'
        : total <= 15 ? 'Increasing risk'
        : total <= 19 ? 'Higher risk'
        : 'Possible dependence';
      updateElement('audit-interp', interp + ' (out of 40)');
    }
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // CASP-19
  // ═══════════════════════════════════════════
  function casp19() {
    var items = BHM.Instruments.CASP19.getItems();
    var total = 0, answered = 0;
    var domainTotals = {};
    for (var i = 0; i < items.length; i++) {
      var val = S.get('instruments.casp19.' + items[i].key);
      if (val !== undefined && val !== null && val !== '') {
        answered++;
        var rawVal = Number(val);
        // Reverse-scored items: Often(0)=0, Never(3)=3 for positive; Often(0)=3, Never(3)=0 for reverse
        var scored;
        if (items[i].reverse) {
          scored = rawVal; // reverse items: Often=0->score 0, Never=3->score 3 (stored as column index)
        } else {
          scored = 3 - rawVal; // positive items: Often=0->score 3, Never=3->score 0
        }
        total += scored;
        if (!domainTotals[items[i].domain]) domainTotals[items[i].domain] = 0;
        domainTotals[items[i].domain] += scored;
      }
    }
    var score = answered === 19 ? total : null;

    S.setScore('casp19', { total: score, domainTotals: domainTotals, answered: answered });

    updateElement('casp19-total', score !== null ? score : '--');
    if (score !== null) {
      updateElement('casp19-interp', 'out of 57 (higher = better quality of life)');
    }
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // Hearing
  // ═══════════════════════════════════════════
  function hearing() {
    var count = 0;
    for (var i = 1; i <= 17; i++) {
      var val = S.get('instruments.hearing.hs' + i);
      if (val === 'yes') count++;
    }

    S.setScore('hearing', { affectedCount: count });

    updateElement('hearing-count', count);
    updateElement('hearing-interp', 'out of 17 situations');
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // MBI-C
  // ═══════════════════════════════════════════
  function mbiC() {
    var domains = BHM.Instruments.MBIC.getDomains();
    var grandTotal = 0, answered = 0;

    for (var d = 0; d < domains.length; d++) {
      var domainTotal = 0, domainAnswered = 0;
      for (var i = 0; i < domains[d].items.length; i++) {
        var val = S.get('instruments.mbiC.' + domains[d].items[i].key);
        if (val !== undefined && val !== null && val !== '') {
          domainTotal += Number(val);
          domainAnswered++;
          answered++;
        }
      }
      grandTotal += domainTotal;
      var badge = document.getElementById('mbic-domain-' + d);
      if (badge) {
        var shortName = domains[d].name.length > 30 ? domains[d].name.substring(0, 30) + '\u2026' : domains[d].name;
        badge.textContent = shortName + ': ' + (domainAnswered > 0 ? domainTotal : '--');
        badge.title = domains[d].name + ': ' + (domainAnswered > 0 ? domainTotal : '--');
      }
    }

    S.setScore('mbiC', { total: answered > 0 ? grandTotal : null, answered: answered });

    updateElement('mbic-total', answered > 0 ? grandTotal : '--');
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // NPI-Q
  // ═══════════════════════════════════════════
  function npiQ() {
    var symptoms = BHM.Instruments.NPIQ.getSymptoms();
    var count = 0, sevTotal = 0, distTotal = 0;

    for (var i = 0; i < symptoms.length; i++) {
      var present = S.get('instruments.npiQ.' + symptoms[i].key + '_present');
      if (present === 'yes') {
        count++;
        var sev = S.get('instruments.npiQ.' + symptoms[i].key + '_severity');
        var dist = S.get('instruments.npiQ.' + symptoms[i].key + '_distress');
        if (sev !== undefined && sev !== null) sevTotal += Number(sev);
        if (dist !== undefined && dist !== null) distTotal += Number(dist);
      }
    }

    S.setScore('npiQ', { count: count, severityTotal: sevTotal, distressTotal: distTotal });

    updateElement('npiq-count', count);
    updateElement('npiq-severity', sevTotal);
    updateElement('npiq-distress', distTotal);
    triggerReport();
  }

  // ═══════════════════════════════════════════
  // RBANS
  // ═══════════════════════════════════════════
  function rbans() {
    // RBANS scoring is handled internally by BHM.Instruments.RBANS.calculate()
    // triggered by the Calculate button; this is a pass-through
    if (BHM.Instruments.RBANS && BHM.Instruments.RBANS.calculate) {
      BHM.Instruments.RBANS.calculate();
    }
  }

  // ═══════════════════════════════════════════
  // CDR — Clinical Dementia Rating
  // ═══════════════════════════════════════════
  function cdr() {
    // CDR scoring is handled internally by BHM.Instruments.CDR.recalc()
    // This function is a pass-through to ensure consistency
    if (BHM.Instruments.CDR && BHM.Instruments.CDR.recalc) {
      BHM.Instruments.CDR.recalc();
    }
  }

  // ═══════════════════════════════════════════
  // DIAMOND Lewy
  // ═══════════════════════════════════════════
  function diamondLewy() {
    if (BHM.Instruments.DiamondLewy && BHM.Instruments.DiamondLewy.recalc) {
      BHM.Instruments.DiamondLewy.recalc();
    }
  }

  // ── Trigger report update ──
  function triggerReport() {
    if (BHM.Report && BHM.Report.update) {
      // Small debounce to avoid excessive updates during rapid entry
      clearTimeout(BHM.Scoring._reportTimer);
      BHM.Scoring._reportTimer = setTimeout(function () {
        BHM.Report.update();
      }, 100);
    }
  }

  return {
    psqi: psqi,
    epworth: epworth,
    gad7: gad7,
    depression: depression,
    diet: diet,
    auditTool: auditTool,
    casp19: casp19,
    hearing: hearing,
    mbiC: mbiC,
    npiQ: npiQ,
    rbans: rbans,
    cdr: cdr,
    diamondLewy: diamondLewy,
    triggerReport: triggerReport,
    _reportTimer: null
  };
})();

/* ── reportGenerator.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Report — Live plain-language report generator
   Granular item-level feedback with MI tone throughout
   v2.1 — per-section clinician notes, generic language
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};

BHM.Report = (function () {
  'use strict';

  var S = BHM.State;
  var TEMPLATE_VERSION = '2.1.0';

  function update() {
    updateSidePanel();
    updateFullReport();
  }

  function updateSidePanel() {
    var body = document.getElementById('reportSidePanelBody');
    if (!body) return;
    body.innerHTML = generateHTML(true);
  }

  function updateFullReport() {
    var container = document.getElementById('reportFullContent');
    if (!container) return;
    container.innerHTML = '';

    var wrapper = document.createElement('div');
    wrapper.className = 'report-full';

    var header = document.createElement('div');
    header.className = 'report-header';
    var name = S.get('patient.name') || '[Patient Name]';
    var date = S.get('patient.dateOfCompletion') || '[Date]';
    header.innerHTML =
      '<div style="font-size:0.85rem;color:#6c757d">PLACEHOLDER — brainHEALTH Manchester Logo</div>' +
      '<h3>Assessment Report</h3>' +
      '<p class="mb-0"><strong>' + esc(name) + '</strong></p>' +
      '<p class="text-muted mb-0">Date: ' + esc(date) + '</p>';
    wrapper.appendChild(header);

    var bodyDiv = document.createElement('div');
    bodyDiv.innerHTML = generateHTML(false);
    wrapper.appendChild(bodyDiv);

    var nextSteps = document.createElement('div');
    nextSteps.innerHTML = '<h4>Next Steps and Signposting</h4>' +
      '<p>This report summarises the information gathered during your assessment. ' +
      'The findings will be discussed with you and any next steps agreed. ' +
      'If you have concerns about any of the areas covered, please speak to your GP or care team.</p>';
    wrapper.appendChild(nextSteps);

    var footer = document.createElement('div');
    footer.className = 'report-footer mt-4 pt-2 border-top text-muted';
    footer.style.fontSize = '0.75rem';
    footer.innerHTML = 'Report template v' + TEMPLATE_VERSION + ' | App v' + S.VERSION +
      ' | Generated: ' + new Date().toLocaleString();
    wrapper.appendChild(footer);
    container.appendChild(wrapper);

    // Bind all clinician insert textareas
    bindInserts(wrapper);

    if (BHM.Charts && BHM.Charts.renderReportCharts) BHM.Charts.renderReportCharts(wrapper);
  }

  function generateHTML(compact) {
    var html = '';
    html += section('About This Report',
      '<p>This report was generated from questionnaire responses completed ' +
      (S.get('meta.sourceMode') === 'live' ? 'during your appointment' : 'from your paper booklet responses') +
      '. It provides a summary of the information gathered, written in plain language. ' +
      'The scores and descriptions below are based on standardised questionnaires and are intended to help you understand the results.</p>', compact, 'about');

    html += sleepSection(compact);
    html += moodSection(compact);
    html += alcoholSection(compact);
    html += dietSection(compact);
    html += qolSection(compact);
    html += hearingSection(compact);
    html += informantSection(compact);
    html += clinicalSection(compact);
    html += stagingSection(compact);
    html += rbansSection(compact);
    html += lewySection(compact);

    // Global inserts at the end (only full report)
    if (!compact) {
      html += insertHTML('overallSummary', 'Overall Summary');
      html += insertHTML('agreedToday', 'What We Agreed Today');
      html += insertHTML('safetyFollowUp', 'Safety and Follow-up');
    }
    return html;
  }

  // ─── Helpers ───

  // Section wrapper — includes optional clinician insert at bottom
  function section(title, content, compact, insertKey) {
    var h = compact ? '<h6>' + title + '</h6>' + content : '<h4>' + title + '</h4>' + content;
    if (!compact && insertKey) {
      h += insertHTML('section_' + insertKey, 'Clinical notes — ' + title);
    }
    return h;
  }

  // HTML for a clinician insert textarea (rendered in the HTML string)
  var _speechSupported = !!(window.SpeechRecognition || window.webkitSpeechRecognition);

  function insertHTML(key, label) {
    var statePath = 'clinicianInserts.' + key;
    var current = S.get(statePath) || '';
    var micBtn = _speechSupported
      ? '<button type="button" class="dictation-btn" data-dictation-for="' + esc(statePath) + '" title="Dictate (click to start/stop)"><i class="bi bi-mic"></i></button>'
      : '<button type="button" class="dictation-btn unsupported" title="Speech recognition not supported in this browser" disabled><i class="bi bi-mic-mute"></i></button>';

    return '<div class="clinician-insert" style="margin:0.75rem 0 1.25rem;padding:8px 12px;background:#fffbe6;border:1px dashed #e0c36a;border-radius:6px;">' +
      '<div style="font-size:0.78rem;color:#8a7530;margin-bottom:4px;font-weight:600">' + esc(label) + ' <span style="font-weight:400">(editable — will be preserved)</span>' + micBtn + '</div>' +
      '<textarea data-insert-key="' + esc(statePath) + '" ' +
        'style="width:100%;min-height:48px;border:1px solid #ddd;border-radius:4px;padding:6px 8px;font-size:0.85rem;resize:vertical;font-family:inherit;background:#fff;"' +
        ' placeholder="Type or dictate clinical notes here...">' + esc(current) + '</textarea></div>';
  }

  // ── Speech recognition state ──
  var _activeRecognition = null;   // current SpeechRecognition instance
  var _activeBtn = null;           // currently active mic button element
  var _activeTa = null;            // currently active textarea element

  function stopDictation() {
    if (_activeRecognition) {
      try { _activeRecognition.stop(); } catch (e) { /* ignore */ }
      _activeRecognition = null;
    }
    if (_activeBtn) {
      _activeBtn.classList.remove('recording');
      _activeBtn.querySelector('i').className = 'bi bi-mic';
      _activeBtn = null;
    }
    _activeTa = null;
  }

  function startDictation(btn, textarea) {
    // Stop any existing session first
    stopDictation();

    var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return;

    var recognition = new SR();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-GB';

    _activeRecognition = recognition;
    _activeBtn = btn;
    _activeTa = textarea;

    // Visual feedback
    btn.classList.add('recording');
    btn.querySelector('i').className = 'bi bi-mic-fill';

    // Track where existing text ends so we can show interim results
    var baseText = textarea.value;
    var finalAppended = '';

    recognition.onresult = function (event) {
      var interim = '';
      for (var i = event.resultIndex; i < event.results.length; i++) {
        var transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          // Capitalise first char if it follows a sentence end or is at the start
          var separator = (baseText + finalAppended).length > 0 ? ' ' : '';
          var lastChar = (baseText + finalAppended).slice(-1);
          if (lastChar === '.' || lastChar === '?' || lastChar === '!' || lastChar === '\n' || (baseText + finalAppended).length === 0) {
            transcript = transcript.charAt(0).toUpperCase() + transcript.slice(1);
          }
          finalAppended += separator + transcript;
          // Persist after each final result
          textarea.value = baseText + finalAppended;
          S.set(textarea.getAttribute('data-insert-key'), textarea.value);
        } else {
          interim += transcript;
        }
      }
      // Show interim text as a preview (greyed out feel via the textarea)
      if (interim) {
        textarea.value = baseText + finalAppended + ' ' + interim;
      }
    };

    recognition.onerror = function (event) {
      console.warn('Speech recognition error:', event.error);
      if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
        alert('Microphone access was denied. Please allow microphone permission in your browser settings.');
      }
      stopDictation();
    };

    recognition.onend = function () {
      // Finalise text (remove any interim preview)
      if (_activeTa) {
        _activeTa.value = baseText + finalAppended;
        S.set(_activeTa.getAttribute('data-insert-key'), _activeTa.value);
      }
      stopDictation();
    };

    recognition.start();
  }

  // Bind event listeners for all clinician inserts after innerHTML is set
  function bindInserts(container) {
    // Stop any active dictation when report re-renders
    stopDictation();

    var textareas = container.querySelectorAll('textarea[data-insert-key]');
    for (var i = 0; i < textareas.length; i++) {
      (function (ta) {
        ta.addEventListener('input', function () {
          S.set(ta.getAttribute('data-insert-key'), ta.value);
        });
      })(textareas[i]);
    }

    // Bind mic buttons
    var micBtns = container.querySelectorAll('.dictation-btn[data-dictation-for]');
    for (var m = 0; m < micBtns.length; m++) {
      (function (btn) {
        btn.addEventListener('click', function () {
          var key = btn.getAttribute('data-dictation-for');
          var ta = container.querySelector('textarea[data-insert-key="' + key + '"]');
          if (!ta) return;
          // Toggle: if this button is already recording, stop
          if (_activeBtn === btn) {
            stopDictation();
          } else {
            startDictation(btn, ta);
          }
        });
      })(micBtns[m]);
    }
  }

  function scoreBadge(value, max, thresholds) {
    if (value === null || value === undefined) return '<span class="score-badge" style="background:#e9ecef">Not yet scored</span>';
    var cls = 'score-good';
    if (thresholds) { if (value > thresholds.poor) cls = 'score-poor'; else if (value > thresholds.moderate) cls = 'score-moderate'; }
    return '<span class="score-badge ' + cls + '">' + value + (max ? '/' + max : '') + '</span>';
  }
  function rptTh(text, align) {
    return '<th style="padding:5px 8px;border:1px solid #dee2e6;background:#e8edf3;font-weight:600;font-size:0.84rem;' + (align ? 'text-align:' + align : 'text-align:left') + '">' + text + '</th>';
  }
  function rptTd(text, align, bold) {
    return '<td style="padding:4px 8px;border:1px solid #dee2e6;font-size:0.86rem;' + (align ? 'text-align:' + align : '') + (bold ? ';font-weight:600' : '') + '">' + text + '</td>';
  }

  // frequency label for PSQI items (0-3)
  var FREQ = ['not during the past month', 'less than once a week', 'once or twice a week', 'three or more times a week'];
  var QUALITY = ['very good', 'fairly good', 'fairly bad', 'very bad'];
  var PROBLEM = ['no problem at all', 'only a very slight problem', 'somewhat of a problem', 'a very big problem'];
  var GAD_FREQ = ['not at all', 'several days', 'more than half the days', 'nearly every day'];

  // ═══════════════════════════════════════════
  //  SLEEP (PSQI + Epworth)
  // ═══════════════════════════════════════════
  function sleepSection(compact) {
    var psqi = S.getScore('psqi');
    var epworth = S.getScore('epworth');
    var d = S.getSession().instruments.psqi || {};
    var content = '';

    if (psqi && psqi.globalTotal !== null) {
      content += '<p><strong>Pittsburgh Sleep Quality Index (PSQI):</strong> ' +
        scoreBadge(psqi.globalTotal, 21, { moderate: 5, poor: 10 }) + '</p>';

      // Overall quality
      if (d.q9_quality !== undefined && d.q9_quality !== null) {
        content += '<p>Over the past month, you rated your overall sleep quality as <strong>' + QUALITY[d.q9_quality] + '</strong>. ';
      } else {
        content += '<p>Over the past month, ';
      }

      // Bedtime/waketime/hours
      if (d.q1_bedtime) content += 'You reported typically going to bed at <strong>' + esc(d.q1_bedtime) + '</strong>';
      if (d.q3_waketime) content += ' and waking at <strong>' + esc(d.q3_waketime) + '</strong>';
      if (d.q4_sleep_hours) content += ', getting approximately <strong>' + d.q4_sleep_hours + ' hours</strong> of actual sleep';
      content += '. ';

      // Latency
      if (d.q2_latency_min) {
        content += 'It usually took you about <strong>' + esc(String(d.q2_latency_min)) + ' minutes</strong> to fall asleep. ';
      }
      content += '</p>';

      // Specific sleep disturbances
      var distItems = [
        { k: 'q5a', t: 'not being able to get to sleep within 30 minutes' },
        { k: 'q5b', t: 'waking up in the middle of the night or early morning' },
        { k: 'q5c', t: 'having to get up to use the bathroom' },
        { k: 'q5d', t: 'not being able to breathe comfortably' },
        { k: 'q5e', t: 'coughing or snoring loudly' },
        { k: 'q5f', t: 'feeling too cold' },
        { k: 'q5g', t: 'feeling too hot' },
        { k: 'q5h', t: 'having bad dreams' },
        { k: 'q5i', t: 'having pain' }
      ];

      var frequent = [], occasional = [];
      for (var i = 0; i < distItems.length; i++) {
        var v = d[distItems[i].k];
        if (v !== undefined && v !== null) {
          if (Number(v) >= 3) frequent.push(distItems[i].t);
          else if (Number(v) >= 2) occasional.push(distItems[i].t);
        }
      }

      if (frequent.length > 0) {
        content += '<p>You reported having trouble sleeping <strong>three or more times a week</strong> because of ' + joinList(frequent) + '. ';
        if (occasional.length > 0) {
          content += 'You also had difficulty <strong>once or twice a week</strong> with ' + joinList(occasional) + '. ';
        }
        content += '</p>';
      } else if (occasional.length > 0) {
        content += '<p>You reported having trouble sleeping <strong>once or twice a week</strong> because of ' + joinList(occasional) + '.</p>';
      }

      // Medication
      if (d.q6_medication !== undefined && Number(d.q6_medication) > 0) {
        content += '<p>You indicated that you have taken sleep medication <strong>' + FREQ[d.q6_medication] + '</strong>.</p>';
      }

      // Daytime dysfunction
      if (d.q7_drowsiness !== undefined && Number(d.q7_drowsiness) >= 2) {
        content += '<p>You reported having trouble staying awake while driving, eating, or during social activity <strong>' + FREQ[d.q7_drowsiness] + '</strong>. ';
      }
      if (d.q8_enthusiasm !== undefined && Number(d.q8_enthusiasm) >= 1) {
        content += 'Keeping up enthusiasm to get things done has been <strong>' + PROBLEM[d.q8_enthusiasm] + '</strong>. ';
      }
      if ((d.q7_drowsiness !== undefined && Number(d.q7_drowsiness) >= 2) || (d.q8_enthusiasm !== undefined && Number(d.q8_enthusiasm) >= 1)) {
        content += '</p>';
      }

      // MI summary
      if (psqi.globalTotal <= 5) {
        content += '<p><em>It sounds like your sleep has been going reasonably well over the past month, which is a real positive for your overall health and wellbeing.</em></p>';
      } else {
        content += '<p><em>It sounds like sleep has been a challenge recently. The good news is that there are practical strategies that can help, and it is worth exploring what might make the biggest difference for you.</em></p>';
      }

      if (!compact) content += '<div class="chart-container" id="chart-psqi"></div>';
    } else {
      content += '<p class="text-muted">PSQI not yet completed.</p>';
    }

    // Epworth
    var ed = S.getSession().instruments.epworth || {};
    if (epworth && epworth.total !== null) {
      content += '<p><strong>Epworth Sleepiness Scale:</strong> ' +
        scoreBadge(epworth.total, 24, { moderate: 10, poor: 14 }) + '</p>';

      var situations = [
        { k: 'e1', t: 'sitting and reading' },
        { k: 'e2', t: 'watching TV' },
        { k: 'e3', t: 'sitting inactive in a public place' },
        { k: 'e4', t: 'as a passenger in a car for an hour' },
        { k: 'e5', t: 'lying down to rest in the afternoon' },
        { k: 'e6', t: 'sitting and talking to someone' },
        { k: 'e7', t: 'sitting quietly after lunch without alcohol' },
        { k: 'e8', t: 'in a car while stopped in traffic' }
      ];

      var high = [], moderate = [];
      for (var ei = 0; ei < situations.length; ei++) {
        var ev = ed[situations[ei].k];
        if (ev !== undefined && ev !== null) {
          if (Number(ev) === 3) high.push(situations[ei].t);
          else if (Number(ev) === 2) moderate.push(situations[ei].t);
        }
      }

      if (high.length > 0) {
        content += '<p>You reported a <strong>high chance of dozing</strong> while ' + joinList(high) + '. ';
        if (moderate.length > 0) content += 'You also noted a <strong>moderate chance</strong> while ' + joinList(moderate) + '. ';
        content += '</p>';
      } else if (moderate.length > 0) {
        content += '<p>You reported a <strong>moderate chance of dozing</strong> while ' + joinList(moderate) + '.</p>';
      }

      if (epworth.total <= 10) {
        content += '<p><em>Your daytime sleepiness appears to be within the normal range, which is reassuring.</em></p>';
      } else {
        content += '<p><em>You mentioned feeling sleepier during the day than might be expected. This is worth exploring further, as addressing the underlying cause can make a real difference to how you feel day-to-day.</em></p>';
      }
    } else {
      content += '<p class="text-muted">Epworth not yet completed.</p>';
    }

    return section('Sleep', content, compact, 'sleep');
  }

  // ═══════════════════════════════════════════
  //  MOOD & WORRY (GAD-7 + GDS-15)
  // ═══════════════════════════════════════════
  function moodSection(compact) {
    var gad = S.getScore('gad7');
    var dep = S.getScore('depression');
    var gd = S.getSession().instruments.gad7 || {};
    var dd = S.getSession().instruments.depression || {};
    var content = '';

    // GAD-7
    if (gad && gad.total !== null) {
      content += '<p><strong>Anxiety (GAD-7):</strong> ' + scoreBadge(gad.total, 21, { moderate: 9, poor: 14 }) + '</p>';

      var gadItems = [
        { k: 'g1', t: 'feeling nervous, anxious, or on edge' },
        { k: 'g2', t: 'not being able to stop or control worrying' },
        { k: 'g3', t: 'worrying too much about different things' },
        { k: 'g4', t: 'trouble relaxing' },
        { k: 'g5', t: 'being so restless that it is hard to sit still' },
        { k: 'g6', t: 'becoming easily annoyed or irritable' },
        { k: 'g7', t: 'feeling afraid, as if something awful might happen' }
      ];

      var gadFreq = {}, gadAny = false;
      for (var gi = 0; gi < gadItems.length; gi++) {
        var gv = gd[gadItems[gi].k];
        if (gv !== undefined && gv !== null && Number(gv) > 0) {
          var freq = GAD_FREQ[Number(gv)];
          if (!gadFreq[freq]) gadFreq[freq] = [];
          gadFreq[freq].push(gadItems[gi].t);
          gadAny = true;
        }
      }

      if (gadAny) {
        content += '<p>Over the past two weeks, you reported: ';
        var parts = [];
        if (gadFreq['nearly every day']) parts.push('<strong>nearly every day</strong> — ' + joinList(gadFreq['nearly every day']));
        if (gadFreq['more than half the days']) parts.push('<strong>more than half the days</strong> — ' + joinList(gadFreq['more than half the days']));
        if (gadFreq['several days']) parts.push('<strong>several days</strong> — ' + joinList(gadFreq['several days']));
        content += parts.join('; ') + '.</p>';
      }

      if (gad.impairment) {
        var impLabels = { not_difficult: 'not at all difficult', somewhat: 'somewhat difficult', very: 'very difficult', extremely: 'extremely difficult' };
        content += '<p>You rated the impact of these difficulties on your daily functioning as <em>' + (impLabels[gad.impairment] || gad.impairment) + '</em>.</p>';
      }

      if (gad.total <= 4) {
        content += '<p><em>It is encouraging that worry and nervousness have not been a significant problem for you recently. This is a real strength to build on.</em></p>';
      } else if (gad.total <= 9) {
        content += '<p><em>You have been experiencing some mild anxiety. Many people find that small, practical steps — such as relaxation techniques or talking things through — can help manage these feelings.</em></p>';
      } else {
        content += '<p><em>It sounds like anxiety has been having a noticeable impact on your life. There are effective approaches that can help, and it is worth exploring what kind of support might be most beneficial for you.</em></p>';
      }
    } else {
      content += '<p class="text-muted">GAD-7 not yet completed.</p>';
    }

    // GDS-15
    if (dep && dep.total !== null) {
      content += '<p><strong>Depression Screen (GDS-15):</strong> ' + scoreBadge(dep.total, 15, { moderate: 4, poor: 8 }) + '</p>';

      var depItems = BHM.Instruments.Depression.getItems();
      var endorsed = [];
      for (var di = 0; di < depItems.length; di++) {
        var dv = dd[depItems[di].key];
        if (dv !== undefined && dv === depItems[di].depressiveAnswer) {
          var stmt = depItems[di].label.replace(/^\d+\s*/, '');
          endorsed.push(stmt);
        }
      }

      if (endorsed.length > 0) {
        content += '<p>Your responses indicated that: ';
        var stmts = [];
        for (var ei2 = 0; ei2 < endorsed.length; ei2++) {
          var s = endorsed[ei2];
          s = s.replace(/^Are you basically satisfied/, 'you are not fully satisfied');
          s = s.replace(/^Have you dropped/, 'you have dropped');
          s = s.replace(/^Do you feel that your life is empty/, 'you feel your life is empty');
          s = s.replace(/^Do you often feel bored/, 'you often feel bored');
          s = s.replace(/^Are you in good spirits/, 'you are not in good spirits');
          s = s.replace(/^Are you afraid/, 'you are afraid');
          s = s.replace(/^Do you feel happy/, 'you do not feel happy');
          s = s.replace(/^Do you often feel helpless/, 'you often feel helpless');
          s = s.replace(/^Do you prefer to stay at home/, 'you prefer to stay at home');
          s = s.replace(/^Do you feel you have more problems/, 'you feel you have more problems');
          s = s.replace(/^Do you think it is wonderful/, 'you do not feel it is wonderful');
          s = s.replace(/^Do you feel pretty worthless/, 'you feel worthless');
          s = s.replace(/^Do you feel full of energy/, 'you do not feel full of energy');
          s = s.replace(/^Do you feel that your situation is hopeless/, 'you feel your situation is hopeless');
          s = s.replace(/^Do you think that most people/, 'you think most people');
          s = s.replace(/\?$/, '');
          stmts.push(s.charAt(0).toLowerCase() + s.slice(1));
        }
        content += stmts.join('; ') + '.</p>';
      }

      if (dep.total <= 4) {
        content += '<p><em>Your responses do not suggest significant symptoms of low mood. It is good to hear that you are generally managing well in this area.</em></p>';
      } else if (dep.total <= 8) {
        content += '<p><em>You have described some feelings that suggest your mood may have dipped a little recently. This is something that many people experience, and talking through how you have been feeling can often be a helpful first step.</em></p>';
      } else {
        content += '<p><em>It sounds like you have been going through a difficult time emotionally. Please know that support is available, and there are effective ways to help with these feelings.</em></p>';
      }
    } else {
      content += '<p class="text-muted">Depression screen not yet completed.</p>';
    }

    return section('Mood and Worry', content, compact, 'mood');
  }

  // ═══════════════════════════════════════════
  //  ALCOHOL (AUDIT)
  // ═══════════════════════════════════════════
  function alcoholSection(compact) {
    var audit = S.getScore('auditTool');
    var ad = S.getSession().instruments.auditTool || {};
    var content = '';

    if (audit && audit.total !== null) {
      content += '<p><strong>AUDIT Score:</strong> ' + scoreBadge(audit.total, 40, { moderate: 7, poor: 15 }) + '</p>';

      var freqLabels = ['never', 'monthly or less', '2 to 4 times per month', '2 to 3 times per week', '4 or more times per week'];
      var unitLabels = ['0 to 2', '3 to 4', '5 to 6', '7 to 9', '10 or more'];
      var bingeLabels = ['never', 'less than monthly', 'monthly', 'weekly', 'daily or almost daily'];

      if (ad.a1 !== undefined && ad.a1 !== null) {
        if (Number(ad.a1) === 0) {
          content += '<p>You reported that you <strong>never</strong> drink alcohol.</p>';
        } else {
          content += '<p>You reported having a drink containing alcohol <strong>' + freqLabels[Number(ad.a1)] + '</strong>';
          if (ad.a2 !== undefined && ad.a2 !== null) {
            content += ', typically having <strong>' + unitLabels[Number(ad.a2)] + ' units</strong> on a drinking day';
          }
          content += '. ';

          if (ad.a3 !== undefined && Number(ad.a3) > 0) {
            content += 'You have had 6 or more units on a single occasion <strong>' + bingeLabels[Number(ad.a3)] + '</strong>. ';
          }
          content += '</p>';

          var concerns = [];
          if (ad.a4 !== undefined && Number(ad.a4) > 0) concerns.push('you found you were not able to stop drinking once you had started (' + bingeLabels[Number(ad.a4)] + ')');
          if (ad.a5 !== undefined && Number(ad.a5) > 0) concerns.push('you failed to do what was normally expected because of drinking (' + bingeLabels[Number(ad.a5)] + ')');
          if (ad.a6 !== undefined && Number(ad.a6) > 0) concerns.push('you needed a morning drink to get going (' + bingeLabels[Number(ad.a6)] + ')');
          if (ad.a7 !== undefined && Number(ad.a7) > 0) concerns.push('you had feelings of guilt or remorse after drinking (' + bingeLabels[Number(ad.a7)] + ')');
          if (ad.a8 !== undefined && Number(ad.a8) > 0) concerns.push('you were unable to remember what happened the night before because of drinking (' + bingeLabels[Number(ad.a8)] + ')');

          if (concerns.length > 0) {
            content += '<p>In the past year, you indicated that ' + joinList(concerns) + '.</p>';
          }

          if (ad.a9 !== undefined && Number(ad.a9) > 0) {
            content += '<p>You reported that ' + (Number(ad.a9) === 4 ? 'you or someone else has been injured during the last year' : 'you or someone else has been injured, though not in the last year') + ' as a result of drinking.</p>';
          }
          if (ad.a10 !== undefined && Number(ad.a10) > 0) {
            content += '<p>A relative, friend, or health worker has expressed concern about your drinking' +
              (Number(ad.a10) === 4 ? ' during the last year' : ', though not in the last year') + '.</p>';
          }
        }
      }

      if (audit.total <= 7) {
        content += '<p><em>Your alcohol use falls within the low-risk range. Maintaining these habits is a positive step for your long-term health.</em></p>';
      } else if (audit.total <= 15) {
        content += '<p><em>Your responses suggest your alcohol use is at a level that could be worth reviewing. Even small changes can make a meaningful difference to your health, and support is available if you are interested in exploring this.</em></p>';
      } else {
        content += '<p><em>Your responses suggest that alcohol may be having a significant impact on your life. There are effective support options available, and it is worth discussing what might be most helpful for you.</em></p>';
      }
    } else {
      content += '<p class="text-muted">AUDIT not yet completed.</p>';
    }

    return section('Alcohol', content, compact, 'alcohol');
  }

  // ═══════════════════════════════════════════
  //  DIET (Mediterranean Diet Score)
  // ═══════════════════════════════════════════
  function dietSection(compact) {
    var dietScore = S.getScore('diet');
    var dd = S.getSession().instruments.diet || {};
    var content = '';

    if (dietScore && dietScore.total !== null) {
      content += '<p><strong>Mediterranean Diet Score:</strong> ' + scoreBadge(dietScore.total, 14, { moderate: -1, poor: -1 }) + '</p>';

      var dietItems = [
        { k: 'md1',  yes: 'olive oil is your main cooking fat', no: 'olive oil is not your main cooking fat' },
        { k: 'md2',  yes: 'you use 4 or more tablespoons of olive oil each day', no: 'you use less than 4 tablespoons of olive oil each day' },
        { k: 'md3',  yes: 'you eat 2 or more servings of vegetables each day', no: 'you eat fewer than 2 servings of vegetables daily' },
        { k: 'md4',  yes: 'you eat 3 or more servings of fruit each day', no: 'you eat fewer than 3 servings of fruit daily' },
        { k: 'md5',  yes: 'you eat less than 1 serving of red meat per day', no: 'you eat 1 or more servings of red meat per day' },
        { k: 'md6',  yes: 'you consume less than 1 serving of butter, margarine, or cream per day', no: 'you consume 1 or more servings of butter, margarine, or cream daily' },
        { k: 'md7',  yes: 'you drink fewer than 1 sweetened carbonated drink per day', no: 'you drink 1 or more sweetened carbonated drinks per day' },
        { k: 'md8',  yes: 'you drink 3 or more glasses of wine per week', no: 'you drink fewer than 3 glasses of wine per week' },
        { k: 'md9',  yes: 'you eat 3 or more servings of legumes per week', no: 'you eat fewer than 3 servings of legumes per week' },
        { k: 'md10', yes: 'you eat 3 or more servings of fish or seafood per week', no: 'you eat fewer than 3 servings of fish or seafood per week' },
        { k: 'md11', yes: 'you eat fewer than 3 commercial sweets or pastries per week', no: 'you eat 3 or more commercial sweets or pastries per week' },
        { k: 'md12', yes: 'you eat 1 or more servings of nuts per week', no: 'you eat fewer than 1 serving of nuts per week' },
        { k: 'md13', yes: 'you routinely choose chicken, turkey, or rabbit over red meat', no: 'you do not routinely choose poultry over red meat' },
        { k: 'md14', yes: 'you eat pasta, vegetable, or rice dishes flavoured with garlic, tomato, leek, or onion twice a week or more', no: 'you eat these Mediterranean-style dishes less than twice a week' }
      ];

      var strengths = [], gaps = [];
      for (var di = 0; di < dietItems.length; di++) {
        var v = dd[dietItems[di].k];
        if (v === 'yes') strengths.push(dietItems[di].yes);
        else if (v === 'no') gaps.push(dietItems[di].no);
      }

      if (strengths.length > 0) {
        content += '<p>Some positive aspects of your current diet: ' + joinList(strengths) + '.</p>';
      }
      if (gaps.length > 0) {
        content += '<p>Some areas where your diet could move closer to a Mediterranean pattern: ' + joinList(gaps) + '.</p>';
      }

      if (dietScore.total >= 10) {
        content += '<p><em>Your diet already follows a Mediterranean pattern well, which is linked to better brain and heart health. That is a real strength to build on and maintain.</em></p>';
      } else if (dietScore.total >= 7) {
        content += '<p><em>Your diet has some good Mediterranean features already. Even small, gradual changes — such as adding a little more fish, vegetables, or olive oil — can further support your brain health over time.</em></p>';
      } else {
        content += '<p><em>There may be some straightforward changes you could consider to move your diet closer to a Mediterranean pattern, which is associated with better brain health outcomes. A dietitian or other specialist can help think about what would work best for you.</em></p>';
      }
    } else {
      content += '<p class="text-muted">Diet questionnaire not yet completed.</p>';
    }

    return section('Diet Pattern', content, compact, 'diet');
  }

  // ═══════════════════════════════════════════
  //  QUALITY OF LIFE (CASP-19)
  // ═══════════════════════════════════════════
  function qolSection(compact) {
    var casp = S.getScore('casp19');
    var cd = S.getSession().instruments.casp19 || {};
    var content = '';

    if (casp && casp.total !== null) {
      content += '<p><strong>Quality of Life (CASP-19):</strong> ' + scoreBadge(casp.total, 57, { moderate: -1, poor: -1 }) + '</p>';
      content += '<p>This questionnaire asks about four aspects of quality of life: Control, Autonomy, Pleasure, and Self-realisation.</p>';

      var items = BHM.Instruments.CASP19.getItems();
      var COLS = ['often', 'sometimes', 'not often', 'never'];

      var domains = {};
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        if (!domains[item.domain]) domains[item.domain] = { concerns: [], positives: [] };
        var v = cd[item.key];
        if (v === undefined || v === null) continue;
        var colIdx = Number(v);
        var freqWord = COLS[colIdx];

        // Convert label to second person ("I/me/my" → "you/your")
        var stmt = toSecondPerson(item.label);
        var stmtLower = stmt.charAt(0).toLowerCase() + stmt.slice(1);
        // Strip "on balance, " prefix for cleaner embedding
        stmtLower = stmtLower.replace(/^on balance,\s*/i, '');

        // Check if the converted text starts with "you [verb]"
        var startsWithYou = /^you\s/.test(stmtLower);
        var verbPhrase = startsWithYou ? stmtLower.replace(/^you\s+/, '') : null;

        if (item.reverse) {
          // Negative wording: concern when often (0) or sometimes (1)
          if (colIdx <= 1) {
            var phrase;
            if (startsWithYou) {
              // "you feel left out" → "you often feel left out"
              phrase = 'you ' + freqWord + ' ' + verbPhrase;
            } else {
              // "your age prevents you..." → "you often feel that your age prevents you..."
              phrase = 'you ' + freqWord + ' feel that ' + stmtLower;
            }
            domains[item.domain].concerns.push(phrase);
          }
        } else {
          // Positive wording: concern when not often (2) or never (3)
          if (colIdx >= 2) {
            var phrase2;
            if (startsWithYou && verbPhrase) {
              // Handle "can" specially: "you do not often feel you can..."
              if (/^can\s/.test(verbPhrase)) {
                phrase2 = (freqWord === 'not often')
                  ? 'you do not often feel you can ' + verbPhrase.replace(/^can\s+/, '')
                  : 'you ' + freqWord + ' feel you can ' + verbPhrase.replace(/^can\s+/, '');
              } else {
                phrase2 = (freqWord === 'not often')
                  ? 'you do not often ' + verbPhrase
                  : 'you ' + freqWord + ' ' + verbPhrase;
              }
            } else {
              phrase2 = (freqWord === 'not often')
                ? 'you do not often feel that ' + stmtLower
                : 'you ' + freqWord + ' feel that ' + stmtLower;
            }
            domains[item.domain].concerns.push(phrase2);
          } else {
            // Positive: store as second-person verb phrase for "you often..."
            var posStmt = toSecondPerson(item.label);
            var posLower = posStmt.charAt(0).toLowerCase() + posStmt.slice(1);
            posLower = posLower.replace(/^on balance,\s*/i, '');
            // Strip leading "you " so it can be joined after "you often"
            var posVerb = /^you\s/.test(posLower) ? posLower.replace(/^you\s+/, '') : posLower;
            domains[item.domain].positives.push(posVerb);
          }
        }
      }

      for (var dom in domains) {
        if (!domains.hasOwnProperty(dom)) continue;
        var dInfo = domains[dom];
        var domScore = casp.domainTotals ? casp.domainTotals[dom] : null;
        content += '<p><strong>' + dom + '</strong>' + (domScore !== null ? ' (score: ' + domScore + ')' : '') + ': ';
        if (dInfo.concerns.length > 0) {
          content += 'You noted that ' + joinList(dInfo.concerns) + '. ';
        }
        if (dInfo.positives.length > 0 && dInfo.concerns.length === 0) {
          content += 'Positively, you indicated that you often ' + joinList(dInfo.positives) + '. ';
        }
        if (dInfo.concerns.length === 0 && dInfo.positives.length === 0) {
          content += 'No notable concerns were identified in this area. ';
        }
        content += '</p>';
      }

      content += '<p><em>Quality of life is personal and multifaceted. It can be helpful to think about which areas matter most to you and what might help you get more of what you value.</em></p>';

      if (!compact) content += '<div class="chart-container" id="chart-casp19"></div>';
    } else {
      content += '<p class="text-muted">CASP-19 not yet completed.</p>';
    }

    return section('Quality of Life', content, compact, 'qol');
  }

  // ═══════════════════════════════════════════
  //  HEARING
  // ═══════════════════════════════════════════
  function hearingSection(compact) {
    var hearingScore = S.getScore('hearing');
    var hd = S.getSession().instruments.hearing || {};
    var content = '';

    if (hearingScore) {
      content += '<p><strong>Hearing difficulties reported in:</strong> ' + hearingScore.affectedCount + ' of 17 situations</p>';

      if (hearingScore.affectedCount > 0) {
        var situations = BHM.Instruments.Hearing ? BHM.Instruments.Hearing.getSituations() : [];
        var affected = [];
        for (var i = 0; i < situations.length; i++) {
          if (hd[situations[i].key] === 'yes') {
            var txt = situations[i].label.replace(/^\d+\.\s*/, '').replace(/\.$/, '').toLowerCase();
            affected.push(txt);
          }
        }
        if (affected.length > 0) {
          content += '<p>You reported that your hearing affects you in the following situations: ' + joinList(affected) + '.</p>';
        }

        var top1 = hd.top1, top2 = hd.top2, top3 = hd.top3;
        var tops = [top1, top2, top3].filter(function (t) { return t && String(t).trim(); });
        if (tops.length > 0) {
          content += '<p>The situations you identified as most important to you were numbers ' + tops.join(', ') + '.</p>';
        }

        var earSymptoms = [];
        if (hd.tinnitus === 'yes') earSymptoms.push('tinnitus (ringing, hissing, or other noises in the ears)');
        if (hd.hyperacusis === 'yes') earSymptoms.push('sensitivity to everyday loud sounds');
        if (hd.pain === 'yes') earSymptoms.push('ear pain');
        if (earSymptoms.length > 0) {
          content += '<p>You also reported experiencing ' + joinList(earSymptoms) + '.</p>';
        }

        if (hd.hearingAids === 'Yes') {
          content += '<p>You currently wear hearing aids. ';
          if (hd.hearingAidProblems && hd.hearingAidProblems.trim()) {
            content += 'You noted the following issues: ' + esc(hd.hearingAidProblems) + '.';
          }
          content += '</p>';
        } else if (hd.hearingAids === 'No') {
          if (hd.wantHearingAids === 'Yes') {
            content += '<p>You do not currently wear hearing aids but indicated you would be interested if they might help.</p>';
          }
        }

        content += '<p><em>Hearing plays an important role in communication, social connection, and overall wellbeing. Addressing hearing difficulties can have a positive impact on many areas of life, and there are good options available.</em></p>';
      } else {
        content += '<p><em>You did not report significant hearing difficulties, which is positive.</em></p>';
      }
    } else {
      content += '<p class="text-muted">Hearing section not yet completed.</p>';
    }

    return section('Hearing', content, compact, 'hearing');
  }

  // ═══════════════════════════════════════════
  //  INFORMANT (MBI-C + NPI-Q)
  //  Concise score-summary + brief narrative
  // ═══════════════════════════════════════════
  function informantSection(compact) {
    var mbic = S.getScore('mbiC');
    var npiq = S.getScore('npiQ');
    var content = '';

    // ── MBI-C ──
    if (mbic && mbic.total !== null) {
      content += '<p><strong>Mild Behavioural Impairment Checklist (MBI-C):</strong> Total score ' + mbic.total + '</p>';

      var domains = BHM.Instruments.MBIC.getDomains();
      var domainShort = ['Motivation & drive', 'Mood & anxiety', 'Impulse control', 'Social appropriateness', 'Beliefs & perception'];
      var mbicData = S.getSession().instruments.mbiC || {};

      // Build per-domain stats
      var domStats = [];
      var concernDomains = [], clearDomains = [];
      for (var d = 0; d < domains.length; d++) {
        var dom = domains[d];
        var domTotal = 0, endorsedCount = 0, maxSev = 0, answered = 0;
        for (var j = 0; j < dom.items.length; j++) {
          var v = mbicData[dom.items[j].key];
          if (v !== undefined && v !== null && v !== '') {
            answered++;
            var nv = Number(v);
            domTotal += nv;
            if (nv > 0) { endorsedCount++; if (nv > maxSev) maxSev = nv; }
          }
        }
        var stat = { name: domainShort[d], score: domTotal, endorsed: endorsedCount, total: dom.items.length, maxSev: maxSev, answered: answered };
        domStats.push(stat);
        if (endorsedCount > 0) concernDomains.push(stat);
        else if (answered > 0) clearDomains.push(stat);
      }

      // Domain score table
      content += '<table style="width:100%;border-collapse:collapse;margin:0.5rem 0 0.75rem">';
      content += '<thead><tr>' + rptTh('Domain') + rptTh('Score', 'center') + rptTh('Items endorsed', 'center') + rptTh('Max severity', 'center') + '</tr></thead><tbody>';
      var sevWord = ['—', 'mild', 'moderate', 'severe'];
      for (var ds = 0; ds < domStats.length; ds++) {
        var st = domStats[ds];
        content += '<tr>' + rptTd(st.name, null, st.endorsed > 0) + rptTd(st.score, 'center') + rptTd(st.endorsed + ' / ' + st.total, 'center') + rptTd(sevWord[st.maxSev] || '—', 'center') + '</tr>';
      }
      content += '</tbody></table>';

      if (mbic.total > 0) {
        // Narrative summary — group by severity
        var severe = [], moderate = [], mild = [];
        for (var cd2 = 0; cd2 < concernDomains.length; cd2++) {
          var cs = concernDomains[cd2];
          var phrase = cs.name.toLowerCase() + ' (' + cs.endorsed + ' item' + (cs.endorsed > 1 ? 's' : '') + ')';
          if (cs.maxSev === 3) severe.push(phrase);
          else if (cs.maxSev === 2) moderate.push(phrase);
          else mild.push(phrase);
        }

        content += '<p>';
        if (severe.length > 0) content += 'The informant reported <strong>severe</strong> concerns in ' + joinList(severe) + '. ';
        if (moderate.length > 0) {
          content += (severe.length > 0 ? '<strong>Moderate</strong> concerns were noted in ' : 'The informant reported <strong>moderate</strong> concerns in ');
          content += joinList(moderate) + '. ';
        }
        if (mild.length > 0) {
          content += (severe.length > 0 || moderate.length > 0 ? '<strong>Mild</strong> concerns were noted in ' : 'The informant reported <strong>mild</strong> concerns in ');
          content += joinList(mild) + '. ';
        }
        content += '</p>';

        if (clearDomains.length > 0) {
          var clearNames = [];
          for (var cl = 0; cl < clearDomains.length; cl++) clearNames.push(clearDomains[cl].name.toLowerCase());
          content += '<p>No concerns were raised in ' + joinList(clearNames) + '.</p>';
        }

        content += '<p><em>Changes in behaviour can sometimes be among the earliest signs of changes in brain health. These observations will be considered alongside all other assessment findings.</em></p>';
      } else {
        content += '<p><em>No behavioural changes were reported by the informant, which is reassuring.</em></p>';
      }
      if (!compact) content += '<div class="chart-container" id="chart-mbic"></div>';
    } else {
      content += '<p class="text-muted">MBI-C not yet completed.</p>';
    }

    // ── NPI-Q ──
    if (npiq) {
      content += '<p><strong>Neuropsychiatric Inventory (NPI-Q):</strong> ' + npiq.count + ' of 12 symptoms reported';
      if (npiq.count > 0) content += ' — severity total ' + npiq.severityTotal + ', carer distress total ' + npiq.distressTotal;
      content += '</p>';

      if (npiq.count > 0) {
        var symptoms = BHM.Instruments.NPIQ.getSymptoms();
        var npiData = S.getSession().instruments.npiQ || {};
        var sevLabels = { 1: 'mild', 2: 'moderate', 3: 'severe' };
        var distLabels = { 0: 'no distress', 1: 'minimal', 2: 'mild', 3: 'moderate', 4: 'severe', 5: 'extreme' };

        // Group by severity
        var npiSevere = [], npiMod = [], npiMild = [], npiAbsent = [];
        var maxDist = 0;
        for (var si = 0; si < symptoms.length; si++) {
          if (npiData[symptoms[si].key + '_present'] === 'yes') {
            var sev = Number(npiData[symptoms[si].key + '_severity'] || 0);
            var dist = Number(npiData[symptoms[si].key + '_distress'] || 0);
            if (dist > maxDist) maxDist = dist;
            var entry = symptoms[si].label;
            if (sev === 3) npiSevere.push(entry);
            else if (sev === 2) npiMod.push(entry);
            else npiMild.push(entry);
          } else if (npiData[symptoms[si].key + '_present'] === 'no') {
            npiAbsent.push(symptoms[si].label.toLowerCase());
          }
        }

        content += '<p>';
        if (npiSevere.length > 0) content += '<strong>Severe:</strong> ' + joinList(npiSevere) + '. ';
        if (npiMod.length > 0) content += '<strong>Moderate:</strong> ' + joinList(npiMod) + '. ';
        if (npiMild.length > 0) content += '<strong>Mild:</strong> ' + joinList(npiMild) + '. ';
        content += '</p>';

        if (npiAbsent.length > 0) {
          content += '<p>Not reported: ' + joinList(npiAbsent) + '.</p>';
        }

        if (maxDist >= 3) {
          content += '<p>The informant indicated up to <strong>' + distLabels[maxDist] + '</strong> levels of personal distress in relation to these symptoms.</p>';
        }

        content += '<p><em>These symptoms can be distressing for both the person and their family. Understanding which are present helps guide the most appropriate support.</em></p>';
      } else {
        content += '<p><em>No neuropsychiatric symptoms were reported by the informant, which is reassuring.</em></p>';
      }
      if (!compact && npiq.count > 0) content += '<div class="chart-container" id="chart-npiq"></div>';
    } else {
      content += '<p class="text-muted">NPI-Q not yet completed.</p>';
    }

    return section('Changes Noticed by Family or Friends', content, compact, 'informant');
  }

  // ═══════════════════════════════════════════
  //  CLINICAL INTERVIEW — granular NLP summary
  // ═══════════════════════════════════════════
  function clinicalSection(compact) {
    var c = S.getSession().instruments.clinical || {};
    var content = '';
    var hasAnything = false;

    // ── A. Memory ──
    var CI = BHM.Instruments.ClinicalInterview;
    var memItems = CI ? CI.getMemItems() : [];
    var memPresent = [], memAbsent = 0;
    for (var mi = 0; mi < memItems.length; mi++) {
      var mk = memItems[mi].key;
      if (c[mk] === 'yes') {
        var freq = c[mk + '_freq'];
        var onset = c[mk + '_onset'];
        var desc = memItems[mi].label.toLowerCase();
        var txt = desc;
        if (freq) txt += ' (' + freq + ')';
        if (onset) txt += ' — onset: ' + esc(onset);
        memPresent.push(txt);
      } else if (c[mk] === 'no') {
        memAbsent++;
      }
    }
    if (memPresent.length > 0) {
      hasAnything = true;
      content += '<p><strong>Memory and new learning:</strong> Difficulties were reported with ' + joinList(memPresent) + '.</p>';
    } else if (memAbsent === memItems.length) {
      hasAnything = true;
      content += '<p><strong>Memory and new learning:</strong> No difficulties were reported in this area.</p>';
    }
    if (c.memoryNotes && c.memoryNotes.trim()) {
      content += '<p style="margin-left:1rem;font-style:italic;font-size:0.88rem"><strong>Examples:</strong> ' + esc(c.memoryNotes) + '</p>';
    }

    // ── B. Language ──
    var langItems = CI ? CI.getLangItems() : [];
    var langPresent = [], langAbsent = 0;
    for (var li = 0; li < langItems.length; li++) {
      var lk = langItems[li].key;
      if (c[lk] === 'yes') {
        var lfreq = c[lk + '_freq'];
        var ltxt = langItems[li].label.toLowerCase();
        if (lfreq) ltxt += ' (' + lfreq + ')';
        langPresent.push(ltxt);
      } else if (c[lk] === 'no') {
        langAbsent++;
      }
    }
    if (langPresent.length > 0) {
      hasAnything = true;
      content += '<p><strong>Word-finding and language:</strong> Difficulties were noted with ' + joinList(langPresent) + '.';
      if (c.primaryLanguage) content += ' Primary language: ' + esc(c.primaryLanguage) + '.';
      if (c.langDifficulty && c.langDifficulty !== 'No' && c.langDifficulty !== '') {
        content += ' A longstanding language difficulty was noted (' + esc(c.langDifficulty) + ').';
      }
      content += '</p>';
    } else if (langAbsent === langItems.length) {
      hasAnything = true;
      content += '<p><strong>Word-finding and language:</strong> No difficulties were reported.';
      if (c.primaryLanguage) content += ' Primary language: ' + esc(c.primaryLanguage) + '.';
      content += '</p>';
    }
    if (c.languageNotes && c.languageNotes.trim()) {
      content += '<p style="margin-left:1rem;font-style:italic;font-size:0.88rem"><strong>Notes:</strong> ' + esc(c.languageNotes) + '</p>';
    }

    // ── C. Wayfinding / visuospatial ──
    var visItems = CI ? CI.getVisItems() : [];
    var visPresent = [], visStopped = [], visSafety = [];
    for (var vi = 0; vi < visItems.length; vi++) {
      var vk = visItems[vi].key;
      var lbl = visItems[vi].label.toLowerCase().replace(/^gets /, '').replace(/^difficulty /, 'difficulty ');
      if (c[vk + '_present'] === 'yes') visPresent.push(lbl);
      if (c[vk + '_stopped'] === 'yes') visStopped.push(lbl);
      if (c[vk + '_safety'] === 'yes') visSafety.push(lbl);
    }
    if (visPresent.length > 0 || visStopped.length > 0) {
      hasAnything = true;
      content += '<p><strong>Wayfinding and visuospatial skills:</strong> ';
      if (visPresent.length > 0) content += 'Current difficulties were reported with ' + joinList(visPresent) + '. ';
      if (visStopped.length > 0) content += 'The person has stopped: ' + joinList(visStopped) + '. ';
      if (visSafety.length > 0) content += '<strong>Safety concerns</strong> were flagged for ' + joinList(visSafety) + '. ';
      content += '</p>';
    }
    if (c.visuospatialNotes && c.visuospatialNotes.trim()) {
      content += '<p style="margin-left:1rem;font-style:italic;font-size:0.88rem"><strong>Examples:</strong> ' + esc(c.visuospatialNotes) + '</p>';
    }

    // ── D. Personal history ──
    var dParts = [];
    if (c.birthPlace) dParts.push('born in ' + esc(c.birthPlace));
    if (c.livingSituation) dParts.push('currently ' + esc(c.livingSituation).toLowerCase());
    if (c.siblings) dParts.push(esc(c.siblings) + ' siblings');
    if (c.relationships) dParts.push('relationship status: ' + esc(c.relationships));
    if (c.children) dParts.push('children: ' + esc(c.children));
    if (c.military === 'Yes') dParts.push('history of military service');
    if (dParts.length > 0) {
      hasAnything = true;
      content += '<p><strong>Personal background:</strong> ' + dParts[0].charAt(0).toUpperCase() + dParts[0].slice(1);
      if (dParts.length > 1) content += '; ' + dParts.slice(1).join('; ');
      content += '.</p>';
    }
    if (c.trauma === 'Yes' && c.traumaDetails) {
      content += '<p>History of trauma was disclosed: ' + esc(c.traumaDetails) + '.</p>';
    }

    // ── E. Head injury ──
    if (c.headInjury === 'Yes') {
      hasAnything = true;
      content += '<p><strong>Head injury:</strong> A history of head injury was reported.';
      if (c.headInjuryMech) content += ' Mechanism: ' + esc(c.headInjuryMech) + '.';
      if (c.headInjuryLOC && c.headInjuryLOC !== 'No' && c.headInjuryLOC !== '') content += ' Loss of consciousness: ' + esc(c.headInjuryLOC) + '.';
      if (c.headInjuryPTA && c.headInjuryPTA !== 'No' && c.headInjuryPTA !== '') content += ' Post-traumatic amnesia: ' + esc(c.headInjuryPTA) + '.';
      if (c.repeatedConcussions === 'Yes') content += ' Repeated concussions reported' + (c.concussionCount ? ' (approximately ' + c.concussionCount + ')' : '') + '.';
      if (c.contactSports === 'Yes') content += ' Contact sports history: ' + esc(c.contactSportsDetails || 'yes') + '.';
      if (c.headInjuryOngoing && c.headInjuryOngoing.trim()) content += ' Ongoing symptoms: ' + esc(c.headInjuryOngoing) + '.';
      content += '</p>';
    } else if (c.headInjury === 'No') {
      hasAnything = true;
      content += '<p><strong>Head injury:</strong> No significant history of head injury.</p>';
    }

    // ── F. Premorbid personality ──
    var persItems = CI ? CI.getPersonalityItems() : [];
    var persParts = [];
    for (var pi = 0; pi < persItems.length; pi++) {
      var pv = c[persItems[pi].key];
      if (pv && pv !== 'typical') {
        persParts.push(pv + ' ' + persItems[pi].label.toLowerCase());
      }
    }
    if (c.persConflict) persParts.push('handles conflict: ' + c.persConflict.toLowerCase());
    if (c.persMood) persParts.push('baseline mood: ' + c.persMood.toLowerCase());
    if (c.persSocial) persParts.push('social engagement: ' + c.persSocial.toLowerCase());
    if (persParts.length > 0) {
      hasAnything = true;
      content += '<p><strong>Premorbid personality:</strong> ' + persParts.join('; ') + '.</p>';
    }

    // ── G. Education and occupation ──
    var edParts = [];
    if (c.highestQual) edParts.push('highest qualification: ' + esc(c.highestQual));
    if (c.schoolLeaveAge) edParts.push('left school at age ' + c.schoolLeaveAge);
    if (c.yearsEdu) edParts.push(c.yearsEdu + ' years of education');
    if (c.academicPerf) edParts.push('self-rated academic performance: ' + c.academicPerf.toLowerCase());
    if (c.peakOccupation) edParts.push('peak occupation: ' + esc(c.peakOccupation));
    if (c.occStatus) edParts.push('currently ' + esc(c.occStatus).toLowerCase());
    if (c.workDomain) edParts.push('work domain: ' + esc(c.workDomain).toLowerCase());
    if (c.learningDiff && c.learningDiff !== 'No' && c.learningDiff !== '') edParts.push('learning difficulty: ' + esc(c.learningDiff));
    if (edParts.length > 0) {
      hasAnything = true;
      content += '<p><strong>Education and occupation:</strong> ' + edParts.join('; ') + '.</p>';
    }

    // ── H. Substance use ──
    var subParts = [];
    if (c.alcUnitsWk) subParts.push('alcohol: ' + esc(c.alcUnitsWk) + ' units/week');
    if (c.alcPast === 'Past harmful use') subParts.push('past harmful alcohol use' + (c.alcPastDetails ? ' (' + esc(c.alcPastDetails) + ')' : ''));
    if (c.tobacco) subParts.push('tobacco: ' + esc(c.tobacco).toLowerCase() + (c.tobaccoPacks ? ', ' + esc(c.tobaccoPacks) + ' packs/day' : '') + (c.tobaccoYears ? ' for ' + esc(c.tobaccoYears) + ' years' : ''));
    if (c.cannabis && c.cannabis !== 'Never' && c.cannabis !== '') subParts.push('cannabis: ' + esc(c.cannabis).toLowerCase());
    if (c.otherSubstances && c.otherSubstances !== 'None' && c.otherSubstances !== '') subParts.push('other substances: ' + esc(c.otherSubstances).toLowerCase());
    if (c.substanceHarms && c.substanceHarms !== 'No' && c.substanceHarms !== '') subParts.push('harms reported: ' + esc(c.substanceHarms).toLowerCase());
    if (subParts.length > 0) {
      hasAnything = true;
      content += '<p><strong>Substance use:</strong> ' + subParts.join('; ') + '.</p>';
    }
    if (c.substanceNotes && c.substanceNotes.trim()) {
      content += '<p style="margin-left:1rem;font-style:italic;font-size:0.88rem"><strong>Notes:</strong> ' + esc(c.substanceNotes) + '</p>';
    }

    // ── I. Clinician summary ──
    if (c.keyPositives && c.keyPositives.trim()) {
      hasAnything = true;
      content += '<p><strong>Key findings:</strong> ' + esc(c.keyPositives) + '</p>';
    }
    if (c.safetyConcerns && c.safetyConcerns.trim()) {
      hasAnything = true;
      content += '<p><strong>Safety concerns:</strong> ' + esc(c.safetyConcerns) + '</p>';
    }

    if (!hasAnything) {
      content = '<p class="text-muted">Clinical interview not yet completed.</p>';
    } else {
      content += '<p><em>This information was gathered during a semi-structured clinical interview and provides important context for interpreting the assessment findings. It will be considered alongside all other results when forming an overall impression.</em></p>';
    }

    return section('Clinical Interview', content, compact, 'clinical');
  }

  // ═══════════════════════════════════════════
  //  STAGING (CDR)
  // ═══════════════════════════════════════════
  function stagingSection(compact) {
    var cdr = S.getScore('cdr');
    var content = '';
    if (cdr && cdr.total !== null) {
      content += '<p><strong>Clinical Dementia Rating (CDR) Total:</strong> ' + scoreBadge(cdr.total, 3, { moderate: 0.5, poor: 1 }) + '</p>';
      content += '<p><strong>CDR Sum of Boxes (CDR-SB):</strong> ' + scoreBadge(cdr.sumOfBoxes, 18, { moderate: 2.5, poor: 4 }) + '</p>';
      if (cdr.total === 0) content += '<p>The CDR rating indicates no dementia. No significant cognitive decline from the person\'s previous usual level was identified across the domains assessed.</p>';
      else if (cdr.total === 0.5) content += '<p>The CDR rating of 0.5 indicates questionable or very mild impairment. There may be some subtle changes in one or more areas that are worth monitoring.</p>';
      else if (cdr.total === 1) content += '<p>The CDR rating of 1 indicates mild dementia. Difficulties were noted across several domains that are likely affecting daily activities to some degree.</p>';
      else if (cdr.total === 2) content += '<p>The CDR rating of 2 indicates moderate dementia. Significant difficulties were noted across several areas, with a clear impact on daily functioning and independence.</p>';
      else if (cdr.total === 3) content += '<p>The CDR rating of 3 indicates severe dementia. Major difficulties were noted across all areas, with substantial loss of independent function.</p>';
      if (cdr.severity) content += '<p>Based on the Sum of Boxes score (' + cdr.sumOfBoxes + '), this is classified as <strong>' + cdr.severity + '</strong> (Bryant et al 2012).</p>';
      if (cdr.domainScores) {
        content += '<p>Domain ratings: ';
        var parts = [], labels = { memory: 'Memory', orientation: 'Orientation', judgment: 'Judgment', community: 'Community Affairs', homeHobbies: 'Home & Hobbies', personalCare: 'Personal Care' };
        for (var key in cdr.domainScores) { if (cdr.domainScores.hasOwnProperty(key)) parts.push(labels[key] + ': ' + cdr.domainScores[key]); }
        content += parts.join(', ') + '</p>';
      }
      if (!compact) content += '<div class="chart-container" id="chart-cdr"></div>';
    } else {
      content += '<p class="text-muted">CDR assessment not yet completed.</p>';
    }
    return section('Staging', content, compact, 'staging');
  }

  // ═══════════════════════════════════════════
  //  RBANS
  // ═══════════════════════════════════════════
  function rbansSection(compact) {
    var rb = S.getScore('rbans');
    if (!rb || !rb.indices) return section('Neuropsychological Assessment', '<p class="text-muted">RBANS not yet completed.</p>', compact, 'rbans');
    var idx = rb.indices, cent = rb.centiles, raw = S.getSession().instruments.rbans || {};
    var content = '';
    if (rb.fsiq) content += '<p><strong>Premorbid Functioning (TOPF):</strong> Estimated pre-morbid IQ approximately <strong>' + rb.fsiq + '</strong>.</p>';
    content += '<p><strong>Total Scale Score:</strong> ' + scoreBadge(idx.totalScale, null, { moderate: 84, poor: 69 }) + ' (' + cent.totalScale + 'th percentile)</p>';
    if (idx.totalScale >= 90) content += '<p>Your overall cognitive performance on the RBANS fell within the average range or better.</p>';
    else if (idx.totalScale >= 80) content += '<p>Your overall cognitive performance was in the low average range, which may reflect subtle difficulties across domains.</p>';
    else if (idx.totalScale >= 70) content += '<p>Your overall cognitive performance was in the borderline range, suggesting difficulties across multiple domains.</p>';
    else content += '<p>Your overall cognitive performance was well below the expected range, indicating significant difficulties.</p>';
    content += '<table style="width:100%;border-collapse:collapse;margin:0.75rem 0"><thead><tr>' + rptTh('Domain') + rptTh('Index', 'center') + rptTh('Centile', 'center') + rptTh('Classification', 'center') + '</tr></thead><tbody>';
    var domainList = [
      { label: 'Immediate Memory', i: idx.immediateMemory, c: cent.immediateMemory },
      { label: 'Visuospatial/Constructional', i: idx.visuospatial, c: cent.visuospatial },
      { label: 'Language', i: idx.language, c: cent.language },
      { label: 'Attention', i: idx.attention, c: cent.attention },
      { label: 'Delayed Memory', i: idx.delayedMemory, c: cent.delayedMemory }
    ];
    for (var d2 = 0; d2 < domainList.length; d2++) { var dm = domainList[d2]; content += '<tr>' + rptTd(dm.label, null, true) + rptTd(dm.i, 'center') + rptTd(dm.c + '%', 'center') + rptTd(classifyIndex(dm.i), 'center') + '</tr>'; }
    content += '<tr style="background:#e8edf3;font-weight:600">' + rptTd('Total Scale', null, true) + rptTd(idx.totalScale, 'center') + rptTd(cent.totalScale + '%', 'center') + rptTd(classifyIndex(idx.totalScale), 'center') + '</tr>';
    content += '</tbody></table>';
    if (!compact) content += '<div class="chart-container" id="chart-rbans"></div>';
    content += '<div style="margin-top:1rem">';
    content += '<h5 style="color:#0d6efd;border-bottom:2px solid #0d6efd;padding-bottom:3px;font-size:0.95rem">Immediate Memory</h5>';
    content += '<p>You scored ' + (raw.listlearning || '--') + '/40 on the word list learning task which is a sensitive indicator of your ability to remember new words. You scored ' + (raw.storylearning || '--') + '/24 on the short story learning task which is similar. This gives an Immediate Memory Index Score of <strong>' + idx.immediateMemory + '</strong>. This means that ' + cent.immediateMemory + '% of healthy people in your age group score worse than you on this subtest.</p>';
    content += '<h5 style="color:#0d6efd;border-bottom:2px solid #0d6efd;padding-bottom:3px;font-size:0.95rem">Visuospatial Function</h5>';
    content += '<p>You scored ' + (raw.lineorientation || '--') + '/20 on the line orientation task which tests visual perceptual ability. You scored ' + (raw.figurecopy || '--') + '/20 on the figure copy task which tests visual working memory and motor skill. This gives a Visuospatial/Constructional Index Score of <strong>' + idx.visuospatial + '</strong>. This means that ' + cent.visuospatial + '% of healthy people in your age group score worse than you on this subtest.</p>';
    content += '<h5 style="color:#0d6efd;border-bottom:2px solid #0d6efd;padding-bottom:3px;font-size:0.95rem">Language Function</h5>';
    content += '<p>You scored ' + (raw.naming || '--') + '/10 on the naming task which is a specific measure of your ability to recall words. You scored ' + (raw.semanticfluency || '--') + '/40 on the semantic fluency task which makes demands on your attention and executive function as well as memory. This gives a Language Index Score of <strong>' + idx.language + '</strong>. This means that ' + cent.language + '% of healthy people in your age group score worse than you on this subtest.</p>';
    content += '<h5 style="color:#0d6efd;border-bottom:2px solid #0d6efd;padding-bottom:3px;font-size:0.95rem">Attention &amp; Concentration</h5>';
    content += '<p>You scored ' + (raw.digitspan || '--') + '/16 on the digit span task which tests attention and working memory. You scored ' + (raw.coding || '--') + '/89 on the digit-symbol coding task which tests attention and processing speed. This gives an Attention Index Score of <strong>' + idx.attention + '</strong>. This means that ' + cent.attention + '% of healthy people in your age group score worse than you on this subtest.</p>';
    content += '<h5 style="color:#0d6efd;border-bottom:2px solid #0d6efd;padding-bottom:3px;font-size:0.95rem">Delayed Memory</h5>';
    content += '<p>You scored ' + (raw.listrecall || '--') + '/10 on the free recall of ten words, a sensitive indicator of verbal learning and recall. You scored ' + (raw.listrecog || '--') + '/20 on the cued recall task which taxes delayed memory. Recalling the complex figure is difficult, and you scored ' + (raw.figurerecall || '--') + '/20. You remembered ' + (raw.storyrecall || '--') + ' items out of a possible 12 from the short story. This gives a Delayed Memory Index Score of <strong>' + idx.delayedMemory + '</strong>. This means that ' + cent.delayedMemory + '% of healthy people in your age group score worse than you on this subtest.</p>';
    content += '<h5 style="color:#0d6efd;border-bottom:2px solid #0d6efd;padding-bottom:3px;font-size:0.95rem">Overall Scores</h5>';
    content += '<p>The Total Scale Score is <strong>' + idx.totalScale + '</strong>. This means that ' + cent.totalScale + '% of healthy people in your age group score worse than you overall.</p>';
    content += '</div>';
    content += '<div style="margin-top:0.75rem;padding:8px 12px;background:#f8f9fa;border-radius:6px;font-size:0.84rem">';
    content += '<strong>Supplementary Indices:</strong> Effort — Silverberg = ' + rb.silverbergEI + ', Novitski = ' + rb.novitskiES + '. ';
    content += 'Cortical–Subcortical Index = ' + rb.corticalSubcortical.toFixed(1) + (rb.corticalSubcortical > 0 ? ' (cortical pattern)' : ' (subcortical pattern)') + '.';
    if (rb.duff) {
      content += '<br><strong>Duff demographically-corrected centiles:</strong> Imm Memory ' + rb.duff.immCentile + '%, Visuospatial ' + rb.duff.visuoCentile + '%, Language ' + rb.duff.langCentile + '%, Attention ' + rb.duff.attCentile + '%, Delayed Memory ' + rb.duff.memCentile + '%, Total ' + rb.duff.totalCentile + '%.';
    }
    content += '</div>';
    return section('Neuropsychological Assessment (RBANS)', content, compact, 'rbans');
  }
  function classifyIndex(idx) { if (idx >= 130) return 'Very Superior'; if (idx >= 120) return 'Superior'; if (idx >= 110) return 'High Average'; if (idx >= 90) return 'Average'; if (idx >= 80) return 'Low Average'; if (idx >= 70) return 'Borderline'; return 'Extremely Low'; }

  // ═══════════════════════════════════════════
  //  LEWY BODY (DIAMOND Lewy)
  // ═══════════════════════════════════════════
  function lewySection(compact) {
    var dl = S.getScore('diamondLewy');
    if (!dl || dl.diagnosis === 'incomplete') return section('Lewy Body Features', '<p class="text-muted">DIAMOND Lewy assessment not yet completed.</p>', compact, 'lewy');
    var content = '';
    switch (dl.diagnosis) {
      case 'probable': content += '<p><strong>Diagnostic classification:</strong> <span class="score-badge score-poor">Probable Dementia with Lewy Bodies (DLB)</span></p>'; break;
      case 'possible': content += '<p><strong>Diagnostic classification:</strong> <span class="score-badge score-moderate">Possible Dementia with Lewy Bodies (DLB)</span></p>'; break;
      case 'not_met': content += '<p><strong>Diagnostic classification:</strong> DLB criteria not met.</p>'; break;
      case 'no_dementia': content += '<p><strong>Diagnostic classification:</strong> Essential criterion (progressive cognitive decline) not established.</p>'; break;
    }
    content += '<p><strong>Core features present (' + dl.coreCount + '/4):</strong> ' + ((dl.corePresent && dl.corePresent.length > 0) ? dl.corePresent.join(', ') : 'None identified') + '</p>';
    content += '<p><strong>Indicative biomarkers:</strong> ' + dl.biomarkerCount + ' present</p>';
    if (dl.supportiveCount > 0) { content += '<p><strong>Supportive features (' + dl.supportiveCount + '):</strong> ' + ((dl.supportivePresent && dl.supportivePresent.length > 0) ? dl.supportivePresent.join(', ') : '') + '</p>'; }
    if (dl.diagnosis === 'probable') content += '<p>The assessment findings meet criteria for <em>probable</em> Dementia with Lewy Bodies based on the 4th DLB Consensus Criteria (McKeith et al., 2017). This means the pattern of symptoms is consistent with this form of dementia, and the implications will be discussed with you.</p>';
    else if (dl.diagnosis === 'possible') content += '<p>The assessment findings meet criteria for <em>possible</em> Dementia with Lewy Bodies. This means some features suggestive of this diagnosis were identified, but the full diagnostic criteria were not met. Further investigation may be helpful.</p>';
    else if (dl.diagnosis === 'not_met') content += '<p>While dementia was identified, the specific features needed for a diagnosis of Dementia with Lewy Bodies were not found during this assessment.</p>';
    return section('Lewy Body Features', content, compact, 'lewy');
  }

  // ─── Utility ───
  function esc(str) { var div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
  function joinList(arr) {
    if (arr.length === 0) return '';
    if (arr.length === 1) return arr[0];
    return arr.slice(0, -1).join(', ') + ', and ' + arr[arr.length - 1];
  }

  /** Convert first-person text to second person (I/me/my → you/your) */
  function toSecondPerson(text) {
    var s = text;
    // Longer phrases first to avoid partial matches
    s = s.replace(/\bI feel\b/g, 'you feel');
    s = s.replace(/\bI can\b/g, 'you can');
    s = s.replace(/\bI choose\b/g, 'you choose');
    s = s.replace(/\bI look\b/g, 'you look');
    s = s.replace(/\bI enjoy\b/g, 'you enjoy');
    s = s.replace(/\bI would\b/g, 'you would');
    s = s.replace(/\bI want\b/g, 'you want');
    s = s.replace(/\bI have\b/g, 'you have');
    s = s.replace(/\bI do\b/g, 'you do');
    s = s.replace(/\bI am\b/g, 'you are');
    s = s.replace(/\bI\b/g, 'you');
    s = s.replace(/\bMy\b/g, 'Your');
    s = s.replace(/\bmy\b/g, 'your');
    s = s.replace(/\bmyself\b/g, 'yourself');
    s = s.replace(/\bme\b/g, 'you');
    return s;
  }

  return { update: update, TEMPLATE_VERSION: TEMPLATE_VERSION };
})();

/* ── charts.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Charts — Report chart rendering (Chart.js)
   Reworked: removed pointless single-bar charts;
   added radar for MBI-C & NPI-Q; RBANS line profile;
   CDR domain radar
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};

BHM.Charts = (function () {
  'use strict';

  var S = BHM.State;
  var _chartInstances = {};

  // ── Helper: destroy previous chart ──
  function destroyChart(id) {
    if (_chartInstances[id]) {
      _chartInstances[id].destroy();
      delete _chartInstances[id];
    }
  }

  // ── Helper: ensure canvas inside container ──
  function ensureCanvas(containerId, height) {
    var container = document.getElementById(containerId);
    if (!container) return null;
    var canvasId = containerId + '-canvas';
    var canvas = document.getElementById(canvasId);
    if (!canvas) {
      container.style.height = (height || 220) + 'px';
      canvas = document.createElement('canvas');
      canvas.id = canvasId;
      container.appendChild(canvas);
    }
    destroyChart(canvasId);
    return { canvas: canvas, canvasId: canvasId };
  }

  // ═══════════════════════════════════════════
  //  BAR CHART (for multi-category data only)
  // ═══════════════════════════════════════════
  function createBarChart(containerId, config) {
    var c = ensureCanvas(containerId, config.height || 220);
    if (!c) return;

    var colors = config.colors || config.data.map(function (val) {
      if (config.thresholdValue !== undefined) {
        return val > config.thresholdValue ? '#dc3545'
          : val > (config.warningValue || config.thresholdValue * 0.7) ? '#ffc107' : '#198754';
      }
      return '#0d6efd';
    });

    try {
      _chartInstances[c.canvasId] = new Chart(c.canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels: config.labels,
          datasets: [{
            data: config.data,
            backgroundColor: colors,
            borderColor: colors,
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: true } },
          scales: {
            y: {
              beginAtZero: true,
              max: config.max || undefined,
              grid: { color: '#e9ecef' },
              ticks: { font: { size: 11 } }
            },
            x: {
              grid: { display: false },
              ticks: { font: { size: 10 }, maxRotation: 45 }
            }
          }
        }
      });
    } catch (e) {
      console.warn('BHM Charts: bar failed', containerId, e);
    }
  }

  // ═══════════════════════════════════════════
  //  RADAR / WINDROSE CHART
  // ═══════════════════════════════════════════
  function createRadarChart(containerId, config) {
    var c = ensureCanvas(containerId, config.height || 300);
    if (!c) return;

    var datasets = [];
    for (var i = 0; i < config.datasets.length; i++) {
      var ds = config.datasets[i];
      datasets.push({
        label: ds.label,
        data: ds.data,
        backgroundColor: ds.bg || 'rgba(13,110,253,0.15)',
        borderColor: ds.border || '#0d6efd',
        borderWidth: ds.borderWidth || 2,
        pointBackgroundColor: ds.border || '#0d6efd',
        pointRadius: 4,
        pointHoverRadius: 6
      });
    }

    try {
      _chartInstances[c.canvasId] = new Chart(c.canvas.getContext('2d'), {
        type: 'radar',
        data: {
          labels: config.labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: datasets.length > 1, position: 'bottom', labels: { font: { size: 11 } } }
          },
          scales: {
            r: {
              beginAtZero: true,
              max: config.max || undefined,
              ticks: { stepSize: config.step || undefined, font: { size: 10 }, backdropColor: 'transparent' },
              pointLabels: { font: { size: config.labelSize || 11 } },
              grid: { color: '#dee2e6' },
              angleLines: { color: '#dee2e6' }
            }
          }
        }
      });
    } catch (e) {
      console.warn('BHM Charts: radar failed', containerId, e);
    }
  }

  // ═══════════════════════════════════════════
  //  RBANS LINE PROFILE CHART
  // ═══════════════════════════════════════════
  function createRBANSChart(containerId) {
    var rb = S.getScore('rbans');
    if (!rb || !rb.indices) return;

    var c = ensureCanvas(containerId, 360);
    if (!c) return;

    var labels = ['Immediate\nMemory', 'Visuospatial', 'Language', 'Attention', 'Delayed\nMemory'];
    var idx = rb.indices;
    var duff = rb.duff;
    var stdData = [idx.immediateMemory, idx.visuospatial, idx.language, idx.attention, idx.delayedMemory];
    var duffData = [parseFloat(duff.immIndex), parseFloat(duff.visuoIndex), parseFloat(duff.langIndex),
      parseFloat(duff.attIndex), parseFloat(duff.memIndex)];

    try {
      _chartInstances[c.canvasId] = new Chart(c.canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Standard Norms',
              data: stdData,
              borderColor: 'rgb(17,157,255)',
              backgroundColor: 'rgba(17,157,255,0.08)',
              borderWidth: 2.5,
              pointRadius: 6,
              pointBackgroundColor: 'rgb(17,157,255)',
              fill: false,
              tension: 0.1
            },
            {
              label: 'Duff Adjusted',
              data: duffData,
              borderColor: 'rgb(255,102,0)',
              backgroundColor: 'rgba(255,102,0,0.08)',
              borderWidth: 2.5,
              borderDash: [6, 3],
              pointRadius: 6,
              pointBackgroundColor: 'rgb(255,102,0)',
              pointStyle: 'rectRot',
              fill: false,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'RBANS Index Profile', font: { size: 13, weight: 'bold' } },
            legend: { position: 'bottom', labels: { font: { size: 11 } } }
          },
          scales: {
            y: {
              min: 40, max: 160,
              ticks: { stepSize: 10, font: { size: 10 } },
              title: { display: true, text: 'Index Score', font: { size: 11 } }
            },
            x: {
              ticks: { font: { size: 10 } }
            }
          }
        },
        plugins: [{
          id: 'rbans-report-bands',
          beforeDraw: function (chart) {
            var ctx = chart.ctx;
            var yScale = chart.scales.y;
            var area = chart.chartArea;
            var bands = [
              { lo: 40, hi: 70, color: 'rgba(255,77,77,0.07)' },
              { lo: 70, hi: 85, color: 'rgba(255,200,0,0.07)' },
              { lo: 85, hi: 115, color: 'rgba(0,200,83,0.07)' },
              { lo: 115, hi: 160, color: 'rgba(0,123,255,0.05)' }
            ];
            ctx.save();
            for (var b = 0; b < bands.length; b++) {
              var top = yScale.getPixelForValue(bands[b].hi);
              var bottom = yScale.getPixelForValue(bands[b].lo);
              ctx.fillStyle = bands[b].color;
              ctx.fillRect(area.left, top, area.right - area.left, bottom - top);
            }
            // Mean line
            var meanY = yScale.getPixelForValue(100);
            ctx.strokeStyle = 'rgba(0,0,0,0.18)';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(area.left, meanY);
            ctx.lineTo(area.right, meanY);
            ctx.stroke();
            ctx.restore();
          }
        }]
      });
    } catch (e) {
      console.warn('BHM Charts: RBANS failed', containerId, e);
    }
  }

  // ═══════════════════════════════════════════
  //  RENDER ALL REPORT CHARTS
  // ═══════════════════════════════════════════
  function renderReportCharts() {

    // ── PSQI 7-component bar (meaningful multi-bar) ──
    var psqi = S.getScore('psqi');
    if (psqi && psqi.globalTotal !== null) {
      var compLabels = ['Quality', 'Latency', 'Duration', 'Efficiency', 'Disturbance', 'Medication', 'Day Dysfunction'];
      var compKeys = ['subjectiveQuality', 'sleepLatency', 'sleepDuration', 'sleepEfficiency',
        'sleepDisturbance', 'sleepMedication', 'daytimeDysfunction'];
      var compData = compKeys.map(function (k) { return psqi.components[k] || 0; });
      createBarChart('chart-psqi', {
        labels: compLabels, data: compData, max: 3, height: 220,
        thresholdValue: 2, warningValue: 1
      });
    }

    // ── CASP-19 4-domain bar (meaningful multi-bar) ──
    var casp = S.getScore('casp19');
    if (casp && casp.total !== null && casp.domainTotals) {
      var cLabels = [], cData = [];
      for (var d in casp.domainTotals) {
        if (casp.domainTotals.hasOwnProperty(d)) {
          cLabels.push(d);
          cData.push(casp.domainTotals[d]);
        }
      }
      createBarChart('chart-casp19', {
        labels: cLabels, data: cData, height: 200,
        colors: cData.map(function () { return '#0d6efd'; })
      });
    }

    // ── MBI-C 5-domain radar (windrose) ──
    var mbic = S.getScore('mbiC');
    if (mbic && mbic.total !== null && BHM.Instruments.MBIC) {
      var domains = BHM.Instruments.MBIC.getDomains();
      var mLabels = [], mData = [];
      var domainShortNames = ['Motivation\n& Drive', 'Mood &\nAnxiety', 'Impulse Control\n& Reward', 'Social\nAppropriate.', 'Beliefs &\nPerception'];
      for (var i = 0; i < domains.length; i++) {
        mLabels.push(domainShortNames[i] || domains[i].name.split(' ')[0]);
        var dTotal = 0;
        for (var j = 0; j < domains[i].items.length; j++) {
          var val = S.get('instruments.mbiC.' + domains[i].items[j].key);
          if (val !== undefined && val !== null) dTotal += Number(val);
        }
        mData.push(dTotal);
      }
      // Max per domain: items * 3 (each scored 0-3)
      var maxPerDomain = domains.map(function (dom) { return dom.items.length * 3; });
      var maxAll = Math.max.apply(null, maxPerDomain);
      createRadarChart('chart-mbic', {
        labels: mLabels,
        datasets: [{ label: 'MBI-C Domain Scores', data: mData, bg: 'rgba(220,53,69,0.15)', border: '#dc3545' }],
        max: maxAll,
        step: Math.ceil(maxAll / 5),
        height: 320,
        labelSize: 11
      });
    }

    // ── NPI-Q 12-symptom radar (severity + distress overlaid) ──
    var npiq = S.getScore('npiQ');
    if (npiq && npiq.count > 0 && BHM.Instruments.NPIQ) {
      var symptoms = BHM.Instruments.NPIQ.getSymptoms();
      var nLabels = [], sevData = [], distData = [];
      for (var si = 0; si < symptoms.length; si++) {
        nLabels.push(symptoms[si].label.split('/')[0]); // short label
        var present = S.get('instruments.npiQ.' + symptoms[si].key + '_present');
        if (present === 'yes') {
          var sev = S.get('instruments.npiQ.' + symptoms[si].key + '_severity');
          var dist = S.get('instruments.npiQ.' + symptoms[si].key + '_distress');
          sevData.push(sev !== undefined && sev !== null ? Number(sev) : 0);
          distData.push(dist !== undefined && dist !== null ? Number(dist) : 0);
        } else {
          sevData.push(0);
          distData.push(0);
        }
      }
      createRadarChart('chart-npiq', {
        labels: nLabels,
        datasets: [
          { label: 'Severity', data: sevData, bg: 'rgba(255,193,7,0.15)', border: '#ffc107', borderWidth: 2 },
          { label: 'Carer Distress', data: distData, bg: 'rgba(220,53,69,0.12)', border: '#dc3545', borderWidth: 2 }
        ],
        max: 5,
        step: 1,
        height: 340,
        labelSize: 10
      });
    }

    // ── CDR 6-domain radar ──
    var cdr = S.getScore('cdr');
    if (cdr && cdr.total !== null && cdr.domainScores) {
      var cdrLabels = ['Memory', 'Orientation', 'Judgment', 'Community\nAffairs', 'Home &\nHobbies', 'Personal\nCare'];
      var cdrKeys = ['memory', 'orientation', 'judgment', 'community', 'homeHobbies', 'personalCare'];
      var cdrData = cdrKeys.map(function (k) { return cdr.domainScores[k] || 0; });
      createRadarChart('chart-cdr', {
        labels: cdrLabels,
        datasets: [{ label: 'CDR Domain Ratings', data: cdrData, bg: 'rgba(108,117,125,0.15)', border: '#6c757d' }],
        max: 3,
        step: 0.5,
        height: 300,
        labelSize: 11
      });
    }

    // ── RBANS profile line chart ──
    createRBANSChart('chart-rbans');
  }

  return {
    renderReportCharts: renderReportCharts
  };
})();

/* ── exporter.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.Export — JSON, CSV, Audit Log, Print
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};

BHM.Export = (function () {
  'use strict';

  var S = BHM.State;

  function downloadFile(content, filename, mimeType) {
    var blob = new Blob([content], { type: mimeType });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function getTimestamp() {
    return new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
  }

  function getPatientSlug() {
    var name = S.get('patient.name') || 'unknown';
    return name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);
  }

  // ── Export raw session as JSON ──
  function exportJSON() {
    var session = S.getSession();
    var json = JSON.stringify(session, null, 2);
    var filename = 'BHM_' + getPatientSlug() + '_' + getTimestamp() + '.json';
    downloadFile(json, filename, 'application/json');
  }

  // ── Export scores summary as CSV ──
  function exportCSV() {
    var scores = S.getSession().scores || {};
    var rows = [['Instrument', 'Metric', 'Value']];

    // PSQI
    if (scores.psqi) {
      rows.push(['PSQI', 'Global Total', scores.psqi.globalTotal]);
      var comps = scores.psqi.components || {};
      for (var ck in comps) {
        if (comps.hasOwnProperty(ck)) {
          rows.push(['PSQI', 'Component: ' + ck, comps[ck]]);
        }
      }
    }

    // Simple totals
    var simpleScores = [
      { key: 'epworth', name: 'Epworth', metric: 'Total' },
      { key: 'gad7', name: 'GAD-7', metric: 'Total' },
      { key: 'depression', name: 'Depression (GDS-15)', metric: 'Total' },
      { key: 'diet', name: 'Mediterranean Diet', metric: 'Total' },
      { key: 'auditTool', name: 'AUDIT', metric: 'Total' },
      { key: 'casp19', name: 'CASP-19', metric: 'Total' }
    ];
    for (var i = 0; i < simpleScores.length; i++) {
      var s = simpleScores[i];
      if (scores[s.key] && scores[s.key].total !== undefined) {
        rows.push([s.name, s.metric, scores[s.key].total]);
      }
    }

    // GAD-7 impairment
    if (scores.gad7 && scores.gad7.impairment) {
      rows.push(['GAD-7', 'Impairment', scores.gad7.impairment]);
    }

    // CASP-19 domains
    if (scores.casp19 && scores.casp19.domainTotals) {
      for (var d in scores.casp19.domainTotals) {
        if (scores.casp19.domainTotals.hasOwnProperty(d)) {
          rows.push(['CASP-19', 'Domain: ' + d, scores.casp19.domainTotals[d]]);
        }
      }
    }

    // Hearing
    if (scores.hearing) {
      rows.push(['Hearing', 'Affected Situations', scores.hearing.affectedCount]);
    }

    // MBI-C
    if (scores.mbiC && scores.mbiC.total !== undefined) {
      rows.push(['MBI-C', 'Total', scores.mbiC.total]);
    }

    // NPI-Q
    if (scores.npiQ) {
      rows.push(['NPI-Q', 'Symptom Count', scores.npiQ.count]);
      rows.push(['NPI-Q', 'Severity Total', scores.npiQ.severityTotal]);
      rows.push(['NPI-Q', 'Distress Total', scores.npiQ.distressTotal]);
    }

    var csv = rows.map(function (row) {
      return row.map(function (cell) {
        return '"' + String(cell === null || cell === undefined ? '' : cell).replace(/"/g, '""') + '"';
      }).join(',');
    }).join('\n');

    var filename = 'BHM_Scores_' + getPatientSlug() + '_' + getTimestamp() + '.csv';
    downloadFile(csv, filename, 'text/csv');
  }

  // ── Export audit log ──
  function exportAudit() {
    var log = S.getSession().auditLog || [];
    var rows = [['Timestamp', 'Field', 'Old Value', 'New Value', 'Operator', 'Source Mode']];
    for (var i = 0; i < log.length; i++) {
      var entry = log[i];
      rows.push([
        entry.timestamp,
        entry.field,
        JSON.stringify(entry.oldValue),
        JSON.stringify(entry.newValue),
        entry.operator,
        entry.sourceMode
      ]);
    }

    var csv = rows.map(function (row) {
      return row.map(function (cell) {
        return '"' + String(cell === null || cell === undefined ? '' : cell).replace(/"/g, '""') + '"';
      }).join(',');
    }).join('\n');

    var filename = 'BHM_Audit_' + getPatientSlug() + '_' + getTimestamp() + '.csv';
    downloadFile(csv, filename, 'text/csv');
  }

  // ── Print report ──
  function printReport() {
    // Switch to report tab first
    var reportTab = document.getElementById('tab-report');
    if (reportTab) {
      var bsTab = new bootstrap.Tab(reportTab);
      bsTab.show();
    }
    setTimeout(function () {
      window.print();
    }, 300);
  }

  // ── Render audit log table ──
  function renderAuditTab(container) {
    container.innerHTML = '';

    var card = document.createElement('div');
    card.className = 'instrument-card';
    card.innerHTML =
      '<h5><i class="bi bi-clock-history me-1"></i>Audit Log</h5>' +
      '<p class="instrument-subtitle">Complete history of all data changes in this session.</p>';

    var log = S.getSession().auditLog || [];

    if (log.length === 0) {
      card.innerHTML += '<p class="text-muted">No changes recorded yet.</p>';
      container.appendChild(card);
      return;
    }

    var toolbar = document.createElement('div');
    toolbar.className = 'd-flex justify-content-between align-items-center mb-3';
    toolbar.innerHTML =
      '<span class="badge bg-secondary">' + log.length + ' entries</span>' +
      '<button class="btn btn-sm btn-outline-primary" id="exportAuditBtn"><i class="bi bi-download me-1"></i>Export Audit Log</button>';
    card.appendChild(toolbar);

    var tableWrap = document.createElement('div');
    tableWrap.className = 'table-responsive';
    tableWrap.style.maxHeight = '500px';
    tableWrap.style.overflowY = 'auto';

    var table = document.createElement('table');
    table.className = 'table table-sm table-striped audit-table';
    table.innerHTML =
      '<thead><tr><th>Time</th><th>Field</th><th>Old</th><th>New</th><th>Operator</th><th>Mode</th></tr></thead>';

    var tbody = document.createElement('tbody');
    // Show most recent first
    for (var i = log.length - 1; i >= 0; i--) {
      var e = log[i];
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>' + new Date(e.timestamp).toLocaleString() + '</td>' +
        '<td><code>' + escHtml(e.field) + '</code></td>' +
        '<td>' + escHtml(formatVal(e.oldValue)) + '</td>' +
        '<td>' + escHtml(formatVal(e.newValue)) + '</td>' +
        '<td>' + escHtml(e.operator || '—') + '</td>' +
        '<td>' + escHtml(e.sourceMode || '—') + '</td>';
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    tableWrap.appendChild(table);
    card.appendChild(tableWrap);

    container.appendChild(card);

    // Bind export button
    var btn = document.getElementById('exportAuditBtn');
    if (btn) btn.addEventListener('click', exportAudit);
  }

  function formatVal(val) {
    if (val === null || val === undefined) return '—';
    return String(val);
  }

  function escHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  return {
    exportJSON: exportJSON,
    exportCSV: exportCSV,
    exportAudit: exportAudit,
    printReport: printReport,
    renderAuditTab: renderAuditTab
  };
})();

/* ── app.js ── */
/* ═══════════════════════════════════════════════════════
   BHM.App — Main application controller
   ═══════════════════════════════════════════════════════ */
var BHM = window.BHM || {};

BHM.App = (function () {
  'use strict';

  function init() {
    console.log('BHM Assessment App v' + BHM.State.VERSION + ' initialising...');

    // ── Load saved session ──
    var loaded = BHM.State.load();
    if (loaded) {
      console.log('BHM: Restored session from localStorage');
    }

    // ── Render all instrument forms ──
    renderAll();

    // ── Bind UI controls ──
    bindReportPanel();
    bindExportButtons();
    bindTabEvents();

    // ── Subscribe to state changes for live report updates ──
    // Skip full report rebuild when the change is just a clinician‐notes
    // textarea (those don't affect computed content, and rebuilding would
    // destroy the textarea the user is actively typing in).
    BHM.State.subscribe(function (changedPath) {
      if (changedPath && changedPath.indexOf('clinicianInserts.') === 0) return;
      BHM.Report.update();
    });

    // ── Initial report generation ──
    BHM.Report.update();

    console.log('BHM: App ready');
  }

  function renderAll() {
    // Session
    BHM.Instruments.Session.render(document.getElementById('sessionContent'));

    // Patient booklet instruments
    BHM.Instruments.PSQI.render(document.getElementById('psqiContent'));
    BHM.Instruments.Epworth.render(document.getElementById('epworthContent'));
    BHM.Instruments.GAD7.render(document.getElementById('gad7Content'));
    BHM.Instruments.Depression.render(document.getElementById('depressionContent'));
    BHM.Instruments.Diet.render(document.getElementById('dietContent'));
    BHM.Instruments.AuditTool.render(document.getElementById('auditToolContent'));
    BHM.Instruments.CASP19.render(document.getElementById('casp19Content'));
    BHM.Instruments.Hearing.render(document.getElementById('hearingContent'));

    // Informant booklet instruments
    BHM.Instruments.MBIC.render(document.getElementById('mbicContent'));
    BHM.Instruments.NPIQ.render(document.getElementById('npiqContent'));

    // RBANS
    BHM.Instruments.RBANS.render(document.getElementById('rbansContent'));

    // Clinical interview
    BHM.Instruments.ClinicalInterview.render(document.getElementById('clinicalContent'));

    // CDR
    BHM.Instruments.CDR.renderAssessment(document.getElementById('cdrAssessContent'));
    BHM.Instruments.CDR.renderScoring(document.getElementById('cdrScoringContent'));

    // DIAMOND Lewy
    BHM.Instruments.DiamondLewy.render(document.getElementById('diamondLewyContent'));

    // Audit log
    BHM.Export.renderAuditTab(document.getElementById('auditContent'));
  }

  // ── Report side panel toggle ──
  function bindReportPanel() {
    var panel = document.getElementById('reportSidePanel');
    var toggleBtn = document.getElementById('toggleReportPanelBtn');
    var closeBtn = document.getElementById('closeSidePanel');

    // Start collapsed
    panel.classList.add('collapsed');

    toggleBtn.addEventListener('click', function () {
      panel.classList.toggle('collapsed');
      if (!panel.classList.contains('collapsed')) {
        BHM.Report.update();
      }
    });

    closeBtn.addEventListener('click', function () {
      panel.classList.add('collapsed');
    });
  }

  // ── Export buttons ──
  function bindExportButtons() {
    var jsonBtn = document.getElementById('exportJSON');
    var csvBtn = document.getElementById('exportCSV');
    var auditBtn = document.getElementById('exportAudit');
    var printBtn = document.getElementById('printReport');

    if (jsonBtn) jsonBtn.addEventListener('click', function (e) { e.preventDefault(); BHM.Export.exportJSON(); });
    if (csvBtn) csvBtn.addEventListener('click', function (e) { e.preventDefault(); BHM.Export.exportCSV(); });
    if (auditBtn) auditBtn.addEventListener('click', function (e) { e.preventDefault(); BHM.Export.exportAudit(); });
    if (printBtn) printBtn.addEventListener('click', function (e) { e.preventDefault(); BHM.Export.printReport(); });
  }

  // ── Tab events ──
  function bindTabEvents() {
    // Re-render audit log when switching to audit tab
    var auditTab = document.getElementById('tab-audit');
    if (auditTab) {
      auditTab.addEventListener('shown.bs.tab', function () {
        BHM.Export.renderAuditTab(document.getElementById('auditContent'));
      });
    }

    // Re-render report when switching to report tab
    var reportTab = document.getElementById('tab-report');
    if (reportTab) {
      reportTab.addEventListener('shown.bs.tab', function () {
        BHM.Report.update();
      });
    }

    // Re-render CDR scoring when switching to CDR scoring sub-tab
    var cdrScoringPill = document.querySelector('[data-bs-target="#sub-cdr-scoring"]');
    if (cdrScoringPill) {
      cdrScoringPill.addEventListener('shown.bs.tab', function () {
        BHM.Instruments.CDR.renderScoring(document.getElementById('cdrScoringContent'));
      });
    }
  }

  // ── DOM ready ──
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  return {
    renderAll: renderAll
  };
})();
  </script>
</body>
</html>
